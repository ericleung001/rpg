<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„èƒŒåŒ…</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 15px; 
            display:flex; flex-direction:column; align-items:center; 
            height: 100dvh; margin:0; box-sizing:border-box;
            overscroll-behavior: none;
        }
        
        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 20px; margin: 0; }

        .container { 
            display: flex; flex: 1; width: 100%; max-width: 600px; 
            flex-direction: column; overflow: hidden; margin-bottom: 15px; 
        }
        
        .bag-list { 
            flex: 1; background: #34495e; border: 3px solid #bdc3c7; 
            overflow-y: auto; padding: 10px; border-radius: 8px; 
        }

        .item-card { 
            background: #ecf0f1; color: #2c3e50; 
            padding: 15px; margin-bottom: 10px; 
            border-radius: 8px; text-align: left; 
            border-bottom: 4px solid #95a5a6;
        }
        
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .item-name { font-size: 14px; font-weight: bold; color: #2980b9; }
        .item-count { font-size: 14px; background: #2c3e50; color: #fff; padding: 2px 6px; border-radius: 4px; }
        .item-desc { font-size: 10px; color: #7f8c8d; margin-bottom: 10px; }

        .action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn { 
            padding: 12px; font-family: inherit; font-size: 12px; cursor: pointer; 
            border: 2px solid rgba(0,0,0,0.2); color: white; border-radius: 6px; font-weight: bold;
        }
        .btn:active { transform: translateY(2px); filter: brightness(0.9); }
        .btn-npc { background: #e74c3c; } 
        .btn-market { background: #3498db; }

        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
        }

        /* === å½ˆçª—æ¨£å¼ === */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; 
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { 
            background: #fff; color: #000; 
            padding: 25px; border: 6px solid #f1c40f; 
            width: 80%; max-width: 300px; border-radius: 12px; text-align: center;
        }
        input { 
            width: 100%; padding: 15px; margin: 15px 0; 
            font-family: inherit; font-size: 16px; 
            box-sizing: border-box; border: 2px solid #ccc; text-align: center;
        }

        /* === Toast é€šçŸ¥ === */
        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f;
            color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999;
            font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-toast"></div>

    <div class="header">
        <h1>ğŸ’ èƒŒåŒ…</h1>
        <div class="gold-display">ğŸ’° <span id="my-gold">0</span> G</div>
    </div>

    <div class="container">
        <div class="bag-list" id="bag-list">
            <div style="font-size:12px; color:#aaa; margin-top:20px;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>

    <div id="market-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="market-title" style="font-size:16px; margin-bottom:10px;">ä¸Šæ¶ç‰©å“</h3>
            <div style="font-size:10px; color:#555; margin-bottom:10px;">è«‹è¼¸å…¥å¸‚é›†è²©è³£åƒ¹æ ¼</div>
            <input type="number" id="sell-price" placeholder="åƒ¹æ ¼ (G)">
            <button class="btn btn-market" style="width:100%; margin-bottom:10px;" onclick="confirmMarketSell()">ç¢ºèªä¸Šæ¶</button>
            <button class="btn" style="background:#555; width:100%;" onclick="closeAllModals()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="npc-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:10px; color:#e74c3c;">è³£çµ¦å•†äºº</h3>
            <div id="npc-msg" style="font-size:12px; color:#555; margin-bottom:20px; line-height:1.6;">...</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="background:#e74c3c;" onclick="confirmNPCSell()">ç¢ºå®š</button>
                <button class="btn" style="background:#7f8c8d;" onclick="closeAllModals()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
        const _0x5a1b = "aHR0cHM6Ly9tbW8udHRjdHYtMTA1LmNj"; 
        const BACKEND_URL = atob(_0x5a1b);
        
        const socket = io(BACKEND_URL, {
            transports: ['websocket', 'polling']
        });
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        // ğŸŸ¢ å®Œæ•´ç‰©å“è³‡æ–™åº«
        const ITEM_DB = {
            // === æ¶ˆè€—å“ ===
            'potion_hp':    { name: "å°ç´…è—¥æ°´", cost: 50, desc: "æ¢å¾© 50 HP" },
            'potion_mid':   { name: "ä¸­ç´…è—¥æ°´", cost: 200, desc: "æ¢å¾© 500 HP" },
            'potion_high':  { name: "å¤§ç´…è—¥æ°´", cost: 1000, desc: "æ¢å¾© 2000 HP" },
            'potion_max':   { name: "ç‰¹ç´šç§˜è—¥", cost: 5000, desc: "æ¢å¾© 10000 HP" },
            'elixir':       { name: "ç¥ä¹‹ç”˜éœ²", cost: 20000, desc: "æ¢å¾© 50000 HP" },
            'potion_mp':    { name: "å°è—è—¥æ°´", cost: 80, desc: "æ¢å¾© 30 MP" },
            'potion_mp_mid':{ name: "ä¸­è—è—¥æ°´", cost: 300, desc: "æ¢å¾© 100 MP" },
            'potion_mp_high':{ name: "å¤§è—è—¥æ°´", cost: 1500, desc: "æ¢å¾© 500 MP" },
            'sushi_plate':  { name: "å£½å¸æ‹¼ç›¤", cost: 200, desc: "æ¢å¾© 500 HP" },

            // === æ–°å¢æ–™ç† ===
            'grilled_carp': { name: "çƒ¤é¯‰é­š", cost: 30, desc: "HP+100" },
            'salmon_sushi': { name: "é®­é­šå£½å¸", cost: 50, desc: "MP+50" },
            'tuna_steak':   { name: "ç…é®ªé­šæ’", cost: 200, desc: "HP+500" },
            'eel_rice':     { name: "é°»é­šé£¯", cost: 300, desc: "HP+300, MP+100" },
            'void_soup':    { name: "è™›ç©ºæµ·é®®æ¹¯", cost: 1000, desc: "ç‹€æ…‹å…¨æ»¿" },

            // === æ­¦å™¨ ===
            'wood_sword':   { name: "æœ¨åŠ", cost: 100, desc: "ATK+10" },
            'copper_dagger':{ name: "éŠ…åŒ•é¦–", cost: 200, desc: "ATK+15" },
            'iron_sword':   { name: "éµåŠ", cost: 500, desc: "ATK+30" },
            'spike_club':   { name: "ç‹¼ç‰™æ£’", cost: 0, desc: "ATK+55" },
            'poison_dag':   { name: "åŠ‡æ¯’åŒ•é¦–", cost: 0, desc: "ATK+60" },
            'silver_blade': { name: "éŠ€åˆƒ", cost: 2000, desc: "ATK+150" },
            'flame_staff':  { name: "ç«ç„°æ³•æ–", cost: 0, desc: "ATK+200" },
            'gold_axe':     { name: "é»ƒé‡‘å·¨æ–§", cost: 10000, desc: "ATK+500" },
            'frost_bow':    { name: "å¯’å†°å¼“", cost: 0, desc: "ATK+650" },
            'mithril_saber':{ name: "ç§˜éŠ€è»åˆ€", cost: 50000, desc: "ATK+2000" },
            'void_reaper':  { name: "è™›ç©ºæ”¶å‰²è€…", cost: 0, desc: "ATK+3500" },
            'god_slayer':   { name: "å¼’ç¥åŠ", cost: 0, desc: "ATK+20000" },
            'chaos_staff':  { name: "æ··æ²Œæ³•æ–", cost: 0, desc: "ATK+25000" },
            'hero_sword':   { name: "å‹‡è€…ä¹‹åŠ", cost: 2000, desc: "ATK+50" },
            'steel_blade':  { name: "ç²¾é‹¼åŠ", cost: 0, desc: "ATK+25" },
            'assassin_dag': { name: "åˆºå®¢çŸ­åˆ€", cost: 2000, desc: "ATK+120" },
            
            // æ¡é›†æ­¦å™¨
            'oak_bow':      { name: "æ©¡æœ¨å¼“", cost: 200, desc: "ATK+25" },
            'maple_staff':  { name: "æ¥“æœ¨æ³•æ–", cost: 500, desc: "ATK+50" },
            'shark_tooth':  { name: "é¯Šé­šç‰™åŒ•é¦–", cost: 800, desc: "ATK+80" },
            'emerald_staff':{ name: "ç¿¡ç¿ æ³•æ–", cost: 5000, desc: "ATK+300" },
            'obsidian_blade':{ name: "é»‘æ›œçŸ³ä¹‹åŠ", cost: 8000, desc: "ATK+600" },
            'dragon_spear': { name: "é¾éª¨é•·æ§", cost: 15000, desc: "ATK+1200" },

            // === é˜²å…· ===
            'cloth_armor':  { name: "å¸ƒè¡£", cost: 100, desc: "DEF+5" },
            'hunt_vest':    { name: "çµäººèƒŒå¿ƒ", cost: 0, desc: "DEF+8" },
            'leather_armor':{ name: "çš®ç”²", cost: 400, desc: "DEF+15" },
            'chain_mail':   { name: "é–å­ç”²", cost: 1500, desc: "DEF+40" },
            'magma_plate':  { name: "ç†”å²©èƒ¸ç”²", cost: 0, desc: "DEF+100" },
            'ice_robe':     { name: "å†°éœœæ³•è¢", cost: 0, desc: "DEF+200" },
            'yeti_cloak':   { name: "é›ªæ€ªæ–—ç¯·", cost: 0, desc: "DEF+250" },
            'demon_armor':  { name: "æƒ¡é­”æˆ°ç”²", cost: 0, desc: "DEF+1000" },
            'angel_armor':  { name: "ç†¾å¤©ä½¿é§ç”²", cost: 0, desc: "DEF+5000" },
            'plate_mail':   { name: "æ¿é‡‘ç”²", cost: 1500, desc: "DEF+15" },
            'dragon_mail':  { name: "é¾é±—ç”²", cost: 0, desc: "DEF+30" },

            // === é£¾å“ ===
            'bone_ring':    { name: "éª¨æˆ’", cost: 0, desc: "ATK+2" },
            'ring_str':     { name: "åŠ›é‡æˆ’æŒ‡", cost: 300, desc: "ATK+10" },
            'snake_boots':  { name: "è›‡çš®é•·é´", cost: 0, desc: "DEF+10" },
            'amulet_soul':  { name: "éˆé­‚è­·ç¬¦", cost: 0, desc: "MP+300" },
            'ring_lord':    { name: "é ˜ä¸»æŒ‡ç’°", cost: 0, desc: "å…¨èƒ½åŠ›+500" },
            'crown_chaos':  { name: "æ··æ²Œä¹‹å† ", cost: 0, desc: "å…¨èƒ½åŠ›+2000" },
            'ring_life':    { name: "ç”Ÿå‘½è­·ç¬¦", cost: 600, desc: "HP+100" },
            'ring_magic':   { name: "é­”åŠ›è€³ç’°", cost: 500, desc: "MP+50" },
            // æ¡é›†é£¾å“
            'fish_ring':    { name: "é­šé±—æˆ’æŒ‡", cost: 400, desc: "DEF+8" },
            'pearl_necklace':{ name: "çç é …éŠ", cost: 2000, desc: "MP+100" },

            // === æ¡é›†ææ–™ (ğŸŒ² æœ¨æ) ===
            'oak_log':      { name: "æ©¡æœ¨åŸæœ¨", cost: 5, desc: "å»ºæ" },
            'maple_log':    { name: "æ¥“æœ¨åŸæœ¨", cost: 15, desc: "é«˜ç´šå»ºæ" },
            'yew_log':      { name: "ç´«æ‰åŸæœ¨", cost: 30, desc: "é­”æ³•æœ¨æ" },
            'ancient_log':  { name: "é å¤ç¥æœ¨", cost: 100, desc: "ç¥è©±ææ–™" },
            'spirit_wood':  { name: "éˆæœ¨", cost: 50, desc: "ç¨€æœ‰æœ¨æ" },
            'dragon_wood':  { name: "é¾éª¨æœ¨", cost: 150, desc: "æ¥µç¡¬æœ¨æ" },
            'void_wood':    { name: "è™›ç©ºæœ¨", cost: 300, desc: "ä¾†è‡ªè™›ç©º" },
            'chaos_wood':   { name: "æ··æ²Œç¥æœ¨", cost: 1000, desc: "å‚³èªªææ–™" },

            // === æ¡é›†ææ–™ (ğŸŸ æ¼ç²) ===
            'carp':         { name: "é¯‰é­š", cost: 5, desc: "é£Ÿæ" },
            'salmon':       { name: "é®­é­š", cost: 10, desc: "ç¾å‘³é£Ÿæ" },
            'koi':          { name: "éŒ¦é¯‰", cost: 50, desc: "å¹¸é‹é­š" },
            'magic_fish':   { name: "é­”åŠ›é­š", cost: 30, desc: "ç™¼å…‰é­š" },
            'tuna':         { name: "é»‘é®ªé­š", cost: 80, desc: "é ‚ç´šé£Ÿæ" },
            'shark':        { name: "å¤§ç™½é¯Š", cost: 100, desc: "å…‡çŒ›é­šé¡" },
            'lava_eel':     { name: "ç†”å²©é°»", cost: 120, desc: "ç‡™æ‰‹" },
            'void_squid':   { name: "è™›ç©ºçƒè³Š", cost: 200, desc: "ç¥ç§˜" },
            'god_carp':     { name: "ç¥ä¹‹é¯‰", cost: 500, desc: "ç¥é­š" },
            'pearl':        { name: "çç ", cost: 500, desc: "çè²´å¯¶çŸ³" },

            // === æ¡é›†ææ–™ (â›ï¸ ç¤¦ç‰©) ===
            'coal':         { name: "ç…¤ç‚­", cost: 5, desc: "ç‡ƒæ–™" },
            'ruby':         { name: "ç´…å¯¶çŸ³", cost: 200, desc: "å¯¶çŸ³" },
            'diamond':      { name: "é‘½çŸ³", cost: 500, desc: "å …ç¡¬å¯¶çŸ³" },
            'star_fragment':{ name: "æ˜Ÿä¹‹ç¢ç‰‡", cost: 1000, desc: "éš•çŸ³" },

            // === æ€ªç‰©æ‰è½ææ–™ ===
            'copper_ore':   { name: "éŠ…ç¤¦çŸ³", cost: 10, desc: "ææ–™" },
            'soft_fur':     { name: "æŸ”è»Ÿçš®æ¯›", cost: 10, desc: "ææ–™" },
            'beast_fang':   { name: "é‡ç¸å°–ç‰™", cost: 15, desc: "ææ–™" },
            'slime_gel':    { name: "é»æ¶²", cost: 5, desc: "ææ–™" },
            'iron_ore':     { name: "éµç¤¦çŸ³", cost: 20, desc: "ææ–™" },
            'tough_hide':   { name: "ç¡¬çš®é©", cost: 25, desc: "ææ–™" },
            'poison_sac':   { name: "æ¯’å›Š", cost: 30, desc: "ææ–™" },
            'bone_shard':   { name: "ç¢éª¨ç‰‡", cost: 20, desc: "ææ–™" },
            'silver_ore':   { name: "éŠ€ç¤¦çŸ³", cost: 50, desc: "ææ–™" },
            'fire_core':    { name: "ç«ç„°æ ¸å¿ƒ", cost: 80, desc: "ææ–™" },
            'lava_rock':    { name: "ç†”å²©çŸ³", cost: 60, desc: "ææ–™" },
            'gold_ore':     { name: "é‡‘ç¤¦çŸ³", cost: 200, desc: "ææ–™" },
            'ice_crystal':  { name: "æ°¸æ†å†°æ™¶", cost: 150, desc: "ææ–™" },
            'yeti_fur':     { name: "é›ªæ€ªæ¯›çš®", cost: 180, desc: "ææ–™" },
            'spirit_dust':  { name: "éˆé­‚ç²‰æœ«", cost: 120, desc: "ææ–™" },
            'mithril':      { name: "ç§˜éŠ€", cost: 500, desc: "ææ–™" },
            'void_dust':    { name: "è™›ç©ºä¹‹å¡µ", cost: 400, desc: "ææ–™" },
            'demon_horn':   { name: "æƒ¡é­”ä¹‹è§’", cost: 600, desc: "ææ–™" },
            'dark_essence': { name: "æš—ä¹‹ç²¾è¯", cost: 800, desc: "ææ–™" },
            'adamantite':   { name: "ç²¾é‡‘", cost: 2000, desc: "ææ–™" },
            'god_blood':    { name: "ç¥ä¹‹è¡€", cost: 3000, desc: "ææ–™" },
            'chaos_orb':    { name: "æ··æ²Œå¯¶ç ", cost: 5000, desc: "ææ–™" },
            'angel_feather':{ name: "å¤©ä½¿ä¹‹ç¾½", cost: 4000, desc: "ææ–™" },
            'dragon_scale': { name: "é¾é±—", cost: 300, desc: "ææ–™" },
            'leather':      { name: "çš®é©", cost: 15, desc: "ææ–™" },
            'magic_dust':   { name: "é­”ç²‰", cost: 30, desc: "ææ–™" }
        };

        // ğŸŸ¢ çµ±ä¸€ä½¿ç”¨ currentItemId
        let currentItemId = null;

        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
        });

        socket.on('playerStatsUpdate', (p) => {
            document.getElementById('my-gold').innerText = p.gold;
            renderBag(p.inventory);
        });

        socket.on('bagResult', (res) => { 
            if(res.success) showMsg(res.msg); 
            else showMsg("âŒ " + res.msg);
            closeAllModals();
        });
        
        socket.on('marketResult', (res) => { 
            if(res.success) showMsg(res.msg); 
            else showMsg("âŒ " + res.msg);
            closeAllModals();
        });

        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        function renderBag(inv) {
            const list = document.getElementById('bag-list');
            list.innerHTML = '';
            
            let keys = Object.keys(inv);
            if (keys.length === 0) {
                list.innerHTML = '<div style="margin-top:20px; font-size:12px; color:#aaa;">èƒŒåŒ…æ˜¯ç©ºçš„</div>';
                return;
            }

            keys.forEach(key => {
                if (inv[key] > 0) {
                    const item = ITEM_DB[key] || { name: key, cost: 10, desc: "æœªçŸ¥ç‰©å“" };
                    let npcPrice = Math.floor((item.cost || 10) * 0.2);
                    if(npcPrice < 1) npcPrice = 1;

                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.innerHTML = `
                        <div class="item-header">
                            <span class="item-name">${item.name}</span>
                            <span class="item-count">x${inv[key]}</span>
                        </div>
                        <div class="item-desc">${item.desc}</div>
                        
                        <div class="action-btns">
                            <button class="btn btn-npc" onclick="openNPCModal('${key}', '${item.name}', ${npcPrice})">
                                è³£åº— (${npcPrice}G)
                            </button>
                            <button class="btn btn-market" onclick="openMarketModal('${key}', '${item.name}')">
                                ä¸Šæ¶å¸‚é›†
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });
        }

        function openNPCModal(id, name, price) {
            currentItemId = id;
            const msg = `ç¢ºå®šè¦å°‡ã€${name}ã€‘è³£çµ¦å•†äººå—ï¼Ÿ<br><br>å›æ”¶åƒ¹: <span style="color:#f1c40f; font-weight:bold;">${price} G</span>`;
            document.getElementById('npc-msg').innerHTML = msg;
            document.getElementById('npc-modal').style.display = 'flex';
        }

        function confirmNPCSell() { socket.emit('npcSell', currentItemId); }

        function openMarketModal(id, name) {
            currentItemId = id; // ğŸŸ¢ ä¿®æ­£é€™è£¡ï¼šä½¿ç”¨çµ±ä¸€è®Šæ•¸
            document.getElementById('market-title').innerText = `ä¸Šæ¶: ${name}`;
            document.getElementById('sell-price').value = '';
            document.getElementById('market-modal').style.display = 'flex';
        }

        function confirmMarketSell() {
            const price = document.getElementById('sell-price').value;
            if (!price || price <= 0) { showMsg("è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼"); return; }
            // ğŸŸ¢ ä¿®æ­£é€™è£¡ï¼šç™¼é€æ™‚ä½¿ç”¨ currentItemId
            socket.emit('marketSell', { itemId: currentItemId, price: price });
        }

        function closeAllModals() {
            document.getElementById('market-modal').style.display = 'none';
            document.getElementById('npc-modal').style.display = 'none';
        }
    </script>
</body>
</html>
