<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„èƒŒåŒ…</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 15px; 
            display:flex; flex-direction:column; align-items:center; 
            height: 100dvh; margin:0; box-sizing:border-box;
            overscroll-behavior: none;
        }
        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 20px; margin: 0; }
        
        /* åˆ†é¡æŒ‰éˆ•åˆ— */
        .category-bar, .category-bar-2 {
            width: 100%; max-width: 600px;
            display: grid; gap: 5px; 
            margin-bottom: 5px;
        }
        .category-bar { grid-template-columns: repeat(4, 1fr); } 
        .category-bar-2 { grid-template-columns: repeat(3, 1fr); margin-bottom: 15px; } 

        .cat-btn {
            background: #34495e; color: #bdc3c7; border: 2px solid #7f8c8d;
            padding: 8px 0; font-family: inherit; font-size: 10px; cursor: pointer;
            border-radius: 6px; outline: none; white-space: nowrap;
        }
        .cat-btn.active { 
            background: #e67e22; color: #fff; border-color: #fff; font-weight: bold;
        }

        .container { 
            display: flex; flex: 1; width: 100%; max-width: 600px; 
            flex-direction: column; overflow: hidden; margin-bottom: 15px; 
        }
        .bag-list { 
            flex: 1; background: #34495e; border: 3px solid #bdc3c7; 
            overflow-y: auto; padding: 10px; border-radius: 8px; 
        }
        .item-card { 
            background: #ecf0f1; color: #2c3e50; 
            padding: 15px; margin-bottom: 10px; 
            border-radius: 8px; text-align: left; 
            border-bottom: 4px solid #95a5a6;
        }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .item-name { font-size: 14px; font-weight: bold; color: #2980b9; }
        .item-count { font-size: 14px; background: #2c3e50; color: #fff; padding: 2px 6px; border-radius: 4px; }
        .item-desc { font-size: 10px; color: #7f8c8d; margin-bottom: 10px; }

        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .btn { 
            padding: 10px; font-family: inherit; font-size: 10px; cursor: pointer; flex: 1;
            border: 2px solid rgba(0,0,0,0.2); color: white; border-radius: 6px; font-weight: bold;
        }
        .btn:active { transform: translateY(2px); filter: brightness(0.9); }
        .btn-npc { background: #e74c3c; } 
        .btn-market { background: #3498db; }
        .btn-dismantle { background: #8e44ad; } 
        .btn-use { background: #27ae60; } 

        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
        }

        /* === å½ˆçª—æ¨£å¼ === */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; 
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { 
            background: #fff; color: #000; 
            padding: 25px; border: 6px solid #f1c40f; 
            width: 80%; max-width: 300px; border-radius: 12px; text-align: center;
        }
        
        /* ğŸŸ¢ è¼¸å…¥æ¡†æ¨£å¼å„ªåŒ– */
        .input-group { margin: 15px 0; }
        .input-label { display: block; font-size: 10px; color: #555; margin-bottom: 5px; text-align: left;}
        input { 
            width: 100%; padding: 12px; margin-bottom: 5px;
            font-family: inherit; font-size: 14px; 
            box-sizing: border-box; border: 2px solid #ccc; text-align: center;
        }

        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f;
            color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999;
            font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-toast"></div>

    <div class="header">
        <h1>ğŸ’ èƒŒåŒ…</h1>
        <div class="gold-display">ğŸ’° <span id="my-gold">0</span> G</div>
    </div>

    <div class="category-bar">
        <button class="cat-btn active" onclick="setFilter('all')">å…¨éƒ¨</button>
        <button class="cat-btn" onclick="setFilter('consumable')">æ¶ˆè€—å“</button>
        <button class="cat-btn" onclick="setFilter('food')">æ–™ç†</button>
        <button class="cat-btn" onclick="setFilter('material')">ææ–™</button>
    </div>
    <div class="category-bar-2">
        <button class="cat-btn" onclick="setFilter('weapon')">æ­¦å™¨</button>
        <button class="cat-btn" onclick="setFilter('armor')">é˜²å…·</button>
        <button class="cat-btn" onclick="setFilter('accessory')">é£¾å“</button>
    </div>

    <div class="container">
        <div class="bag-list" id="bag-list">
            <div style="font-size:12px; color:#aaa; margin-top:20px;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>

    <div id="market-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="market-title" style="font-size:16px; margin-bottom:10px;">ä¸Šæ¶ç‰©å“</h3>
            
            <div class="input-group">
                <span class="input-label">å–®åƒ¹ (G)</span>
                <input type="number" id="sell-price" placeholder="è¼¸å…¥å–®åƒ¹" max="999999">
            </div>

            <div class="input-group">
                <span class="input-label">æ•¸é‡ (Max: 30)</span>
                <input type="number" id="sell-amount" value="1" min="1" max="30">
                <div style="font-size: 9px; color: #888; text-align: right;">æ“æœ‰: <span id="owned-count">0</span></div>
            </div>

            <button class="btn btn-market" style="width:100%; margin-bottom:10px;" onclick="confirmMarketSell()">ç¢ºèªä¸Šæ¶</button>
            <button class="btn" style="background:#555; width:100%;" onclick="closeAllModals()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="npc-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:10px; color:#e74c3c;">è³£çµ¦å•†äºº</h3>
            <div id="npc-msg" style="font-size:12px; color:#555; margin-bottom:20px; line-height:1.6;">...</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="background:#e74c3c;" onclick="confirmNPCSell()">ç¢ºå®š</button>
                <button class="btn" style="background:#7f8c8d;" onclick="closeAllModals()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myInventory = {};
        let currentFilter = 'all'; 
        let currentItemId = null;

        const PROHIBITED_ITEMS = [
            'lucky_bag',
            'genesis_weapon', 'genesis_armor', 'void_reaper_dark', 'ring_galaxy', 
            'void_blade', 'void_armor', 
            'galaxy_saber', 'nebula_plate', 
            'dimension_ring',
            'entropy_sword', 'entropy_god_armor'
        ];

        const NPC_SHOP_ALLOW_LIST = [
            'potion_hp', 'potion_mid', 'potion_high', 'potion_max', 'elixir',
            'potion_mp', 'potion_mp_mid', 'potion_mp_high',
            'grilled_carp', 'salmon_sushi', 'tuna_steak', 'eel_rice', 'void_soup', 'sushi_plate',
            'wood_sword', 'copper_dagger', 'iron_sword', 'silver_blade',
            'oak_bow', 'maple_staff',
            'cloth_armor', 'leather_armor', 'chain_mail', 'iron_armor',
            'ring_str', 'bracelet_def', 'necklace_hp', 'necklace_mp'
        ];

        const ITEM_DB = {
            'lucky_bag': { name: "ğŸ§§ å¥‡è¹Ÿç¦è¢‹(ç¯€æ—¥é™å®š)", cost: 1000000000, desc: "éš¨æ©Ÿç²å¾—å·¨é‡ç¨€æœ‰ææ–™ï¼" },
            'potion_hp': { name: "å°ç´…è—¥æ°´", cost: 50, desc: "æ¢å¾© 50 HP" },
            'potion_mid': { name: "ä¸­ç´…è—¥æ°´", cost: 200, desc: "æ¢å¾© 500 HP" },
            'potion_high': { name: "å¤§ç´…è—¥æ°´", cost: 600, desc: "æ¢å¾© 2000 HP" }, 
            'potion_max': { name: "ç‰¹ç´šç§˜è—¥", cost: 5000, desc: "æ¢å¾© 10000 HP" },
            'elixir': { name: "ç¥ä¹‹ç”˜éœ²", cost: 20000, desc: "æ¢å¾© 50000 HP" },
            'potion_mp': { name: "å°è—è—¥æ°´", cost: 80, desc: "æ¢å¾© 30 MP" },
            'potion_mp_mid': { name: "ä¸­è—è—¥æ°´", cost: 200, desc: "æ¢å¾© 100 MP" }, 
            'potion_mp_high': { name: "å¤§è—è—¥æ°´", cost: 600, desc: "æ¢å¾© 500 MP" }, 
            'sushi_plate': { name: "å£½å¸æ‹¼ç›¤", cost: 500, desc: "é£Ÿç”¨: HP+500" },
            'grilled_carp': { name: "çƒ¤é¯‰é­š", cost: 30, desc: "HP+100" },
            'salmon_sushi': { name: "é®­é­šå£½å¸", cost: 50, desc: "MP+50" },
            'tuna_steak': { name: "ç…é®ªé­šæ’", cost: 200, desc: "HP+500" },
            'eel_rice': { name: "é°»é­šé£¯", cost: 300, desc: "HP+300, MP+100" },
            'void_soup': { name: "è™›ç©ºæµ·é®®æ¹¯", cost: 1000, desc: "ç‹€æ…‹å…¨æ»¿" },
            'wood_sword': { name: "æœ¨åŠ", cost: 100, desc: "ATK+10" },
            'copper_dagger': { name: "éŠ…åŒ•é¦–", cost: 400, desc: "ATK+20" }, 
            'iron_sword': { name: "éµåŠ", cost: 1500, desc: "ATK+60" }, 
            'silver_blade': { name: "éŠ€åˆƒ", cost: 4000, desc: "ATK+150" }, 
            'oak_bow': { name: "æ©¡æœ¨å¼“", cost: 200, desc: "ATK+25" },
            'maple_staff': { name: "æ¥“æœ¨æ³•æ–", cost: 500, desc: "ATK+50" },
            'spike_club': { name: "ç‹¼ç‰™æ£’", cost: 0, desc: "ATK+55 HP+80" }, 
            'poison_dag': { name: "åŠ‡æ¯’åŒ•é¦–", cost: 0, desc: "ATK+80" }, 
            'shark_tooth': { name: "é¯Šé­šç‰™åŒ•é¦–", cost: 800, desc: "ATK+80" },
            'flame_staff': { name: "ç«ç„°æ³•æ–", cost: 0, desc: "ATK+300 MP+100" }, 
            'emerald_staff': { name: "ç¿¡ç¿ æ³•æ–", cost: 5000, desc: "ATK+300" },
            'gold_axe': { name: "é»ƒé‡‘å·¨æ–§", cost: 10000, desc: "ATK+500" },
            'obsidian_blade': { name: "é»‘æ›œçŸ³ä¹‹åŠ", cost: 8000, desc: "ATK+600" },
            'frost_bow': { name: "å¯’å†°å¼“", cost: 0, desc: "ATK+1300" }, 
            'dragon_spear': { name: "é¾éª¨é•·æ§", cost: 15000, desc: "ATK+1200" },
            'mithril_saber': { name: "ç§˜éŠ€è»åˆ€", cost: 50000, desc: "ATK+2000" },
            'void_reaper': { name: "è™›ç©ºæ”¶å‰²è€…", cost: 0, desc: "ATK+3500" },
            'void_reaper_dark': { name: "é—‡Â·è™›ç©ºæ”¶å‰²è€…", cost: 0, desc: "ATK+5500" }, 
            'god_slayer': { name: "å¼’ç¥åŠ", cost: 0, desc: "ATK+20000 HP+4000" }, 
            'chaos_staff': { name: "æ··æ²Œæ³•æ–", cost: 0, desc: "ATK+25000 MP+300" }, 
            'hero_sword': { name: "å‹‡è€…ä¹‹åŠ", cost: 0, desc: "ATK+100" },
            'steel_blade': { name: "ç²¾é‹¼åŠ", cost: 0, desc: "ATK+25" },
            'assassin_dag': { name: "åˆºå®¢çŸ­åˆ€", cost: 0, desc: "ATK+120" },
            'genesis_weapon': { name: "å‰µä¸–Â·çµ‚ç„‰ä¹‹åŠ", cost: 0, desc: "ATK+50000 HP+20000" }, 
            'void_blade': { name: "è™›ç©ºä¹‹åˆƒ", cost: 0, desc: "ATK+75000 HP+80000" }, 
            'galaxy_saber': { name: "éŠ€æ²³å…‰åŠ", cost: 0, desc: "ATK+110000 HP+150000" }, 
            'entropy_sword': { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹åŠ", cost: 0, desc: "ATK+200000 HP+300000" },
            'cloth_armor': { name: "å¸ƒè¡£", cost: 100, desc: "DEF+5" },
            'hunt_vest': { name: "çµäººèƒŒå¿ƒ", cost: 0, desc: "DEF+8 HP+80" },
            'leather_armor': { name: "çš®ç”²", cost: 400, desc: "DEF+15" }, 
            'plate_mail': { name: "æ¿é‡‘ç”²", cost: 0, desc: "DEF+15" },
            'dragon_mail': { name: "é¾é±—ç”²", cost: 0, desc: "DEF+30" },
            'chain_mail': { name: "é–å­ç”²", cost: 1500, desc: "DEF+40" }, 
            'iron_armor': { name: "éµç›”ç”²", cost: 4000, desc: "DEF+100" }, 
            'magma_plate': { name: "ç†”å²©èƒ¸ç”²", cost: 0, desc: "DEF+150 HP+1500" }, 
            'ice_robe': { name: "å†°éœœæ³•è¢", cost: 0, desc: "DEF+200 MP+500" }, 
            'yeti_cloak': { name: "é›ªæ€ªæ–—ç¯·", cost: 0, desc: "DEF+350 HP+4000" }, 
            'demon_armor': { name: "æƒ¡é­”æˆ°ç”²", cost: 0, desc: "DEF+1000 HP+12000" }, 
            'angel_armor': { name: "ç†¾å¤©ä½¿é§ç”²", cost: 0, desc: "DEF+5000 HP+50000" },
            'genesis_armor': { name: "å‰µä¸–Â·ç¥ä¹‹åº‡è­·", cost: 0, desc: "DEF+20000 HP+150000" }, 
            'void_armor': { name: "è™›ç©ºæˆ°ç”²", cost: 0, desc: "DEF+45000 HP+300000" }, 
            'nebula_plate': { name: "æ˜Ÿé›²æ¿ç”²", cost: 0, desc: "DEF+70000 HP+600000" }, 
            'entropy_god_armor': { name: "çµ‚ç„‰Â·ç¥ä¹‹åº‡è­·", cost: 0, desc: "DEF+120000 HP+1500000" },
            'bone_ring': { name: "éª¨æˆ’", cost: 0, desc: "ATK+10 MP+20" }, 
            'ring_str': { name: "åŠ›é‡æˆ’æŒ‡", cost: 3000, desc: "ATK+30" },
            'bracelet_def': { name: "å …æ¯…æ‰‹ç’°", cost: 3000, desc: "DEF+30" }, 
            'necklace_hp': { name: "ç´…æ°´æ™¶é …éŠ", cost: 5000, desc: "HP+250" }, 
            'necklace_mp': { name: "è—æ°´æ™¶é …éŠ", cost: 5000, desc: "MP+60" }, 
            'snake_boots': { name: "è›‡çš®é•·é´", cost: 0, desc: "DEF+20 HP+200" }, 
            'fish_ring': { name: "é­šé±—æˆ’æŒ‡", cost: 400, desc: "DEF+50 HP+500" }, 
            'pearl_necklace': { name: "çç é …éŠ", cost: 2000, desc: "DEF+20 MP+150" }, 
            'amulet_soul': { name: "éˆé­‚è­·ç¬¦", cost: 0, desc: "MP+300 HP+1000" },
            'ring_lord': { name: "é ˜ä¸»æŒ‡ç’°", cost: 0, desc: "å…¨èƒ½åŠ›+600" }, 
            'crown_chaos': { name: "æ··æ²Œä¹‹å† ", cost: 0, desc: "å…¨èƒ½åŠ›+2000" },
            'ring_galaxy': { name: "éŠ€æ²³æŒ‡ç’°", cost: 0, desc: "å…¨èƒ½åŠ›+5000" }, 
            'ring_life': { name: "ç”Ÿå‘½è­·ç¬¦", cost: 0, desc: "HP+100" },
            'ring_magic': { name: "é­”åŠ›è€³ç’°", cost: 0, desc: "MP+50" },
            'dimension_ring': { name: "ç¶­åº¦æŒ‡ç’°", cost: 0, desc: "å…¨èƒ½åŠ›+15000" },
            'copper_ore': { name: 'éŠ…ç¤¦çŸ³', cost: 10, desc: "åŸºç¤çš„é‡‘å±¬ç¤¦çŸ³" }, 
            'soft_fur': { name: 'æŸ”è»Ÿçš®æ¯›', cost: 10, desc: "è§¸æ„Ÿèˆ’é©çš„æ¯›çš®" },
            'beast_fang': { name: 'é‡ç¸å°–ç‰™', cost: 15, desc: "éŠ³åˆ©çš„ç‰™é½’" }, 
            'slime_gel': { name: 'é»æ¶²', cost: 5, desc: "é»ç³Šç³Šçš„æ¶²é«”" },
            'iron_ore': { name: 'éµç¤¦çŸ³', cost: 20, desc: "å …ç¡¬çš„éµç¤¦" }, 
            'leather': { name: 'çš®é©', cost: 15, desc: "åŠ å·¥éçš„ç¸çš®" },
            'tough_hide': { name: 'ç¡¬çš®é©', cost: 25, desc: "å …éŸŒçš„çš®é©" }, 
            'magic_dust': { name: 'é­”ç²‰', cost: 30, desc: "è˜Šå«å¾®å¼±é­”åŠ›" },
            'poison_sac': { name: 'æ¯’å›Š', cost: 30, desc: "å«æœ‰åŠ‡æ¯’" }, 
            'bone_shard': { name: 'ç¢éª¨ç‰‡', cost: 20, desc: "éŠ³åˆ©çš„éª¨é ­ç¢ç‰‡" },
            'silver_ore': { name: 'éŠ€ç¤¦çŸ³', cost: 50, desc: "é–ƒäº®çš„éŠ€ç¤¦" }, 
            'fire_core': { name: 'ç«ç„°æ ¸å¿ƒ', cost: 80, desc: "ç‡ƒç‡’è‘—çš„æ ¸å¿ƒ" },
            'lava_rock': { name: 'ç†”å²©çŸ³', cost: 60, desc: "æ»¾ç‡™çš„çŸ³é ­" }, 
            'dragon_scale': { name: 'é¾é±—', cost: 300, desc: "æ¥µå…¶å …ç¡¬çš„é±—ç‰‡" },
            'gold_ore': { name: 'é‡‘ç¤¦çŸ³', cost: 200, desc: "è²´é‡çš„é‡‘å±¬" }, 
            'ice_crystal': { name: 'æ°¸æ†å†°æ™¶', cost: 150, desc: "æ°¸é ä¸æœƒèåŒ–çš„å†°" },
            'yeti_fur': { name: 'é›ªæ€ªæ¯›çš®', cost: 180, desc: "éå¸¸ä¿æš–" }, 
            'spirit_dust': { name: 'éˆé­‚ç²‰æœ«', cost: 120, desc: "äº¡éˆçš„éºå¡µ" },
            'mithril': { name: 'ç§˜éŠ€', cost: 500, desc: "è¼•ç›ˆè€Œå …å›ºçš„é‡‘å±¬" }, 
            'void_dust': { name: 'è™›ç©ºä¹‹å¡µ', cost: 400, desc: "ä¾†è‡ªç•°ç•Œçš„å¡µåŸƒ" },
            'demon_horn': { name: 'æƒ¡é­”ä¹‹è§’', cost: 600, desc: "æ•£ç™¼è‘—é‚ªæ°£" }, 
            'dark_essence': { name: 'æš—ä¹‹ç²¾è¯', cost: 800, desc: "ç´”ç²¹çš„é»‘æš—èƒ½é‡" },
            'adamantite': { name: 'ç²¾é‡‘', cost: 2000, desc: "å‚³èªªä¸­çš„é‡‘å±¬" }, 
            'god_blood': { name: 'ç¥ä¹‹è¡€', cost: 3000, desc: "ç¥æ˜çš„è¡€æ¶²" },
            'chaos_orb': { name: 'æ··æ²Œå¯¶ç ', cost: 5000, desc: "æ··æ²Œèƒ½é‡çš„çµæ™¶" }, 
            'angel_feather': { name: 'å¤©ä½¿ä¹‹ç¾½', cost: 4000, desc: "æ½”ç™½ç„¡ç‘•çš„ç¾½æ¯›" },
            'titan_steel': { name: 'æ³°å¦ç¥é‹¼', cost: 8000, desc: "æ³°å¦é›é€ çš„ç¥éµ" }, 
            'star_fragment': { name: 'æ˜Ÿä¹‹ç¢ç‰‡', cost: 10000, desc: "ä¾†è‡ªç¾¤æ˜Ÿçš„ç¢ç‰‡" },
            'void_shard': { name: 'è™›ç©ºç¢ç‰‡', cost: 15000, desc: "è™›ç„¡ç©ºé–“çš„æ®˜ç‰‡" },
            'dark_matter': { name: 'æš—ç‰©è³ª', cost: 20000, desc: "æ¥µåº¦æ²‰é‡çš„ç‰©è³ª" },
            'star_core': { name: 'æ†æ˜Ÿæ ¸å¿ƒ', cost: 50000, desc: "ç‡ƒç‡’çš„æ†æ˜Ÿä¹‹å¿ƒ" },
            'cosmic_steel': { name: 'å®‡å®™é‹¼', cost: 80000, desc: "å®‡å®™ç´šåˆé‡‘" },
            'time_sand': { name: 'æ™‚å…‰ä¹‹æ²™', cost: 150000, desc: "æ™‚é–“çš„æ²™ç¤«" },
            'dimension_gem': { name: 'ç¶­åº¦å¯¶çŸ³', cost: 300000, desc: "æŠ˜å°„ç©ºé–“çš„å¯¶çŸ³" },
            'entropy_origin': { name: 'ç†±å¯‚åŸé»', cost: 999999, desc: "å®‡å®™çµ‚çµçš„è±¡å¾µ" },
            'oak_log': { name: "æ©¡æœ¨åŸæœ¨", cost: 5, desc: "æ™®é€šçš„æœ¨æ" }, 
            'maple_log': { name: "æ¥“æœ¨åŸæœ¨", cost: 15, desc: "è³ªåœ°ä¸éŒ¯çš„æœ¨æ" },
            'yew_log': { name: "ç´«æ‰åŸæœ¨", cost: 30, desc: "è£½ä½œå¼“çš„å¥½ææ–™" }, 
            'ancient_log': { name: "é å¤ç¥æœ¨", cost: 100, desc: "å……æ»¿éˆæ°£çš„æœ¨é ­" },
            'spirit_wood': { name: "éˆæœ¨", cost: 50, desc: "å¹½éˆé™„è‘—çš„æœ¨é ­" }, 
            'dragon_wood': { name: "é¾éª¨æœ¨", cost: 150, desc: "å¦‚é¾éª¨èˆ¬å …ç¡¬" },
            'void_wood': { name: "è™›ç©ºæœ¨", cost: 300, desc: "åå™¬å…‰ç·šçš„æœ¨é ­" }, 
            'chaos_wood': { name: "æ··æ²Œç¥æœ¨", cost: 1000, desc: "æ‰­æ›²çš„æœ¨æ" },
            'carp': { name: "é¯‰é­š", cost: 5, desc: "æ™®é€šçš„æ·¡æ°´é­š" }, 
            'salmon': { name: "é®­é­š", cost: 10, desc: "è‚‰è³ªé®®ç¾" },
            'koi': { name: "éŒ¦é¯‰", cost: 50, desc: "è§€è³ç”¨é­š" }, 
            'magic_fish': { name: "é­”åŠ›é­š", cost: 30, desc: "é–ƒçˆè‘—é­”åŠ›å…‰è¼" },
            'tuna': { name: "é»‘é®ªé­š", cost: 80, desc: "å·¨å¤§çš„æµ·é­š" }, 
            'shark': { name: "å¤§ç™½é¯Š", cost: 100, desc: "æµ·ä¸­çš„éœ¸ä¸»" },
            'lava_eel': { name: "ç†”å²©é°»", cost: 120, desc: "ç”Ÿæ´»åœ¨å²©æ¼¿ä¸­" }, 
            'void_squid': { name: "è™›ç©ºçƒè³Š", cost: 200, desc: "ä¾†è‡ªæ·±æ·µçš„ç”Ÿç‰©" },
            'god_carp': { name: "ç¥ä¹‹é¯‰", cost: 500, desc: "å‚³èªªä¸­çš„é­š" }, 
            'pearl': { name: "çç ", cost: 500, desc: "åœ“æ½¤çš„å¯¶çŸ³" },
            'coal': { name: "ç…¤ç‚­", cost: 5, desc: "ç‡ƒæ–™" }, 
            'ruby': { name: "ç´…å¯¶çŸ³", cost: 200, desc: "ç´…è‰²çš„å¯¶çŸ³" }, 
            'diamond': { name: "é‘½çŸ³", cost: 500, desc: "å …ç¡¬çš„å¯¶çŸ³" }
        };

        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
        });

        socket.on('playerStatsUpdate', (p) => {
            document.getElementById('my-gold').innerText = p.gold;
            myInventory = p.inventory;
            renderBag(); 
        });

        socket.on('bagResult', (res) => { 
            if(res.success) showMsg(res.msg); 
            else showMsg("âŒ " + res.msg);
            closeAllModals();
        });
        
        socket.on('marketResult', (res) => { 
            if(res.success) showMsg(res.msg); 
            else showMsg("âŒ " + res.msg);
            closeAllModals();
        });

        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text;
            t.style.top = "30px"; 
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        // åˆ‡æ›åˆ†é¡å‡½æ•¸
        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderBag();
        }

        // æ¸²æŸ“èƒŒåŒ… (å«éæ¿¾é‚è¼¯)
        function renderBag() {
            const list = document.getElementById('bag-list');
            list.innerHTML = '';
            
            let keys = Object.keys(myInventory).filter(k => myInventory[k] > 0);
            
            if (currentFilter !== 'all') {
                keys = keys.filter(key => {
                    const id = key.toLowerCase();
                    
                    if (currentFilter === 'consumable') {
                        return id.includes('potion') || id.includes('elixir');
                    }
                    if (currentFilter === 'food') {
                        return id.includes('grilled') || id.includes('sushi') || id.includes('steak') || id.includes('rice') || id.includes('soup') || id.includes('plate');
                    }
                    if (currentFilter === 'weapon') {
                        return id.includes('sword') || id.includes('bow') || id.includes('staff') || id.includes('dagger') || id.includes('axe') || id.includes('spear') || id.includes('blade') || id.includes('saber') || id.includes('slayer') || id.includes('reaper') || id.includes('club') || id.includes('tooth') || id.includes('dag') || id.includes('weapon');
                    }
                    if (currentFilter === 'armor') {
                        return id.includes('armor') || id.includes('mail') || id.includes('vest') || id.includes('plate') || id.includes('robe') || id.includes('cloak');
                    }
                    if (currentFilter === 'accessory') {
                        return id.includes('ring') || id.includes('necklace') || id.includes('amulet') || id.includes('bracelet') || id.includes('boots') || id.includes('crown');
                    }
                    if (currentFilter === 'material') {
                        // æ’é™¤æ‰€æœ‰è£å‚™å’Œæ¶ˆè€—å“ï¼Œå‰©ä¸‹çš„å°±æ˜¯ææ–™
                        return !id.includes('potion') && !id.includes('elixir') && 
                               !id.includes('grilled') && !id.includes('sushi') && !id.includes('steak') && 
                               !id.includes('rice') && !id.includes('soup') && !id.includes('plate') &&
                               !id.includes('sword') && !id.includes('bow') && !id.includes('staff') && 
                               !id.includes('dagger') && !id.includes('axe') && !id.includes('spear') && 
                               !id.includes('blade') && !id.includes('saber') && !id.includes('slayer') && 
                               !id.includes('reaper') && !id.includes('club') && !id.includes('tooth') && !id.includes('dag') && !id.includes('weapon') &&
                               !id.includes('armor') && !id.includes('mail') && !id.includes('vest') && !id.includes('robe') && !id.includes('cloak') && 
                               !id.includes('ring') && !id.includes('necklace') && !id.includes('amulet') && !id.includes('bracelet') && !id.includes('boots') && !id.includes('crown') &&
                               !id.includes('plate') && 
                               true; 
                    }
                    return true;
                });
            }

            if (keys.length === 0) {
                list.innerHTML = '<div style="margin-top:20px; font-size:12px; color:#aaa;">æ­¤åˆ†é¡æ²’æœ‰ç‰©å“</div>';
                return;
            }

            keys.forEach(key => {
                const item = ITEM_DB[key] || { name: key, cost: 10, desc: "æœªçŸ¥ç‰©å“" };
                let npcPrice = Math.floor((item.cost || 10) * 0.2);
                if(npcPrice < 1) npcPrice = 1;

                // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºåˆ†è§£
                let showDismantle = false;
                const kid = key.toLowerCase();
                const isEquipment = kid.includes('sword') || kid.includes('bow') || kid.includes('staff') || kid.includes('dagger') || kid.includes('axe') || kid.includes('blade') || kid.includes('saber') || kid.includes('slayer') || kid.includes('reaper') || kid.includes('armor') || kid.includes('mail') || kid.includes('plate') || kid.includes('robe') || kid.includes('cloak') || kid.includes('ring') || kid.includes('necklace') || kid.includes('amulet') || kid.includes('crown') || kid.includes('weapon');
                const isShopItem = NPC_SHOP_ALLOW_LIST.includes(key);
                if (isEquipment && !isShopItem) {
                    showDismantle = true;
                }

                // ğŸŸ¢ [ä¿®æ”¹] åªæœ‰ç¦è¢‹é¡¯ç¤ºã€Œä½¿ç”¨ã€æŒ‰éˆ•
                let useBtn = '';
                if (key === 'lucky_bag') { 
                    useBtn = `<button class="btn btn-use" onclick="useItem('${key}')">ä½¿ç”¨</button>`;
                }

                // ğŸŸ¢ [æ˜¯å¦é¡¯ç¤ºè³£åº—èˆ‡ä¸Šæ¶æŒ‰éˆ•] (ç¦è¢‹èˆ‡ç¥è£çš†ä¸å¯è³£)
                let sellBtns = '';
                if (!PROHIBITED_ITEMS.includes(key)) {
                    // å‚³å…¥æ“æœ‰çš„æ•¸é‡ (myInventory[key]) çµ¦ openMarketModal
                    sellBtns = `
                        <button class="btn btn-npc" onclick="openNPCModal('${key}', '${item.name}', ${npcPrice})">
                            è³£åº— (${npcPrice}G)
                        </button>
                        <button class="btn btn-market" onclick="openMarketModal('${key}', '${item.name}', ${myInventory[key]})">
                            ä¸Šæ¶å¸‚é›†
                        </button>
                    `;
                }

                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `
                    <div class="item-header">
                        <span class="item-name">${item.name}</span>
                        <span class="item-count">x${myInventory[key]}</span>
                    </div>
                    <div class="item-desc">${item.desc}</div>
                    
                    <div class="action-btns">
                        ${useBtn}
                        ${sellBtns}
                        ${showDismantle ? `<button class="btn btn-dismantle" onclick="confirmDismantle('${key}', '${item.name}')">åˆ†è§£</button>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function useItem(id) {
            if(confirm("ç¢ºå®šè¦ä½¿ç”¨é€™å€‹ç‰©å“å—ï¼Ÿ")) {
                socket.emit('useItem', id);
            }
        }

        function confirmDismantle(id, name) {
            if (confirm(`âš ï¸ ç¢ºå®šè¦åˆ†è§£ã€${name}ã€‘å—ï¼Ÿ\n\n1. è£å‚™å°‡æœƒæ¶ˆå¤±ã€‚\n2. åƒ…é€€é‚„ 50% è£½ä½œææ–™ã€‚`)) {
                socket.emit('dismantleItem', id);
            }
        }

        function openNPCModal(id, name, price) {
            currentItemId = id;
            const msg = `ç¢ºå®šè¦å°‡ã€${name}ã€‘è³£çµ¦å•†äººå—ï¼Ÿ<br><br>å›æ”¶åƒ¹: <span style="color:#f1c40f; font-weight:bold;">${price} G</span>`;
            document.getElementById('npc-msg').innerHTML = msg;
            document.getElementById('npc-modal').style.display = 'flex';
        }

        function confirmNPCSell() { socket.emit('npcSell', currentItemId); }

        // ğŸŸ¢ æ‰¹é‡ä¸Šæ¶ï¼šæ¥æ”¶ count åƒæ•¸ä¸¦è¨­ç½® input å±¬æ€§
        function openMarketModal(id, name, count) {
            currentItemId = id; 
            document.getElementById('market-title').innerText = `ä¸Šæ¶: ${name}`;
            document.getElementById('sell-price').value = '';
            
            const amountInput = document.getElementById('sell-amount');
            amountInput.value = 1; 
            amountInput.max = Math.min(30, count); // ä¸Šé™ç‚º 30 æˆ– æ“æœ‰æ•¸é‡
            document.getElementById('owned-count').innerText = count;

            document.getElementById('market-modal').style.display = 'flex';
        }

        function confirmMarketSell() {
            const priceVal = document.getElementById('sell-price').value;
            const amountVal = document.getElementById('sell-amount').value;
            
            const price = parseInt(priceVal);
            const amount = parseInt(amountVal);

            if (!price || price <= 0) { 
                showMsg("âŒ è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼"); 
                return; 
            }
            if (price > 999999999) { 
                showMsg("âš ï¸ åƒ¹æ ¼ä¸èƒ½è¶…é 9.9å„„ G"); 
                return; 
            }
            
            if (!amount || amount < 1 || amount > 30) {
                showMsg("âŒ æ•¸é‡å¿…é ˆåœ¨ 1 ~ 30 ä¹‹é–“");
                return;
            }

            // ğŸŸ¢ ç™¼é€æ•¸é‡çµ¦ä¼ºæœå™¨
            socket.emit('marketSell', { itemId: currentItemId, price: price, amount: amount });
        }

        function closeAllModals() {
            document.getElementById('market-modal').style.display = 'none';
            document.getElementById('npc-modal').style.display = 'none';
        }
    </script>
</body>
</html>
