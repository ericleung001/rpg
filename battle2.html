<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ°é¬¥ä¸­_new2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #111; font-family: 'Press Start 2P', monospace; 
            height: 100dvh; margin: 0; overflow: hidden; 
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; 
            padding: 10px; box-sizing: border-box; overscroll-behavior: none;
        }
        #game-container { 
            width: 100%; max-width: 640px; height: 100%; 
            background: linear-gradient(135deg, #a8c0b0 50%, #789080 50%); 
            border: 4px solid #2c3e50; 
            display: grid; grid-template-rows: 40px 1.5fr 1fr 1.8fr; /* èª¿æ•´é«˜åº¦æ¯”ä¾‹ */
            position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 8px;
        }
        
        /* ğŸŸ¢ CT è¡Œå‹•æ¢ */
        #turn-bar { 
            background: #2c3e50; color: #fff; display: flex; align-items: center; 
            overflow-x: auto; white-space: nowrap; border-bottom: 4px solid #000; 
            padding: 0 5px; scrollbar-width: none; 
        }
        .turn-icon {
            width: 30px; height: 30px; border-radius: 50%; margin-right: 5px;
            border: 2px solid #555; display: inline-flex; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold; background: #fff; color: #000; flex-shrink: 0;
            transition: all 0.3s; opacity: 0.6; transform: scale(0.8);
        }
        .turn-icon.active {
            border-color: #f1c40f; opacity: 1; transform: scale(1.1); box-shadow: 0 0 10px #f1c40f; z-index: 10;
        }
        .turn-icon.player { background: #3498db; color: white; }
        .turn-icon.monster { background: #e74c3c; color: white; }
        
        /* ğŸŸ¢ å¤šæ€ªç‰©å€åŸŸ */
        .boss-area { 
            display: flex; justify-content: center; align-items: flex-end; position: relative; padding: 10px; gap: 10px;
        }
        .mob-container {
            display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.2s; position: relative;
        }
        .mob-container:active { transform: scale(0.95); }
        .mob-container.selected { filter: drop-shadow(0 0 5px #f1c40f); transform: scale(1.05); }
        .mob-container.dead { opacity: 0.3; filter: grayscale(100%); pointer-events: none; }
        
        .boss-sprite { 
            width: 60px; height: 60px; object-fit: contain; margin-bottom: 5px; 
            image-rendering: pixelated; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }
        .mob-hp-bar { width: 50px; height: 6px; background: #555; border: 1px solid #000; margin-top: 2px; }
        .mob-hp-fill { height: 100%; background: #e74c3c; transition: width 0.3s; }
        .mob-name { font-size: 8px; color: #fff; text-shadow: 1px 1px 0 #000; margin-bottom: 2px; }
        
        /* å‚·å®³é£„å­— */
        .dmg-text {
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
            color: #ffeb3b; font-size: 14px; font-weight: bold; text-shadow: 2px 2px 0 #000;
            animation: floatUp 1s ease-out forwards; pointer-events: none;
        }
        @keyframes floatUp { 0% { top: -20px; opacity: 1; } 100% { top: -50px; opacity: 0; } }

        .player-area { display: flex; flex-direction: column; justify-content: center; padding: 0 10px; width: 100%; box-sizing: border-box; gap: 4px; }
        .my-status { width: 100%; box-sizing: border-box; padding: 5px; } 
        .teammates { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 2px;} 
        
        .gba-box { background: #f0f0d8; border: 4px solid #706870; border-radius: 8px; padding: 5px; color: #383838; font-size: 10px; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); }
        .mini-box { background: #ecf0f1; border: 2px solid #95a5a6; padding: 3px; font-size: 9px; color: #333; overflow: hidden; border-radius: 4px; }
        
        .hp-bar { width: 100%; height: 8px; background: #555; border: 2px solid #333; margin-top: 3px; border-radius: 2px; }
        .hp-fill { height: 100%; background: #48c058; transition: width 0.3s; }
        .mp-bar { width: 100%; height: 5px; background: #555; border: 2px solid #333; margin-top: 2px; border-radius: 2px; }
        .mp-fill { height: 100%; background: #3498db; transition: width 0.3s; }

        .mini-hp-bar { width: 100%; height: 4px; background: #555; margin-top: 2px; }
        .mini-hp-fill { height: 100%; background: #e74c3c; width: 100%; }
        .mini-mp-bar { width: 100%; height: 3px; background: #555; margin-top: 1px; }
        .mini-mp-fill { height: 100%; background: #3498db; width: 100%; }

        .stat-text { font-size: 9px; margin-top: 3px; font-weight: bold; }
        
        .hud { background: #305080; border-top: 4px solid #c8c8f8; display: flex; height: 100%; overflow: hidden; }
        .log { width: 40%; padding: 8px; color: white; font-size: 9px; line-height: 1.5; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-start; border-right: 2px solid rgba(255,255,255,0.1); }
        
        .menu { 
            width: 60%; display: flex; flex-direction: column; 
            background: #fff; border-left: 4px solid #c8c8f8; 
            padding: 5px; box-sizing: border-box; position: relative; 
        }
        
        /* å¿«æ·éµå€åŸŸ */
        #shortcut-area {
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px;
            margin-bottom: 5px; padding-bottom: 5px; border-bottom: 2px solid #ccc;
            flex-shrink: 0;
        }
        .btn-shortcut {
            background: #ecf0f1; border: 1px solid #bdc3c7; color: #2c3e50;
            font-size: 9px; padding: 8px 2px; cursor: pointer; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-family: inherit; font-weight: bold;
        }
        .btn-shortcut:active { background: #bdc3c7; transform: translateY(1px); }
        .btn-shortcut:disabled { opacity: 0.5; cursor: not-allowed; background: #95a5a6; }

        .fixed-top-area {
            flex-shrink: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 5px;
            display: none; 
        }

        .scroll-area { 
            flex: 1; overflow-y: auto; 
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; 
            align-content: start; padding-bottom: 5px;
        }

        .btn { 
            background: #f8f8f8; border: 2px solid #888; cursor: pointer; font-family: inherit; font-size: 11px; font-weight: bold; 
            text-align: center; display:flex; align-items:center; justify-content:center; border-radius: 6px; min-height: 42px;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        .btn:active { background: #f8d030; color: #000; transform: scale(0.98); }
        .btn:disabled { background: #999; color: #555; cursor: not-allowed; opacity: 0.6; }
        
        #lobby-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .player-list { border: 4px solid #fff; padding: 20px; width: 80%; min-height: 100px; text-align: left; margin-bottom: 30px; font-size: 14px; line-height: 2; overflow-y: auto; }
        
        .start-btn { display: none; padding: 15px 30px; font-size: 16px; background: #e74c3c; color: white; border: 4px solid #c0392b; cursor: pointer; font-family: inherit; }
        .start-btn:disabled { background: #7f8c8d; border-color: #555; cursor: wait; }
        
        #chat-container { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.95); border-top: 4px solid #bdc3c7; display: flex; flex-direction: column; font-size: 12px; z-index: 100; padding-bottom: env(safe-area-inset-bottom); transition: height 0.3s ease-in-out; height: 35px; }
        #chat-header { height: 35px; background: #34495e; color: #fff; line-height: 35px; cursor: pointer; font-weight: bold; border-bottom: 1px solid #555; display: flex; justify-content: center; align-items: center; touch-action: manipulation; }
        .chat-open { height: 30vh !important; }
        #chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-open #chat-body { display: flex; }
        #chat-history { flex: 1; overflow-y: auto; padding: 10px; text-align: left; color: white; }
        #chat-input-area { display: flex; border-top: 1px solid #555; height: 45px; }
        #chat-input { flex: 1; background: #222; color: white; border: none; padding: 0 15px; font-family: inherit; font-size: 14px; outline: none; }
        #chat-send { background: #2980b9; color: white; border: none; padding: 0 20px; cursor: pointer; font-family: inherit; font-size: 14px; font-weight: bold; touch-action: manipulation; }
        
        .shake { animation: shake 0.5s; } 
        @keyframes shake { 0%,100% {transform:translateX(0);} 25% {transform:translateX(-5px);} 75% {transform:translateX(5px);} }
        
        #game-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f; color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999; font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out; pointer-events: none; }

        #countdown-timer {
            position: absolute; top: 10px; right: 10px;
            color: #e74c3c; font-size: 10px; font-weight: bold;
            display: none;
            background: rgba(0,0,0,0.7); padding: 5px; border-radius: 4px;
        }

        /* é¸å–ç›®æ¨™æç¤º */
        #target-select-tip {
            position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px; border-radius: 5px;
            font-size: 12px; pointer-events: none; display: none; z-index: 20;
            border: 2px solid #f1c40f; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(1); } 50% { transform: translate(-50%, -50%) scale(1.1); } 100% { transform: translate(-50%, -50%) scale(1); } }
    </style>
</head>
<body>
    <div id="game-toast"></div>
    <div id="target-select-tip">ğŸ‘‰ è«‹é»æ“Šé¸æ“‡æ”»æ“Šç›®æ¨™ï¼</div>
    
    <div id="game-container">
        <div id="countdown-timer">âš ï¸ æ»…åœ˜å€’æ•¸: 09:00</div>

        <div id="lobby-overlay">
            <div style="color:#f1c40f; margin-bottom:20px; font-size:18px;">ç­‰å¾…éšŠå‹...</div>
            <div class="player-list" id="lobby-players">è®€å–ä¸­...</div>
            
            <div id="host-controls" style="margin-top: 20px;">
                <button class="start-btn" id="start-btn" onclick="requestStart()">æˆ¿ä¸»é–‹å§‹</button>
            </div>
            
            <div id="waiting-txt" style="margin-top:15px; font-size:12px; color:#aaa; display:none;">(ç­‰å¾…æˆ¿ä¸»...)</div>
            <button onclick="leaveRoom()" style="margin-top:20px; background:transparent; border:2px solid #aaa; color:#aaa; cursor:pointer; font-size:12px; padding:10px;">é›¢é–‹æˆ¿é–“</button>
        </div>
        
        <div id="turn-bar">
            </div>
        
        <div class="boss-area" id="mob-area">
            </div>
        
        <div class="player-area">
            <div class="gba-box my-status">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:3px;">
                    <span style="font-size:11px; font-weight:bold;"><span id="my-name">å‹‡è€…</span>(ä½ )</span>
                    <span style="font-size:9px; color:#f1c40f;">âš”ï¸<span id="atk-val">0</span> ğŸ›¡ï¸<span id="def-val">0</span></span>
                </div>
                <div class="hp-bar"><div id="php" class="hp-fill" style="width:100%"></div></div>
                <div class="mp-bar"><div id="pmp" class="mp-fill" style="width:100%"></div></div>
                <div style="font-size: 9px; margin-top: 3px; text-align:right;" id="hp-txt">...</div>
            </div>
            
            <div class="teammates" id="teammates-box"></div>
        </div>
        
        <div class="hud">
            <div class="log" id="log"><div>æº–å‚™æˆ°é¬¥...</div></div>
            <div class="menu" id="menu-container">
                
                <div id="shortcut-area"></div>

                <div id="fixed-top-area" class="fixed-top-area">
                    <button class="btn" style="width:100%; background:#ddd; color:#555;" onclick="resetButtons()">â—€ è¿”å›é¸å–®</button>
                </div>

                <div id="btns" class="scroll-area">
                    <button class="btn battle-action" onclick="act('attack')">æ”»æ“Š</button>
                    <button class="btn battle-action" onclick="openSkill()">é­”æ³•</button>
                    <button class="btn battle-action" onclick="openBag()">ç‰©å“</button>
                    <button class="btn" onclick="leaveRoom()">é€ƒè·‘</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="chat-container">
        <div id="chat-header" onclick="toggleChat()"> èŠå¤©å®¤ (é»æ“Šå±•é–‹)</div>
        <div id="chat-body">
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." maxlength="50">
                <button id="chat-send">ç™¼é€</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
            transports: ['websocket', 'polling'],
            secure: true 
        });

        let isMyTurn = false; 
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('room');
        let myPlayer = { mp: 0, hp: 0, maxMp: 100, maxHp: 100, skills: ['fireball'] };
        let battleTimer = null;
        let timeLeft = 540;
        
        // å¤šæ€ªç‰©ç›¸é—œ
        let currentMonsters = []; // å­˜æ€ªç‰©è³‡æ–™
        let selectedTargetId = null; // ç©å®¶é¸ä¸­çš„ç›®æ¨™
        let pendingAction = null; // ç­‰å¾…é¸ç›®æ¨™çš„è¡Œå‹• { type: 'attack'/'skill', skillId: ... }

        let myShortcuts = []; 
        try {
            const saved = localStorage.getItem('rpg_shortcuts');
            if (saved) { myShortcuts = JSON.parse(saved); }
        } catch(e) { console.error("è®€å–å¿«æ·éµå¤±æ•—", e); myShortcuts = []; }

        const SKILL_INFO = {
            'fireball':      { name: "ç«çƒè¡“", mp: 5, cat: 'atk', desc: "å‚·x1.5" },
            'thunder':       { name: "é›·æ“Š",   mp: 15, cat: 'atk', desc: "å‚·x1.2+æšˆ" },
            'poison_touch': { name: "åŠ‡æ¯’ä¹‹è§¸", mp: 25, cat: 'atk', desc: "å‚·x2.5" },
            'frost_nova':    { name: "å†°éœœæ–°æ˜Ÿ", mp: 30, cat: 'atk', desc: "å‚·x1.2+é™é˜²" },
            'meteor':        { name: "éš•çŸ³è¡“",   mp: 80, cat: 'atk', desc: "å‚·x3.5" },
            'divine_slash': { name: "æ¬¡å…ƒæ–¬",   mp: 150, cat: 'atk', desc: "å‚·x5.0" },
            'drain':         { name: "å¸è¡€",     mp: 20, cat: 'atk', desc: "å¸è¡€100%" },
            'void_crush':    { name: "è™›ç©ºç¢æ“Š", mp: 1000, cat: 'atk', desc: "å‚·x10" },
            'big_bang':      { name: "å®‡å®™å¤§çˆ†ç‚¸", mp: 5000, cat: 'atk', desc: "å‚·x25" },
            'entropy_decay':{ name: "ç†±å¯‚Â·è¡°è®Š", mp: 2500, cat: 'atk', desc: "5%çœŸå‚·" },
            'holy_shield':  { name: "è–å…‰å®ˆè­·", mp: 40, cat: 'buff', desc: "é˜²ç¦¦x2" },
            'berserk':       { name: "ç‹‚æš´",     mp: 60, cat: 'buff', desc: "æ”»x2(è‡ªæ®˜)" },
            'god_mode':      { name: "å¤©ç¥ä¸‹å‡¡", mp: 300, cat: 'buff', desc: "å…¨èƒ½x3" },
            'heal_light':    { name: "å°å›å¾©",   mp: 10, cat: 'heal', desc: "HP+20%" },
            'god_light':     { name: "ç¥ä¹‹å…‰",   mp: 50, cat: 'heal', desc: "HP+50%" },
            'heal_all':      { name: "è–å…‰æ™®ç…§", mp: 100, cat: 'heal', desc: "å…¨éšŠæ»¿HP" },
            'full_heal':     { name: "å¤§å¤©ä½¿æ¯", mp: 200, cat: 'heal', desc: "HPå…¨æ»¿" }
        };

        const ITEM_NAMES = {
            'potion_hp': 'ç´…æ°´(å°)', 'potion_mid': 'ç´…æ°´(ä¸­)', 'potion_high': 'ç´…æ°´(å¤§)', 'potion_max': 'ç§˜è—¥', 'elixir': 'ç”˜éœ²',
            'potion_mp': 'è—æ°´(å°)', 'potion_mp_mid': 'è—æ°´(ä¸­)', 'potion_mp_high': 'è—æ°´(å¤§)',
            'grilled_carp': 'çƒ¤é¯‰é­š', 'salmon_sushi': 'é®­é­šå£½å¸', 'tuna_steak': 'é®ªé­šæ’', 
            'eel_rice': 'é°»é­šé£¯', 'void_soup': 'è™›ç©ºæ¹¯', 'sushi_plate': 'å£½å¸æ‹¼ç›¤'
        };

        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) { window.location.href = 'index.html'; }
        if (!roomId && roomId !== 'world_boss') { 
            showMsg("ç„¡æ•ˆçš„æˆ¿é–“ï¼"); setTimeout(()=>window.location.href = 'hub.html', 1000); 
        }

        socket.on('connect', () => {
            socket.emit('joinGame', myToken); 
            setTimeout(() => {
                if (roomId === 'world_boss') {
                    socket.emit('connectToBossRoom');
                    // ... (Boss æˆ¿é–“é‚è¼¯æš«ç•¥ï¼Œç¶­æŒåŸæ¨£)
                } else {
                    socket.emit('connectToRoom', roomId);
                }
            }, 100);
        });

        // ğŸŸ¢ 1. æˆ°é¬¥é–‹å§‹ï¼šåˆå§‹åŒ–æ€ªç‰©èˆ‡æ™‚é–“è»¸
        socket.on('battleStart', (data) => { 
            document.getElementById('lobby-overlay').style.display = 'none'; 
            log("æˆ°é¬¥é–‹å§‹ï¼"); 
            startCountdown(); 

            // ç¹ªè£½æ€ªç‰©
            currentMonsters = data.monsters;
            renderMonsters(currentMonsters);
            
            // ç¹ªè£½æ™‚é–“è»¸
            renderTimeline(data.turnOrder, -1);
        });

        // ğŸŸ¢ 2. å›åˆåˆ‡æ›
        socket.on('turnChange', (data) => {
            renderTimeline(null, data.index); // æ›´æ–°æ™‚é–“è»¸é«˜äº®

            if (data.actorId === socket.id) {
                isMyTurn = true;
                log(`<span style="color:#2ecc71">ğŸ‘‰ è¼ªåˆ°ä½ äº†ï¼è«‹é¸æ“‡è¡Œå‹•</span>`);
                toggle(false); // è§£é–æŒ‰éˆ•
            } else {
                isMyTurn = false;
                toggle(true); // é–å®šæŒ‰éˆ•
            }
        });

        // ğŸŸ¢ 3. ç¹ªè£½æ€ªç‰©å‡½å¼
        function renderMonsters(mobs) {
            const area = document.getElementById('mob-area');
            area.innerHTML = '';
            
            mobs.forEach(m => {
                const div = document.createElement('div');
                div.className = 'mob-container';
                div.id = `mob-${m.id}`;
                if (m.hp <= 0) div.classList.add('dead');
                
                div.onclick = () => selectTarget(m.id); // é»æ“Šé¸æ“‡

                // åœ–ç‰‡è·¯å¾‘ (å‡è¨­ monsterKey æ˜¯ slime, å‰‡ç”¨ slime.png)
                // é€™è£¡æš«æ™‚ç”¨å›ºå®šåœ–ï¼Œå¯¦éš›å¯ç”±å¾Œç«¯å‚³ img æ¬„ä½
                let imgSrc = `img/monsters/${m.name.split(' ')[0]}.png`; 
                // ç°¡å–®è™•ç†ï¼šç”¨åå­—å‰ç¶´ç•¶åœ–æª”åï¼Œæˆ–å¾Œç«¯å‚³éä¾†çš„ key
                // æš«æ™‚ç”¨é»˜èªåœ–
                imgSrc = "img/monsters/slime.png"; 
                if (m.name.includes("æ··æ²Œ")) imgSrc = "img/monsters/void_walker.png";

                const hpPct = (m.hp / m.maxHp) * 100;
                
                div.innerHTML = `
                    <div class="mob-name">${m.name}</div>
                    <img class="boss-sprite" src="${imgSrc}" onerror="this.src='img/monsters/slime.png'">
                    <div class="mob-hp-bar"><div class="mob-hp-fill" style="width:${hpPct}%"></div></div>
                `;
                
                // é£„å­—å®¹å™¨
                const floatArea = document.createElement('div');
                floatArea.id = `dmg-${m.id}`;
                floatArea.style.position = 'absolute';
                floatArea.style.width = '100%';
                floatArea.style.height = '100%';
                floatArea.style.pointerEvents = 'none';
                div.appendChild(floatArea);

                area.appendChild(div);
            });
        }

        // ğŸŸ¢ 4. æ›´æ–°ç‰¹å®šæ€ªç‰©ç‹€æ…‹ (å—å‚·/æ­»äº¡)
        socket.on('updateEntityStatus', (data) => {
            if (data.type === 'monster') {
                const mobDiv = document.getElementById(`mob-${data.id}`);
                if (mobDiv) {
                    const fill = mobDiv.querySelector('.mob-hp-fill');
                    const pct = (data.hp / data.maxHp) * 100;
                    fill.style.width = `${pct}%`;
                    
                    if (data.hp <= 0) {
                        mobDiv.classList.add('dead');
                        mobDiv.querySelector('.boss-sprite').style.filter = "grayscale(100%)";
                    } else {
                        // å—å‚·é–ƒçˆ
                        const img = mobDiv.querySelector('.boss-sprite');
                        img.classList.remove('damaged'); 
                        void img.offsetWidth; 
                        img.classList.add('damaged');
                    }
                }
                
                // æ›´æ–°æœ¬åœ°ç·©å­˜
                const m = currentMonsters.find(x => x.id === data.id);
                if (m) { m.hp = data.hp; m.maxHp = data.maxHp; }
            }
        });

        // ğŸŸ¢ 5. å‚·å®³é£„å­—
        socket.on('playerDamaged', (data) => {
            // å¦‚æœæ˜¯æ€ªç‰©å—å‚·
            if (data.id && data.id.startsWith('mob_')) {
                const dmgArea = document.getElementById(`dmg-${data.id}`);
                if (dmgArea) {
                    const floatTxt = document.createElement('div');
                    floatTxt.className = 'dmg-text';
                    floatTxt.innerText = `-${data.damage}`;
                    dmgArea.appendChild(floatTxt);
                    setTimeout(() => floatTxt.remove(), 1000);
                }
            }
        });

        // ğŸŸ¢ 6. é¸æ“‡ç›®æ¨™é‚è¼¯
        function act(type) {
            if (!isMyTurn) return;
            
            // å¦‚æœåªæœ‰ä¸€éš»æ€ªï¼Œç›´æ¥æ‰“
            const aliveMobs = currentMonsters.filter(m => m.hp > 0);
            if (aliveMobs.length === 1) {
                commitAction(type, null, aliveMobs[0].id);
                return;
            }

            // å¤šéš»æ€ª -> é€²å…¥é¸ç›®æ¨™æ¨¡å¼
            pendingAction = { type: type, skillId: null };
            showTargetTip(true);
        }

        function useSkill(skillId) {
            if (!isMyTurn) return;
            // åˆ¤æ–·æŠ€èƒ½é¡å‹ï¼Œå¦‚æœæ˜¯å…¨é«”æˆ–è‡ªèº«Buffï¼Œä¸éœ€è¦é¸ç›®æ¨™
            const skill = SKILL_INFO[skillId];
            if (skill.cat === 'buff' || skill.cat === 'heal' || skill.name === 'è–å…‰æ™®ç…§') {
                commitAction('skill', skillId, null); // null target
                resetButtons();
                return;
            }

            // æ”»æ“ŠæŠ€èƒ½ -> é¸ç›®æ¨™
            const aliveMobs = currentMonsters.filter(m => m.hp > 0);
            if (aliveMobs.length === 1) {
                commitAction('skill', skillId, aliveMobs[0].id);
                resetButtons();
                return;
            }

            pendingAction = { type: 'skill', skillId: skillId };
            showTargetTip(true);
            // éš±è—é¸å–®ï¼Œè®“ç©å®¶çœ‹æ¸…æ¥šæ€ªç‰©
            document.getElementById('menu-container').style.opacity = 0.3;
        }

        function selectTarget(mobId) {
            if (!pendingAction) return; // æ²’åœ¨é¸ç›®æ¨™
            
            const mob = currentMonsters.find(m => m.id === mobId);
            if (!mob || mob.hp <= 0) { showMsg("ç›®æ¨™å·²æ­»äº¡"); return; }

            commitAction(pendingAction.type, pendingAction.skillId, mobId);
            
            // é‡ç½®ç‹€æ…‹
            pendingAction = null;
            showTargetTip(false);
            document.getElementById('menu-container').style.opacity = 1;
            resetButtons();
        }

        function showTargetTip(show) {
            document.getElementById('target-select-tip').style.display = show ? 'block' : 'none';
        }

        function commitAction(type, skillId, targetId) {
            toggle(true); // é–å®šæŒ‰éˆ•
            socket.emit('combatAction', { 
                roomId: roomId, 
                type: type, 
                skillId: skillId, 
                targetId: targetId // ğŸŸ¢ å‚³é€ç›®æ¨™ ID
            });
        }

        // ğŸŸ¢ 7. ç¹ªè£½æ™‚é–“è»¸
        let currentTimeline = [];
        function renderTimeline(order, activeIndex) {
            if (order) currentTimeline = order; // æ›´æ–°é †åºç·©å­˜
            
            const bar = document.getElementById('turn-bar');
            bar.innerHTML = '';
            
            currentTimeline.forEach((actor, idx) => {
                const div = document.createElement('div');
                div.className = `turn-icon ${actor.type}`;
                if (idx === activeIndex) div.classList.add('active');
                
                // é¡¯ç¤ºåå­—ç°¡å¯«
                // å¯¦éš›æ‡‰è©²å¾ id æŸ¥åå­—ï¼Œé€™è£¡ç°¡åŒ–è™•ç†
                div.innerText = actor.type === 'player' ? 'P' : 'M';
                
                // å¦‚æœæ˜¯è‡ªå·±
                if (actor.id === socket.id) { 
                    div.style.border = "2px solid #2ecc71"; 
                    div.innerText = "æˆ‘";
                }
                
                bar.appendChild(div);
            });
            
            // è‡ªå‹•æ²å‹•åˆ°ç•¶å‰
            if (activeIndex >= 0) {
                const activeEl = bar.children[activeIndex];
                if (activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
            }
        }

        // --- ä»¥ä¸‹ç‚ºé€šç”¨åŠŸèƒ½ (ä¿ç•™åŸæ¨£) ---
        
        setInterval(() => { if (socket.connected) socket.emit('heartbeat'); }, 20000);
        socket.on('disconnect', () => { showMsg("âš ï¸ èˆ‡ä¼ºæœå™¨é€£ç·šä¸­æ–·..."); });

        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text; t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        // Chat & UI Update Logic (ç•¥ï¼Œèˆ‡åŸæœ¬ç›¸åŒ)
        function appendChat(name, msg) { /* ... */ }
        socket.on('chatMessage', (data) => { /* ... */ });
        // ... å…¶ä»– UI æ›´æ–°å‡½å¼ (playerStatsUpdate, etc.) ä¿æŒä¸è®Š ...
        
        socket.on('playerStatsUpdate', (p) => {
            myPlayer = p;
            document.getElementById('my-name').innerText = p.name || "å‹‡è€…";
            document.getElementById('php').style.width = (p.hp / p.maxHp * 100) + '%';
            document.getElementById('pmp').style.width = (p.mp / p.maxMp * 100) + '%';
            document.getElementById('hp-txt').innerText = `HP:${p.hp}/${p.maxHp}  MP:${p.mp}/${p.maxMp}`;
            updateShortcutStates(p);
        });

        // å¿«æ·éµæ›´æ–°
        function updateShortcutStates(p) {
             // (åŒåŸç‰ˆé‚è¼¯ï¼Œåªæ˜¯è¦åŠ ä¸Š isMyTurn åˆ¤æ–·)
             const area = document.getElementById('shortcut-area');
             // ...
             const btns = area.querySelectorAll('.btn-shortcut');
             btns.forEach(btn => {
                const cost = parseInt(btn.getAttribute('data-mp'));
                if (p.mp < cost) { btn.disabled = true; btn.style.opacity = "0.5"; }
                else if (isMyTurn) { btn.disabled = false; btn.style.opacity = "1"; }
                else { btn.disabled = true; btn.style.opacity = "0.5"; }
             });
        }
        
        function toggle(disabled) { 
            document.querySelectorAll('.battle-action').forEach(b => {
                b.disabled = disabled; b.style.opacity = disabled ? "0.5" : "1";
            }); 
            // é †ä¾¿æ›´æ–°å¿«æ·éµç‹€æ…‹
            if (myPlayer) updateShortcutStates(myPlayer);
        }

        function log(m) { 
            const box = document.getElementById('log'); const div = document.createElement('div');
            div.innerHTML = `> ${m}`; box.insertBefore(div, box.firstChild); 
            const lines = box.querySelectorAll('div');
            if (lines.length > 20) for(let i=20; i<lines.length; i++) lines[i].remove();
        }

        // é›œé …ï¼šé‡ç½®æŒ‰éˆ•ã€æ‰“é–‹èƒŒåŒ…ç­‰ (åŒåŸç‰ˆ)
        function resetButtons() {
            // (é‚„åŸä¸»é¸å–®)
            const btnArea = document.getElementById('btns');
            const fixedArea = document.getElementById('fixed-top-area');
            const shortcutArea = document.getElementById('shortcut-area');

            fixedArea.style.display = 'none'; 
            shortcutArea.style.display = 'grid'; 

            btnArea.style.gridTemplateColumns = '1fr 1fr';
            btnArea.innerHTML = `
                <button class="btn battle-action" onclick="act('attack')">æ”»æ“Š</button>
                <button class="btn battle-action" onclick="openSkill()">é­”æ³•</button>
                <button class="btn battle-action" onclick="openBag()">ç‰©å“</button>
                <button class="btn" onclick="leaveRoom()">é€ƒè·‘</button>
            `;
            toggle(!isMyTurn);
        }
        
        function leaveRoom() { socket.emit('leaveRoom', roomId); window.location.href = 'hub.html'; }
        // ğŸŸ¢ [è£œå›ç¼ºå¤±çš„å‡½å¼] æˆ¿ä¸»é–‹å§‹æˆ°é¬¥
        function requestStart() {
            if (!roomId) return;
            // é¿å…é€£é»
            const btn = document.getElementById('start-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerText = "å•Ÿå‹•ä¸­...";
            }
            socket.emit('startBattle', roomId);
        }
        // å•Ÿå‹•å€’æ•¸
        function startCountdown() {
            // ...
        }
        
        // è™•ç†åŠ å…¥æˆ¿é–“è³‡è¨Š
        socket.on('roomInfoUpdate', (info) => {
             // (åŒåŸç‰ˆï¼Œè™•ç†ç©å®¶åˆ—è¡¨)
             const lobbyList = document.getElementById('lobby-players');
             // ...
             // è™•ç†æŒ‰éˆ•
             const amIHost = (info.host === socket.id);
             const startBtn = document.getElementById('start-btn');
             const waitTxt = document.getElementById('waiting-txt');
             if (amIHost) {
                startBtn.style.display = 'block';
                startBtn.innerText = `é–‹å§‹ (${info.players.length}äºº)`;
                waitTxt.style.display = 'none';
             } else {
                startBtn.style.display = 'none';
                waitTxt.style.display = 'block';
             }
        });

    </script>
</body>
</html>
