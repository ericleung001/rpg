<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ„å»ºç‰Œçµ„</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh;
        }
        
        /* ä¸Šæ–¹ï¼šå¡ç‰‡åº« */
        .card-pool {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
            padding-bottom: 160px; align-content: flex-start;
        }

        /* ä¸‹æ–¹ï¼šæˆ‘çš„ç‰Œçµ„ */
        .my-deck-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 140px; background: rgba(0,0,0,0.95);
            border-top: 3px solid #f1c40f;
            display: flex; flex-direction: column; align-items: center;
            padding: 10px; z-index: 100;
        }

        .deck-info { margin-bottom: 5px; font-size: 12px; color: #f1c40f; }
        
        .deck-slots {
            display: flex; gap: 5px; overflow-x: auto; width: 100%; 
            justify-content: flex-start; padding-bottom: 5px;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            width: 80px; height: 120px; background: #34495e; border: 2px solid #fff;
            border-radius: 8px; display: flex; flex-direction: column; align-items: center;
            cursor: pointer; position: relative; font-size: 10px;
            transition: transform 0.1s;
        }
        .card:active { transform: scale(0.95); }
        .card.disabled { 
            filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; 
            pointer-events: none; /* ç¦æ­¢é»æ“Š */
        }
        
        .card.unit { border-color: #e67e22; }
        .card.spell { border-color: #9b59b6; }

        .card img { width: 50px; height: 50px; object-fit: contain; margin-top: 5px; }
        .card .name { margin-top: 5px; text-align: center; font-size: 8px; overflow: hidden; white-space: nowrap; width: 90%; }
        .card .stats { color: #f1c40f; font-size: 7px; margin-top: 2px; }
        
        /* æ•¸é‡æ¨™è¨˜ */
        .count-badge {
            background: #e74c3c; color: white; padding: 2px 6px; border-radius: 4px;
            font-size: 8px; margin-top: 5px; border: 1px solid white;
        }

        /* æŒ‰éˆ•å€ */
        .action-btn {
            position: absolute; top: -50px; right: 20px;
            padding: 10px 20px; background: #2ecc71; border: none; color: white;
            font-family: inherit; border-radius: 5px; cursor: pointer;
            box-shadow: 0 4px 0 #27ae60;
        }
        .action-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .back-btn {
            position: fixed; top: 10px; left: 10px; z-index: 200;
            padding: 8px; background: #e74c3c; border: none; color: white;
            border-radius: 5px; cursor: pointer; font-family: inherit;
        }

        /* ç‰Œçµ„å°å¡ */
        .mini-card {
            min-width: 60px; height: 80px; background: #34495e; border: 1px solid #fff;
            border-radius: 5px; display: flex; flex-direction: column; align-items: center;
            font-size: 8px; cursor: pointer; position: relative; flex-shrink: 0;
        }
        .mini-card:hover { background: #c0392b; border-color: #e74c3c; }
        .mini-card img { width: 40px; height: 40px; margin-top: 5px; }
        .mini-card .remove-icon { position: absolute; top: 2px; right: 2px; color: red; font-weight: bold; }

    </style>
</head>
<body>

    <button class="back-btn" onclick="window.location.href='hub.html'">å›å¤§å»³</button>

    <div class="card-pool" id="pool-container">
        <div style="margin-top: 50px;">è¼‰å…¥å¡ç‰‡ä¸­...</div>
    </div>

    <div class="my-deck-bar">
        <button class="action-btn" onclick="startMatch()">é–‹å§‹å°æˆ°</button>
        <div class="deck-info">ç‰Œçµ„: <span id="deck-count">0</span> / 10</div>
        <div class="deck-slots" id="deck-container"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        const IMG_BASE_URL = "https://ericleung001.github.io/rpg/img/monsters/";

        // ğŸŸ¢ å®Œæ•´çš„è³‡æ–™å®šç¾© (ç´”é¡¯ç¤ºç”¨)
        const MONSTER_LIST = {
            'slime': { name: "å²èŠå§†", img: "slime.png", atk: 5, hp: 20 },
            'rat': { name: "å¤§è€é¼ ", img: "rat.png", atk: 8, hp: 15 },
            'bee': { name: "æ®ºäººèœ‚", img: "bee.png", atk: 12, hp: 10 },
            'boar': { name: "é‡è±¬", img: "boar.png", atk: 10, hp: 30 },
            'thief': { name: "ç›œè³Š", img: "thief.png", atk: 15, hp: 25 },
            'wolf_king': { name: "ç‹¼ç‹", img: "wolf_king.png", atk: 18, hp: 40 },
            'snake': { name: "æ¯’è›‡", img: "snake.png", atk: 14, hp: 20 },
            'zombie': { name: "è…å±", img: "zombie.png", atk: 10, hp: 50 },
            'skeleton': { name: "éª·é«å…µ", img: "skeleton.png", atk: 12, hp: 35 },
            'ghoul': { name: "é£Ÿå±é¬¼", img: "ghoul.png", atk: 16, hp: 45 },
            'witch': { name: "æ²¼æ¾¤å¥³å·«", img: "witch.png", atk: 25, hp: 30 },
            'hydra': { name: "ä¹é ­è›‡", img: "hydra.png", atk: 30, hp: 80 },
            'fire_imp': { name: "ç«ç„°å°é¬¼", img: "fire_imp.png", atk: 15, hp: 20 },
            'lava_golem': { name: "ç†”å²©æˆˆä¾–", img: "lava_golem.png", atk: 20, hp: 60 },
            'salamander': { name: "ç«èœ¥èœ´", img: "salamander.png", atk: 18, hp: 40 },
            'fire_mage': { name: "çƒˆç„°æ³•å¸«", img: "fire_mage.png", atk: 35, hp: 30 },
            'dragon_hatchling': { name: "å¹¼é¾", img: "dragon_hatchling.png", atk: 25, hp: 50 },
            'balrog': { name: "ç‚é­”", img: "balrog.png", atk: 45, hp: 70 },
            'snow_wolf': { name: "é›ªåŸç‹¼", img: "snow_wolf.png", atk: 15, hp: 35 },
            'yeti': { name: "é›ªäºº", img: "yeti.png", atk: 25, hp: 60 },
            'ice_spirit': { name: "å†°ç²¾éˆ", img: "ice_spirit.png", atk: 20, hp: 25 },
            'frost_knight': { name: "å¯’éœœé¨å£«", img: "frost_knight.png", atk: 30, hp: 55 },
            'ice_dragon': { name: "å†°éœœé¾", img: "ice_dragon.png", atk: 40, hp: 90 },
            'lich_king': { name: "å·«å¦–ç‹", img: "lich_king.png", atk: 50, hp: 80 },
            'void_eye': { name: "è™›ç©ºä¹‹çœ¼", img: "void_eye.png", atk: 35, hp: 40 },
            'shadow_assassin': { name: "æš—å½±åˆºå®¢", img: "shadow_assassin.png", atk: 45, hp: 30 },
            'dark_paladin': { name: "å¢®è½è–é¨", img: "dark_paladin.png", atk: 40, hp: 70 },
            'demon_guard': { name: "æƒ¡é­”å®ˆè¡›", img: "demon_guard.png", atk: 35, hp: 65 },
            'succubus': { name: "é­…é­”", img: "succubus.png", atk: 30, hp: 40 },
            'void_lord': { name: "è™›ç©ºé ˜ä¸»", img: "void_lord.png", atk: 55, hp: 90 },
            'chaos_beast': { name: "æ··æ²Œå·¨ç¸", img: "chaos_beast.png", atk: 60, hp: 100 },
            'fallen_angel': { name: "å¢®å¤©ä½¿", img: "fallen_angel.png", atk: 65, hp: 85 },
            'demon_king': { name: "é­”ç‹æ’’æ—¦", img: "demon_king.png", atk: 80, hp: 150 },
            'void_walker': { name: "è™›ç©ºè¡Œè€…", img: "void_walker.png", atk: 70, hp: 120 },
            'chaos_knight': { name: "æ··æ²Œé¨å£«", img: "chaos_knight.png", atk: 75, hp: 130 },
            'abyss_dragon': { name: "æ·±æ·µé­”é¾", img: "abyss_dragon.png", atk: 90, hp: 200 },
            'fallen_titan': { name: "å¢®è½æ³°å¦", img: "fallen_titan.png", atk: 100, hp: 250 },
            'genesis_god': { name: "å‰µä¸–ç ´å£ç¥", img: "genesis_god.png", atk: 999, hp: 999 },
            'void_worm': { name: "è™›ç©ºåå™¬èŸ²", img: "void_worm.png", atk: 120, hp: 300 },
            'shadow_phantom': { name: "è™šå½±å¤¢é­˜", img: "shadow_phantom.png", atk: 110, hp: 200 },
            'star_eater': { name: "åæ˜Ÿå·¨ç¸", img: "star_eater.png", atk: 200, hp: 500 },
            'nebula_dragon': { name: "æ˜Ÿé›²å¹»é¾", img: "nebula_dragon.png", atk: 150, hp: 400 },
            'time_keeper': { name: "æ™‚ç©ºè£æ±ºè€…", img: "time_keeper.png", atk: 180, hp: 450 },
            'dimension_breaker': { name: "ç¶­åº¦ç²‰ç¢è€…", img: "dimension_breaker.png", atk: 250, hp: 600 },
            'entropy_god': { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹ç¥", img: "entropy_god.png", atk: 9999, hp: 9999 }
        };

        const SPELL_LIST = {
            'card_potion': { name: "å›å¾©å¡", icon: "ğŸ’Š", desc: "å›å¾© 50% HP" },
            'card_fire': { name: "æ”»æ“Šå¡", icon: "ğŸ”¥", desc: "å‚·å®³ = ATK * 2" },
            'card_shield': { name: "è­·ç›¾å¡", icon: "ğŸ›¡ï¸", desc: "+20 HPä¸Šé™" }
        };

        const CARD_CONFIG = {};
        Object.keys(MONSTER_LIST).forEach(k => CARD_CONFIG[`card_${k}`] = { ...MONSTER_LIST[k], type: 'unit' });
        Object.keys(SPELL_LIST).forEach(k => CARD_CONFIG[k] = { ...SPELL_LIST[k], type: 'spell' });

        let myDeck = [];        // ç›®å‰é¸ä¸­çš„ç‰Œ
        let myInventory = {};   // ç©å®¶æ“æœ‰çš„ç‰Œåº« (å¾Serverå–å¾—)

        socket.on('connect', () => { 
            socket.emit('joinGame', myToken); 
        });

        // ğŸŸ¢ æ¥æ”¶ç©å®¶è³‡æ–™ (åŒ…å«ç‰Œçµ„ & åº«å­˜)
        socket.on('playerStatsUpdate', (player) => {
            // 1. è®€å–åº«å­˜ (å¦‚æœæ²’æœ‰å°±çµ¦ç©ºç‰©ä»¶)
            myInventory = player.cardPool || {};
            
            // 2. è®€å–å·²é¸ç‰Œçµ„
            if (player.cardDeck && Array.isArray(player.cardDeck)) {
                myDeck = player.cardDeck;
            } else {
                myDeck = [];
            }

            // 3. åˆ·æ–°ä»‹é¢
            refreshUI();
        });

        function refreshUI() {
            renderPool();
            renderDeck();
        }

        // ğŸŸ¢ æ¸²æŸ“ä¸Šæ–¹å¡ç‰‡åº« (æ ¹æ“šåº«å­˜é¡¯ç¤º)
        function renderPool() {
            const container = document.getElementById('pool-container');
            container.innerHTML = '';

            // å¦‚æœåº«å­˜æ˜¯ç©ºçš„
            if (Object.keys(myInventory).length === 0) {
                container.innerHTML = '<div style="margin-top:50px;">ä½ é‚„æ²’æœ‰ä»»ä½•å¡ç‰‡ï¼</div>';
                return;
            }

            Object.keys(myInventory).forEach(id => {
                const info = CARD_CONFIG[id];
                if (!info) return; // è·³éæœªçŸ¥å¡ç‰‡

                // è¨ˆç®—å‰©é¤˜æ•¸é‡
                const ownedCount = myInventory[id];
                const usedCount = myDeck.filter(card => card === id).length;
                const remaining = ownedCount - usedCount;

                const el = document.createElement('div');
                
                let visual = info.type === 'unit' ? 
                    `<img src="${IMG_BASE_URL + info.img}" onerror="this.style.display='none'">` : 
                    `<div style="font-size:30px; margin-top:10px;">${info.icon}</div>`;

                let stats = info.type === 'unit' ? `âš”ï¸${info.atk} â¤ï¸${info.hp}` : info.desc;

                el.className = `card ${info.type}`;
                
                // ğŸŸ¢ [é—œéµ] å¦‚æœç”¨å…‰äº†ï¼Œè®Šç°ä¸¦ç¦æ­¢é»æ“Š
                if (remaining <= 0) {
                    el.classList.add('disabled');
                }

                el.innerHTML = `
                    ${visual}
                    <div class="name">${info.name}</div>
                    <div class="stats">${stats}</div>
                    <div class="count-badge">å‰©é¤˜: ${remaining}</div>
                `;
                
                el.onclick = () => addToDeck(id, remaining);
                
                container.appendChild(el);
            });
        }

        // ğŸŸ¢ æ¸²æŸ“ä¸‹æ–¹ç‰Œçµ„
        function renderDeck() {
            const container = document.getElementById('deck-container');
            const countEl = document.getElementById('deck-count');
            
            container.innerHTML = '';
            countEl.innerText = myDeck.length;
            countEl.style.color = myDeck.length === 10 ? '#2ecc71' : '#f1c40f';

            myDeck.forEach((id, index) => {
                const info = CARD_CONFIG[id];
                const el = document.createElement('div');
                el.className = 'mini-card';
                el.title = "é»æ“Šç§»é™¤";
                
                if(!info) {
                    el.innerText = "?";
                } else {
                    let visual = info.type === 'unit' ? 
                        `<img src="${IMG_BASE_URL + info.img}">` : 
                        `<div style="font-size:20px; margin-top:10px;">${info.icon}</div>`;
                    
                    el.innerHTML = `${visual}<div class="remove-icon">Ã—</div>`;
                    if(info.type === 'unit') el.style.borderColor = '#e67e22';
                    else el.style.borderColor = '#9b59b6';
                }

                el.onclick = () => removeFromDeck(index);
                container.appendChild(el);
            });
        }

        function addToDeck(id, remaining) {
            if (myDeck.length >= 10) {
                alert("ç‰Œçµ„å·²æ»¿ (æœ€å¤š 10 å¼µ)ï¼");
                return;
            }
            if (remaining <= 0) {
                // ç†è«–ä¸Šé»ä¸åˆ°ï¼Œä½†é˜²å‘†ä¸€ä¸‹
                return;
            }
            myDeck.push(id);
            refreshUI(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°å‰©é¤˜æ•¸é‡
        }

        function removeFromDeck(index) {
            myDeck.splice(index, 1);
            refreshUI(); // é‡æ–°æ¸²æŸ“ä»¥é‡‹æ”¾åº«å­˜
        }

        function startMatch() {
            if (myDeck.length !== 10) {
                alert(`ç‰Œçµ„å¿…é ˆå‰›å¥½ 10 å¼µï¼(ç›®å‰ ${myDeck.length} å¼µ)`);
                return;
            }
            let monsterCount = 0;
            myDeck.forEach(id => {
                if (CARD_CONFIG[id] && CARD_CONFIG[id].type === 'unit') monsterCount++;
            });
            if (monsterCount < 3) {
                alert(`ç‰Œçµ„è‡³å°‘éœ€è¦ 3 å¼µæ€ªç‰©å¡ï¼(ç›®å‰ ${monsterCount} å¼µ)`);
                return;
            }

            socket.emit('updateDeck', myDeck);

            const btn = document.querySelector('.action-btn');
            btn.innerText = "æ­£åœ¨å°‹æ‰¾å°æ‰‹...";
            btn.disabled = true;
            btn.style.background = '#7f8c8d';

            setTimeout(() => {
                socket.emit('joinCardQueue');
            }, 500);
        }

        socket.on('matchFound', (data) => {
            window.location.href = 'card_battle.html';
        });

    </script>
</body>
</html>
