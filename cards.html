<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡ç‰‡åœ–é‘‘</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 10px; margin: 0;
        }
        h1 { color: #f1c40f; font-size: 16px; margin: 15px 0; }

        /* å¡ç‰‡å®¹å™¨ */
        .card-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-width: 600px; margin: 0 auto; padding-bottom: 60px;
        }

        .card {
            background: #34495e; border: 2px solid #7f8c8d; border-radius: 8px;
            padding: 10px 5px; position: relative; cursor: pointer;
            transition: transform 0.1s;
            min-height: 120px; display: flex; flex-direction: column; justify-content: space-between;
        }
        .card:active { transform: scale(0.95); }
        .card.owned { border-color: #f1c40f; background: #2c3e50; }
        .card.not-owned { opacity: 0.4; filter: grayscale(100%); }
        .card.in-deck { border: 2px solid #2ecc71; box-shadow: 0 0 10px #2ecc71; }

        .card-name { font-size: 10px; color: #fff; margin-bottom: 5px; font-weight: bold; }
        .card-img { font-size: 24px; margin: 5px 0; }
        .card-stats { font-size: 8px; color: #bdc3c7; }
        .card-count { 
            position: absolute; top: -5px; right: -5px; 
            background: #e74c3c; color: white; 
            border-radius: 50%; width: 20px; height: 20px; 
            font-size: 8px; line-height: 20px;
        }

        /* ç‰Œçµ„å€åŸŸ */
        .deck-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.9); border-top: 2px solid #f1c40f;
            padding: 10px; box-sizing: border-box; display: flex; 
            justify-content: space-between; align-items: center;
        }
        .deck-info { font-size: 10px; text-align: left; }
        .save-btn {
            background: #27ae60; color: white; border: none; padding: 8px 15px;
            font-family: inherit; font-size: 10px; border-radius: 5px; cursor: pointer;
        }

        .back-btn {
            position: fixed; top: 10px; left: 10px;
            background: #7f8c8d; color: white; padding: 5px 10px; text-decoration: none;
            border-radius: 5px; font-size: 10px; border: 1px solid #fff;
        }
    </style>
</head>
<body>

    <a href="hub.html" class="back-btn">â—€ è¿”å›</a>
    <h1>ğŸ´ å¡ç‰‡æ”¶è—</h1>

    <div id="card-list" class="card-grid">è¼‰å…¥ä¸­...</div>

    <div class="deck-bar">
        <div class="deck-info">
            å‡ºæˆ°ç‰Œçµ„: <span id="deck-count" style="color:#f1c40f">0</span> / 5<br>
            <span style="color:#aaa; font-size:8px;">é»æ“Šå¡ç‰‡ä»¥æ”¾å…¥/ç§»é™¤</span>
        </div>
        <button class="save-btn" onclick="saveDeck()">ğŸ’¾ å„²å­˜ç‰Œçµ„</button>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { transports: ['websocket', 'polling'], secure: true });
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myCards = {};
        let myDeck = [];
        
        // ğŸŸ¢ é€™è£¡è¤‡è£½ Server çš„ CARD_CONFIGï¼Œè®“å‰ç«¯èƒ½é¡¯ç¤ºè³‡æ–™
        const CARD_CONFIG = {
            'card_slime':   { name: "å²èŠå§†å¡", type: 'unit', atk: 5, hp: 20, desc: "æ™®é€šçš„å²èŠå§†" },
            'card_wolf':    { name: "ç‹¼ç‹å¡",   type: 'unit', atk: 15, hp: 50, desc: "å…‡çŒ›çš„ç‹¼ç‹" },
            'card_demon':   { name: "æƒ¡é­”å¡",   type: 'unit', atk: 50, hp: 200, desc: "å¼·å¤§çš„æƒ¡é­”" },
            'card_potion':  { name: "å›å¾©å¡",   type: 'spell', desc: "å›å¾© 50 HP" },
            'card_fire':    { name: "ç«çƒå¡",   type: 'spell', desc: "é€ æˆ 30 å‚·å®³" },
            'card_shield':  { name: "è­·ç›¾å¡",   type: 'spell', desc: "ç²å¾—è­·ç›¾" }
        };

        socket.on('connect', () => { socket.emit('joinGame', myToken); });

        socket.on('playerStatsUpdate', (p) => {
            myCards = p.cards || {};
            myDeck = p.cardDeck || []; // ç¢ºä¿ Server æœ‰å­˜é€™å€‹æ¬„ä½
            renderCards();
        });

        socket.on('errorMessage', (msg) => alert(msg));
        socket.on('marketResult', (res) => alert(res.msg)); // å€Ÿç”¨é€™å€‹é¡¯ç¤ºå„²å­˜æˆåŠŸ

        function renderCards() {
            const list = document.getElementById('card-list');
            list.innerHTML = '';
            
            // éæ­·æ‰€æœ‰å·²çŸ¥çš„å¡ç‰‡ (ä¸è«–æœ‰ç„¡æ“æœ‰ï¼Œé¡¯ç¤ºåœ–é‘‘æ„Ÿ)
            Object.keys(CARD_CONFIG).forEach(id => {
                const cardData = CARD_CONFIG[id];
                const ownedCount = myCards[id] || 0;
                const isOwned = ownedCount > 0;
                const isInDeck = myDeck.includes(id);

                const div = document.createElement('div');
                div.className = `card ${isOwned ? 'owned' : 'not-owned'} ${isInDeck ? 'in-deck' : ''}`;
                
                // å¡ç‰‡åœ–ç¤º (ç°¡å–®ç”¨ Emoji)
                let icon = 'ğŸƒ';
                if(id.includes('slime')) icon = 'ğŸ’§';
                if(id.includes('wolf')) icon = 'ğŸº';
                if(id.includes('demon')) icon = 'ğŸ‘¿';
                if(id.includes('potion')) icon = 'ğŸ’Š';
                if(id.includes('fire')) icon = 'ğŸ”¥';
                if(id.includes('shield')) icon = 'ğŸ›¡ï¸';

                // æ•¸å€¼é¡¯ç¤º
                let statsHtml = '';
                if(cardData.type === 'unit') statsHtml = `âš”ï¸${cardData.atk} â¤ï¸${cardData.hp}`;
                else statsHtml = `âœ¨${cardData.desc}`;

                div.innerHTML = `
                    ${isOwned ? `<div class="card-count">${ownedCount}</div>` : ''}
                    <div class="card-name">${cardData.name}</div>
                    <div class="card-img">${icon}</div>
                    <div class="card-stats">${statsHtml}</div>
                `;

                div.onclick = () => toggleDeck(id, isOwned);
                list.appendChild(div);
            });

            document.getElementById('deck-count').innerText = myDeck.length;
        }

        function toggleDeck(id, isOwned) {
            if (!isOwned) return; // æ²’æ“æœ‰ä¸èƒ½æ”¾

            const idx = myDeck.indexOf(id);
            if (idx > -1) {
                // ç§»é™¤
                myDeck.splice(idx, 1);
            } else {
                // åŠ å…¥
                if (myDeck.length >= 5) {
                    alert("ç‰Œçµ„æœ€å¤šåªèƒ½æ”¾ 5 å¼µå¡ï¼");
                    return;
                }
                myDeck.push(id);
            }
            renderCards();
        }

        function saveDeck() {
            if (myDeck.length === 0) {
                alert("ç‰Œçµ„ä¸èƒ½ç‚ºç©ºï¼");
                return;
            }
            socket.emit('updateDeck', myDeck);
        }
    </script>
</body>
</html>
