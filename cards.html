<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡ç‰‡åœ–é‘‘2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 10px; margin: 0;
            display: flex; flex-direction: column; height: 100vh;
        }
        h1 { color: #f1c40f; font-size: 16px; margin: 15px 0; flex-shrink: 0; }

        /* ä¸Šæ–¹å¡ç‰‡åº« (å¯æ²å‹•) */
        .card-pool-container {
            flex: 1; overflow-y: auto; padding-bottom: 120px; 
        }

        .card-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-width: 600px; margin: 0 auto; padding: 10px;
        }

        /* å¡ç‰‡æœ¬é«” */
        .card {
            background: #34495e; border: 2px solid #7f8c8d; border-radius: 8px;
            padding: 5px; position: relative; cursor: pointer;
            transition: transform 0.1s;
            min-height: 140px; display: flex; flex-direction: column; justify-content: space-between;
            overflow: hidden;
        }
        .card:active { transform: scale(0.95); }
        
        /* ç‹€æ…‹ */
        .card.owned { border-color: #f1c40f; background: #2c3e50; }
        .card.disabled { opacity: 0.4; filter: grayscale(100%); cursor: not-allowed; pointer-events: none; }

        /* ç¨€æœ‰åº¦ */
        .card[data-rarity="1"] { border-color: #bdc3c7; } 
        .card[data-rarity="2"] { border-color: #2ecc71; } 
        .card[data-rarity="3"] { border-color: #3498db; } 
        .card[data-rarity="4"] { border-color: #9b59b6; } 
        .card[data-rarity="5"] { border-color: #f1c40f; box-shadow: 0 0 8px #f1c40f; } 

        .card-name { font-size: 8px; color: #fff; margin-bottom: 5px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .card-img-box { 
            margin: 2px 0; height: 50px; display: flex; 
            align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.3); border-radius: 5px; padding: 2px;
        }
        .monster-pic { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5)); }
        .spell-icon { font-size: 24px; }
        .card-stats { font-size: 7px; color: #bdc3c7; line-height: 1.2; margin-top: 2px; }
        
        /* å‰©é¤˜æ•¸é‡æ¨™è¨˜ (å³ä¸Šè§’) */
        .card-count-badge { 
            position: absolute; top: 2px; right: 2px; 
            background: #e74c3c; color: white; border: 1px solid #fff;
            border-radius: 4px; padding: 2px 4px; font-size: 7px; z-index: 10; 
        }

        /* ä¸‹æ–¹å›ºå®š Deck Bar */
        .deck-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 110px;
            background: rgba(0,0,0,0.95); border-top: 2px solid #f1c40f;
            padding: 5px; box-sizing: border-box; display: flex; flex-direction: column;
            z-index: 100;
        }
        
        .deck-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px; padding: 0 5px;
        }
        .deck-info { font-size: 10px; text-align: left; }
        
        /* æ©«å‘æ²å‹•çš„ç‰Œçµ„å€ */
        .deck-slots {
            display: flex; gap: 5px; overflow-x: auto; width: 100%; height: 70px;
            align-items: center; padding-bottom: 5px;
        }
        
        /* ç‰Œçµ„å…§çš„å°å¡ */
        .mini-card {
            min-width: 45px; height: 60px; background: #34495e; border: 1px solid #fff;
            border-radius: 4px; display: flex; flex-direction: column; align-items: center;
            font-size: 6px; cursor: pointer; position: relative; flex-shrink: 0;
        }
        .mini-card:hover { border-color: #e74c3c; background: #442222; }
        .mini-card img { width: 30px; height: 30px; margin-top: 2px; }
        .mini-card .remove-icon { position: absolute; top: 0; right: 0; color: #e74c3c; font-weight: bold; font-size: 10px; line-height: 8px; }

        .save-btn {
            background: #27ae60; color: white; border: none; padding: 5px 10px;
            font-family: inherit; font-size: 10px; border-radius: 5px; cursor: pointer;
        }
        .back-btn {
            position: fixed; top: 10px; left: 10px;
            background: #7f8c8d; color: white; padding: 5px 10px; text-decoration: none;
            border-radius: 5px; font-size: 10px; border: 1px solid #fff; z-index: 100;
        }
        
        .status-ok { color: #2ecc71; }
        .status-warn { color: #f1c40f; }
        .status-err { color: #e74c3c; }

        #queue-msg {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); padding: 20px; border: 2px solid #f1c40f;
            color: #fff; border-radius: 10px; text-align: center; z-index: 200;
            display: none;
        }
    </style>
</head>
<body>

    <a href="hub.html" class="back-btn">â—€ è¿”å›</a>
    <h1>ğŸ´ ç·¨è¼¯ç‰Œçµ„</h1>

    <div class="card-pool-container">
        <div id="card-list" class="card-grid">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="deck-bar">
        <div class="deck-header">
            <div class="deck-info">
                ç‰Œçµ„: <span id="deck-count" class="status-warn">0</span>/10 
                <span style="color:#aaa; font-size:8px;">(æ€ªâ‰¥3)</span>
            </div>
            <div>
                <button class="save-btn" onclick="startMatch()" style="background:#e74c3c; margin-right:5px;">âš”ï¸ å°æˆ°</button>
                <button class="save-btn" onclick="saveDeck()">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
        <div class="deck-slots" id="deck-container"></div>
    </div>

    <div id="queue-msg">
        <div style="font-size:14px; margin-bottom:10px;">ğŸ” æ­£åœ¨å°‹æ‰¾å°æ‰‹...</div>
        <div style="font-size:10px; color:#aaa;">è«‹ç¨å€™ï¼Œé…å°æˆåŠŸå°‡è‡ªå‹•è·³è½‰</div>
        <button onclick="cancelMatch()" style="margin-top:15px; padding:5px 10px; background:#c0392b; border:none; color:white; border-radius:5px;">å–æ¶ˆ</button>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
            transports: ['websocket', 'polling'],
            secure: true 
        });
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myInventory = {}; 
        let myDeck = [];
        
        const IMG_BASE_URL = "https://ericleung001.github.io/rpg/img/monsters/";

        // [è³‡æ–™å®šç¾©]
        const MONSTER_LIST = {
            'slime': { name: "å²èŠå§†", img: "slime.png", atk: 5, hp: 20 },
            'rat': { name: "å¤§è€é¼ ", img: "rat.png", atk: 8, hp: 15 },
            'bee': { name: "æ®ºäººèœ‚", img: "bee.png", atk: 12, hp: 10 },
            'boar': { name: "é‡è±¬", img: "boar.png", atk: 10, hp: 30 },
            'thief': { name: "ç›œè³Š", img: "thief.png", atk: 15, hp: 25 },
            'wolf_king': { name: "ç‹¼ç‹", img: "wolf_king.png", atk: 18, hp: 40 },
            'snake': { name: "æ¯’è›‡", img: "snake.png", atk: 14, hp: 20 },
            'zombie': { name: "è…å±", img: "zombie.png", atk: 10, hp: 50 },
            'skeleton': { name: "éª·é«å…µ", img: "skeleton.png", atk: 12, hp: 35 },
            'ghoul': { name: "é£Ÿå±é¬¼", img: "ghoul.png", atk: 16, hp: 45 },
            'witch': { name: "æ²¼æ¾¤å¥³å·«", img: "witch.png", atk: 25, hp: 30 },
            'hydra': { name: "ä¹é ­è›‡", img: "hydra.png", atk: 30, hp: 80 },
            'fire_imp': { name: "ç«ç„°å°é¬¼", img: "fire_imp.png", atk: 15, hp: 20 },
            'lava_golem': { name: "ç†”å²©æˆˆä¾–", img: "lava_golem.png", atk: 20, hp: 60 },
            'salamander': { name: "ç«èœ¥èœ´", img: "salamander.png", atk: 18, hp: 40 },
            'fire_mage': { name: "çƒˆç„°æ³•å¸«", img: "fire_mage.png", atk: 35, hp: 30 },
            'dragon_hatchling': { name: "å¹¼é¾", img: "dragon_hatchling.png", atk: 25, hp: 50 },
            'balrog': { name: "ç‚é­”", img: "balrog.png", atk: 45, hp: 70 },
            'snow_wolf': { name: "é›ªåŸç‹¼", img: "snow_wolf.png", atk: 15, hp: 35 },
            'yeti': { name: "é›ªäºº", img: "yeti.png", atk: 25, hp: 60 },
            'ice_spirit': { name: "å†°ç²¾éˆ", img: "ice_spirit.png", atk: 20, hp: 25 },
            'frost_knight': { name: "å¯’éœœé¨å£«", img: "frost_knight.png", atk: 30, hp: 55 },
            'ice_dragon': { name: "å†°éœœé¾", img: "ice_dragon.png", atk: 40, hp: 90 },
            'lich_king': { name: "å·«å¦–ç‹", img: "lich_king.png", atk: 50, hp: 80 },
            'void_eye': { name: "è™›ç©ºä¹‹çœ¼", img: "void_eye.png", atk: 35, hp: 40 },
            'shadow_assassin': { name: "æš—å½±åˆºå®¢", img: "shadow_assassin.png", atk: 45, hp: 30 },
            'dark_paladin': { name: "å¢®è½è–é¨", img: "dark_paladin.png", atk: 40, hp: 70 },
            'demon_guard': { name: "æƒ¡é­”å®ˆè¡›", img: "demon_guard.png", atk: 35, hp: 65 },
            'succubus': { name: "é­…é­”", img: "succubus.png", atk: 30, hp: 40 },
            'void_lord': { name: "è™›ç©ºé ˜ä¸»", img: "void_lord.png", atk: 55, hp: 90 },
            'chaos_beast': { name: "æ··æ²Œå·¨ç¸", img: "chaos_beast.png", atk: 60, hp: 100 },
            'fallen_angel': { name: "å¢®å¤©ä½¿", img: "fallen_angel.png", atk: 65, hp: 85 },
            'demon_king': { name: "é­”ç‹æ’’æ—¦", img: "demon_king.png", atk: 80, hp: 150 },
            'void_walker': { name: "è™›ç©ºè¡Œè€…", img: "void_walker.png", atk: 70, hp: 120 },
            'chaos_knight': { name: "æ··æ²Œé¨å£«", img: "chaos_knight.png", atk: 75, hp: 130 },
            'abyss_dragon': { name: "æ·±æ·µé­”é¾", img: "abyss_dragon.png", atk: 90, hp: 200 },
            'fallen_titan': { name: "å¢®è½æ³°å¦", img: "fallen_titan.png", atk: 100, hp: 250 },
            'genesis_god': { name: "å‰µä¸–ç ´å£ç¥", img: "genesis_god.png", atk: 999, hp: 999 },
            'void_worm': { name: "è™›ç©ºåå™¬èŸ²", img: "void_worm.png", atk: 120, hp: 300 },
            'shadow_phantom': { name: "è™šå½±å¤¢é­˜", img: "shadow_phantom.png", atk: 110, hp: 200 },
            'star_eater': { name: "åæ˜Ÿå·¨ç¸", img: "star_eater.png", atk: 200, hp: 500 },
            'nebula_dragon': { name: "æ˜Ÿé›²å¹»é¾", img: "nebula_dragon.png", atk: 150, hp: 400 },
            'time_keeper': { name: "æ™‚ç©ºè£æ±ºè€…", img: "time_keeper.png", atk: 180, hp: 450 },
            'dimension_breaker': { name: "ç¶­åº¦ç²‰ç¢è€…", img: "dimension_breaker.png", atk: 250, hp: 600 },
            'entropy_god': { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹ç¥", img: "entropy_god.png", atk: 9999, hp: 9999 }
        };

        const SPELL_LIST = {
            'card_potion': { name: "å›å¾©å¡", icon: "ğŸ’Š", desc: "å›å¾© 50% HP" },
            'card_fire': { name: "æ”»æ“Šå¡", icon: "ğŸ”¥", desc: "å‚·å®³ = ATK * 2" },
            'card_shield': { name: "è­·ç›¾å¡", icon: "ğŸ›¡ï¸", desc: "+20 HPä¸Šé™" }
        };

        const CARD_CONFIG = {};
        Object.keys(MONSTER_LIST).forEach(key => {
            const mon = MONSTER_LIST[key];
            CARD_CONFIG[`card_${key}`] = { name: mon.name, src: mon.img, type: 'unit', rarity: 1, desc: `âš”ï¸${mon.atk} â¤ï¸${mon.hp}` };
        });
        Object.keys(SPELL_LIST).forEach(key => {
            CARD_CONFIG[key] = { name: SPELL_LIST[key].name, icon: SPELL_LIST[key].icon, type: 'spell', rarity: 2, desc: SPELL_LIST[key].desc };
        });

        socket.on('connect', () => { socket.emit('joinGame', myToken); });

        // ğŸŸ¢ [ä¿®æ­£] è®€å– Inventory (ç›¸å®¹èˆŠè³‡æ–™åº«)
        socket.on('playerStatsUpdate', (p) => {
            // é€™è£¡å„ªå…ˆä½¿ç”¨ä½ æä¾›çš„è³‡æ–™æ ¼å¼: p.inventory æ˜¯ç‰©ä»¶ {card_id: count, ...}
            myInventory = p.inventory || {}; 
            myDeck = p.cardDeck || []; 
            refreshUI();
        });

        socket.on('errorMessage', (msg) => alert(msg));
        socket.on('marketResult', (res) => alert(res.msg)); 

        socket.on('matchFound', (data) => {
            document.getElementById('queue-msg').innerHTML = `<div style="font-size:14px; color:#2ecc71;">âœ… é…å°æˆåŠŸï¼</div><div style="margin-top:10px;">å°æ‰‹: ${data.opponent}</div>`;
            setTimeout(() => { window.location.href = 'card_battle.html'; }, 1000);
        });

        socket.on('queueStatus', (msg) => {
            if (msg === 'å·²å–æ¶ˆé…å°') document.getElementById('queue-msg').style.display = 'none';
        });

        function refreshUI() {
            renderPool();
            renderDeck();
            updateDeckInfo();
        }

        // 1. æ¸²æŸ“ä¸Šæ–¹å¡ç‰‡åº«
        function renderPool() {
            const list = document.getElementById('card-list');
            list.innerHTML = '';
            
            // éæ­·æˆ‘å€‘çŸ¥é“çš„æ‰€æœ‰å¡ç‰‡å®šç¾©
            Object.keys(CARD_CONFIG).forEach(id => {
                const cardData = CARD_CONFIG[id];
                
                // ğŸŸ¢ è¨ˆç®—å‰©é¤˜æ•¸é‡ = åº«å­˜ç¸½æ•¸ - ç‰Œçµ„å·²ç”¨æ•¸é‡
                const totalOwned = myInventory[id] || 0;
                const usedInDeck = myDeck.filter(c => c === id).length;
                const remaining = totalOwned - usedInDeck;
                
                // å¦‚æœå®Œå…¨æ²’æ“æœ‰ï¼Œå°±ä¸é¡¯ç¤º (æœªæ”¶é›†)
                if (totalOwned === 0) return;

                const div = document.createElement('div');
                // å¦‚æœå‰©é¤˜æ•¸é‡ <= 0ï¼Œè®Šç°
                div.className = `card ${cardData.type} ${remaining <= 0 ? 'disabled' : 'owned'}`;
                div.setAttribute('data-rarity', cardData.rarity);

                let visualHtml = cardData.type === 'unit' ? 
                    `<img src="${IMG_BASE_URL + cardData.src}" class="monster-pic" onerror="this.style.display='none'">` : 
                    `<span class="spell-icon">${cardData.icon}</span>`;

                let statsHtml = cardData.type === 'unit' ? `å¬å–šå–®ä½<br>${cardData.desc}` : `é­”æ³•å¡<br>${cardData.desc}`;

                div.innerHTML = `
                    <div class="card-count-badge">å‰©: ${remaining}</div>
                    <div class="card-name">${cardData.name}</div>
                    <div class="card-img-box">${visualHtml}</div>
                    <div class="card-stats">${statsHtml}</div>
                `;

                // é»æ“Šäº‹ä»¶ï¼šåŠ å…¥ç‰Œçµ„ (è¤‡æ•¸é¸å–)
                div.onclick = () => addToDeck(id, remaining);
                list.appendChild(div);
            });
        }

        // 2. æ¸²æŸ“ä¸‹æ–¹ç‰Œçµ„
        function renderDeck() {
            const container = document.getElementById('deck-container');
            container.innerHTML = '';

            myDeck.forEach((id, index) => {
                const info = CARD_CONFIG[id];
                const el = document.createElement('div');
                el.className = 'mini-card';
                
                if(!info) {
                    el.innerText = "?";
                } else {
                    let visual = info.type === 'unit' ? 
                        `<img src="${IMG_BASE_URL + info.src}">` : 
                        `<div style="font-size:20px; margin-top:5px;">${info.icon}</div>`;
                    
                    el.innerHTML = `${visual}<div class="remove-icon">Ã—</div>`;
                    el.style.borderColor = info.type === 'unit' ? '#e67e22' : '#9b59b6';
                }

                // é»æ“Šäº‹ä»¶ï¼šå¾ç‰Œçµ„ç§»é™¤ (æœƒé‡‹æ”¾å›å¡ç‰‡åº«)
                el.onclick = () => removeFromDeck(index);
                container.appendChild(el);
            });
        }

        function addToDeck(id, remaining) {
            if (myDeck.length >= 10) { alert("ç‰Œçµ„æœ€å¤šåªèƒ½æ”¾ 10 å¼µå¡ï¼"); return; }
            if (remaining <= 0) return; // é˜²å‘†
            myDeck.push(id);
            refreshUI(); // åˆ·æ–°
        }

        function removeFromDeck(index) {
            myDeck.splice(index, 1);
            refreshUI(); // åˆ·æ–°
        }

        function updateDeckInfo() {
            let monsterCount = 0;
            myDeck.forEach(id => { if (CARD_CONFIG[id]?.type === 'unit') monsterCount++; });
            
            const countSpan = document.getElementById('deck-count');
            countSpan.innerText = myDeck.length;
            countSpan.className = myDeck.length === 10 ? 'status-ok' : 'status-warn';
        }

        function saveDeck() {
            if (!validateDeck()) return;
            socket.emit('updateDeck', myDeck);
        }

        function startMatch() {
            if (!validateDeck()) return;
            socket.emit('updateDeck', myDeck); 
            setTimeout(() => {
                socket.emit('joinCardQueue');
                document.getElementById('queue-msg').style.display = 'block';
            }, 500);
        }

        function validateDeck() {
            if (myDeck.length !== 10) {
                alert(`ç‰Œçµ„å¿…é ˆå‰›å¥½ 10 å¼µï¼(ç›®å‰ ${myDeck.length})`);
                return false;
            }
            let monsterCount = 0;
            myDeck.forEach(id => { if (CARD_CONFIG[id]?.type === 'unit') monsterCount++; });
            if (monsterCount < 3) {
                alert(`ç‰Œçµ„è‡³å°‘éœ€è¦ 3 å¼µæ€ªç‰©å¡ï¼(ç›®å‰ ${monsterCount})`);
                return false;
            }
            return true;
        }

        function cancelMatch() {
            socket.emit('leaveCardQueue');
        }
    </script>
</body>
</html>
