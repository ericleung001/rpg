<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡ç‰‡åœ–é‘‘3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 10px; margin: 0;
        }
        h1 { color: #f1c40f; font-size: 16px; margin: 15px 0; }

        /* å¡ç‰‡å®¹å™¨ */
        .card-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-width: 600px; margin: 0 auto; padding-bottom: 60px;
        }

        .card {
            background: #34495e; border: 2px solid #7f8c8d; border-radius: 8px;
            padding: 10px 5px; position: relative; cursor: pointer;
            transition: transform 0.1s;
            min-height: 140px; display: flex; flex-direction: column; justify-content: space-between;
            overflow: hidden;
        }
        .card:active { transform: scale(0.95); }
        .card.owned { border-color: #f1c40f; background: #2c3e50; }
        .card.not-owned { opacity: 0.4; filter: grayscale(100%); }
        .card.in-deck { border: 2px solid #2ecc71; box-shadow: 0 0 10px #2ecc71; }

        /* ç¨€æœ‰åº¦é¡è‰² (å°æ‡‰ CARD_CONFIG çš„ rarity) */
        .card[data-rarity="1"] { border-color: #bdc3c7; } /* ç™½ */
        .card[data-rarity="2"] { border-color: #2ecc71; } /* ç¶  */
        .card[data-rarity="3"] { border-color: #3498db; } /* è— */
        .card[data-rarity="4"] { border-color: #9b59b6; } /* ç´« */
        .card[data-rarity="5"] { border-color: #f1c40f; box-shadow: 0 0 5px #f1c40f; } /* é‡‘ */

        .card-name { font-size: 8px; color: #fff; margin-bottom: 5px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* æ€ªç‰©åœ–ç‰‡å€åŸŸ */
        .card-img { 
            font-size: 32px; margin: 5px 0; height: 50px; display: flex; 
            align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.2); border-radius: 5px;
        }
        
        .card-stats { font-size: 8px; color: #bdc3c7; line-height: 1.4; }
        .card-count { 
            position: absolute; top: -5px; right: -5px; 
            background: #e74c3c; color: white; 
            border-radius: 50%; width: 20px; height: 20px; 
            font-size: 8px; line-height: 20px; z-index: 10;
        }

        /* ç‰Œçµ„å€åŸŸ */
        .deck-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.9); border-top: 2px solid #f1c40f;
            padding: 10px; box-sizing: border-box; display: flex; 
            justify-content: space-between; align-items: center; z-index: 100;
        }
        .deck-info { font-size: 10px; text-align: left; }
        .save-btn {
            background: #27ae60; color: white; border: none; padding: 8px 15px;
            font-family: inherit; font-size: 10px; border-radius: 5px; cursor: pointer;
        }

        .back-btn {
            position: fixed; top: 10px; left: 10px;
            background: #7f8c8d; color: white; padding: 5px 10px; text-decoration: none;
            border-radius: 5px; font-size: 10px; border: 1px solid #fff; z-index: 100;
        }
    </style>
</head>
<body>

    <a href="hub.html" class="back-btn">â—€ è¿”å›</a>
    <h1>ğŸ´ å¡ç‰‡æ”¶è—</h1>

    <div id="card-list" class="card-grid">è¼‰å…¥ä¸­...</div>

    <div class="deck-bar">
        <div class="deck-info">
            å‡ºæˆ°ç‰Œçµ„: <span id="deck-count" style="color:#f1c40f">0</span> / 5<br>
            <span style="color:#aaa; font-size:8px;">é»æ“Šå¡ç‰‡ä»¥æ”¾å…¥/ç§»é™¤</span>
        </div>
        <button class="save-btn" onclick="saveDeck()">ğŸ’¾ å„²å­˜ç‰Œçµ„</button>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
                // æŒ‡å®šé€£æ¥åˆ°ä½ çš„ https ç¶²å€
const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myInventory = {}; // æ”¹ç”¨èƒŒåŒ…
        let myDeck = [];
        
        // ğŸŸ¢ å®Œæ•´çš„æ€ªç‰©è³‡æ–™ (éœ€èˆ‡ Server åŒæ­¥)
        const MONSTER_LIST = {
            'slime': { name: "å²èŠå§†", icon: "ğŸ’§" },
            'rat': { name: "å¤§è€é¼ ", icon: "ğŸ€" },
            'bee': { name: "æ®ºäººèœ‚", icon: "ğŸ" },
            'boar': { name: "é‡è±¬", icon: "ğŸ—" },
            'thief': { name: "ç›œè³Š", icon: "ğŸ¥·" },
            'wolf_king': { name: "ç‹¼ç‹", icon: "ğŸº" },
            'snake': { name: "æ¯’è›‡", icon: "ğŸ" },
            'zombie': { name: "è…å±", icon: "ğŸ§Ÿ" },
            'skeleton': { name: "éª·é«å…µ", icon: "ğŸ’€" },
            'ghoul': { name: "é£Ÿå±é¬¼", icon: "ğŸ§Ÿâ€â™‚ï¸" },
            'witch': { name: "æ²¼æ¾¤å¥³å·«", icon: "ğŸ§™â€â™€ï¸" },
            'hydra': { name: "ä¹é ­è›‡", icon: "ğŸ‰" },
            'fire_imp': { name: "ç«ç„°å°é¬¼", icon: "ğŸ”¥" },
            'lava_golem': { name: "ç†”å²©æˆˆä¾–", icon: "ğŸ—¿" },
            'salamander': { name: "ç«èœ¥èœ´", icon: "ğŸ¦" },
            'fire_mage': { name: "çƒˆç„°æ³•å¸«", icon: "ğŸ§™â€â™‚ï¸" },
            'dragon_hatchling': { name: "å¹¼é¾", icon: "ğŸ²" },
            'balrog': { name: "ç‚é­”", icon: "ğŸ‘¹" },
            'snow_wolf': { name: "é›ªåŸç‹¼", icon: "ğŸ•" },
            'yeti': { name: "é›ªäºº", icon: "â›„" },
            'ice_spirit': { name: "å†°ç²¾éˆ", icon: "ğŸ§š" },
            'frost_knight': { name: "å¯’éœœé¨å£«", icon: "ğŸ›¡ï¸" },
            'ice_dragon': { name: "å†°éœœé¾", icon: "â„ï¸" },
            'lich_king': { name: "å·«å¦–ç‹", icon: "ğŸ‘‘" },
            'void_eye': { name: "è™›ç©ºä¹‹çœ¼", icon: "ğŸ‘ï¸" },
            'shadow_assassin': { name: "æš—å½±åˆºå®¢", icon: "ğŸ—¡ï¸" },
            'dark_paladin': { name: "å¢®è½è–é¨", icon: "ğŸ‡" },
            'demon_guard': { name: "æƒ¡é­”å®ˆè¡›", icon: "ğŸ›¡ï¸" },
            'succubus': { name: "é­…é­”", icon: "ğŸ’‹" },
            'void_lord': { name: "è™›ç©ºé ˜ä¸»", icon: "ğŸ‘¿" },
            'chaos_beast': { name: "æ··æ²Œå·¨ç¸", icon: "ğŸ—" },
            'fallen_angel': { name: "å¢®å¤©ä½¿", icon: "ğŸª½" },
            'demon_king': { name: "é­”ç‹æ’’æ—¦", icon: "ğŸ˜ˆ" },
            'void_walker': { name: "è™›ç©ºè¡Œè€…", icon: "ğŸš¶" },
            'chaos_knight': { name: "æ··æ²Œé¨å£«", icon: "âš”ï¸" },
            'abyss_dragon': { name: "æ·±æ·µé­”é¾", icon: "ğŸ²" },
            'fallen_titan': { name: "å¢®è½æ³°å¦", icon: "ğŸ—¿" },
            'genesis_god': { name: "å‰µä¸–ç ´å£ç¥", icon: "ğŸŒŸ" },
            'void_worm': { name: "è™›ç©ºåå™¬èŸ²", icon: "ğŸ›" },
            'shadow_phantom': { name: "è™šå½±å¤¢é­˜", icon: "ğŸ‘»" },
            'star_eater': { name: "åæ˜Ÿå·¨ç¸", icon: "ğŸŒŒ" },
            'nebula_dragon': { name: "æ˜Ÿé›²å¹»é¾", icon: "ğŸ‰" },
            'time_keeper': { name: "æ™‚ç©ºè£æ±ºè€…", icon: "â³" },
            'dimension_breaker': { name: "ç¶­åº¦ç²‰ç¢è€…", icon: "ğŸ”¨" },
            'entropy_god': { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹ç¥", icon: "âš«" }
        };

        // åŠŸèƒ½å¡ (æ‰‹å‹•å®šç¾©)
        const SPELL_LIST = {
            'card_potion': { name: "å›å¾©å¡", icon: "ğŸ’Š", desc: "å›å¾© 50 HP" },
            'card_fire': { name: "ç«çƒå¡", icon: "ğŸ”¥", desc: "30 å‚·å®³" },
            'card_shield': { name: "è­·ç›¾å¡", icon: "ğŸ›¡ï¸", desc: "ç²å¾—è­·ç›¾" }
        };

        // å‹•æ…‹ç”Ÿæˆ CARD_CONFIG
        const CARD_CONFIG = {};
        
        // 1. åŠ å…¥æ€ªç‰©å¡
        Object.keys(MONSTER_LIST).forEach(key => {
            const mon = MONSTER_LIST[key];
            const cardId = `card_${key}`;
            CARD_CONFIG[cardId] = {
                name: mon.name + "å¡",
                icon: mon.icon,
                type: 'unit',
                rarity: 1, // é è¨­ 1ï¼Œé¡¯ç¤ºæ™‚æœƒæ ¹æ“š Server è³‡æ–™èª¿æ•´
                desc: `${mon.name} çš„éˆé­‚`
            };
        });

        // 2. åŠ å…¥åŠŸèƒ½å¡
        Object.keys(SPELL_LIST).forEach(key => {
            CARD_CONFIG[key] = {
                name: SPELL_LIST[key].name,
                icon: SPELL_LIST[key].icon,
                type: 'spell',
                rarity: 2,
                desc: SPELL_LIST[key].desc
            };
        });

        socket.on('connect', () => { socket.emit('joinGame', myToken); });

        socket.on('playerStatsUpdate', (p) => {
            // ğŸŸ¢ [é‡é»ä¿®æ”¹] æ”¹ç‚ºè®€å– inventory (èƒŒåŒ…)
            myInventory = p.inventory || {}; 
            myDeck = p.cardDeck || []; 
            renderCards();
        });

        socket.on('errorMessage', (msg) => alert(msg));
        socket.on('marketResult', (res) => alert(res.msg)); 

        function renderCards() {
            const list = document.getElementById('card-list');
            list.innerHTML = '';
            
            Object.keys(CARD_CONFIG).forEach(id => {
                const cardData = CARD_CONFIG[id];
                
                // ğŸŸ¢ æª¢æŸ¥èƒŒåŒ…è£¡æœ‰æ²’æœ‰é€™å€‹ ID (key å¿…é ˆåŒ…å« 'card_')
                const ownedCount = myInventory[id] || 0;
                const isOwned = ownedCount > 0;
                const isInDeck = myDeck.includes(id);

                const div = document.createElement('div');
                div.className = `card ${isOwned ? 'owned' : 'not-owned'} ${isInDeck ? 'in-deck' : ''}`;
                
                // é€™è£¡ç°¡å–®æ ¹æ“šå¡ç‰‡ç¨®é¡çµ¦å€‹ç¨€æœ‰åº¦é¡è‰² (åŠŸèƒ½å¡=2, æ€ªç‰©å¡=1)
                // å¦‚æœæƒ³æ›´ç²¾ç´°ï¼Œéœ€è¦å¾Œç«¯å‚³ rarity çµ¦å‰ç«¯ï¼Œç›®å‰å…ˆç°¡å–®è™•ç†
                div.setAttribute('data-rarity', cardData.rarity);

                // æ•¸å€¼é¡¯ç¤º
                let statsHtml = '';
                if(cardData.type === 'unit') {
                    statsHtml = `å¬å–šå–®ä½<br>${cardData.desc}`;
                } else {
                    statsHtml = `é­”æ³•å¡<br>${cardData.desc}`;
                }

                div.innerHTML = `
                    ${isOwned ? `<div class="card-count">${ownedCount}</div>` : ''}
                    <div class="card-name">${cardData.name}</div>
                    <div class="card-img">${cardData.icon}</div>
                    <div class="card-stats">${statsHtml}</div>
                `;

                div.onclick = () => toggleDeck(id, isOwned);
                list.appendChild(div);
            });

            document.getElementById('deck-count').innerText = myDeck.length;
        }

        function toggleDeck(id, isOwned) {
            if (!isOwned) return; 

            const idx = myDeck.indexOf(id);
            if (idx > -1) {
                myDeck.splice(idx, 1);
            } else {
                if (myDeck.length >= 5) {
                    alert("ç‰Œçµ„æœ€å¤šåªèƒ½æ”¾ 5 å¼µå¡ï¼");
                    return;
                }
                myDeck.push(id);
            }
            renderCards();
        }

        function saveDeck() {
            if (myDeck.length === 0) {
                alert("ç‰Œçµ„ä¸èƒ½ç‚ºç©ºï¼");
                return;
            }
            socket.emit('updateDeck', myDeck);
        }
    </script>
</body>
</html>
