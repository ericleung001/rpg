<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡ç‰‡åœ–é‘‘4</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 10px; margin: 0;
        }
        h1 { color: #f1c40f; font-size: 16px; margin: 15px 0; }

        /* å¡ç‰‡å®¹å™¨ */
        .card-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            max-width: 600px; margin: 0 auto; padding-bottom: 60px;
        }

        .card {
            background: #34495e; border: 2px solid #7f8c8d; border-radius: 8px;
            padding: 10px 5px; position: relative; cursor: pointer;
            transition: transform 0.1s;
            min-height: 150px; display: flex; flex-direction: column; justify-content: space-between;
            overflow: hidden;
        }
        .card:active { transform: scale(0.95); }
        .card.owned { border-color: #f1c40f; background: #2c3e50; }
        .card.not-owned { opacity: 0.4; filter: grayscale(100%); }
        .card.in-deck { border: 2px solid #2ecc71; box-shadow: 0 0 10px #2ecc71; }

        /* ç¨€æœ‰åº¦é‚Šæ¡† */
        .card[data-rarity="1"] { border-color: #bdc3c7; } 
        .card[data-rarity="2"] { border-color: #2ecc71; } 
        .card[data-rarity="3"] { border-color: #3498db; } 
        .card[data-rarity="4"] { border-color: #9b59b6; } 
        .card[data-rarity="5"] { border-color: #f1c40f; box-shadow: 0 0 8px #f1c40f; } 

        .card-name { font-size: 8px; color: #fff; margin-bottom: 5px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ğŸŸ¢ [ä¿®æ”¹] åœ–ç‰‡å®¹å™¨æ¨£å¼ */
        .card-img-box { 
            margin: 5px 0; height: 60px; display: flex; 
            align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.3); border-radius: 5px;
            padding: 5px;
        }
        /* æ€ªç‰©åœ–ç‰‡ */
        .monster-pic {
            max-width: 100%; max-height: 100%; 
            object-fit: contain; /* ä¿æŒæ¯”ä¾‹ */
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
        }
        /* é­”æ³•å¡ Emoji */
        .spell-icon { font-size: 30px; }
        
        .card-stats { font-size: 8px; color: #bdc3c7; line-height: 1.4; margin-top: 5px; }
        .card-count { 
            position: absolute; top: -5px; right: -5px; 
            background: #e74c3c; color: white; 
            border-radius: 50%; width: 20px; height: 20px; 
            font-size: 8px; line-height: 20px; z-index: 10;
            border: 1px solid #fff;
        }

        .deck-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.95); border-top: 2px solid #f1c40f;
            padding: 10px; box-sizing: border-box; display: flex; 
            justify-content: space-between; align-items: center; z-index: 100;
        }
        .deck-info { font-size: 10px; text-align: left; }
        .save-btn {
            background: #27ae60; color: white; border: none; padding: 8px 15px;
            font-family: inherit; font-size: 10px; border-radius: 5px; cursor: pointer;
        }

        .back-btn {
            position: fixed; top: 10px; left: 10px;
            background: #7f8c8d; color: white; padding: 5px 10px; text-decoration: none;
            border-radius: 5px; font-size: 10px; border: 1px solid #fff; z-index: 100;
        }
    </style>
</head>
<body>

    <a href="hub.html" class="back-btn">â—€ è¿”å›</a>
    <h1>ğŸ´ å¡ç‰‡æ”¶è—</h1>

    <div id="card-list" class="card-grid">è¼‰å…¥ä¸­...</div>

    <div class="deck-bar">
        <div class="deck-info">
            å‡ºæˆ°ç‰Œçµ„: <span id="deck-count" style="color:#f1c40f">0</span> / 5<br>
            <span style="color:#aaa; font-size:8px;">é»æ“Šå¡ç‰‡ä»¥æ”¾å…¥/ç§»é™¤</span>
        </div>
        <button class="save-btn" onclick="saveDeck()">ğŸ’¾ å„²å­˜ç‰Œçµ„</button>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myInventory = {}; 
        let myDeck = [];
        
        // ğŸŸ¢ æ€ªç‰©åˆ—è¡¨ (Icon æ”¹ç‚ºåœ–ç‰‡æª”å)
        // å‡è¨­ä½ çš„åœ–ç‰‡æ˜¯ pngï¼Œå¦‚æœä½ çš„æª”æ¡ˆæ˜¯ jpgï¼Œè«‹è‡ªè¡Œä¿®æ”¹
        const MONSTER_LIST = {
            'slime': { name: "å²èŠå§†", img: "slime.png" },
            'rat': { name: "å¤§è€é¼ ", img: "rat.png" },
            'bee': { name: "æ®ºäººèœ‚", img: "bee.png" },
            'boar': { name: "é‡è±¬", img: "boar.png" },
            'thief': { name: "ç›œè³Š", img: "thief.png" },
            'wolf_king': { name: "ç‹¼ç‹", img: "wolf_king.png" },
            'snake': { name: "æ¯’è›‡", img: "snake.png" },
            'zombie': { name: "è…å±", img: "zombie.png" },
            'skeleton': { name: "éª·é«å…µ", img: "skeleton.png" },
            'ghoul': { name: "é£Ÿå±é¬¼", img: "ghoul.png" },
            'witch': { name: "æ²¼æ¾¤å¥³å·«", img: "witch.png" },
            'hydra': { name: "ä¹é ­è›‡", img: "hydra.png" },
            'fire_imp': { name: "ç«ç„°å°é¬¼", img: "fire_imp.png" },
            'lava_golem': { name: "ç†”å²©æˆˆä¾–", img: "lava_golem.png" },
            'salamander': { name: "ç«èœ¥èœ´", img: "salamander.png" },
            'fire_mage': { name: "çƒˆç„°æ³•å¸«", img: "fire_mage.png" },
            'dragon_hatchling': { name: "å¹¼é¾", img: "dragon_hatchling.png" },
            'balrog': { name: "ç‚é­”", img: "balrog.png" },
            'snow_wolf': { name: "é›ªåŸç‹¼", img: "snow_wolf.png" },
            'yeti': { name: "é›ªäºº", img: "yeti.png" },
            'ice_spirit': { name: "å†°ç²¾éˆ", img: "ice_spirit.png" },
            'frost_knight': { name: "å¯’éœœé¨å£«", img: "frost_knight.png" },
            'ice_dragon': { name: "å†°éœœé¾", img: "ice_dragon.png" },
            'lich_king': { name: "å·«å¦–ç‹", img: "lich_king.png" },
            'void_eye': { name: "è™›ç©ºä¹‹çœ¼", img: "void_eye.png" },
            'shadow_assassin': { name: "æš—å½±åˆºå®¢", img: "shadow_assassin.png" },
            'dark_paladin': { name: "å¢®è½è–é¨", img: "dark_paladin.png" },
            'demon_guard': { name: "æƒ¡é­”å®ˆè¡›", img: "demon_guard.png" },
            'succubus': { name: "é­…é­”", img: "succubus.png" },
            'void_lord': { name: "è™›ç©ºé ˜ä¸»", img: "void_lord.png" },
            'chaos_beast': { name: "æ··æ²Œå·¨ç¸", img: "chaos_beast.png" },
            'fallen_angel': { name: "å¢®å¤©ä½¿", img: "fallen_angel.png" },
            'demon_king': { name: "é­”ç‹æ’’æ—¦", img: "demon_king.png" },
            'void_walker': { name: "è™›ç©ºè¡Œè€…", img: "void_walker.png" },
            'chaos_knight': { name: "æ··æ²Œé¨å£«", img: "chaos_knight.png" },
            'abyss_dragon': { name: "æ·±æ·µé­”é¾", img: "abyss_dragon.png" },
            'fallen_titan': { name: "å¢®è½æ³°å¦", img: "fallen_titan.png" },
            'genesis_god': { name: "å‰µä¸–ç ´å£ç¥", img: "genesis_god.png" },
            'void_worm': { name: "è™›ç©ºåå™¬èŸ²", img: "void_worm.png" },
            'shadow_phantom': { name: "è™šå½±å¤¢é­˜", img: "shadow_phantom.png" },
            'star_eater': { name: "åæ˜Ÿå·¨ç¸", img: "star_eater.png" },
            'nebula_dragon': { name: "æ˜Ÿé›²å¹»é¾", img: "nebula_dragon.png" },
            'time_keeper': { name: "æ™‚ç©ºè£æ±ºè€…", img: "time_keeper.png" },
            'dimension_breaker': { name: "ç¶­åº¦ç²‰ç¢è€…", img: "dimension_breaker.png" },
            'entropy_god': { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹ç¥", img: "entropy_god.png" }
        };

        // åŠŸèƒ½å¡ (ä¿æŒ Emoji)
        const SPELL_LIST = {
            'card_potion': { name: "å›å¾©å¡", icon: "ğŸ’Š", desc: "å›å¾© 50 HP" },
            'card_fire': { name: "ç«çƒå¡", icon: "ğŸ”¥", desc: "30 å‚·å®³" },
            'card_shield': { name: "è­·ç›¾å¡", icon: "ğŸ›¡ï¸", desc: "ç²å¾—è­·ç›¾" }
        };

        const CARD_CONFIG = {};
        
        // 1. åŠ å…¥æ€ªç‰©å¡ (è¨­å®šç‚º image é¡å‹)
        Object.keys(MONSTER_LIST).forEach(key => {
            const mon = MONSTER_LIST[key];
            const cardId = `card_${key}`;
            CARD_CONFIG[cardId] = {
                name: mon.name + "å¡",
                src: mon.img, // åœ–ç‰‡æª”å
                type: 'unit',
                rarity: 1, 
                desc: `${mon.name} çš„éˆé­‚`
            };
        });

        // 2. åŠ å…¥åŠŸèƒ½å¡ (è¨­å®šç‚º icon é¡å‹)
        Object.keys(SPELL_LIST).forEach(key => {
            CARD_CONFIG[key] = {
                name: SPELL_LIST[key].name,
                icon: SPELL_LIST[key].icon, // Emoji
                type: 'spell',
                rarity: 2,
                desc: SPELL_LIST[key].desc
            };
        });

        socket.on('connect', () => { socket.emit('joinGame', myToken); });

        socket.on('playerStatsUpdate', (p) => {
            myInventory = p.inventory || {}; 
            myDeck = p.cardDeck || []; 
            renderCards();
        });

        socket.on('errorMessage', (msg) => alert(msg));
        socket.on('marketResult', (res) => alert(res.msg)); 

        function renderCards() {
            const list = document.getElementById('card-list');
            list.innerHTML = '';
            
            Object.keys(CARD_CONFIG).forEach(id => {
                const cardData = CARD_CONFIG[id];
                const ownedCount = myInventory[id] || 0;
                const isOwned = ownedCount > 0;
                const isInDeck = myDeck.includes(id);

                const div = document.createElement('div');
                div.className = `card ${isOwned ? 'owned' : 'not-owned'} ${isInDeck ? 'in-deck' : ''}`;
                div.setAttribute('data-rarity', cardData.rarity);

                // ğŸŸ¢ [åˆ¤æ–·] é¡¯ç¤ºåœ–ç‰‡ é‚„æ˜¯ Emoji
                let visualHtml = '';
                if (cardData.type === 'unit') {
                    // æ€ªç‰©å¡ï¼šä½¿ç”¨ <img>
                    // é è¨­è·¯å¾‘: /img/monster/ + æª”å
                    // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•— (onerror)ï¼Œè‡ªå‹•è®Šå› Emoji "ğŸ‘¾"
                    visualHtml = `<img src="/img/monsters/${cardData.src}" class="monster-pic" onerror="this.style.display='none';this.parentNode.innerHTML='ğŸ‘¾'">`;
                } else {
                    // åŠŸèƒ½å¡ï¼šä½¿ç”¨ Emoji
                    visualHtml = `<span class="spell-icon">${cardData.icon}</span>`;
                }

                // æ•¸å€¼é¡¯ç¤º
                let statsHtml = '';
                if(cardData.type === 'unit') {
                    statsHtml = `å¬å–šå–®ä½<br>${cardData.desc}`;
                } else {
                    statsHtml = `é­”æ³•å¡<br>${cardData.desc}`;
                }

                div.innerHTML = `
                    ${isOwned ? `<div class="card-count">${ownedCount}</div>` : ''}
                    <div class="card-name">${cardData.name}</div>
                    <div class="card-img-box">${visualHtml}</div>
                    <div class="card-stats">${statsHtml}</div>
                `;

                div.onclick = () => toggleDeck(id, isOwned);
                list.appendChild(div);
            });

            document.getElementById('deck-count').innerText = myDeck.length;
        }

        function toggleDeck(id, isOwned) {
            if (!isOwned) return; 

            const idx = myDeck.indexOf(id);
            if (idx > -1) {
                myDeck.splice(idx, 1);
            } else {
                if (myDeck.length >= 5) {
                    alert("ç‰Œçµ„æœ€å¤šåªèƒ½æ”¾ 5 å¼µå¡ï¼");
                    return;
                }
                myDeck.push(id);
            }
            renderCards();
        }

        function saveDeck() {
            if (myDeck.length === 0) {
                alert("ç‰Œçµ„ä¸èƒ½ç‚ºç©ºï¼");
                return;
            }
            socket.emit('updateDeck', myDeck);
        }
    </script>
</body>
</html>
