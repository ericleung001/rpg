<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>戰鬥中</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #111; font-family: 'Press Start 2P', monospace; 
            height: 100dvh; margin: 0; overflow: hidden; 
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; 
            padding: 10px 10px 50px 10px; 
            box-sizing: border-box;
            overscroll-behavior: none;
        }
        
        #game-container { 
            width: 100%; max-width: 640px; height: 100%; 
            background: linear-gradient(135deg, #a8c0b0 50%, #789080 50%); 
            border: 4px solid #2c3e50; 
            display: grid; grid-template-rows: 40px 1.5fr 1.5fr 1.2fr; 
            position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 8px;
        }
        
        #turn-bar { 
            background: #333; color: #fff; display: flex; align-items: center; justify-content: center; 
            font-size: 14px; border-bottom: 4px solid #000; letter-spacing: 1px;
        }
        
        .boss-area { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /*  修改：怪物圖片樣式 */
        .boss-sprite { 
            width: 120px; height: 120px; 
            object-fit: contain; /* 保持圖片比例 */
            margin-bottom: 10px; 
            transition: transform 0.1s;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
        }
        
        .boss-info { width: 80%; text-align: center; }

        .player-area { display: flex; flex-direction: column; justify-content: center; padding: 0 15px; width: 100%; box-sizing: border-box; gap: 5px; }
        
        .my-status { width: 100%; box-sizing: border-box; } 
        .teammates { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;} 

        .gba-box { 
            background: #f0f0d8; border: 4px solid #706870; border-radius: 8px; 
            padding: 8px; color: #383838; font-size: 12px; 
            box-shadow: 4px 4px 0 rgba(0,0,0,0.3); 
        }
        .mini-box { background: #ecf0f1; border: 2px solid #95a5a6; padding: 4px; font-size: 10px; color: #333; overflow: hidden; border-radius: 4px; }
        
        .hp-bar { width: 100%; height: 12px; background: #555; border: 2px solid #333; margin-top: 5px; border-radius: 2px; }
        .hp-fill { height: 100%; background: #48c058; transition: width 0.3s; }
        .mp-bar { width: 100%; height: 8px; background: #555; border: 2px solid #333; margin-top: 3px; border-radius: 2px; }
        .mp-fill { height: 100%; background: #3498db; transition: width 0.3s; }
        .mini-hp-bar { width: 100%; height: 6px; background: #555; margin-top: 2px; }
        .mini-hp-fill { height: 100%; background: #e74c3c; width: 100%; }

        .stat-text { font-size: 10px; margin-top: 4px; font-weight: bold; }

        .hud { background: #305080; border-top: 6px solid #c8c8f8; display: flex; height: 100%; overflow: hidden; }
        .log { 
            width: 50%; padding: 10px; color: white; 
            font-size: 10px; line-height: 1.6; 
            overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-start; 
        }
        .menu { 
            width: 50%; display: grid; grid-template-columns: 1fr 1fr; 
            background: #fff; border-left: 6px solid #c8c8f8; 
            padding: 5px; gap: 5px; box-sizing: border-box;
        }
        
        .btn { 
            background: #f8f8f8; border: 2px solid #888; cursor: pointer; 
            font-family: inherit; font-size: 14px; font-weight: bold;
            text-align: center; display:flex; align-items:center; justify-content:center; border-radius: 6px;
        }
        .btn:active { background: #f8d030; color: #000; transform: translateY(2px); }
        .btn:disabled { background: #999; color: #555; cursor: not-allowed; }
        
        #lobby-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .player-list { border: 4px solid #fff; padding: 20px; width: 80%; min-height: 100px; text-align: left; margin-bottom: 30px; font-size: 14px; line-height: 2; }
        .start-btn { display: none; padding: 15px 30px; font-size: 16px; background: #e74c3c; color: white; border: 4px solid #c0392b; cursor: pointer; font-family: inherit; }
        
        #chat-container {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.95); border-top: 4px solid #bdc3c7;
            display: flex; flex-direction: column; font-size: 12px; z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            transition: height 0.3s ease-in-out; height: 35px; 
        }
        #chat-header {
            height: 35px; background: #34495e; color: #fff; line-height: 35px; 
            cursor: pointer; font-weight: bold; border-bottom: 1px solid #555;
            display: flex; justify-content: center; align-items: center;
        }
        .chat-open { height: 20vh !important; }
        #chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-open #chat-body { display: flex; }
        #chat-history { flex: 1; overflow-y: auto; padding: 10px; text-align: left; color: white; }
        #chat-input-area { display: flex; border-top: 1px solid #555; height: 45px; }
        #chat-input { flex: 1; background: #222; color: white; border: none; padding: 0 15px; font-family: inherit; font-size: 14px; outline: none; }
        #chat-send { background: #2980b9; color: white; border: none; padding: 0 20px; cursor: pointer; font-family: inherit; font-size: 14px; font-weight: bold; }

        /*  動畫特效 */
        .shake { animation: shake 0.5s; }
        .flash { animation: flash 0.3s; }
        /* 受傷變色 + 震動 */
        .damaged { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; filter: sepia(1) hue-rotate(-50deg) saturate(3) drop-shadow(0 0 10px red) !important; }

        @keyframes shake { 0%,100% {transform:translateX(0);} 25% {transform:translateX(-5px);} 75% {transform:translateX(5px);} }
        @keyframes flash { 0%,100% {filter:none;} 50% {filter:sepia(1) hue-rotate(-50deg) saturate(5);} }

        /*  Toast 通知 */
        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f;
            color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999;
            font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out;
            pointer-events: none;
        }
        
        /*  修改：怪物圖片樣式 */
        .boss-sprite { 
            width: 120px; height: 120px; 
            object-fit: contain; 
            margin-bottom: 10px; 
            transition: transform 0.1s;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
            
            /*  加入這兩行，讓像素圖放大後保持銳利，不會糊掉 */
            image-rendering: pixelated;       /* Chrome/Edge */
            image-rendering: -moz-crisp-edges; /* Firefox */
        }
    </style>
</head>
<body>
    <div id="game-toast"></div>

    <div id="game-container">
        <div id="lobby-overlay">
            <div style="color:#f1c40f; margin-bottom:20px; font-size:18px;">等待隊友...</div>
            <div class="player-list" id="lobby-players">讀取中...</div>
            <div id="host-controls"><button class="start-btn" id="start-btn" onclick="requestStart()">房主開始</button></div>
            <div id="waiting-txt" style="margin-top:15px; font-size:12px; color:#aaa; display:none;">(等待房主...)</div>
            <button onclick="leaveRoom()" style="margin-top:30px; background:transparent; border:2px solid #aaa; color:#aaa; cursor:pointer; font-size:12px; padding:10px;">離開房間</button>
        </div>

        <div id="turn-bar">等待...</div>

        <div class="boss-area">
            <img id="monster-img" class="boss-sprite" src="" onerror="this.style.display='none'" alt="Monster">
            <div class="gba-box boss-info">
                <div id="monster-name" style="font-size:14px; font-weight:bold; margin-bottom:5px;">...</div>
                <div class="hp-bar"><div id="mhp" class="hp-fill" style="width:100%"></div></div>
                <div id="mhp-txt" class="stat-text" style="text-align:right;">...</div>
            </div>
        </div>
        
        <div class="player-area">
            <div class="gba-box my-status">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span style="font-size:12px; font-weight:bold;">勇者(你)</span>
                    <span style="font-size:10px; color:#f1c40f;">
                        ⚔️<span id="atk-val">0</span> ️<span id="def-val">0</span>
                    </span>
                </div>
                <div class="hp-bar"><div id="php" class="hp-fill" style="width:100%"></div></div>
                <div class="mp-bar"><div id="pmp" class="mp-fill" style="width:100%"></div></div>
                <div style="font-size: 10px; margin-top: 5px; text-align:right;" id="hp-txt">...</div>
            </div>
            <div class="teammates" id="teammates-box"></div>
        </div>

        <div class="hud">
            <div class="log" id="log"><div>準備戰鬥...</div></div>
            <div class="menu" id="btns">
                <button class="btn battle-action" onclick="act('attack')">攻擊</button>
                <button class="btn battle-action" onclick="act('skill')">技能(10)</button>
                <button class="btn battle-action" onclick="openBag()">物品</button>
                <button class="btn" onclick="leaveRoom()">逃跑</button>
            </div>
        </div>
    </div>

    <div id="chat-container">
        <div id="chat-header" onclick="toggleChat()"> 聊天室 (點擊展開)</div>
        <div id="chat-body">
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="輸入訊息..." maxlength="50">
                <button id="chat-send">發送</button>
            </div>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
        //  網址混淆 (Base64)
        const _0x5a1b = "aHR0cHM6Ly9tbW8udHRjdHYtMTA1LmNj"; 
        const BACKEND_URL = atob(_0x5a1b);
        
        const socket = io(BACKEND_URL, {
            transports: ['websocket', 'polling'] // 確保連線穩定
        });

        let isMyTurn = false; 
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('room');
        let myPlayer = { mp: 0, hp: 0, maxMp: 100, maxHp: 100 };
        let lastMonsterHp = -1; // 用來偵測受傷

        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) { window.location.href = 'index.html'; }
        if (!roomId) { showMsg("無效的房間！"); setTimeout(()=>window.location.href = 'hub.html', 1000); }

        socket.on('connect', () => {
            socket.emit('joinGame', myToken); 
            setTimeout(() => socket.emit('connectToRoom', roomId), 100);
        });

        //  Toast 訊息 (取代 alert)
        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        //  聊天 (雙重安全：前端強制純文字)
        socket.on('chatHistory', (history) => {
            const box = document.getElementById('chat-history');
            box.innerHTML = ''; 
            history.forEach(data => appendChat(data.name, data.msg));
        });
        socket.on('chatMessage', (data) => { appendChat(data.name, data.msg); });
        
        function appendChat(name, msg) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            
            const nameSpan = document.createElement('span');
            nameSpan.style.color = '#f1c40f';
            nameSpan.style.fontWeight = 'bold';
            nameSpan.textContent = `[${name}]: `; // 安全寫法

            const msgNode = document.createTextNode(msg); // 安全寫法
            
            div.appendChild(nameSpan);
            div.appendChild(msgNode);
            history.appendChild(div); 
            history.scrollTop = history.scrollHeight;
        }

        document.getElementById('chat-send').onclick = sendChat;
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (msg) { socket.emit('sendChat', msg); input.value = ''; }
        }
        function toggleChat() {
            const chat = document.getElementById('chat-container');
            chat.classList.toggle('chat-open');
            document.getElementById('chat-header').innerText = chat.classList.contains('chat-open') ? " 收起" : " 聊天室 (點擊展開)";
        }

        //  遊戲狀態更新
        socket.on('roomInfoUpdate', (info) => {
            document.getElementById('lobby-players').innerHTML = info.players.map(p => `<div> ${p.name} (LV.${p.level})</div>`).join('');
            
            const amIHost = (info.host === socket.id);
            const startBtn = document.getElementById('start-btn');
            const waitTxt = document.getElementById('waiting-txt');
            if (amIHost) { startBtn.style.display = 'block'; startBtn.disabled = false; startBtn.innerText = `開始 (${info.players.length}人)`; waitTxt.style.display = 'none'; }
            else { startBtn.style.display = 'none'; waitTxt.style.display = 'block'; }
            
            document.getElementById('monster-name').innerText = info.monsterName;

            //  更新怪物圖片
            const img = document.getElementById('monster-img');
            if (info.monsterKey) {
                const newSrc = `img/monsters/${info.monsterKey}.png`;
                if (!img.src.includes(newSrc)) {
                    img.src = newSrc;
                    img.style.display = 'block';
                }
            }

            // 更新隊友
            const teammatesBox = document.getElementById('teammates-box');
            teammatesBox.innerHTML = '';
            info.players.forEach(p => {
                if (p.id !== socket.id) { 
                    const div = document.createElement('div');
                    div.className = 'mini-box';
                    const hpPct = (p.hp / p.maxHp) * 100;
                    div.innerHTML = `
                        <div style="white-space:nowrap; overflow:hidden; font-weight:bold;">${p.name}</div>
                        <div class="mini-hp-bar"><div class="mini-hp-fill" style="width:${hpPct}%; background:${hpPct<30?'red':'#2ecc71'}"></div></div>
                        <div style="font-size:8px; text-align:right;">${p.hp}/${p.maxHp}</div>
                    `;
                    teammatesBox.appendChild(div);
                }
            });
        });

        socket.on('battleStarted', () => {
            document.getElementById('lobby-overlay').style.display = 'none';
            log("戰鬥開始！");
        });

        socket.on('turnUpdate', (data) => {
            const bar = document.getElementById('turn-bar');
            if (data.currentId === 'monster') {
                isMyTurn = false; bar.innerText = "⚠️ 怪物回合..."; bar.style.background = "#c0392b"; toggle(true);
            } else if (data.currentId === socket.id) {
                isMyTurn = true; bar.innerText = "⚔️ 你的回合"; bar.style.background = "#27ae60"; toggle(false);
            } else {
                isMyTurn = false; bar.innerText = `⏳ ${data.name}`; bar.style.background = "#333"; toggle(true);
            }
        });

        socket.on('monsterUpdate', (m) => {
            document.getElementById('monster-name').innerText = `LV.${m.level} ${m.name}`;
            document.getElementById('mhp').style.width = (m.hp / m.maxHp * 100) + '%';
            document.getElementById('mhp-txt').innerText = `HP: ${m.hp}/${m.maxHp}`;
            
            //  怪物受傷特效
            const img = document.getElementById('monster-img');
            if (lastMonsterHp !== -1 && m.hp < lastMonsterHp) {
                img.classList.remove('damaged');
                void img.offsetWidth; // 觸發重繪
                img.classList.add('damaged');
            }
            lastMonsterHp = m.hp;
        });

        socket.on('playerStatsUpdate', (p) => {
            myPlayer = p;
            document.getElementById('php').style.width = (p.hp / p.maxHp * 100) + '%';
            let mpPct = (p.mp / p.maxMp * 100); if(mpPct < 0) mpPct = 0;
            document.getElementById('pmp').style.width = mpPct + '%';
            document.getElementById('hp-txt').innerText = `${p.hp}/${p.maxHp}`;
            if(document.getElementById('atk-val')) document.getElementById('atk-val').innerText = p.atk;
            if(document.getElementById('def-val')) document.getElementById('def-val').innerText = p.def;
        });

        socket.on('playerDamaged', (d) => {
            //  震動效果
            const container = document.getElementById('game-container');
            container.classList.add('shake');
            container.classList.add('flash');
            setTimeout(() => {
                container.classList.remove('shake');
                container.classList.remove('flash');
            }, 500);
            log(`<span style="color:#e74c3c">受到 ${d.damage} 傷害！</span>`); 
        });

        socket.on('battleWon', (data) => {
            document.getElementById('turn-bar').innerText = " 勝利！";
            document.getElementById('turn-bar').style.background = "gold";
            document.getElementById('turn-bar').style.color = "black";
            showMsg(`勝利！獲得 ${data.gold} G`);
            
            const img = document.getElementById('monster-img');
            img.style.transition = "opacity 2s";
            img.style.opacity = 0;
            
            document.getElementById('btns').innerHTML = `<button class="btn" style="grid-column: span 2;" disabled>下一場...</button><button class="btn" style="grid-column: span 2;" onclick="leaveRoom()">離開</button>`;
        });

        socket.on('battleReset', () => {
            log("--- 房間重置 ---");
            document.getElementById('lobby-overlay').style.display = 'flex';
            // 重置怪物圖片狀態
            const img = document.getElementById('monster-img');
            img.style.opacity = 1; 
            img.style.display = 'none'; // 等待下次更新顯示
            resetButtons(); isMyTurn = false;
        });

        socket.on('playerDead', () => { 
            log("你被打倒了..."); 
            showMsg(" 你已經死亡...");
            document.getElementById('btns').innerHTML = `<button class="btn" style="grid-column:span 2; background:red; color:white" onclick="window.location.href='rest.html'"> 去復活</button>`; 
        });
        
        socket.on('errorMessage', (msg) => { showMsg("❌ " + msg); });
        socket.on('battleLog', (msg) => log(msg));

        function requestStart() { socket.emit('startBattle', roomId); }
        
        function act(type) {
            if(!isMyTurn) return; 
            if (type === 'skill' && myPlayer.mp < 10) { showMsg("MP 不足 (需要 10)！"); return; }
            toggle(true); 
            socket.emit('combatAction', { roomId, type });
        }

        function openBag() {
            const btnArea = document.getElementById('btns');
            btnArea.innerHTML = '';
            
            // 這裡可以根據你想要顯示的物品做調整
            const itemsToShow = ['potion_hp', 'potion_mid', 'potion_high'];
            
            itemsToShow.forEach(itemId => {
                const count = (myPlayer.inventory && myPlayer.inventory[itemId]) || 0;
                if(count > 0) {
                    const potBtn = document.createElement('button');
                    potBtn.className = 'btn battle-action';
                    // 簡單的名稱對照，你也可以用 ITEM_NAMES 表
                    let name = '藥水';
                    if(itemId==='potion_hp') name='小水';
                    if(itemId==='potion_mid') name='中水';
                    if(itemId==='potion_high') name='大水';
                    
                    potBtn.innerText = `${name}(${count})`;
                    potBtn.onclick = () => { useItem(itemId); };
                    btnArea.appendChild(potBtn);
                }
            });

            const backBtn = document.createElement('button');
            backBtn.className = 'btn';
            backBtn.innerText = '返回';
            backBtn.onclick = resetButtons;
            btnArea.appendChild(backBtn);
        }

        function useItem(itemId) { socket.emit('useItem', { roomId, itemId }); resetButtons(); }
        function leaveRoom() { socket.emit('leaveRoom', roomId); window.location.href = 'hub.html'; }
        
        function toggle(disabled) { 
            document.querySelectorAll('.battle-action').forEach(b => {
                b.disabled = disabled;
                b.style.opacity = disabled ? "0.5" : "1";
            }); 
        }
        
        function resetButtons() {
            document.getElementById('btns').innerHTML = `
                <button class="btn battle-action" onclick="act('attack')">攻擊</button>
                <button class="btn battle-action" onclick="act('skill')">技能(10)</button>
                <button class="btn battle-action" onclick="openBag()">物品</button>
                <button class="btn" onclick="leaveRoom()">逃跑</button>
            `;
            toggle(!isMyTurn);
        }

        function log(m) { 
            const box = document.getElementById('log');
            box.innerHTML = `<div>> ${m}</div>` + box.innerHTML;
            const lines = box.querySelectorAll('div');
            if (lines.length > 20) for(let i=20; i<lines.length; i++) lines[i].remove();
        }
    </script>
</body>
</html>