<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ°é¬¥ä¸­ (Auto Ver0.8)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #111; font-family: 'Press Start 2P', monospace; 
            height: 100dvh; margin: 0; overflow: hidden; 
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; 
            padding: 10px 10px 50px 10px; box-sizing: border-box; overscroll-behavior: none;
        }
        #game-container { 
            width: 100%; max-width: 640px; height: 100%; 
            background: linear-gradient(135deg, #a8c0b0 50%, #789080 50%); 
            border: 4px solid #2c3e50; 
            /* ğŸŸ¢ èª¿æ•´é«˜åº¦ä½ˆå±€ä»¥å®¹ç´è‡ªå‹•æˆ°é¬¥é¢æ¿ */
            display: grid; grid-template-rows: 35px 30px 1.1fr 1fr 1.8fr; 
            position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); border-radius: 8px;
        }
        #turn-bar { background: #333; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; border-bottom: 4px solid #000; letter-spacing: 1px;}
        
        /* ğŸŸ¢ è‡ªå‹•æˆ°é¬¥é¢æ¿æ¨£å¼ */
        #auto-panel {
            background: rgba(0,0,0,0.85); color: #fff; display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; font-size: 10px; border-bottom: 2px solid #555;
        }

        .boss-area { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; padding: 5px 0; }
        .boss-sprite { 
            width: 90px; height: 90px; object-fit: contain; margin-bottom: 5px; 
            transition: transform 0.1s; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); 
            image-rendering: pixelated; 
        }
        .boss-info { width: 85%; text-align: center; }
        
        .player-area { display: flex; flex-direction: column; justify-content: center; padding: 0 10px; width: 100%; box-sizing: border-box; gap: 4px; }
        .my-status { width: 100%; box-sizing: border-box; padding: 5px; } 
        .teammates { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 2px;} 
        
        .gba-box { background: #f0f0d8; border: 4px solid #706870; border-radius: 8px; padding: 5px; color: #383838; font-size: 10px; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); }
        .mini-box { background: #ecf0f1; border: 2px solid #95a5a6; padding: 3px; font-size: 9px; color: #333; overflow: hidden; border-radius: 4px; }
        
        .hp-bar { width: 100%; height: 8px; background: #555; border: 2px solid #333; margin-top: 3px; border-radius: 2px; }
        .hp-fill { height: 100%; background: #48c058; transition: width 0.3s; }
        .mp-bar { width: 100%; height: 5px; background: #555; border: 2px solid #333; margin-top: 2px; border-radius: 2px; }
        .mp-fill { height: 100%; background: #3498db; transition: width 0.3s; }

        .mini-hp-bar { width: 100%; height: 4px; background: #555; margin-top: 2px; }
        .mini-hp-fill { height: 100%; background: #e74c3c; width: 100%; }
        .mini-mp-bar { width: 100%; height: 3px; background: #555; margin-top: 1px; }
        .mini-mp-fill { height: 100%; background: #3498db; width: 100%; }

        .stat-text { font-size: 9px; margin-top: 3px; font-weight: bold; }
        
        .hud { background: #305080; border-top: 4px solid #c8c8f8; display: flex; height: 100%; overflow: hidden; }
        .log { width: 40%; padding: 8px; color: white; font-size: 9px; line-height: 1.5; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-start; border-right: 2px solid rgba(255,255,255,0.1); }
        
        .menu { 
            width: 60%; display: flex; flex-direction: column; 
            background: #fff; border-left: 4px solid #c8c8f8; 
            padding: 5px; box-sizing: border-box; position: relative; 
        }
        
        #shortcut-area {
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px;
            margin-bottom: 5px; padding-bottom: 5px; border-bottom: 2px solid #ccc;
            flex-shrink: 0;
        }
        .btn-shortcut {
            background: #ecf0f1; border: 1px solid #bdc3c7; color: #2c3e50;
            font-size: 9px; padding: 8px 2px; cursor: pointer; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-family: inherit; font-weight: bold;
        }
        .btn-shortcut:active { background: #bdc3c7; transform: translateY(1px); }
        .btn-shortcut:disabled { opacity: 0.5; cursor: not-allowed; background: #95a5a6; }

        .fixed-top-area {
            flex-shrink: 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 5px;
            display: none; 
        }

        .scroll-area { 
            flex: 1; overflow-y: auto; 
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px; 
            align-content: start; padding-bottom: 5px;
        }

        .btn { 
            background: #f8f8f8; border: 2px solid #888; cursor: pointer; font-family: inherit; font-size: 11px; font-weight: bold; 
            text-align: center; display:flex; align-items:center; justify-content:center; border-radius: 6px; min-height: 42px;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        .btn:active { background: #f8d030; color: #000; transform: scale(0.98); }
        .btn:disabled { background: #999; color: #555; cursor: not-allowed; opacity: 0.6; }
        
        #lobby-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
        .player-list { border: 4px solid #fff; padding: 20px; width: 80%; min-height: 100px; text-align: left; margin-bottom: 30px; font-size: 14px; line-height: 2; overflow-y: auto; }
        
        .start-btn { display: none; padding: 15px 30px; font-size: 16px; background: #e74c3c; color: white; border: 4px solid #c0392b; cursor: pointer; font-family: inherit; }
        .start-btn:disabled { background: #7f8c8d; border-color: #555; cursor: wait; }
        
        #chat-container { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.95); border-top: 4px solid #bdc3c7; display: flex; flex-direction: column; font-size: 12px; z-index: 100; padding-bottom: env(safe-area-inset-bottom); transition: height 0.3s ease-in-out; height: 35px; }
        #chat-header { height: 35px; background: #34495e; color: #fff; line-height: 35px; cursor: pointer; font-weight: bold; border-bottom: 1px solid #555; display: flex; justify-content: center; align-items: center; touch-action: manipulation; }
        .chat-open { height: 30vh !important; }
        #chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-open #chat-body { display: flex; }
        #chat-history { flex: 1; overflow-y: auto; padding: 10px; text-align: left; color: white; }
        #chat-input-area { display: flex; border-top: 1px solid #555; height: 45px; }
        #chat-input { flex: 1; background: #222; color: white; border: none; padding: 0 15px; font-family: inherit; font-size: 14px; outline: none; }
        #chat-send { background: #2980b9; color: white; border: none; padding: 0 20px; cursor: pointer; font-family: inherit; font-size: 14px; font-weight: bold; touch-action: manipulation; }
        
        .shake { animation: shake 0.5s; } .flash { animation: flash 0.3s; }
        .damaged { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; filter: sepia(1) hue-rotate(-50deg) saturate(3) drop-shadow(0 0 10px red) !important; }
        @keyframes shake { 0%,100% {transform:translateX(0);} 25% {transform:translateX(-5px);} 75% {transform:translateX(5px);} }
        @keyframes flash { 0%,100% {filter:none;} 50% {filter:sepia(1) hue-rotate(-50deg) saturate(5);} }
        
        #game-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f; color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999; font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out; pointer-events: none; }

        #countdown-timer {
            position: absolute; top: 10px; right: 10px;
            color: #e74c3c; font-size: 10px; font-weight: bold;
            display: none;
            background: rgba(0,0,0,0.7); padding: 5px; border-radius: 4px;
        }

        #afk-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 99999; 
            flex-direction: column; justify-content: center; align-items: center;
        }
        .afk-box {
            background: #fff; color: #2c3e50; padding: 20px; border-radius: 10px; 
            border: 4px solid #e74c3c; text-align: center; max-width: 300px; width: 80%;
        }
        .afk-title { color: #c0392b; margin-top: 0; font-size: 16px; font-weight: bold; }
        .afk-desc { font-size: 10px; margin-bottom: 15px; color: #555; line-height: 1.5; }
        .afk-question { font-size: 20px; font-weight: bold; margin: 20px 0; color: #2980b9; word-break: break-all; }
        .afk-input { padding: 10px; font-size: 16px; width: 80%; text-align: center; margin-bottom: 10px; border: 2px solid #bdc3c7; border-radius: 5px; outline: none; }
        .afk-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; width: 100%; border-radius: 5px; font-family: inherit; }
    </style>
</head>
<body>
    <div id="game-toast"></div>
    
    <div id="afk-modal">
        <div class="afk-box">
            <div class="afk-title">âš ï¸ éˆé­‚æ‹·å• âš ï¸</div>
            <div class="afk-desc">ç³»çµ±åµæ¸¬åˆ°ä½ æ“ä½œéå¿«ï¼Œ<br>è«‹è­‰æ˜ä½ ä¸æ˜¯æ©Ÿå™¨äººï¼</div>
            <div id="afk-timer-display" style="color:red; font-weight:bold; margin-bottom:10px;">å‰©é¤˜æ™‚é–“: 60s</div>
            <div class="afk-question" id="afk-question">...</div>
            <input type="number" id="afk-answer" class="afk-input" placeholder="è¼¸å…¥æ•¸å­—ç­”æ¡ˆ">
            <button class="afk-btn" onclick="submitAfk()">ç¢ºèª</button>
        </div>
    </div>

    <div id="game-container">
        <div id="countdown-timer">âš ï¸ æ»…åœ˜å€’æ•¸: 09:00</div>

        <div id="lobby-overlay">
            <div style="color:#f1c40f; margin-bottom:20px; font-size:18px;">ç­‰å¾…éšŠå‹...</div>
            <div class="player-list" id="lobby-players">è®€å–ä¸­...</div>
            
            <div id="host-controls" style="margin-top: 20px;">
                <button class="start-btn" id="start-btn" onclick="requestStart()">æˆ¿ä¸»é–‹å§‹</button>
            </div>
            
            <div id="waiting-txt" style="margin-top:15px; font-size:12px; color:#aaa; display:none;">(ç­‰å¾…æˆ¿ä¸»...)</div>
            <button onclick="leaveRoom()" style="margin-top:20px; background:transparent; border:2px solid #aaa; color:#aaa; cursor:pointer; font-size:12px; padding:10px;">é›¢é–‹æˆ¿é–“</button>
        </div>
        
        <div id="turn-bar">ç­‰å¾…...</div>
        
        <div id="auto-panel">
            <div style="display:flex; gap:5px; align-items:center;">
                <span style="color:#aaa;">è·è²¬:</span>
                <select id="role-select" style="font-size:10px; padding:2px; background:#ddd; border:none; border-radius:2px;" onchange="updateRole()">
                    <option value="atk">âš”ï¸ è¼¸å‡º</option>
                    <option value="tank">ğŸ›¡ï¸ å¦å…‹</option>
                    <option value="heal">ğŸ’– è£œå¸«</option>
                </select>
            </div>
            <button id="auto-btn" onclick="toggleAuto()" style="background:#e74c3c; color:white; border:1px solid #555; font-size:10px; padding:4px 8px; cursor:pointer; border-radius:4px;">
                è‡ªå‹•: OFF
            </button>
        </div>
        
        <div class="boss-area">
            <img id="monster-img" class="boss-sprite" src="" onerror="this.style.display='none'" alt="Monster">
            <div class="gba-box boss-info">
                <div id="monster-name" style="font-size:12px; font-weight:bold; margin-bottom:3px;">...</div>
                <div class="hp-bar"><div id="mhp" class="hp-fill" style="width:100%"></div></div>
                <div id="mhp-txt" class="stat-text" style="text-align:right; font-size:9px;">...</div>
            </div>
        </div>
        
        <div class="player-area">
            <div class="gba-box my-status">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:3px;">
                    <span style="font-size:11px; font-weight:bold;"><span id="my-name">å‹‡è€…</span>(ä½ )</span>
                    <span style="font-size:9px; color:#f1c40f;">âš”ï¸<span id="atk-val">0</span> ğŸ›¡ï¸<span id="def-val">0</span></span>
                </div>
                <div class="hp-bar"><div id="php" class="hp-fill" style="width:100%"></div></div>
                <div class="mp-bar"><div id="pmp" class="mp-fill" style="width:100%"></div></div>
                <div style="font-size: 9px; margin-top: 3px; text-align:right;" id="hp-txt">...</div>
            </div>
            
            <div class="teammates" id="teammates-box"></div>
        </div>
        
        <div class="hud">
            <div class="log" id="log"><div>æº–å‚™æˆ°é¬¥...</div></div>
            <div class="menu" id="menu-container">
                
                <div id="shortcut-area"></div>

                <div id="fixed-top-area" class="fixed-top-area">
                    <button class="btn" style="width:100%; background:#ddd; color:#555;" onclick="resetButtons()">â—€ è¿”å›é¸å–®</button>
                </div>

                <div id="btns" class="scroll-area">
                    <button class="btn battle-action" onclick="act('attack')">æ”»æ“Š</button>
                    <button class="btn battle-action" onclick="openSkill()">é­”æ³•</button>
                    <button class="btn battle-action" onclick="openBag()">ç‰©å“</button>
                    <button class="btn" onclick="leaveRoom()">é€ƒè·‘</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="chat-container">
        <div id="chat-header" onclick="toggleChat()"> èŠå¤©å®¤ (é»æ“Šå±•é–‹)</div>
        <div id="chat-body">
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." maxlength="50">
                <button id="chat-send">ç™¼é€</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
            transports: ['websocket', 'polling'],
            secure: true 
        });

        // ğŸŸ¢ 3. æ–°å¢è‡ªå‹•æˆ°é¬¥å…¨åŸŸè®Šæ•¸
        let isAuto = false;
        let myRole = 'atk';
        let allPlayers = []; // å„²å­˜å…¨éšŠè³‡æ–™

        let isMyTurn = false; 
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get('room');
        let myPlayer = { mp: 0, hp: 0, maxMp: 100, maxHp: 100, skills: ['fireball'] };
        let lastMonsterHp = -1;
        let currentMonsterLevel = 0;
        let currentMonsterName = "";
        let battleTimer = null;
        let timeLeft = 540;

        let myShortcuts = []; 
        try {
            const saved = localStorage.getItem('rpg_shortcuts');
            if (saved) { myShortcuts = JSON.parse(saved); }
        } catch(e) { console.error("è®€å–å¿«æ·éµå¤±æ•—", e); myShortcuts = []; }

        const SKILL_INFO = {
            'fireball':      { name: "ç«çƒè¡“", mp: 5, cat: 'atk', desc: "å‚·x1.5" },
            'thunder':       { name: "é›·æ“Š",   mp: 15, cat: 'atk', desc: "å‚·x1.2+æšˆ" },
            'poison_touch': { name: "åŠ‡æ¯’ä¹‹è§¸", mp: 25, cat: 'atk', desc: "å‚·x2.5" },
            'frost_nova':    { name: "å†°éœœæ–°æ˜Ÿ", mp: 30, cat: 'atk', desc: "å‚·x1.2+é™é˜²" },
            'meteor':        { name: "éš•çŸ³è¡“",   mp: 80, cat: 'atk', desc: "å‚·x3.5" },
            'divine_slash': { name: "æ¬¡å…ƒæ–¬",   mp: 150, cat: 'atk', desc: "å‚·x5.0" },
            'drain':         { name: "å¸è¡€",     mp: 20, cat: 'atk', desc: "å¸è¡€100%" },
            'void_crush':    { name: "è™›ç©ºç¢æ“Š", mp: 1000, cat: 'atk', desc: "å‚·x10" },
            'big_bang':      { name: "å®‡å®™å¤§çˆ†ç‚¸", mp: 5000, cat: 'atk', desc: "å‚·x25" },
            'entropy_decay':{ name: "ç†±å¯‚Â·è¡°è®Š", mp: 2500, cat: 'atk', desc: "5%çœŸå‚·" },
            'holy_shield':  { name: "è–å…‰å®ˆè­·", mp: 40, cat: 'buff', desc: "é˜²ç¦¦x2" },
            'berserk':       { name: "ç‹‚æš´",     mp: 60, cat: 'buff', desc: "æ”»x2(è‡ªæ®˜)" },
            'god_mode':      { name: "å¤©ç¥ä¸‹å‡¡", mp: 300, cat: 'buff', desc: "å…¨èƒ½x3" },
            'heal_light':    { name: "å°å›å¾©",   mp: 10, cat: 'heal', desc: "HP+20%" },
            'god_light':     { name: "ç¥ä¹‹å…‰",   mp: 50, cat: 'heal', desc: "HP+50%" },
            'heal_all':      { name: "è–å…‰æ™®ç…§", mp: 100, cat: 'heal', desc: "å…¨éšŠæ»¿HP" },
            'full_heal':     { name: "å¤§å¤©ä½¿æ¯", mp: 200, cat: 'heal', desc: "HPå…¨æ»¿" }
        };

        const ITEM_NAMES = {
            'potion_hp': 'ç´…æ°´(å°)', 'potion_mid': 'ç´…æ°´(ä¸­)', 'potion_high': 'ç´…æ°´(å¤§)', 'potion_max': 'ç§˜è—¥', 'elixir': 'ç”˜éœ²',
            'potion_mp': 'è—æ°´(å°)', 'potion_mp_mid': 'è—æ°´(ä¸­)', 'potion_mp_high': 'è—æ°´(å¤§)',
            'grilled_carp': 'çƒ¤é¯‰é­š', 'salmon_sushi': 'é®­é­šå£½å¸', 'tuna_steak': 'é®ªé­šæ’', 
            'eel_rice': 'é°»é­šé£¯', 'void_soup': 'è™›ç©ºæ¹¯', 'sushi_plate': 'å£½å¸æ‹¼ç›¤'
        };

        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) { window.location.href = 'index.html'; }
        if (!roomId && roomId !== 'world_boss') { 
            showMsg("ç„¡æ•ˆçš„æˆ¿é–“ï¼"); setTimeout(()=>window.location.href = 'hub.html', 1000); 
        }

        socket.on('connect', () => {
            socket.emit('joinGame', myToken); 
            setTimeout(() => {
                if (roomId === 'world_boss') {
                    socket.emit('connectToBossRoom');
                    document.getElementById('turn-bar').innerText = "ğŸ”¥ ä¸–ç•Œ BOSS è¨ä¼æˆ° ğŸ”¥";
                    document.getElementById('turn-bar').style.background = "#c0392b";
                    document.getElementById('teammates-box').style.display = 'none'; 
                    document.getElementById('lobby-overlay').style.display = 'none';
                    document.getElementById('countdown-timer').style.display = 'block'; 
                } else {
                    socket.emit('connectToRoom', roomId);
                }
            }, 100);
        });

        socket.on('afkCheck', (data) => {
            document.getElementById('afk-question').innerText = data.question;
            document.getElementById('afk-answer').value = ''; 
            document.getElementById('afk-modal').style.display = 'flex';
            let timeLeftAfk = data.timeout || 60;
            const timerDisplay = document.getElementById('afk-timer-display');
            if (afkInterval) clearInterval(afkInterval);
            afkInterval = setInterval(() => {
                timeLeftAfk--; timerDisplay.innerText = `å‰©é¤˜æ™‚é–“: ${timeLeftAfk}s`;
                if (timeLeftAfk <= 0) { clearInterval(afkInterval); }
            }, 1000);
        });

        socket.on('afkSuccess', () => {
            document.getElementById('afk-modal').style.display = 'none';
            if (afkInterval) clearInterval(afkInterval);
            resetButtons(); toggle(false); 
            log(`<span style="color:#2ecc71">é©—è­‰é€šéï¼è«‹ç¹¼çºŒæˆ°é¬¥ã€‚</span>`);
        });

        function submitAfk() {
            const ans = document.getElementById('afk-answer').value;
            if (ans === '') return;
            socket.emit('afkResponse', parseInt(ans));
            document.getElementById('afk-modal').style.display = 'none';
            if (afkInterval) clearInterval(afkInterval);
        }

        setInterval(() => { if (socket.connected) socket.emit('heartbeat'); }, 20000);
        socket.on('disconnect', () => { showMsg("âš ï¸ èˆ‡ä¼ºæœå™¨é€£ç·šä¸­æ–·..."); });

        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text; t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        function appendChat(name, msg) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.innerHTML = `<span style="color:#f1c40f; font-weight:bold;">[${name}]:</span> ${msg}`;
            history.appendChild(div); history.scrollTop = history.scrollHeight;
        }

        socket.on('chatHistory', (history) => {
            const box = document.getElementById('chat-history');
            box.innerHTML = ''; 
            history.forEach(data => appendChat(data.name, data.msg));
        });
        socket.on('chatMessage', (data) => { appendChat(data.name, data.msg); });

        document.getElementById('chat-send').onclick = sendChat;
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (msg) { socket.emit('sendChat', msg); input.value = ''; }
        }
        function toggleChat() {
            const chat = document.getElementById('chat-container');
            chat.classList.toggle('chat-open');
            document.getElementById('chat-header').innerText = chat.classList.contains('chat-open') ? " æ”¶èµ·" : " èŠå¤©å®¤ (é»æ“Šå±•é–‹)";
        }

        socket.on('worldBossSync', (data) => {
            if (!data.active) {
                showMsg("BOSS å·²è¢«æ“Šæ•—ï¼"); setTimeout(() => window.location.href = 'hub.html', 3000);
                return;
            }
            document.getElementById('monster-name').innerText = data.name;
            const hpPct = (data.hp / data.maxHp) * 100;
            document.getElementById('mhp').style.width = hpPct + '%';
            document.getElementById('mhp-txt').innerText = `${(data.hp/100000000).toFixed(2)}å„„`;
            const img = document.getElementById('monster-img');
            const bossSrc = "img/monsters/entropy_god.png"; 
            if (!img.src.includes(bossSrc)) { img.src = bossSrc; img.style.display = 'block'; }
            if (data.remainingTime !== undefined) {
                const serverTimeSec = Math.floor(data.remainingTime / 1000);
                if (Math.abs(timeLeft - serverTimeSec) > 2 || !battleTimer) {
                    timeLeft = serverTimeSec;
                    if (!battleTimer) startCountdown(); 
                    else updateTimerDisplay();
                }
            }
        });

        socket.on('roomInfoUpdate', (info) => {
            // ğŸŸ¢ 4. å„²å­˜éšŠå‹è³‡æ–™ä»¥ä¾› AI ä½¿ç”¨
            allPlayers = info.players;

            const amIHost = (info.host === socket.id);
            const lobbyList = document.getElementById('lobby-players');
            lobbyList.innerHTML = ''; 
            info.players.forEach(p => {
                const row = document.createElement('div');
                row.style.display = "flex"; row.style.justifyContent = "space-between"; row.style.alignItems = "center";
                row.style.padding = "5px 0"; row.style.borderBottom = "1px dashed #555"; row.style.fontSize = "12px";
                let kickBtn = (amIHost && p.id !== socket.id) ? `<button onclick="kickMember('${p.id}', '${p.name}')" style="background:#c0392b; color:white; border:1px solid #e74c3c; cursor:pointer; font-size:10px; padding:2px 5px; margin-left:10px;">è¸¢</button>` : '';
                row.innerHTML = `<span>${p.name} (LV.${p.level})</span> ${kickBtn}`;
                lobbyList.appendChild(row);
            });
            const overlay = document.getElementById('lobby-overlay');
            if (info.status === 'fighting') { overlay.style.display = 'none'; document.getElementById('countdown-timer').style.display = 'block'; }
            else { if (info.monsterHp <= 0) overlay.style.display = 'none'; else overlay.style.display = 'flex'; }
            document.getElementById('monster-name').innerText = info.monsterName;
            const img = document.getElementById('monster-img');
            if (info.monsterKey) {
                const newSrc = `img/monsters/${info.monsterKey}.png`;
                if (!img.src.includes(newSrc)) { img.src = newSrc; img.style.display = 'block'; }
            }
            const teammatesBox = document.getElementById('teammates-box');
            teammatesBox.innerHTML = '';
            info.players.forEach(p => {
                if (p.id !== socket.id) { 
                    const div = document.createElement('div');
                    div.className = 'mini-box'; div.style.position = 'relative'; div.style.overflow = 'visible'; 
                    const hpPct = (p.hp / p.maxHp) * 100; const mpPct = (p.mp / p.maxMp) * 100;
                    div.innerHTML = `<div style="white-space:nowrap; overflow:hidden; font-weight:bold;">${p.name}</div><div class="mini-hp-bar"><div class="mini-hp-fill" style="width:${hpPct}%; background:${hpPct<30?'red':'#2ecc71'}"></div></div><div class="mini-mp-bar"><div class="mini-mp-fill" style="width:${mpPct}%;"></div></div>`;
                    teammatesBox.appendChild(div);
                }
            });
            
            const startBtn = document.getElementById('start-btn');
            const waitTxt = document.getElementById('waiting-txt');
            if (amIHost) {
                startBtn.style.display = 'block';
                startBtn.disabled = false;
                startBtn.innerText = `é–‹å§‹ (${info.players.length}äºº)`;
                waitTxt.style.display = 'none';
            } else {
                startBtn.style.display = 'none';
                waitTxt.style.display = 'block';
            }
        });

        socket.on('battleStarted', () => { document.getElementById('lobby-overlay').style.display = 'none'; log("æˆ°é¬¥é–‹å§‹ï¼"); startCountdown(); });

        function startCountdown() {
            const timerDiv = document.getElementById('countdown-timer');
            timerDiv.style.display = 'block'; if (battleTimer) clearInterval(battleTimer);
            updateTimerDisplay();
            battleTimer = setInterval(() => { timeLeft--; updateTimerDisplay(); if (timeLeft <= 0) { clearInterval(battleTimer); timerDiv.innerText = "â˜ ï¸ æ™‚é–“åˆ°ï¼"; } }, 1000);
        }

        function updateTimerDisplay() {
            const timerDiv = document.getElementById('countdown-timer');
            const min = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const sec = (timeLeft % 60).toString().padStart(2, '0');
            timerDiv.innerText = `âš ï¸ æ»…åœ˜å€’æ•¸: ${min}:${sec}`;
        }

        socket.on('turnUpdate', (data) => {
            const bar = document.getElementById('turn-bar'); 
            if (roomId === 'world_boss') return; 
            
            if (data.currentId === 'monster') { 
                isMyTurn = false; 
                bar.innerText = "âš ï¸ æ€ªç‰©å›åˆ..."; 
                bar.style.background = "#c0392b"; 
                toggle(true); 
            }
            else if (data.currentId === socket.id) { 
                isMyTurn = true; 
                bar.innerText = "âš”ï¸ ä½ çš„å›åˆ"; 
                bar.style.background = "#2ecc71"; // ç¶ è‰²
                toggle(false); 

                // ğŸŸ¢ 5. è¼ªåˆ°æˆ‘æ™‚ï¼Œå¦‚æœé–‹å•Ÿè‡ªå‹•ï¼Œè§¸ç™¼ AI
                if (isAuto) {
                    log(`<span style="color:#f39c12">ğŸ¤– è‡ªå‹•æˆ°é¬¥ä¸­...</span>`);
                    autoPlayLogic();
                }
            }
            else { 
                isMyTurn = false; 
                bar.innerText = `â³ ${data.name}`; 
                bar.style.background = "#333"; 
                toggle(true); 
            }
        });

        socket.on('monsterUpdate', (m) => {
            if (roomId === 'world_boss') return;
            document.getElementById('monster-name').innerText = `LV.${m.level} ${m.name}`;
            document.getElementById('mhp').style.width = (m.hp / m.maxHp * 100) + '%';
            document.getElementById('mhp-txt').innerText = `HP: ${m.hp}/${m.maxHp}`;
            const img = document.getElementById('monster-img');
            if (lastMonsterHp !== -1 && m.hp < lastMonsterHp) { img.classList.remove('damaged'); void img.offsetWidth; img.classList.add('damaged'); }
            lastMonsterHp = m.hp;
        });

        socket.on('playerStatsUpdate', (p) => {
            myPlayer = p;
            document.getElementById('my-name').innerText = p.name || "å‹‡è€…";
            document.getElementById('php').style.width = (p.hp / p.maxHp * 100) + '%';
            document.getElementById('pmp').style.width = (p.mp / p.maxMp * 100) + '%';
            document.getElementById('hp-txt').innerText = `HP:${p.hp}/${p.maxHp}  MP:${p.mp}/${p.maxMp}`;
            if(document.getElementById('atk-val')) document.getElementById('atk-val').innerText = p.atk;
            if(document.getElementById('def-val')) document.getElementById('def-val').innerText = p.def;
            updateShortcutStates(p);
        });

        function updateShortcutStates(p) {
            const area = document.getElementById('shortcut-area');
            const skillsOwned = p.skills || []; 
            if (myShortcuts.length === 0 && skillsOwned.length > 0) {
                myShortcuts = skillsOwned.slice(0, 4); localStorage.setItem('rpg_shortcuts', JSON.stringify(myShortcuts));
            }
            area.innerHTML = '';
            let validShortcuts = myShortcuts.filter(sid => skillsOwned.includes(sid));
            if (validShortcuts.length < 4) {
                skillsOwned.forEach(sid => { if (!validShortcuts.includes(sid) && validShortcuts.length < 4) validShortcuts.push(sid); });
            }
            myShortcuts = validShortcuts; localStorage.setItem('rpg_shortcuts', JSON.stringify(myShortcuts));
            myShortcuts.forEach(sid => {
                const info = SKILL_INFO[sid];
                if(info) {
                    const btn = document.createElement('button');
                    btn.className = 'btn-shortcut'; btn.setAttribute('data-mp', info.mp); btn.setAttribute('data-sid', sid);
                    btn.innerHTML = `${info.name} <span style="color:#2980b9">(${info.mp})</span>`;
                    btn.onclick = () => { useSkill(sid); }; area.appendChild(btn);
                }
            });
            const btns = area.querySelectorAll('.btn-shortcut');
            btns.forEach(btn => {
                const cost = parseInt(btn.getAttribute('data-mp'));
                if (p.mp < cost) { btn.disabled = true; btn.style.opacity = "0.5"; }
                else if (isMyTurn || roomId === 'world_boss') { btn.disabled = false; btn.style.opacity = "1"; }
            });
        }

        socket.on('battleWon', (data) => {
            if (battleTimer) clearInterval(battleTimer);
            document.getElementById('countdown-timer').style.display = 'none';
            const bar = document.getElementById('turn-bar'); bar.innerText = " å‹åˆ©ï¼"; bar.style.background = "gold"; bar.style.color = "black";
            const img = document.getElementById('monster-img'); img.style.opacity = 0;
            showMsg(`å‹åˆ©ï¼ç²å¾— ${data.gold} G`); showNormalVictoryBtn();
            if (data.rewards) data.rewards.forEach(reward => log(`<span style="color:#9b59b6; font-weight:bold;">ğŸ ç²å¾—: [${reward}]</span>`));
            
            // æˆ°é¬¥çµæŸï¼Œé—œé–‰è‡ªå‹•
            if(isAuto) toggleAuto();
        });

        // ğŸŸ¢ [ä¿®æ­£] å‹åˆ©æŒ‰éˆ• (å¢åŠ  z-index é˜²æ­¢è¢«æ“‹ï¼Œèˆ‡æ›´æ˜é¡¯çš„æ¨£å¼)
        function showNormalVictoryBtn() {
            const btnArea = document.getElementById('btns');
            
            // å¼·åˆ¶éš±è—å…¶ä»–é¸å–®
            document.getElementById('fixed-top-area').style.display = 'none'; 
            document.getElementById('shortcut-area').style.display = 'none'; 
            
            // è¨­å®šæŒ‰éˆ•å€
            btnArea.style.gridTemplateColumns = '1fr'; 
            btnArea.innerHTML = `
                <button class="btn" 
                    style="
                        background: linear-gradient(to bottom, #f1c40f, #f39c12); 
                        color: #000; 
                        font-weight: bold; 
                        font-size: 16px; 
                        border: 3px solid #fff; 
                        box-shadow: 0 0 15px rgba(241, 196, 15, 0.8);
                        z-index: 9999; 
                        position: relative;
                        height: 60px;
                    " 
                    onclick="leaveRoom()">
                    ğŸ† æˆ°é¬¥å‹åˆ© (é»æ“Šé›¢é–‹)
                </button>
            `;
        }

        // ğŸŸ¢ [ä¿®æ­£] é›¢é–‹æˆ¿é–“ (æ›´å¼·åˆ¶çš„è·³è½‰)
        function leaveRoom() { 
            // 1. é€šçŸ¥ä¼ºæœå™¨ (å³ä½¿ä¼ºæœå™¨æ²’åæ‡‰ï¼Œå‰ç«¯ä¹Ÿè¦èµ°)
            if (socket && socket.connected) {
                socket.emit('leaveRoom', roomId); 
            }

            // 2. é¡¯ç¤ºæç¤º
            const btn = document.querySelector('#btns button');
            if(btn) btn.innerText = "æ­£åœ¨å›åˆ°å¤§å»³...";

            // 3. å¼·åˆ¶è·³è½‰ (ä½¿ç”¨ replace é¿å…æŒ‰ä¸Šä¸€é åˆå›åˆ°æˆ°é¬¥)
            setTimeout(() => {
                window.location.replace('hub.html');
            }, 300); 
        }

        socket.on('playerDead', () => { 
            if (battleTimer) clearInterval(battleTimer); document.getElementById('countdown-timer').style.display = 'none';
            log("ä½ è¢«æ‰“å€’äº†..."); showMsg("ğŸ‘» ä½ å·²ç¶“æ­»äº¡..."); 
            document.getElementById('btns').innerHTML = `<button class="btn" style="grid-column:span 2; background:red; color:white" onclick="window.location.href='rest.html'"> å»å¾©æ´»</button>`;
            document.getElementById('fixed-top-area').style.display = 'none'; document.getElementById('shortcut-area').style.display = 'none';
            if(isAuto) toggleAuto();
        });

        socket.on('errorMessage', (msg) => { showMsg("âŒ " + msg); });
        socket.on('battleLog', (msg) => log(msg));
        
        socket.on('roomLeft', () => {
            if (battleTimer) clearInterval(battleTimer);
            showMsg("ä½ é›¢é–‹äº†æˆ¿é–“");
            setTimeout(() => { window.location.href = 'hub.html'; }, 1000);
        });

        function requestStart() { socket.emit('startBattle', roomId); }
        
        function act(type) {
            if (roomId === 'world_boss') { toggle(true); socket.emit('worldBossAction', { type: 'attack' }); setTimeout(() => toggle(false), 500); }
            else { if(!isMyTurn) return; toggle(true); socket.emit('combatAction', { roomId, type }); }
        }

        function kickMember(targetId, targetName) {
            if (event) event.stopPropagation();
            if (confirm(`ç¢ºå®šè¦è¸¢é™¤ [${targetName}] å—ï¼Ÿ`)) { socket.emit('kickMember', targetId); }
        }

        function openSkill() {
            const btnArea = document.getElementById('btns');
            const fixedArea = document.getElementById('fixed-top-area');
            const shortcutArea = document.getElementById('shortcut-area'); 
            
            btnArea.innerHTML = ''; 
            fixedArea.style.display = 'block'; 
            shortcutArea.style.display = 'none'; 
            
            btnArea.style.gridTemplateColumns = '1fr';

            const mySkills = myPlayer.skills || ['fireball'];
            const sortOrder = { 'atk': 1, 'buff': 2, 'heal': 3 };
            mySkills.sort((a, b) => {
                const catA = SKILL_INFO[a] ? SKILL_INFO[a].cat : 'atk';
                const catB = SKILL_INFO[b] ? SKILL_INFO[b].cat : 'atk';
                if (sortOrder[catA] === sortOrder[catB]) {
                    const mpA = SKILL_INFO[a] ? SKILL_INFO[a].mp : 0;
                    const mpB = SKILL_INFO[b] ? SKILL_INFO[b].mp : 0;
                    return mpA - mpB;
                }
                return (sortOrder[catA] || 4) - (sortOrder[catB] || 4);
            });

            mySkills.forEach(skillId => {
                const info = SKILL_INFO[skillId];
                if (info) {
                    const btn = document.createElement('button');
                    btn.className = 'btn battle-action'; 
                    btn.style.fontSize = '12px'; btn.style.display = 'flex'; btn.style.justifyContent = 'space-between'; btn.style.alignItems = 'center'; btn.style.padding = '0 15px'; btn.style.minHeight = '45px'; 
                    let nameColor = "#333";
                    if (info.cat === 'heal') nameColor = "#27ae60";
                    if (info.cat === 'buff') nameColor = "#e67e22";
                    if (skillId === 'void_crush' || skillId === 'big_bang' || skillId === 'entropy_decay') nameColor = "#8e44ad"; 

                    btn.innerHTML = `<div style="font-weight:bold; color:${nameColor};">${info.name}</div><div style="text-align:right; font-size:10px;"><div style="color:#3498db; margin-bottom:2px;">MP-${info.mp}</div><div style="color:#7f8c8d;">${info.desc}</div></div>`;

                    if (myPlayer.mp < info.mp) { btn.disabled = true; btn.style.opacity = 0.5; }
                    btn.onclick = () => { useSkill(skillId); };
                    btnArea.appendChild(btn);
                }
            });
        }

        function openBag() {
            const btnArea = document.getElementById('btns');
            const fixedArea = document.getElementById('fixed-top-area');
            const shortcutArea = document.getElementById('shortcut-area'); 
            
            btnArea.innerHTML = ''; 
            fixedArea.style.display = 'block'; 
            shortcutArea.style.display = 'none'; 
            
            btnArea.style.gridTemplateColumns = '1fr 1fr'; 
            
            const itemsToShow = [
                'potion_hp', 'potion_mid', 'potion_high', 'potion_max', 'elixir', 
                'potion_mp', 'potion_mp_mid', 'potion_mp_high',
                'grilled_carp', 'salmon_sushi', 'tuna_steak', 'eel_rice', 'void_soup', 'sushi_plate'
            ];
            let hasItem = false;
            itemsToShow.forEach(itemId => {
                const count = (myPlayer.inventory && myPlayer.inventory[itemId]) || 0;
                if(count > 0) {
                    hasItem = true;
                    const potBtn = document.createElement('button');
                    potBtn.className = 'btn battle-action';
                    potBtn.style.fontSize = '10px'; 
                    const name = ITEM_NAMES[itemId] || 'ç‰©å“';
                    potBtn.innerText = `${name}(${count})`;
                    potBtn.onclick = () => { useItem(itemId); };
                    btnArea.appendChild(potBtn);
                }
            });
            if(!hasItem) { btnArea.innerHTML = '<div style="grid-column:span 2; font-size:12px; padding:10px;">èƒŒåŒ…æ²’æœ‰è£œçµ¦å“</div>'; }
        }

        function resetButtons() {
            const btnArea = document.getElementById('btns');
            const fixedArea = document.getElementById('fixed-top-area');
            const shortcutArea = document.getElementById('shortcut-area'); 

            fixedArea.style.display = 'none'; 
            shortcutArea.style.display = 'grid'; 

            btnArea.style.gridTemplateColumns = '1fr 1fr';
            btnArea.innerHTML = `
                <button class="btn battle-action" onclick="act('attack')">æ”»æ“Š</button>
                <button class="btn battle-action" onclick="openSkill()">é­”æ³•</button>
                <button class="btn battle-action" onclick="openBag()">ç‰©å“</button>
                <button class="btn" onclick="leaveRoom()">é€ƒè·‘</button>
            `;
            if (roomId === 'world_boss') { toggle(false); } else { toggle(!isMyTurn); }
        }

        function useSkill(skillId) {
            const info = SKILL_INFO[skillId];
            if (info && myPlayer.mp < info.mp) { showMsg("MP ä¸è¶³ï¼"); return; }
            const existingIndex = myShortcuts.indexOf(skillId);
            if (existingIndex === -1) {
                myShortcuts.unshift(skillId);
                if (myShortcuts.length > 4) { myShortcuts.pop(); }
                localStorage.setItem('rpg_shortcuts', JSON.stringify(myShortcuts));
                updateShortcutStates(myPlayer);
            }
            if (roomId === 'world_boss') {
                toggle(true); socket.emit('worldBossAction', { type: 'skill', skillId: skillId });
                const img = document.getElementById('monster-img');
                img.classList.remove('shake'); void img.offsetWidth; img.classList.add('shake');
                setTimeout(() => toggle(false), 500);
            } else {
                if(!isMyTurn) return; 
                toggle(true); socket.emit('combatAction', { roomId, type: 'skill', skillId: skillId });
                const img = document.getElementById('monster-img');
                img.classList.remove('shake'); void img.offsetWidth; img.classList.add('shake');
            }
        }

        function useItem(itemId) {
            if (roomId === 'world_boss') {
               showMsg("BOSS æˆ°ç„¡æ³•ä½¿ç”¨é“å…·ï¼"); resetButtons();
            } else {
                if(!isMyTurn) return; 
                toggle(true); socket.emit('combatAction', { roomId, type: 'item', itemId: itemId }); 
                resetButtons();
            }
        }

        function toggle(disabled) { 
            document.querySelectorAll('.battle-action').forEach(b => {
                b.disabled = disabled; b.style.opacity = disabled ? "0.5" : "1";
            }); 
            const area = document.getElementById('shortcut-area');
            const btns = area.querySelectorAll('.btn-shortcut');
            btns.forEach(btn => {
                const cost = parseInt(btn.getAttribute('data-mp'));
                if (myPlayer.mp < cost) { btn.disabled = true; btn.style.opacity = "0.5"; }
                else { btn.disabled = disabled; btn.style.opacity = disabled ? "0.5" : "1"; }
            });
        }

        function log(m) { 
            const box = document.getElementById('log'); const div = document.createElement('div');
            div.innerHTML = `> ${m}`; box.insertBefore(div, box.firstChild); 
            const lines = box.querySelectorAll('div');
            if (lines.length > 20) for(let i=20; i<lines.length; i++) lines[i].remove();
        }

        // ==========================================
        // ğŸŸ¢ 6. è‡ªå‹•æˆ°é¬¥ AI é‚è¼¯ (æ™ºèƒ½ç‰©å“èˆ‡å¦å…‹å¾ªç’°ç‰ˆ)
        // ==========================================
        
        // æŠ€èƒ½å„ªå…ˆç´š (ç¶­æŒä¸è®Š)
        const SKILL_PRIORITY = {
            atk: [
                'big_bang', 'entropy_decay', 'void_crush',
                'divine_slash', 'meteor',
                'poison_touch', 'frost_nova',
                'thunder', 'drain', 'fireball'
            ],
            tank: [
                'god_mode',
                'holy_shield',
                'divine_slash', 'poison_touch', 'drain'
            ],
            heal: [
                'heal_all', 'full_heal', 'god_light', 'heal_light'
            ]
        };

        // ğŸŸ¢ å®šç¾©ç‰©å“æ¸…å–®ï¼šä¾å›å¾©é‡ã€Œç”±å¼·åˆ°å¼±ã€æ’åº
        const ITEMS_HP_DESC = [
            'void_soup', 'elixir', 'potion_max',    // ç¥ç´š/å…¨æ»¿ (Lv100+)
            'potion_high',                          // å¤§ç´… +2000
            'sushi_plate', 'tuna_steak', 'potion_mid', // ä¸­ç´…/æ‹¼ç›¤ +500
            'eel_rice',                             // é°»é­š +300
            'grilled_carp', 'potion_hp'             // å°ç´… +50~100
        ];

        const ITEMS_MP_DESC = [
            'void_soup',                            // å…¨æ»¿
            'potion_mp_high',                       // å¤§è— +500
            'potion_mp_mid', 'eel_rice',            // ä¸­è—/é°»é­š +100
            'salmon_sushi', 'potion_mp'             // å°è— +30~50
        ];

        function toggleAuto() {
            isAuto = !isAuto;
            const btn = document.getElementById('auto-btn');
            
            // é‡ç½®å¦å…‹è¨ˆæ•¸å™¨
            tankAttackCounter = 0; 

            if (isAuto) {
                btn.innerText = "è‡ªå‹•: ON";
                btn.style.background = "#2ecc71"; 
                btn.style.border = "1px solid #27ae60";
                if (isMyTurn) autoPlayLogic(); 
            } else {
                btn.innerText = "è‡ªå‹•: OFF";
                btn.style.background = "#e74c3c"; 
                btn.style.border = "1px solid #555";
            }
        }

        function updateRole() {
            myRole = document.getElementById('role-select').value;
        }

        function autoPlayLogic() {
            if (!isAuto || !isMyTurn) return;

            const delay = Math.random() * 700 + 800;
            
            setTimeout(() => {
                if (!isMyTurn || roomId === 'world_boss') { 
                    if(roomId === 'world_boss' && isAuto) {
                        socket.emit('worldBossAction', { type: 'attack' });
                        return;
                    }
                    if(!isMyTurn) return;
                }

                const myHpPct = (myPlayer.hp / myPlayer.maxHp) * 100;
                
                // [1] ç·Šæ€¥è‡ªä¿ (æ‰€æœ‰è·è²¬é€šç”¨)
                // è¡€é‡ < 40% æ™‚ï¼Œå„ªå…ˆå–æ°´
                if (myHpPct < 40) {
                    if (recoverStat('hp')) return;
                    // æ²’æ°´æ‰è©¦æŠ€èƒ½
                    if (attemptSkill('full_heal')) return;
                    if (attemptSkill('god_light')) return;
                    if (attemptSkill('heal_light')) return;
                }

                // [2] æ ¹æ“šè·è²¬åŸ·è¡Œé‚è¼¯
                switch (myRole) {
                    case 'heal': // ğŸ’– è£œå¸«æ¨¡å¼
                        const teamNeedHeal = allPlayers.some(p => (p.hp / p.maxHp) < 0.6);
                        
                        if (teamNeedHeal) {
                            for (let skill of SKILL_PRIORITY.heal) {
                                if (attemptSkill(skill)) return;
                            }
                        } 
                        if (attemptSkill('divine_slash')) return;
                        if (attemptSkill('thunder')) return;
                        break;

                    case 'tank': // ğŸ›¡ï¸ å¦å…‹æ¨¡å¼ (2å›åˆæ”»æ“Šå¾ªç’°)
                        if (tankAttackCounter > 0) {
                            tankAttackCounter--; 
                            if (attemptSkill('divine_slash')) return;
                            if (attemptSkill('poison_touch')) return;
                            if (attemptSkill('drain')) return;
                        } else {
                            // å„ªå…ˆé–‹å¤©ç¥
                            if (attemptSkill('god_mode')) {
                                tankAttackCounter = 2; return;
                            }
                            if (attemptSkill('holy_shield')) {
                                tankAttackCounter = 2; return;
                            }
                            // æ²’buffæŠ€èƒ½å°±æ”»æ“Š
                            if (attemptSkill('divine_slash')) return;
                            if (attemptSkill('poison_touch')) return;
                        }
                        break;

                    case 'atk': // âš”ï¸ è¼¸å‡ºæ¨¡å¼
                    default:
                        for (let skill of SKILL_PRIORITY.atk) {
                            if (attemptSkill(skill)) return;
                        }
                        break;
                }

                // [3] ä¿åº•ï¼šæ™®é€šæ”»æ“Š
                doNormalAttack();

            }, delay);
        }

        // --- ğŸŸ¢ æ™ºèƒ½è¼”åŠ©å‡½å¼ (ä¿®æ­£ç‰ˆ) ---

        function attemptSkill(skillId) {
            if (!myPlayer.skills || !myPlayer.skills.includes(skillId)) return false;
            
            const info = SKILL_INFO[skillId];
            if (!info) return false;

            if (myPlayer.mp >= info.mp) {
                useSkill(skillId);
                return true;
            } else {
                // MP ä¸è¶³ -> æ‰¾æ°´å–
                if (recoverStat('mp')) {
                    return true; 
                }
                return false;
            }
        }

        // ğŸŸ¢ [æ ¸å¿ƒä¿®æ”¹] æ™ºèƒ½å–æ°´é‚è¼¯ (å«è™›ç©ºæ¹¯ç‰¹æ®Šåˆ¤æ–·)
        function recoverStat(type) {
            const hpPct = myPlayer.hp / myPlayer.maxHp;
            const mpPct = myPlayer.mp / myPlayer.maxMp;
            
            // åˆ¤æ–·æ˜¯å¦ç‚º "é›™é‡å±æ€¥" (HP å’Œ MP éƒ½ < 30%)
            const isCriticalEmergency = (hpPct < 0.3 && mpPct < 0.3);

            // æ ¹æ“šé¡å‹é¸æ“‡åˆ—è¡¨
            // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘éœ€è¦ä¸€å€‹ "æ’é™¤ void_soup" çš„åˆ—è¡¨ï¼Œå’Œä¸€å€‹ "åªæœ‰ void_soup" çš„æª¢æŸ¥
            const fullList = (type === 'hp') ? ITEMS_HP_DESC : ITEMS_MP_DESC;
            
            // ç­–ç•¥è®Šæ›´ï¼š
            // 1. å¦‚æœæ˜¯é›™é‡å±æ€¥ -> å…è¨±ä½¿ç”¨ void_soup (ä½†ä¸ä¸€å®šæ˜¯ç¬¬ä¸€å€‹ï¼Œçœ‹åˆ—è¡¨æ’åº)
            // 2. å¦‚æœåªæ˜¯å–®é …å±æ€¥ -> è·³é void_soupï¼Œå…ˆæ‰¾å…¶ä»–è—¥æ°´
            
            let targetList = [];

            if (type === 'hp' ? hpPct < 0.4 : mpPct < 0.4) {
                // å±æ€¥æ¨¡å¼ï¼šä½¿ç”¨åŸåˆ—è¡¨ (å¼· -> å¼±)
                targetList = [...fullList];
            } else {
                // è£œçµ¦æ¨¡å¼ï¼šåè½‰åˆ—è¡¨ (å¼± -> å¼·)
                targetList = [...fullList].reverse();
            }

            // éæ­·èƒŒåŒ…å°‹æ‰¾å¯ç”¨ç‰©å“
            for (let itemId of targetList) {
                // æª¢æŸ¥èƒŒåŒ…æœ‰ç„¡æ­¤ç‰©å“
                if (myPlayer.inventory && myPlayer.inventory[itemId] > 0) {
                    
                    // ğŸŸ¢ ç‰¹æ®Šåˆ¤æ–·ï¼šå¦‚æœæ˜¯è™›ç©ºæ¹¯ (void_soup)
                    if (itemId === 'void_soup') {
                        // åªæœ‰åœ¨ "é›™é‡å±æ€¥" æ™‚æ‰å…è¨±ç›´æ¥ä½¿ç”¨
                        if (isCriticalEmergency) {
                            useItem(itemId);
                            return true;
                        } else {
                            // å¦‚æœä¸æ˜¯é›™é‡å±æ€¥ï¼Œå…ˆè·³éå®ƒï¼Œç¹¼çºŒæ‰¾ä¸‹ä¸€å€‹ç‰©å“
                            // é™¤é... èƒŒåŒ…è£¡çœŸçš„åªå‰©ä¸‹è™›ç©ºæ¹¯äº†ï¼Œå…¶ä»–éƒ½æ²’äº†ï¼Ÿ
                            // ç‚ºäº†æ›´åš´è¬¹çš„çœéŒ¢é‚è¼¯ï¼Œé€™è£¡é¸æ“‡ "è·³é"ï¼Œå¯§é¡˜ä¸‹ä¸€å›åˆå†åˆ¤æ–·ï¼Œä¹Ÿä¸è¦å–®è£œä¸€é …å°±å–ç¥æ¹¯
                            continue; 
                        }
                    }

                    // æ™®é€šç‰©å“ -> ç›´æ¥ä½¿ç”¨
                    useItem(itemId);
                    return true;
                }
            }
            
            // å¦‚æœè·‘åˆ°é€™è£¡ï¼Œä»£è¡¨ï¼š
            // 1. èƒŒåŒ…å…¨ç©º
            // 2. æˆ–è€…åªå‰©ä¸‹ void_soup ä½†æ¢ä»¶ä¸ç¬¦ (ä¸æ˜¯é›™é‡å±æ€¥)
            
            // ğŸŸ¢ ä¿åº•æ©Ÿåˆ¶ï¼šå¦‚æœçœŸçš„åªå‰©ä¸‹ void_soup ä¸”éå¸¸å±æ€¥ (ä¾‹å¦‚ HP < 10%)ï¼Œé‚„æ˜¯å–äº†å§
            if (myPlayer.inventory && myPlayer.inventory['void_soup'] > 0) {
                if (type === 'hp' && hpPct < 0.1) {
                    useItem('void_soup');
                    return true;
                }
            }

            return false;
        }

        function doNormalAttack() {
            const aliveMobs = currentMonsters.filter(m => m.hp > 0);
            const targetId = aliveMobs.length > 0 ? aliveMobs[0].id : null;
            socket.emit('combatAction', { roomId, type: 'attack', targetId: targetId });
        }

    </script>
</body>
</html>
