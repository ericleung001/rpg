<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¹¸é‹å½©ç¥¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 20px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .header { color: #f1c40f; margin-bottom: 20px; text-shadow: 2px 2px #000; }
        
        .jackpot-box {
            background: #c0392b; padding: 15px; border-radius: 10px; border: 4px solid #e74c3c;
            margin-bottom: 20px; width: 100%; max-width: 500px; box-sizing: border-box;
            box-shadow: 0 0 20px #e74c3c;
        }
        .jackpot-title { font-size: 12px; margin-bottom: 10px; }
        .jackpot-amount { font-size: 20px; font-weight: bold; color: #f1c40f; word-break: break-all; }

        .number-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
            max-width: 500px; margin-bottom: 20px;
        }
        .ball {
            width: 35px; height: 35px; border-radius: 50%;
            background: #ecf0f1; color: #2c3e50;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: bold; cursor: pointer;
            border: 2px solid #bdc3c7; user-select: none;
            transition: transform 0.1s;
        }
        .ball:active { transform: scale(0.9); }
        .ball.selected { background: #e74c3c; color: white; border-color: #fff; box-shadow: 0 0 10px #e74c3c; }

        .selected-info { font-size: 12px; margin-bottom: 15px; color: #aaa; }
        .buy-btn {
            background: #27ae60; color: white; padding: 15px 30px; font-family: inherit; font-size: 14px;
            border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 4px 0 #1e8449;
        }
        .buy-btn:active { transform: translateY(4px); box-shadow: none; }
        
        .back-btn { margin-top: 20px; background: #7f8c8d; padding: 10px 20px; color: white; text-decoration: none; border-radius: 5px; font-size: 12px; display: inline-block;}

        /* å½©ç¥¨åˆ—è¡¨æ¨£å¼ */
        .my-tickets-area {
            width: 100%; max-width: 500px; margin-top: 30px;
            text-align: left;
        }
        .section-title { font-size: 12px; color: #3498db; margin-bottom: 10px; border-bottom: 1px dashed #555; padding-bottom: 5px; display: flex; justify-content: space-between; }
        
        .ticket-row {
            background: rgba(0,0,0,0.3); padding: 8px; margin-bottom: 5px; border-radius: 5px;
            display: flex; align-items: center; justify-content: space-between;
            border-left: 4px solid #aaa;
        }
        /* ä¸­ççš„ç¥¨æœƒæœ‰é‡‘é‚Š */
        .ticket-row.winner { border-left: 4px solid #f1c40f; background: rgba(241, 196, 15, 0.1); }

        .ticket-nums { font-size: 10px; color: #fff; letter-spacing: 1px; flex: 1; margin-left: 10px; }
        .ticket-tag { font-size: 8px; color: #aaa; width: 20px; }
        .win-tag { font-size: 8px; color: #f1c40f; font-weight: bold; }

        /* ä¸­çè™Ÿç¢¼é«˜äº® */
        .num-hit { color: #f1c40f; font-weight: bold; text-decoration: underline; }

        .last-result {
            margin-top: 30px; border-top: 1px dashed #7f8c8d; padding-top: 10px; font-size: 10px; color: #bdc3c7; width: 100%; max-width: 500px;
        }
        .result-balls { display: flex; gap: 5px; justify-content: center; margin-top: 10px; }
        .res-ball { width: 30px; height: 30px; border-radius: 50%; background: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

    <h1 class="header">ğŸ± å…­åˆå½©</h1>

    <div class="jackpot-box">
        <div class="jackpot-title">æœ¬æœŸç´¯ç©çé‡‘</div>
        <div class="jackpot-amount" id="jackpot-display">Loading...</div>
        <div style="font-size:10px; margin-top:5px;">æ¯æ™š 22:00 é–‹ç</div>
    </div>

    <div class="selected-info">
        å·²é¸è™Ÿç¢¼: <span id="count">0</span> / 6
        <br><br>
        <span id="selected-nums" style="color:#f1c40f; min-height: 20px; display:block;">-</span>
    </div>

    <div class="number-grid" id="grid"></div>

    <button class="buy-btn" onclick="buyTicket()">è³¼è²·å½©ç¥¨ (1è¬ G)</button>

    <div class="my-tickets-area">
        <div class="section-title"><span>ğŸ“¥ æœ¬æœŸå·²è³¼</span> <span id="my-ticket-count">0</span></div>
        <div id="my-ticket-list">
            <div style="font-size:10px; color:#aaa; padding:10px;">å°šæœªè³¼è²·</div>
        </div>
    </div>

    <div class="my-tickets-area" id="history-section" style="display:none; opacity: 0.8;">
        <div class="section-title" style="color:#e74c3c;"><span>ğŸ“‹ ä¸ŠæœŸæ ¸å°</span></div>
        <div id="history-list"></div>
    </div>

    <div class="last-result" id="last-result-area" style="display:none;">
        ä¸Šæ¬¡é–‹ççµæœ:
        <div class="result-balls" id="res-balls"></div>
    </div>

    <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>

    <script src="socket.io.js"></script>
    <script>
const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let selected = [];
        let lastResultNums = []; // å­˜ä¸ŠæœŸè™Ÿç¢¼ç”¨ä¾†æ¯”å°

        // åˆå§‹åŒ– 49 å€‹è™Ÿç¢¼çƒ
        const grid = document.getElementById('grid');
        for(let i=1; i<=49; i++) {
            const ball = document.createElement('div');
            ball.className = 'ball';
            ball.innerText = i;
            ball.onclick = () => toggleNumber(i, ball);
            grid.appendChild(ball);
        }

        function toggleNumber(n, el) {
            if (selected.includes(n)) {
                selected = selected.filter(x => x !== n);
                el.classList.remove('selected');
            } else {
                if (selected.length >= 6) { alert("æœ€å¤šåªèƒ½é¸ 6 å€‹è™Ÿç¢¼ï¼"); return; }
                selected.push(n);
                el.classList.add('selected');
            }
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('count').innerText = selected.length;
            document.getElementById('selected-nums').innerText = selected.sort((a,b)=>a-b).join(', ');
        }

        function buyTicket() {
            if (selected.length !== 6) { alert("è«‹é¸æ“‡ 6 å€‹è™Ÿç¢¼ï¼"); return; }
            if (!confirm(`ç¢ºå®šè¦èŠ±è²» 10,000 G è³¼è²·è™Ÿç¢¼ [${selected.join(',')}] å—ï¼Ÿ`)) return;
            
            socket.emit('buyLottery', selected);
        }

        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
        });

        socket.on('playerStatsUpdate', (p) => {
            // ç¢ºä¿æ¯æ¬¡æ›´æ–°éƒ½è«‹æ±‚æœ€æ–°å½©ç¥¨è³‡æ–™ (ä»¥é˜²é–‹çå¾Œæ²’åˆ·æ–°)
            socket.emit('getLotteryInfo');
        });

        socket.on('lotteryUpdate', (data) => {
            document.getElementById('jackpot-display').innerText = `$ ${data.jackpot.toLocaleString()}`;
            
            // 1. æ›´æ–°ä¸Šæ¬¡é–‹ççµæœ
            if (data.lastResult) {
                lastResultNums = data.lastResult; // å­˜èµ·ä¾†æ¯”å°
                document.getElementById('last-result-area').style.display = 'block';
                const container = document.getElementById('res-balls');
                container.innerHTML = '';
                data.lastResult.forEach(n => {
                    const b = document.createElement('div');
                    b.className = 'res-ball';
                    b.innerText = n;
                    container.appendChild(b);
                });
            }

            // 2. æ›´æ–°æœ¬æœŸå·²è³¼åˆ—è¡¨
            if (data.myBets) {
                const list = document.getElementById('my-ticket-list');
                const count = document.getElementById('my-ticket-count');
                count.innerText = data.myBets.length;
                list.innerHTML = '';

                if (data.myBets.length === 0) {
                    list.innerHTML = '<div style="font-size:10px; color:#aaa; padding:10px;">å°šæœªè³¼è²·</div>';
                } else {
                    data.myBets.forEach((nums, idx) => {
                        const div = document.createElement('div');
                        div.className = 'ticket-row';
                        const fmtNums = nums.map(n => n.toString().padStart(2, '0')).join(' - ');
                        div.innerHTML = `<span class="ticket-tag">#${idx + 1}</span><span class="ticket-nums">${fmtNums}</span>`;
                        list.appendChild(div);
                    });
                }
            }

            // 3. ğŸŸ¢ æ›´æ–°ä¸ŠæœŸæ ¸å°åˆ—è¡¨ (æœ‰æ¯”å°åŠŸèƒ½)
            if (data.myLastBets && data.myLastBets.length > 0) {
                document.getElementById('history-section').style.display = 'block';
                const histList = document.getElementById('history-list');
                histList.innerHTML = '';

                data.myLastBets.forEach((bet, idx) => {
                    const div = document.createElement('div');
                    // å¦‚æœä¸­çï¼ŒåŠ ä¸Š winner class
                    const isWinner = bet.prize > 0;
                    div.className = isWinner ? 'ticket-row winner' : 'ticket-row';

                    // ç”¢ç”Ÿè™Ÿç¢¼ HTMLï¼Œå¦‚æœè™Ÿç¢¼åœ¨é–‹ççµæœä¸­ï¼Œè®Šè‰²é¡¯ç¤º
                    const numsHtml = bet.nums.map(n => {
                        const isHit = lastResultNums.includes(n);
                        const style = isHit ? 'class="num-hit"' : '';
                        return `<span ${style}>${n.toString().padStart(2,'0')}</span>`;
                    }).join(' - ');

                    let resultText = '<span style="color:#aaa;">æœªä¸­ç</span>';
                    if (isWinner) {
                        resultText = `<span class="win-tag">${bet.winMsg} (+$${bet.prize.toLocaleString()})</span>`;
                    } else if (bet.hits > 0) {
                        resultText = `<span style="color:#777; font-size:8px;">ä¸­${bet.hits}å€‹å­—</span>`;
                    }

                    div.innerHTML = `
                        <span class="ticket-tag">#${idx + 1}</span>
                        <span class="ticket-nums">${numsHtml}</span>
                        ${resultText}
                    `;
                    histList.appendChild(div);
                });
            }
        });

        socket.on('lotteryResult', (res) => {
            alert(res.msg);
            if(res.success) {
                selected = [];
                document.querySelectorAll('.ball').forEach(b => b.classList.remove('selected'));
                updateDisplay();
            }
        });

        socket.on('errorMessage', (msg) => { alert(msg); });

    </script>
</body>
</html>
