<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å†’éšªè€…å…¬æœƒv3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body { 
            background-color: #2c3e50; color: #ecf0f1; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; 
            display: flex; flex-direction: column; align-items: center; 
            height: 100dvh; 
            margin: 0; padding: 10px; box-sizing: border-box; 
            overflow: hidden; 
            overscroll-behavior: none;
            user-select: none; -webkit-user-select: none;
        }

        /* ğŸŸ¢ Loading é®ç½©å±¤ */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; 
            z-index: 99999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #fff; border-top: 4px solid #f1c40f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* é ‚éƒ¨åˆ— */
        .top-bar { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; height: 30px;}
        .logout-btn { font-size: 10px; color: #e74c3c; cursor: pointer; text-decoration: underline; white-space: nowrap; padding: 5px; }
        h1 { font-size: 16px; margin: 0; white-space: nowrap; }
        #conn-status { font-size: 10px; padding: 5px 8px; background: #333; border: 1px solid #fff; border-radius: 6px; white-space: nowrap; display: flex; align-items: center; gap: 5px; }

        /* ç‹€æ…‹æ¬„ */
        .status-bar { 
            background: #34495e; border: 3px solid #fff; padding: 10px; 
            width: 100%; max-width: 600px; margin-bottom: 10px; border-radius: 12px; 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: left; 
            font-size: 10px; box-sizing: border-box;
        }
        .stat-row { color: #f1c40f; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .val { color: white; float: right; font-weight: bold; }
        .exp-bar { width: 100%; height: 6px; background: #555; margin-top: 3px; border: 1px solid #fff; border-radius: 4px; }
        .exp-fill { height: 100%; background: #3498db; width: 0%; transition: width 0.3s; }
        
        .main-content {
            width: 100%; max-width: 600px;
            flex: 1; 
            display: flex; flex-direction: column;
            overflow: hidden; 
            margin-bottom: 40px; 
        }

        /* è¨­æ–½æŒ‰éˆ•ç¶²æ ¼ */
        .facility-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 4px; 
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px dashed #7f8c8d; 
        }
        
        .facility-btn {
            padding: 0; 
            font-family: inherit; 
            font-size: 10px; 
            font-weight: bold;
            cursor: pointer; 
            border: 2px solid #bdc3c7; color: white; text-decoration: none; 
            display: flex; align-items: center; justify-content: center;
            background: #34495e; 
            border-radius: 6px;
            height: 38px; 
            white-space: nowrap; 
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3); 
            
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent; 
            transition: transform 0.05s;
        }
        .facility-btn:active { transform: scale(0.95); box-shadow: none; filter: brightness(0.9); }
        
        .map-container {
            flex: 1; overflow-y: auto; padding-right: 5px;
            -webkit-overflow-scrolling: touch; 
        }

        /* åœ°åœ–å€åŸŸæŒ‰éˆ• */
        .btn { 
            padding: 12px 8px; font-family: inherit; font-size: 12px; cursor: pointer; 
            border: 2px solid #bdc3c7; color: white; text-decoration: none; 
            display: block; text-shadow: 1px 1px 0 #000; background: #34495e; 
            position: relative; text-align: left; margin-bottom: 8px; border-radius: 6px;
            
            touch-action: manipulation; 
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.05s, background-color 0.1s; 
        }
        
        .btn:active { 
            transform: scale(0.98); 
            filter: brightness(0.8); 
            background: #2980b9; 
        }

        .locked { background: #555; color: #888; border-color: #555; pointer-events: none; }
        
        .info-tag { float: right; font-size: 10px; color: #f1c40f; margin-top: 2px; }
        .room-tag { font-size: 9px; padding: 2px 4px; border-radius: 4px; float: right; margin-left: 5px; }
        .status-waiting { background: #27ae60; color: white; }
        .status-fighting { background: #c0392b; color: white; }
        
        /* èŠå¤©å®¤ */
        #chat-container {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.95); border-top: 4px solid #bdc3c7;
            display: flex; flex-direction: column; font-size: 10px; z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            transition: height 0.3s ease-in-out;
            height: 30px; 
        }
        
        #chat-header {
            height: 30px; background: #34495e; color: #fff; line-height: 30px; 
            cursor: pointer; font-weight: bold; border-bottom: 1px solid #555;
            display: flex; justify-content: center; align-items: center;
            touch-action: manipulation;
        }
        #chat-header:hover { background: #2c3e50; }

        .chat-open { height: 40vh !important; }
        #chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-open #chat-body { display: flex; } 

        #chat-history { flex: 1; overflow-y: auto; padding: 8px; text-align: left; color: white; }
        #chat-input-area { display: flex; border-top: 1px solid #555; height: 40px; }
        #chat-input { flex: 1; background: #222; color: white; border: none; padding: 0 10px; font-family: inherit; font-size: 12px; outline: none; }
        #chat-send { background: #2980b9; color: white; border: none; padding: 0 15px; cursor: pointer; font-family: inherit; font-size: 12px; font-weight: bold; touch-action: manipulation; }

        /* é€šçŸ¥å½ˆçª— */
        #toast-notification {
            position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
            background: #f1c40f; color: #000; border: 3px solid #fff;
            padding: 10px 20px; border-radius: 30px; font-size: 12px; font-weight: bold;
            box-shadow: 0 6px 15px rgba(0,0,0,0.6); z-index: 1000;
            transition: top 0.5s ease-in-out; white-space: nowrap;
        }

        /* ğŸŸ¢ å…¬å‘Šç³»çµ±æ¨£å¼ */
        #notice-btn {
            position: fixed; top: 50px; left: 10px;
            width: 40px; height: 40px;
            background: #e67e22; border: 2px solid #fff;
            border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; z-index: 90;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        #notice-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .notice-box {
            background: #fff; color: #2c3e50;
            width: 85%; max-width: 400px;
            border: 4px solid #f1c40f; border-radius: 10px;
            padding: 20px; text-align: left;
            font-family: 'Press Start 2P', monospace;
            max-height: 70vh; overflow-y: auto;
        }
        .notice-title { font-size: 16px; color: #d35400; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .notice-content { font-size: 10px; line-height: 1.8; white-space: pre-wrap; }
        .close-notice-btn {
            margin-top: 20px; width: 100%; padding: 10px;
            background: #34495e; color: white; border: none; border-radius: 5px;
            cursor: pointer; font-family: inherit; font-size: 12px;
        }

    </style>
</head>
<body>
    
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-size:12px; margin-top:10px;">æ­£åœ¨è®€å–ç©å®¶è³‡æ–™...</div>
        <div style="font-size:10px; color:#95a5a6; margin-top:5px;">(è«‹ç¨å€™)</div>
    </div>

    <div id="toast-notification"> è¨Šæ¯æç¤º</div>

    <div id="notice-btn" onclick="openNotice()">ğŸ“¢</div>

    <div id="notice-modal">
        <div class="notice-box">
            <div class="notice-title">ğŸ“œ å…¬æœƒå…¬å‘Š</div>
            <div class="notice-content">
<b style="color:#c0392b;">ã€æœ€æ–°æ›´æ–° v2.0ã€‘</b>
1. æ–°å¢ä¸–ç•Œåœ°åœ–èˆ‡å€åŸŸæ€ªç‰©
2. é–‹æ”¾äº¤æ˜“å¸‚é›†èˆ‡æ‹è³£è¡Œ
3. æ–°å¢è£å‚™èˆ‡è£½ä½œç³»çµ±
4. æå‡ç­‰ç´šä¸Šé™è‡³ Lv.100

<b style="color:#2980b9;">ã€æ´»å‹•é€šçŸ¥ã€‘</b>
ğŸ”¥ é€±æœ«ç¶“é©—å€¼åŠ å€æ´»å‹•é–‹å•Ÿï¼
è«‹å„ä½å†’éšªè€…æŠŠæ¡æ©Ÿæœƒå‡ç´šã€‚

<b style="color:#27ae60;">ã€ç¶­è­·æé†’ã€‘</b>
æ¯æ—¥å‡Œæ™¨ 04:00 é€²è¡Œç³»çµ±å‚™ä»½ã€‚
            </div>
            <button class="close-notice-btn" onclick="closeNotice()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="logout-btn" onclick="logout()">ç™»å‡º</div>
        <h1> å…¬æœƒå¤§å»³</h1>
        <div id="conn-status" style="color:#e74c3c"> æœªé€£ç·š</div>
    </div>
    
    <div class="status-bar">
        <div class="stat-row">Name <span id="pid" class="val">...</span></div>
        <div class="stat-row">LV <span id="lvl" class="val">1</span></div>
        <div class="stat-row">é‡‘ <span id="gold" class="val">0</span></div>
        <div class="stat-row">HP <span id="hp" class="val">...</span></div>
        <div class="stat-row">MP <span id="mp" class="val" style="color:#3498db">...</span></div>
        <div class="stat-row"></div>
        <div style="grid-column: span 3;">
            EXP <span id="exp-txt" style="font-size:8px; float:right">0/100</span>
            <div class="exp-bar"><div id="exp-fill" class="exp-fill"></div></div>
        </div>
    </div>

    <div class="main-content">
        <div class="section-title" style="text-align:left; font-size:10px; color:#aaa; margin-bottom:5px;">åŸé®è¨­æ–½</div>
        
        <div class="facility-grid">
            <a href="bag.html" class="facility-btn" style="background:#16a085; border-color:#1abc9c;">ğŸ’ èƒŒåŒ…</a>
            <a href="equip.html" class="facility-btn" style="background:#8e44ad; border-color:#9b59b6;">ğŸ›¡ï¸ è£å‚™</a>
            <a href="market.html" class="facility-btn" style="background:#f39c12; border-color:#d35400;">ğŸª é“å…·</a>
            <a href="auction.html" class="facility-btn" style="background:#2980b9; border-color:#3498db;">âš–ï¸ å¸‚é›†</a>
            <a href="smithy.html" class="facility-btn" style="background:#c0392b; border-color:#e74c3c;">ğŸ”¨ é›é€ </a>
            <a href="gathering.html" class="facility-btn" style="background:#27ae60; border-color:#2ecc71;">ğŸŒ² æ¡é›†</a>
            <a href="rest.html" class="facility-btn" style="background:#2c3e50; border-color:#95a5a6;">ğŸ¨ æ—…é¤¨</a>
            <a href="kitchen.html" class="facility-btn" style="background:#e67e22; border-color:#d35400;">ğŸ³ å»šæˆ¿</a>
        </div>

        <div id="list-title" style="text-align:left; font-size:10px; color:#aaa; margin-bottom:5px;">ä¸–ç•Œåœ°åœ–</div>
        <div class="map-container" id="map-list">
            <div class="btn locked">è®€å–ä¸­...</div>
        </div>
    </div>

    <div id="chat-container">
        <div id="chat-header" onclick="toggleChat()"> å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)</div>
        <div id="chat-body">
            <div id="chat-history"></div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." maxlength="50">
                <button id="chat-send">ç™¼é€</button>
            </div>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
        // ğŸŸ¢ Loading æ§åˆ¶ (3.5ç§’å¼·åˆ¶å†·å»)
        window.addEventListener('load', () => {
            setTimeout(() => {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 500);
            }, 3500); // 3.5ç§’
        });

        const _0x5a1b = "aHR0cHM6Ly9ycGdnYW1lc2VyLmNj"; 
        const BACKEND_URL = atob(_0x5a1b);
        
        const socket = io(BACKEND_URL, {
            transports: ['websocket', 'polling'],
            secure: true 
        });
        let myLevel = 1;
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) { window.location.href = 'index.html'; }

        // ğŸŸ¢ å…¬å‘ŠåŠŸèƒ½
        function openNotice() {
            document.getElementById('notice-modal').style.display = 'flex';
        }
        function closeNotice() {
            document.getElementById('notice-modal').style.display = 'none';
        }

        // åœ°åœ–è¨­å®š
        const WORLD_MAP = [
            { 
                id: 'city_1', name: 'æ›™å…‰å¹³åŸ', reqLv: 1, desc: 'å†’éšªçš„èµ·é» (Lv.1-20)', 
                monsters: [
                    { id: 'slime', name: 'å²èŠå§†', lv: 1 }, 
                    { id: 'rat', name: 'å¤§è€é¼ ', lv: 3 },
                    { id: 'bee', name: 'æ®ºäººèœ‚', lv: 5 },
                    { id: 'boar', name: 'é‡è±¬', lv: 8 },
                    { id: 'thief', name: 'ç›œè³Š', lv: 12 },
                    { id: 'wolf_king', name: 'ğŸº ç‹¼ç‹ (BOSS)', lv: 15 }
                ] 
            },
            { 
                id: 'city_2', name: 'è¿·éœ§æ²¼æ¾¤', reqLv: 1, desc: 'å……æ»¿æ¯’æ°£èˆ‡äº¡éˆ (Lv.20-40)', 
                monsters: [
                    { id: 'snake', name: 'æ¯’è›‡', lv: 22 }, 
                    { id: 'zombie', name: 'è…å±', lv: 25 },
                    { id: 'skeleton', name: 'éª·é«å…µ', lv: 28 },
                    { id: 'ghoul', name: 'é£Ÿå±é¬¼', lv: 32 },
                    { id: 'witch', name: 'æ²¼æ¾¤å¥³å·«', lv: 35 },
                    { id: 'hydra', name: 'ğŸ ä¹é ­è›‡ (BOSS)', lv: 40 }
                ] 
            },
            { 
                id: 'city_3', name: 'ç¼ç†±å³½è°·', reqLv: 1, desc: 'çƒˆç«èˆ‡ç†”å²© (Lv.40-60)', 
                monsters: [
                    { id: 'fire_imp', name: 'ç«ç„°å°é¬¼', lv: 42 }, 
                    { id: 'lava_golem', name: 'ç†”å²©æˆˆä¾–', lv: 45 },
                    { id: 'salamander', name: 'ç«èœ¥èœ´', lv: 48 },
                    { id: 'fire_mage', name: 'çƒˆç„°æ³•å¸«', lv: 52 },
                    { id: 'dragon_hatchling', name: 'å¹¼é¾', lv: 55 },
                    { id: 'balrog', name: 'ğŸ”¥ ç‚é­” (BOSS)', lv: 60 }
                ] 
            },
            { 
                id: 'city_4', name: 'æ¥µå¯’å‡åœŸ', reqLv: 1, desc: 'æ°¸å†¬ä¹‹åœ° (Lv.60-80)', 
                monsters: [
                    { id: 'snow_wolf', name: 'é›ªåŸç‹¼', lv: 62 }, 
                    { id: 'yeti', name: 'é›ªäºº', lv: 65 },
                    { id: 'ice_spirit', name: 'å†°ç²¾éˆ', lv: 68 },
                    { id: 'frost_knight', name: 'å¯’éœœé¨å£«', lv: 72 },
                    { id: 'ice_dragon', name: 'å†°éœœé¾', lv: 75 },
                    { id: 'lich_king', name: 'â„ï¸ å·«å¦–ç‹ (BOSS)', lv: 80 }
                ] 
            },
            { 
                id: 'city_5', name: 'è™›ç©ºè¦å¡', reqLv: 1, desc: 'æ¥è¿‘é­”ç•Œçš„åœ°æ–¹ (Lv.80-100)', 
                monsters: [
                    { id: 'void_eye', name: 'è™›ç©ºä¹‹çœ¼', lv: 82 }, 
                    { id: 'shadow_assassin', name: 'æš—å½±åˆºå®¢', lv: 85 },
                    { id: 'dark_paladin', name: 'å¢®è½è–é¨', lv: 88 },
                    { id: 'demon_guard', name: 'æƒ¡é­”å®ˆè¡›', lv: 92 },
                    { id: 'succubus', name: 'é­…é­”', lv: 95 },
                    { id: 'void_lord', name: 'ğŸ‘ï¸ è™›ç©ºé ˜ä¸» (BOSS)', lv: 99 }
                ] 
            },
            { 
                id: 'city_6', name: 'é­”ç•Œç‹åº§', reqLv: 1, desc: 'â˜ ï¸ æœ€çµ‚æ±ºæˆ° (Lv.100+)', 
                monsters: [
                    { id: 'chaos_beast', name: 'æ··æ²Œå·¨ç¸', lv: 105 },
                    { id: 'fallen_angel', name: 'å¢®å¤©ä½¿', lv: 110 },
                    { id: 'demon_king', name: 'ğŸ‘‘ é­”ç‹æ’’æ—¦ (FINAL)', lv: 150 }
                ] 
            }
        ];

        let currentView = 'cities'; 
        let selectedCity = null;
        let selectedMonster = null;
        let cityData = {}; 
        let activeRooms = []; 

        socket.on('connect', () => {
            const status = document.getElementById('conn-status');
            status.innerHTML = " å·²é€£ç·š";
            status.style.color = "#2ecc71";
            
            // ğŸŸ¢ éš¨æ©Ÿå»¶é² (Random Jitter)
            // å»¶é² 100ms ~ 1500ms å¾Œå†ç™¼é€è«‹æ±‚ï¼ŒéŒ¯é–‹æµé‡
            const delay = Math.floor(Math.random() * 1400) + 100;
            console.log(`[ç³»çµ±] éš¨æ©Ÿå»¶é²: ${delay}ms`);
            
            setTimeout(() => {
                socket.emit('joinGame', myToken);
            }, delay);
        });

        socket.on('disconnect', () => {
            const status = document.getElementById('conn-status');
            status.innerHTML = " æ–·ç·š...";
            status.style.color = "#e74c3c";
        });

        socket.on('playerStatsUpdate', (p) => {
            myLevel = p.level;
            document.getElementById('pid').innerText = p.name || "Unknown";
            document.getElementById('lvl').innerText = p.level;
            document.getElementById('gold').innerText = p.gold;
            document.getElementById('hp').innerText = `${p.hp}/${p.maxHp}`;
            document.getElementById('mp').innerText = `${p.mp}/${p.maxMp}`;
            document.getElementById('exp-txt').innerText = `${p.exp}/${p.maxExp}`;
            document.getElementById('exp-fill').style.width = (p.exp / p.maxExp * 100) + '%';
            refreshUI();
        });

        socket.on('hubDataUpdate', (data) => {
            cityData = data.cityCounts;
            activeRooms = data.roomsList;
            refreshUI(); 
        });

        socket.on('marketResult', (res) => { if (res.success) { showToast(res.msg); } });
        socket.on('bagResult', (res) => { if (res.success) { showToast(res.msg); } });

        function showToast(msg) {
            const toast = document.getElementById('toast-notification');
            toast.innerText = msg;
            toast.style.top = "30px"; 
            setTimeout(() => { toast.style.top = "-60px"; }, 3000);
        }

        socket.on('roomJoined', (data) => { 
            const roomId = data.roomId || data; 
            window.location.href = `battle.html?room=${roomId}`; 
        });
        
        socket.on('errorMessage', (msg) => { alert("âŒ " + msg); });

        // --- èŠå¤©é‚è¼¯ ---
        socket.on('chatHistory', (history) => {
            const box = document.getElementById('chat-history');
            box.innerHTML = ''; 
            history.forEach(data => appendChat(data.name, data.msg));
        });

        socket.on('chatMessage', (data) => {
            appendChat(data.name, data.msg);
        });

        function appendChat(name, msg) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            
            const nameSpan = document.createElement('span');
            nameSpan.style.color = '#f1c40f';
            nameSpan.style.fontWeight = 'bold';
            nameSpan.textContent = `[${name}]: `;

            const msgNode = document.createTextNode(msg);

            div.appendChild(nameSpan);
            div.appendChild(msgNode);
            
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        document.getElementById('chat-send').onclick = sendChat;
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (msg) { socket.emit('sendChat', msg); input.value = ''; }
        }

        function toggleChat() {
            const chat = document.getElementById('chat-container');
            chat.classList.toggle('chat-open');
            const header = document.getElementById('chat-header');
            if(chat.classList.contains('chat-open')) {
                header.innerText = " é»æ“Šæ”¶èµ·";
            } else {
                header.innerText = " å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)";
            }
        }

        window.logout = function() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('rpg_token');
                window.location.href = 'index.html';
            }
        };

        // ğŸŸ¢ å®šç¾©ä¸€å€‹è®Šæ•¸ä¾†é–å®šæŒ‰éˆ•
        let isProcessing = false;
        
        window.triggerCreateRoom = function(mobId) {
            if (isProcessing) return; // å¦‚æœæ­£åœ¨è™•ç†ï¼Œç›´æ¥ç„¡è¦–é»æ“Š
            if (!socket.connected) { showToast("éŒ¯èª¤ï¼šæœªé€£ç·šåˆ°ä¼ºæœå™¨ï¼"); return; }
        
            isProcessing = true; // é–å®š
            document.getElementById('list-title').innerText = "æ­£åœ¨å»ºç«‹æˆ¿é–“...";
            
            socket.emit('createRoom', mobId);
        
            // ğŸŸ¢ 2ç§’å¾Œè‡ªå‹•è§£é– (é˜²æ­¢å¦‚æœä¼ºæœå™¨æ²’å›æ‡‰ï¼ŒæŒ‰éˆ•æ°¸é å¡æ­»)
            setTimeout(() => {
                isProcessing = false;
                document.getElementById('list-title').innerText = `${selectedMonster.name} - æˆ¿é–“`; // é‚„åŸæ¨™é¡Œ
            }, 2000);
        };
        
        window.triggerJoinRoom = function(roomId) { socket.emit('joinRoom', roomId); };
        window.triggerEnterCity = function(cityId) {
            let city = WORLD_MAP.find(c => c.id === cityId);
            if (city) { selectedCity = city; currentView = 'monsters'; socket.emit('enterCity', cityId); refreshUI(); }
        };
        window.triggerSelectMonster = function(mobId) {
            let city = selectedCity;
            let mob = city.monsters.find(m => m.id === mobId);
            if (mob) { selectedMonster = mob; currentView = 'rooms'; refreshUI(); }
        };
        window.goBack = function(view) { currentView = view; refreshUI(); };

        function refreshUI() {
            const container = document.getElementById('map-list');
            let html = '';
            
            if (currentView === 'cities') {
                document.getElementById('list-title').innerText = "é¸æ“‡å€åŸŸ";
                WORLD_MAP.forEach(city => {
                    const isLowLevel = myLevel < city.reqLv;
                    const count = cityData[city.id] || 0;
                    const warnText = isLowLevel ? `<span style="color:#e74c3c">(LV${city.reqLv})</span>` : '';
                    
                    const lockClass = isLowLevel ? 'locked' : '';
                    const action = isLowLevel ? '' : `onclick="triggerEnterCity('${city.id}')"`;

                    html += `<div class="btn ${lockClass}" style="border-color:#3498db" ${action}>
                        <div style="display:flex; justify-content:space-between;"><span style="font-size:12px; font-weight:bold;">${city.name} ${warnText}</span><span class="info-tag">${count}äºº</span></div>
                        <div style="font-size:10px; color:#bdc3c7; margin-top:5px;">${city.desc}</div></div>`;
                });
            } else if (currentView === 'monsters') {
                document.getElementById('list-title').innerText = `${selectedCity.name} - æ€ªç‰©`;
                selectedCity.monsters.forEach(mob => {
                    const rooms = activeRooms.filter(r => r.monsterKey === mob.id);
                    const fighting = rooms.filter(r => r.status === 'fighting').length;
                    const waiting = rooms.filter(r => r.status === 'waiting').length;
                    
                    html += `<div class="btn" style="border-color:#c0392b" onclick="triggerSelectMonster('${mob.id}')">
                        <span style="font-size:12px; font-weight:bold;">${mob.name} (LV.${mob.lv})</span>
                        <div style="margin-top:5px; font-size:10px;"><span class="info-tag" style="color:#2ecc71">ç­‰:${waiting}</span><span class="info-tag" style="color:#e74c3c; margin-right:10px;">æˆ°:${fighting}</span></div></div>`;
                });
                html += `<div class="btn" style="background:#7f8c8d; text-align:center;" onclick="goBack('cities')">â—€ è¿”å›åœ°åœ–</div>`;
            } else if (currentView === 'rooms') {
                document.getElementById('list-title').innerText = `${selectedMonster.name} - æˆ¿é–“`;
                html += `<div class="btn" style="background:#27ae60; text-align:center; font-weight:bold; font-size:12px;" onclick="triggerCreateRoom('${selectedMonster.id}')">â• é–‹æ–°æˆ¿é–“</div>`;
                
                const myRooms = activeRooms.filter(r => r.monsterKey === selectedMonster.id);
                
                if (myRooms.length === 0) html += `<div style="font-size:10px; color:#aaa; margin:10px;">ç›®å‰æ²’æœ‰æˆ¿é–“...</div>`;
                
                myRooms.forEach(room => {
                    const isFighting = room.status === 'fighting';
                    const clickAction = isFighting ? '' : `onclick="triggerJoinRoom('${room.id}')"`;
                    const statusTag = isFighting ? '<span class="room-tag status-fighting">æˆ°é¬¥</span>' : '<span class="room-tag status-waiting">ç­‰å¾…</span>';
                    const lockClass = isFighting ? 'locked' : '';
                    
                    html += `<div class="btn ${lockClass}" ${clickAction}>
                        <div style="font-size:10px;">Room ${room.id.substr(5)}</div>
                        <div style="margin-top:5px;">${statusTag}<span class="info-tag" style="margin-right:5px;">${room.playerCount}/5</span></div>
                    </div>`;
                });
                html += `<div class="btn" style="background:#7f8c8d; text-align:center;" onclick="goBack('monsters')">â—€ è¿”å›åˆ—è¡¨</div>`;
            }
            container.innerHTML = html;
        }
    </script>
</body>
</html>
