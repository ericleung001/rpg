<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å†’éšªè€…å…¬æœƒ2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body { 
            background-color: #2c3e50; color: #ecf0f1; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; 
            margin: 0; padding: 0; 
            height: 100dvh; 
            overflow: hidden; 
            overscroll-behavior: none;
            user-select: none; -webkit-user-select: none;
            display: flex; justify-content: center; 
        }

        #app-layout {
            display: flex;
            flex-direction: column; 
            width: 100%;
            height: 100%;
            max-width: 600px; 
            position: relative;
        }

        #game-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
            width: 100%;
        }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; 
            z-index: 99999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #fff; border-top: 4px solid #f1c40f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .top-bar { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; height: 30px;}
        .logout-btn { font-size: 10px; color: #e74c3c; cursor: pointer; text-decoration: underline; white-space: nowrap; padding: 5px; }
        h1 { font-size: 16px; margin: 0; white-space: nowrap; }
        #conn-status { font-size: 10px; padding: 5px 8px; background: #333; border: 1px solid #fff; border-radius: 6px; white-space: nowrap; display: flex; align-items: center; gap: 5px; }

        .status-bar { 
            background: #34495e; border: 3px solid #fff; padding: 10px; 
            width: 100%; margin-bottom: 10px; border-radius: 12px; 
            display: flex; flex-direction: column; gap: 8px;
            font-size: 10px; box-sizing: border-box; text-align: left;
            flex-shrink: 0; 
        }

        .status-row-top {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #555; padding-bottom: 6px;
        }
        .status-item { display: flex; gap: 5px; align-items: center; }
        .label { color: #f1c40f; font-weight: bold; }
        .val { color: white; font-weight: bold; }

        .status-row-bars {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .bar-container { display: flex; flex-direction: column; }
        .bar-label { font-size: 9px; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .bar-bg { width:100%; height:6px; background:#555; border-radius:3px; overflow:hidden; }
        
        .status-row-stats {
            display: flex; justify-content: space-around; background: rgba(0,0,0,0.2);
            padding: 6px; border-radius: 4px; 
        }

        .exp-container { margin-top: 2px; }
        .exp-bar { width: 100%; height: 6px; background: #555; border: 1px solid #fff; border-radius: 4px; overflow: hidden; }
        .exp-fill { height: 100%; background: #3498db; width: 0%; transition: width 0.3s; }
        
        .main-content {
            width: 100%;
            flex: 1; 
            display: flex; flex-direction: column;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
        }

        .facility-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 4px; 
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px dashed #7f8c8d; 
            flex-shrink: 0;
        }
        
        .facility-btn {
            position: relative; /* ğŸŸ¢ ç‚ºç´…é»å®šä½ */
            padding: 0; 
            font-family: inherit; font-size: 10px; font-weight: bold;
            cursor: pointer; border: 2px solid #bdc3c7; color: white; text-decoration: none; 
            display: flex; align-items: center; justify-content: center;
            background: #34495e; border-radius: 6px; height: 38px; white-space: nowrap; 
            box-shadow: 2px 2px 0 rgba(0,0,0,0.3); 
            touch-action: manipulation; transition: transform 0.05s;
        }
        .facility-btn:active { transform: scale(0.95); box-shadow: none; filter: brightness(0.9); }
        
        .map-container { padding-right: 5px; padding-bottom: 60px; }
        .btn { 
            padding: 12px 8px; font-family: inherit; font-size: 12px; cursor: pointer; 
            border: 2px solid #bdc3c7; color: white; text-decoration: none; 
            display: block; text-shadow: 1px 1px 0 #000; background: #34495e; 
            position: relative; text-align: left; margin-bottom: 8px; border-radius: 6px;
            touch-action: manipulation; transition: transform 0.05s, background-color 0.1s; 
        }
        .btn:active { transform: scale(0.98); filter: brightness(0.8); background: #2980b9; }
        .locked { background: #555; color: #888; border-color: #555; pointer-events: none; }
        
        .info-tag { float: right; font-size: 10px; color: #f1c40f; margin-top: 2px; }
        .room-tag { font-size: 9px; padding: 2px 4px; border-radius: 4px; float: right; margin-left: 5px; }
        .status-waiting { background: #27ae60; color: white; }
        .status-fighting { background: #c0392b; color: white; }
        
        #chat-container {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.95); border-top: 4px solid #bdc3c7;
            display: flex; flex-direction: column; font-size: 10px; z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            transition: height 0.3s ease-in-out;
            height: 30px; 
        }
        #chat-header {
            height: 30px; background: #34495e; color: #fff; line-height: 30px; 
            cursor: pointer; font-weight: bold; border-bottom: 1px solid #555;
            display: flex; justify-content: center; align-items: center;
            touch-action: manipulation; flex-shrink: 0; 
        }
        #chat-header:hover { background: #2c3e50; }

        .chat-open { height: 40vh !important; }
        #chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-open #chat-body { display: flex; } 

        #chat-history { flex: 1; overflow-y: auto; padding: 8px; text-align: left; color: white; }
        #chat-input-area { display: flex; border-top: 1px solid #555; height: 40px; flex-shrink: 0; }
        #chat-input { flex: 1; background: #222; color: white; border: none; padding: 0 10px; font-family: inherit; font-size: 12px; outline: none; }
        #chat-send { background: #2980b9; color: white; border: none; padding: 0 15px; cursor: pointer; font-family: inherit; font-size: 12px; font-weight: bold; touch-action: manipulation; }

        #toast-notification {
            position: fixed; top: -60px; left: 50%; transform: translateX(-50%);
            background: #f1c40f; color: #000; border: 3px solid #fff;
            padding: 10px 20px; border-radius: 30px; font-size: 12px; font-weight: bold;
            box-shadow: 0 6px 15px rgba(0,0,0,0.6); z-index: 2000;
            transition: top 0.5s ease-in-out; white-space: nowrap; pointer-events: none;
        }

        #notice-btn {
            position: fixed; top: 80px; left: 10px;
            width: 40px; height: 40px;
            background: #e67e22; border: 2px solid #fff;
            border-radius: 50%; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; z-index: 90;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            animation: bounce 2s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        #notice-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .notice-box {
            background: #fff; color: #2c3e50; width: 85%; max-width: 400px;
            border: 4px solid #f1c40f; border-radius: 10px; padding: 20px; text-align: left;
            font-family: 'Press Start 2P', monospace; max-height: 70vh; overflow-y: auto;
        }
        .notice-title { font-size: 16px; color: #d35400; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .notice-content { font-size: 10px; line-height: 1.8; white-space: pre-wrap; }
        .close-notice-btn {
            margin-top: 20px; width: 100%; padding: 10px; background: #34495e; 
            color: white; border: none; border-radius: 5px; cursor: pointer; font-family: inherit; font-size: 12px;
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); 
            display: none;
            flex-direction: column; 
            justify-content: center; 
            align-items: center;     
            z-index: 9999;
        }
        
        .modal-box {
            background: #fff; color: #2c3e50; width: 85%; max-width: 400px;
            border: 4px solid #f1c40f; border-radius: 10px; padding: 20px; text-align: left;
            font-family: 'Press Start 2P', monospace; max-height: 70vh; overflow-y: auto;
            position: relative;
            margin: auto; 
        }
        .close-btn-x {
            position: absolute; top: 10px; right: 10px;
            background: #e74c3c; color: white; border: none;
            width: 25px; height: 25px; border-radius: 50%;
            cursor: pointer; font-weight: bold;
        }
        
        

        /* è‹±é›„æ¦œæ¨£å¼ */
        .ranking-box {
            width: 100%; max-width: 600px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #f1c40f;
            border-radius: 8px; padding: 10px; margin: 10px 0; text-align: left;
            box-sizing: border-box; box-shadow: 0 0 10px rgba(241, 196, 15, 0.2); flex-shrink: 0; 
        }
        .rank-title { color: #f1c40f; font-size: 12px; font-weight: bold; text-align: center; margin-bottom: 8px; border-bottom: 1px dashed #555; padding-bottom: 5px; }
        .rank-row { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px; padding: 4px 5px; }
        .rank-row:nth-child(odd) { background: rgba(255,255,255,0.05); }
        .rank-1 { color: #ffd700; font-weight: bold; text-shadow: 0 0 5px #ffd700; }
        .rank-2 { color: #c0c0c0; font-weight: bold; }
        .rank-3 { color: #cd7f32; font-weight: bold; }

        /* å¥½å‹åˆ—è¡¨æ¨£å¼ */
        .friend-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid #eee; font-size: 10px;
        }
        .friend-name { font-weight: bold; }
        .friend-status { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-on { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .status-off { background: #95a5a6; }
        .friend-actions button {
            font-size: 9px; padding: 4px 8px; margin-left: 5px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc;
        }
        .btn-pm { background: #3498db; color: white; border-color: #2980b9; }
        .btn-del { background: #e74c3c; color: white; border-color: #c0392b; }

        /* ç§è¨Šå°ˆç”¨è¦–çª—æ¨£å¼ */
        #pm-modal { z-index: 10000; }
        #pm-history {
            background: #f9f9f9; border: 1px solid #ddd; height: 250px; 
            overflow-y: auto; padding: 10px; margin-bottom: 10px; border-radius: 5px;
            font-size: 10px; display: flex; flex-direction: column; gap: 8px;
        }
        .pm-msg { padding: 8px; border-radius: 8px; max-width: 80%; word-break: break-all; }
        .pm-mine { align-self: flex-end; background: #3498db; color: white; border-bottom-right-radius: 0; }
        .pm-other { align-self: flex-start; background: #eec5a9; color: #2c3e50; border-bottom-left-radius: 0; }
        .pm-time { font-size: 8px; opacity: 0.7; margin-top: 2px; text-align: right; }

        /* ğŸŸ¢ æœªè®€ç´…é»æ¨£å¼ */
        .unread-badge {
            position: absolute; top: -5px; right: -5px;
            background: #e74c3c; color: white;
            border-radius: 50%; width: 18px; height: 18px;
            font-size: 9px; display: flex; justify-content: center; align-items: center;
            border: 2px solid white; font-weight: bold;
            display: none; /* é è¨­éš±è— */
            z-index: 10;
        }
        .friend-badge {
            background: #e74c3c; color: white;
            border-radius: 10px; padding: 2px 6px;
            font-size: 8px; margin-left: 5px;
        }

        @media (min-width: 1024px) {
            body { background-color: #222; }
            #app-layout { flex-direction: row; max-width: 1000px; background-color: #2c3e50; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
            #game-view { width: 600px; border-right: 4px solid #bdc3c7; }
            #chat-container { position: static; width: 400px; height: 100% !important; border-top: none; background: #34495e; }
            #chat-header { cursor: default; background: #2c3e50; }
            #chat-header:active { pointer-events: none; }
            #chat-body { display: flex !important; height: calc(100% - 30px); }
            .main-content { margin-bottom: 0; }
            #notice-btn { left: calc(50% - 540px); }
        }
    </style>
</head>
<body>
    
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-size:12px; margin-top:10px;">æ­£åœ¨è®€å–ç©å®¶è³‡æ–™...</div>
        <div style="font-size:10px; color:#95a5a6; margin-top:5px;">(è«‹ç¨å€™)</div>
    </div>

    <div id="toast-notification"> è¨Šæ¯æç¤º</div>
    <div id="notice-btn" onclick="openNotice()">ğŸ“¢</div>

    <div id="notice-modal">
        <div class="notice-box">
            <div class="notice-title">ğŸ“œ å…¬æœƒå…¬å‘Š</div>
            <div class="notice-content">
<b style="color:#c0392b;">ã€v2.8 æ›´æ–°å…¬å‘Šï¼šç¤¾äº¤æ™‚ä»£ã€‘</b>
2026/01/12 22:00 - 23:00æ›´æ–°: 
1. ğŸ‘¥ å¥½å‹ç³»çµ±ä¸Šç·šï¼šå¯ç™¼é€å¥½å‹ç”³è«‹ï¼Œéœ€å°æ–¹ç¢ºèªã€‚
2. ğŸ’Œ ç¨ç«‹ç§è¨Šè¦–çª—ï¼šç§è¨Šå°‡æœ‰ç¨ç«‹çš„èŠå¤©è¨˜éŒ„ï¼Œä¸å†èˆ‡å…¬é »æ··é›œï¼Œä¸”æ°¸ä¹…ä¿å­˜ã€‚
3. ğŸ”´ æœªè®€æç¤ºï¼šæ”¶åˆ°ç§è¨Šæ™‚ï¼Œå¥½å‹åˆ—è¡¨å°‡é¡¯ç¤ºç´…é»æç¤ºã€‚

            </div>
            <button class="close-notice-btn" onclick="closeNotice()">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="friends-modal" class="modal-overlay">
        <div class="modal-box">
            <button class="close-btn-x" onclick="document.getElementById('friends-modal').style.display='none'">Ã—</button>
            <div style="font-size:16px; font-weight:bold; color:#d35400; margin-bottom:15px; text-align:center;">ğŸ‘¥ å¥½å‹ç³»çµ±</div>
            
            <div style="display:flex; gap:5px; margin-bottom:15px; border-bottom:1px dashed #ccc; padding-bottom:10px;">
                <input type="text" id="friend-input" placeholder="è¼¸å…¥ç©å®¶åå­—" style="flex:1; padding:8px; font-size:10px;">
                <button onclick="sendRequest()" style="background:#27ae60; color:white; border:none; padding:8px; cursor:pointer; font-size:10px; border-radius:4px;">ç”³è«‹</button>
            </div>
            
            <div id="request-section" style="display:none; margin-bottom:10px;">
                <div style="font-size:12px; color:#e67e22; margin-bottom:5px;">ğŸ“© å¥½å‹ç”³è«‹</div>
                <div id="request-list-content" style="max-height:100px; overflow-y:auto; border:1px solid #f39c12; padding:5px; background:#fffbf0; border-radius:4px;"></div>
            </div>

            <div style="font-size:12px; color:#3498db; margin-bottom:5px;">ğŸ“‹ å¥½å‹åå–®</div>
            <div id="friend-list-content" style="min-height:150px; max-height:250px; overflow-y:auto; border:1px solid #eee; padding:5px;">
                <div style="text-align:center; color:#aaa; font-size:10px; margin-top:20px;">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="pm-modal" class="modal-overlay">
        <div class="modal-box" style="display:flex; flex-direction:column; height: 70vh;">
            <button class="close-btn-x" onclick="closePM()">Ã—</button>
            <div style="font-size:14px; font-weight:bold; color:#3498db; margin-bottom:10px; text-align:center; border-bottom:1px solid #ccc; padding-bottom:5px;">
                èˆ‡ <span id="pm-target-name">...</span> çš„å°è©±
            </div>
            
            <div id="pm-history">
                <div style="text-align:center; color:#aaa; margin-top:20px;">è¼‰å…¥è¨˜éŒ„ä¸­...</div>
            </div>

            <div style="display:flex; gap:5px; margin-top:auto;">
                <input type="text" id="pm-input" placeholder="è¼¸å…¥è¨Šæ¯..." style="flex:1; padding:10px; font-size:12px; border:1px solid #ccc; border-radius:4px;">
                <button onclick="sendPM()" style="background:#2980b9; color:white; border:none; padding:10px 15px; border-radius:4px; font-weight:bold; cursor:pointer;">ç™¼é€</button>
            </div>
        </div>
    </div>

    <div id="app-layout">
        <div id="game-view">
            <div class="top-bar">
                <div class="logout-btn" onclick="logout()">ç™»å‡º</div>
                <h1> å…¬æœƒå¤§å»³</h1>
                <div id="conn-status" style="color:#e74c3c"> æœªé€£ç·š</div>
            </div>
            
            <div class="status-bar">
                <div class="status-row-top">
                    <div class="status-item"><span class="label">LV</span> <span id="lvl" class="val">1</span></div>
                    <div class="status-item"><span id="pid" class="val" style="color:#2ecc71;">Unknown</span></div>
                    <div class="status-item"><span class="label">ğŸ’°</span> <span id="gold" class="val">0</span></div>
                </div>

                <div class="status-row-bars">
                    <div class="bar-container">
                        <div class="bar-label"><span style="color:#e74c3c">HP</span> <span id="hp">...</span></div>
                        <div class="bar-bg">
                            <div id="hp-bar-fill" style="width:100%; height:100%; background:#e74c3c; transition:width 0.3s;"></div>
                        </div>
                    </div>
                    <div class="bar-container">
                        <div class="bar-label"><span style="color:#3498db">MP</span> <span id="mp">...</span></div>
                        <div class="bar-bg">
                            <div id="mp-bar-fill" style="width:100%; height:100%; background:#3498db; transition:width 0.3s;"></div>
                        </div>
                    </div>
                </div>

                <div class="status-row-stats">
                    <div class="status-item"><span class="label">âš”ï¸ ATK</span> <span id="atk" class="val">0</span></div>
                    <div class="status-item"><span class="label">ğŸ›¡ï¸ DEF</span> <span id="def" class="val">0</span></div>
                </div>

                <div class="exp-container">
                    <div style="display:flex; justify-content:space-between; font-size:8px; color:#bdc3c7; margin-bottom:1px;">
                        <span>EXP</span> <span id="exp-txt">0/100</span>
                    </div>
                    <div class="exp-bar"><div id="exp-fill" class="exp-fill"></div></div>
                </div>
            </div>

            <div class="main-content">
                
                <div id="boss-banner" style="display:none; background: linear-gradient(90deg, #2c3e50, #c0392b); padding: 15px; border-radius: 8px; border: 2px solid #e74c3c; margin-bottom: 15px; text-align: left; box-shadow: 0 0 15px #c0392b; animation: pulse 2s infinite; flex-shrink: 0;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="color:#f1c40f; font-weight:bold; font-size:14px; margin-bottom:5px;">â˜ ï¸ è™›ç©ºæ»…ä¸–è€… é™è‡¨ï¼</div>
                            <div style="color:#fff; font-size:10px;">
                                <div style="margin-bottom:2px;">å…¨æœ HP: <span id="boss-hp-text">è¨ˆç®—ä¸­...</span></div>
                                <div style="color:#e74c3c; font-weight:bold;">â±ï¸ å‰©é¤˜æ™‚é–“: <span id="boss-timer">--:--</span></div>
                            </div>
                        </div>
                        <button onclick="joinBoss()" style="background:#f1c40f; color:#000; border:none; padding:10px 20px; font-weight:bold; border-radius:5px; cursor:pointer;">
                            âš”ï¸ ç«‹å³è¨ä¼
                        </button>
                    </div>
                    <div style="width:100%; height:8px; background:#333; margin-top:10px; border-radius:4px;">
                        <div id="boss-hp-bar" style="width:100%; height:100%; background:#e74c3c; transition: width 0.5s;"></div>
                    </div>
                </div>

                <div class="ranking-box" id="boss-ranking-area" style="display:none;">
                    <div class="rank-title">ğŸ† ä¸Šå±†è¨ä¼è‹±é›„æ¦œ</div>
                    <div id="ranking-list">
                        </div>
                </div>

                <div class="section-title" style="text-align:left; font-size:10px; color:#aaa; margin-bottom:5px; flex-shrink: 0;">åŸé®è¨­æ–½</div>
                
                <div class="facility-grid">
                    <a href="bag.html" class="facility-btn" style="background:#16a085; border-color:#1abc9c;">ğŸ’ èƒŒåŒ…</a>
                    <a href="equip.html" class="facility-btn" style="background:#8e44ad; border-color:#9b59b6;">ğŸ›¡ï¸ è£å‚™</a>
                    <a href="market.html" class="facility-btn" style="background:#f39c12; border-color:#d35400;">ğŸª é“å…·</a>
                    <a href="auction.html" class="facility-btn" style="background:#2980b9; border-color:#3498db;">âš–ï¸ å¸‚é›†</a>
                    <a href="smithy.html" class="facility-btn" style="background:#c0392b; border-color:#e74c3c;">ğŸ”¨ é›é€ </a>
                    <a href="enhance.html" class="facility-btn" style="background:#d35400; border-color:#e67e22;">ğŸ”¥ å¼·åŒ–</a>
                    <a href="gathering.html" class="facility-btn" style="background:#27ae60; border-color:#2ecc71;">ğŸŒ² æ¡é›†</a>
                    <a href="rest.html" class="facility-btn" style="background:#2c3e50; border-color:#95a5a6;">ğŸ¨ æ—…é¤¨</a>
                    <a href="kitchen.html" class="facility-btn" style="background:#e67e22; border-color:#d35400;">ğŸ³ å»šæˆ¿</a>
                    <a href="lottery.html" class="facility-btn" style="background:#8e44ad; border-color:#9b59b6;">ğŸ± å½©ç¥¨</a>
                    <a href="manual.html" class="facility-btn" style="background:#7f8c8d; border-color:#95a5a6;">ğŸ“œ åœ–é‘‘</a>
                    
                    <div class="facility-btn" style="background:#3498db; border-color:#2980b9;" onclick="openFriends()">
                        ğŸ‘¥ å¥½å‹
                        <div id="main-unread-badge" class="unread-badge">0</div>
                    </div>
                </div>

                <div style="margin-bottom: 15px; padding: 10px; border: 2px solid #9b59b6; background: rgba(0,0,0,0.3); border-radius: 8px; text-align: center; flex-shrink: 0;">
                    <h3 style="color: #9b59b6; margin: 5px 0; font-size: 12px;">ğŸ”® æ··æ²Œè£‚ç¸« (Lv.350-500)</h3>
                    <p style="font-size: 10px; color: #ccc; margin-bottom: 8px;">æ¯æ¬¡é€²å…¥ï¼Œæ•µäººçš„å¼·åº¦éƒ½æœƒéš¨æ©Ÿè®ŠåŒ–ï¼(å¦‚è¦æŸ¥çœ‹å¾—åˆ°ç‰©å“ï¼Œè«‹æŸ¥é–±åœ–é‘‘)</p>
                    <button class="btn" onclick="triggerSelectChaosBoss()" style="background: #8e44ad; color: #fff; width: 100%; text-align: center;">
                        æŸ¥çœ‹è¨ä¼éšŠä¼
                    </button>
                </div>

                <div id="list-title" style="text-align:left; font-size:10px; color:#aaa; margin-bottom:5px; flex-shrink: 0;">ä¸–ç•Œåœ°åœ–</div>
                <div class="map-container" id="map-list">
                    <div class="btn locked">è®€å–ä¸­...</div>
                </div>
            </div>
        </div>

        <div id="chat-container">
            <div id="chat-header" onclick="toggleChat()"> å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)</div>
            <div id="chat-body">
                <div id="chat-history"></div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." maxlength="50">
                    <button id="chat-send">ç™¼é€</button>
                </div>
            </div>
        </div>

    </div> 
    
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => { 
                    overlay.style.display = 'none'; 
                    // ğŸŸ¢ ä¸è‡ªå‹•å½ˆå‡ºï¼Œç­‰å¾…æ‰‹å‹•é»æ“Š
                }, 500);
            }, 2000); 
        });

        const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myLevel = 1;
        let myName = ""; 
        let currentChatTarget = null;
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) { window.location.href = 'index.html'; }

        // ğŸŸ¢ [åŠŸèƒ½] é–‹å•Ÿ/é—œé–‰å…¬å‘Š (ä½¿ç”¨ flex ä»¥ç¢ºä¿ CSS ç½®ä¸­)
        function openNotice() {
            document.getElementById('notice-modal').style.display = 'flex'; 
        }
        function closeNotice() {
            document.getElementById('notice-modal').style.display = 'none';
        }

        // --- å¥½å‹ç³»çµ±é‚è¼¯ ---
        function openFriends() {
            document.getElementById('friends-modal').style.display = 'flex';
            socket.emit('getFriends'); 
        }

        function sendRequest() {
            const name = document.getElementById('friend-input').value.trim();
            if(!name) return;
            socket.emit('sendFriendRequest', name);
            document.getElementById('friend-input').value = '';
        }

        function answerRequest(name, action) {
            socket.emit('handleFriendRequest', { requesterName: name, action: action });
        }

        function removeFriend(name) {
            if(confirm(`ç¢ºå®šè¦åˆªé™¤å¥½å‹ [${name}] å—ï¼Ÿ`)) {
                socket.emit('removeFriend', name);
            }
        }

        // --- ç§è¨Šè¦–çª—é‚è¼¯ ---
        function startPM(name) {
            currentChatTarget = name;
            document.getElementById('friends-modal').style.display = 'none';
            document.getElementById('pm-modal').style.display = 'flex';
            document.getElementById('pm-target-name').innerText = name;
            document.getElementById('pm-history').innerHTML = '<div style="text-align:center; color:#aaa; margin-top:20px;">è¼‰å…¥è¨˜éŒ„ä¸­...</div>';
            
            socket.emit('getPrivateHistory', name); 
            // ğŸŸ¢ æ‰“é–‹å¾Œæ¨™è¨˜ç‚ºå·²è®€
            socket.emit('markAsRead', name);
            // ğŸŸ¢ æœ¬åœ°æ‰£é™¤è©²å¥½å‹çš„ç´…é» (ç°¡å–®åšæ³•ï¼šåˆ·æ–°ä¸€æ¬¡å¥½å‹åˆ—è¡¨)
            socket.emit('getFriends');
        }

        function closePM() {
            document.getElementById('pm-modal').style.display = 'none';
            currentChatTarget = null;
        }

        function sendPM() {
            const input = document.getElementById('pm-input');
            const msg = input.value.trim();
            if (!msg || !currentChatTarget) return;
            
            socket.emit('privateMessage', { targetName: currentChatTarget, msg: msg });
            input.value = '';
        }
        
        document.getElementById('pm-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendPM();
        });

        // æ¥æ”¶æ­·å²è¨Šæ¯
        socket.on('privateHistoryUpdate', (data) => {
            if (currentChatTarget !== data.targetName) return;
            
            const historyDiv = document.getElementById('pm-history');
            historyDiv.innerHTML = '';
            
            if (data.history.length === 0) {
                historyDiv.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:20px;">ç„¡å°è©±è¨˜éŒ„</div>';
            } else {
                data.history.forEach(row => {
                    appendPM(row.sender, row.message);
                });
            }
        });

        socket.on('privateMessageUpdate', (data) => {
            // 1. è¨ˆç®—æ™‚é–“
            const time = data.timestamp ? new Date(data.timestamp) : new Date();
            const timeStr = time.toLocaleTimeString('en-GB', { hour12: false }); // ä¾‹å¦‚ "14:30:05"

            // 2. åˆ¤æ–·æ˜¯å¦æ­£åœ¨èˆ‡è©²äººå°è©±
            if (currentChatTarget && (data.sender === currentChatTarget || data.receiver === currentChatTarget)) {
                
                // ğŸŸ¢ [ä¿®æ­£] é€™è£¡è¦å‚³å…¥ timeStr
                appendPM(data.sender, data.msg, timeStr); 
                
                // å¦‚æœè¦–çª—é–‹è‘—ä¸”ä¸æ˜¯è‡ªå·±ç™¼çš„ï¼Œæ¨™è¨˜å·²è®€
                if (!data.isSelf) {
                    socket.emit('markAsRead', data.sender);
                }
            } else if (!data.isSelf) {
                // æ²’é–‹è¦–çª— -> å½ˆæç¤º + åˆ·æ–°å¥½å‹åˆ—è¡¨(ç´…é»)
                showToast(`ğŸ“© æ”¶åˆ°ä¾†è‡ª [${data.sender}] çš„ç§è¨Š`);
                socket.emit('getFriends'); 
            }
        });

        // æ”¶åˆ°ç§è¨Šé€šçŸ¥ (ä¾‹å¦‚å°æ–¹ç™¼é€è¨Šæ¯æ™‚è§¸ç™¼)
        socket.on('pmNotification', (senderName) => {
            if (currentChatTarget !== senderName) {
                showToast(`ğŸ“© ${senderName} å‚³é€äº†ç§è¨Šçµ¦ä½ ï¼`);
                // ğŸŸ¢ æ”¶åˆ°é€šçŸ¥ -> åˆ·æ–°ç´…é»
                socket.emit('getFriends');
            }
        });

        // é¡¯ç¤ºç§è¨Šå…§å®¹çš„å‡½å¼
    function appendPM(sender, msg, time = "") {
        const box = document.getElementById('pm-history'); // ä½ çš„å°è©±æ¡† ID
        if (!box) return;

        const div = document.createElement('div');
        div.style.marginBottom = "8px";
        
        // åˆ¤æ–·æ˜¯åˆ¥äººç™¼çš„é‚„æ˜¯è‡ªå·±ç™¼çš„ (æ’ç‰ˆç”¨)
        const isMe = (sender === document.getElementById('my-name').innerText); // æˆ–æ˜¯ç”¨å…¶ä»–æ–¹å¼åˆ¤æ–·è‡ªå·±
        
        if (isMe) {
            // è‡ªå·±ç™¼çš„ (é å³)
            div.style.textAlign = "right";
            div.innerHTML = `
                <span style="font-size:10px; color:#aaa;">${time}</span>
                <span style="background:#2980b9; color:white; padding:5px 10px; border-radius:10px;">${msg}</span>
            `;
        } else {
            // å°æ–¹ç™¼çš„ (é å·¦)
            div.style.textAlign = "left";
            div.innerHTML = `
                <span style="color:#f1c40f; font-weight:bold;">${sender}:</span>
                <span style="background:#444; color:white; padding:5px 10px; border-radius:10px;">${msg}</span>
                <span style="font-size:10px; color:#aaa;">${time}</span>
            `;
        }

        box.appendChild(div);
        box.scrollTop = box.scrollHeight; // æ²å‹•åˆ°åº•éƒ¨
    }

        socket.on('friendListUpdate', (data) => {
            // data.friends: [ { name, isOnline, unread }, ... ]
            // data.totalUnread: number
            
            const friends = data.friends || [];
            const requests = data.requests || [];
            const totalUnread = data.totalUnread || 0;

            // ğŸŸ¢ æ›´æ–°ä¸»ç•«é¢æŒ‰éˆ•ç´…é»
            const mainBadge = document.getElementById('main-unread-badge');
            if (totalUnread > 0) {
                mainBadge.innerText = totalUnread > 99 ? '99+' : totalUnread;
                mainBadge.style.display = 'flex';
            } else {
                mainBadge.style.display = 'none';
            }

            // 1. æ¸²æŸ“ç”³è«‹åˆ—è¡¨
            const reqSection = document.getElementById('request-section');
            const reqContainer = document.getElementById('request-list-content');
            reqContainer.innerHTML = '';
            
            if (requests && requests.length > 0) {
                reqSection.style.display = 'block';
                requests.forEach(name => {
                    const div = document.createElement('div');
                    div.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:5px; border-bottom:1px dashed #ccc; font-size:10px;";
                    div.innerHTML = `
                        <span style="font-weight:bold;">${name}</span>
                        <div>
                            <button onclick="answerRequest('${name}', 'accept')" style="background:#2ecc71; border:none; color:white; cursor:pointer; padding:2px 5px; border-radius:3px;">âœ”</button>
                            <button onclick="answerRequest('${name}', 'reject')" style="background:#e74c3c; border:none; color:white; cursor:pointer; padding:2px 5px; border-radius:3px;">âœ˜</button>
                        </div>
                    `;
                    reqContainer.appendChild(div);
                });
            } else {
                reqSection.style.display = 'none';
            }

            // 2. æ¸²æŸ“å¥½å‹åˆ—è¡¨ (å«å€‹åˆ¥ç´…é»)
            const friendContainer = document.getElementById('friend-list-content');
            friendContainer.innerHTML = '';
            
            if (friends.length === 0) {
                friendContainer.innerHTML = '<div style="text-align:center; color:#aaa; margin-top:20px;">é‚„æ²’æœ‰å¥½å‹ï¼Œå¿«å»åŠ äººå§ï¼</div>';
            } else {
                friends.sort((a, b) => (a.isOnline === b.isOnline) ? 0 : a.isOnline ? -1 : 1);
                friends.forEach(f => {
                    const div = document.createElement('div');
                    div.className = 'friend-row';
                    const statusClass = f.isOnline ? 'status-on' : 'status-off';
                    const color = f.isOnline ? '#2c3e50' : '#aaa';
                    
                    // ğŸŸ¢ å€‹åˆ¥ç´…é»
                    let badgeHtml = '';
                    if (f.unread > 0) {
                        badgeHtml = `<span class="friend-badge">${f.unread}</span>`;
                    }

                    div.innerHTML = `
                        <div style="display:flex; align-items:center; color:${color}">
                            <div class="friend-status ${statusClass}"></div>
                            <span class="friend-name">${f.name}</span>
                            ${badgeHtml}
                        </div>
                        <div class="friend-actions">
                            <button class="btn-pm" onclick="startPM('${f.name}')">ç§è¨Š</button>
                            <button class="btn-del" onclick="removeFriend('${f.name}')">åˆªé™¤</button>
                        </div>
                    `;
                    friendContainer.appendChild(div);
                });
            }
        });

        socket.on('updateFriendListRequest', () => {
            socket.emit('getFriends'); // éš¨æ™‚ä¿æŒè³‡æ–™æœ€æ–°
        });

        // ... (ä»¥ä¸‹ç‚ºå…¶ä»– socket äº‹ä»¶ï¼Œä¿æŒåŸæ¨£)
        const WORLD_MAP = [
            { id: 'city_1', name: 'æ›™å…‰å¹³åŸ', reqLv: 1, desc: 'å†’éšªçš„èµ·é» (Lv.1-20)', monsters: [{ id: 'slime', name: 'å²èŠå§†', lv: 1 }, { id: 'rat', name: 'å¤§è€é¼ ', lv: 3 }, { id: 'bee', name: 'æ®ºäººèœ‚', lv: 5 }, { id: 'boar', name: 'é‡è±¬', lv: 8 }, { id: 'thief', name: 'ç›œè³Š', lv: 12 }, { id: 'wolf_king', name: 'ğŸº ç‹¼ç‹ (BOSS)', lv: 15 }] },
            { id: 'city_2', name: 'è¿·éœ§æ²¼æ¾¤', reqLv: 1, desc: 'å……æ»¿æ¯’æ°£èˆ‡äº¡éˆ (Lv.20-40)', monsters: [{ id: 'snake', name: 'æ¯’è›‡', lv: 22 }, { id: 'zombie', name: 'è…å±', lv: 25 }, { id: 'skeleton', name: 'éª·é«å…µ', lv: 28 }, { id: 'ghoul', name: 'é£Ÿå±é¬¼', lv: 32 }, { id: 'witch', name: 'æ²¼æ¾¤å¥³å·«', lv: 35 }, { id: 'hydra', name: 'ğŸ ä¹é ­è›‡ (BOSS)', lv: 40 }] },
            { id: 'city_3', name: 'ç¼ç†±å³½è°·', reqLv: 1, desc: 'çƒˆç«èˆ‡ç†”å²© (Lv.40-60)', monsters: [{ id: 'fire_imp', name: 'ç«ç„°å°é¬¼', lv: 42 }, { id: 'lava_golem', name: 'ç†”å²©æˆˆä¾–', lv: 45 }, { id: 'salamander', name: 'ç«èœ¥èœ´', lv: 48 }, { id: 'fire_mage', name: 'çƒˆç„°æ³•å¸«', lv: 52 }, { id: 'dragon_hatchling', name: 'å¹¼é¾', lv: 55 }, { id: 'balrog', name: 'ğŸ”¥ ç‚é­” (BOSS)', lv: 60 }] },
            { id: 'city_4', name: 'æ¥µå¯’å‡åœŸ', reqLv: 1, desc: 'æ°¸å†¬ä¹‹åœ° (Lv.60-80)', monsters: [{ id: 'snow_wolf', name: 'é›ªåŸç‹¼', lv: 62 }, { id: 'yeti', name: 'é›ªäºº', lv: 65 }, { id: 'ice_spirit', name: 'å†°ç²¾éˆ', lv: 68 }, { id: 'frost_knight', name: 'å¯’éœœé¨å£«', lv: 72 }, { id: 'ice_dragon', name: 'å†°éœœé¾', lv: 75 }, { id: 'lich_king', name: 'â„ï¸ å·«å¦–ç‹ (BOSS)', lv: 80 }] },
            { id: 'city_5', name: 'è™›ç©ºè¦å¡', reqLv: 1, desc: 'æ¥è¿‘é­”ç•Œçš„åœ°æ–¹ (Lv.80-100)', monsters: [{ id: 'void_eye', name: 'è™›ç©ºä¹‹çœ¼', lv: 82 }, { id: 'shadow_assassin', name: 'æš—å½±åˆºå®¢', lv: 85 }, { id: 'dark_paladin', name: 'å¢®è½è–é¨', lv: 88 }, { id: 'demon_guard', name: 'æƒ¡é­”å®ˆè¡›', lv: 92 }, { id: 'succubus', name: 'é­…é­”', lv: 95 }, { id: 'void_lord', name: 'ğŸ‘ï¸ è™›ç©ºé ˜ä¸» (BOSS)', lv: 99 }] },
            { id: 'city_6', name: 'é­”ç•Œç‹åº§', reqLv: 1, desc: 'â˜ ï¸ æœ€çµ‚æ±ºæˆ° (Lv.100-150)', monsters: [{ id: 'chaos_beast', name: 'æ··æ²Œå·¨ç¸', lv: 105 }, { id: 'fallen_angel', name: 'å¢®å¤©ä½¿', lv: 110 }, { id: 'demon_king', name: 'ğŸ‘‘ é­”ç‹æ’’æ—¦', lv: 150 }] },
            { id: 'city_7', name: 'è™›ç©ºè£‚ç¸«', reqLv: 1, desc: 'ğŸŸ£ æ‰­æ›²çš„æ¬¡å…ƒ (Lv.160-180)', monsters: [{ id: 'void_walker', name: 'è™›ç©ºè¡Œè€…', lv: 160 }, { id: 'chaos_knight', name: 'æ··æ²Œé¨å£«', lv: 170 }, { id: 'abyss_dragon', name: 'ğŸ‰ æ·±æ·µé­”é¾ (BOSS)', lv: 180 }] },
            { id: 'city_8', name: 'çœ¾ç¥å¢“åœ°', reqLv: 130, desc: 'ğŸ’€ ç¥è©±çµ‚çµä¹‹åœ° (Lv.190-200)', monsters: [{ id: 'fallen_titan', name: 'å¢®è½æ³°å¦', lv: 190 }, { id: 'genesis_god', name: 'â˜ ï¸ å‰µä¸–ç ´å£ç¥ (FINAL)', lv: 200 }] },
            { id: 'city_9', name: 'è™›ç©ºä¹‹ç•Œ', reqLv: 160, desc: 'âš« è™›ç„¡çš„ç›¡é ­ (Lv.210-225)', monsters: [{ id: 'void_worm', name: 'è™›ç©ºåå™¬èŸ²', lv: 210 }, { id: 'shadow_phantom', name: 'ğŸ‘» è™šå½±å¤¢é­˜ (BOSS)', lv: 225 }] },
            { id: 'city_10', name: 'æ˜Ÿéš›èˆªé“', reqLv: 200, desc: 'ğŸŒŒ ç©¿è¶Šæ˜Ÿè¾° (Lv.245-260)', monsters: [{ id: 'star_eater', name: 'åæ˜Ÿå·¨ç¸', lv: 245 }, { id: 'nebula_dragon', name: 'ğŸ² æ˜Ÿé›²å¹»é¾ (BOSS)', lv: 260 }] },
            { id: 'city_11', name: 'ç¶­åº¦ç›¡é ­', reqLv: 215, desc: 'â³ æ™‚é–“èˆ‡ç©ºé–“çš„çµ‚é» (Lv.280-300)', monsters: [{ id: 'time_keeper', name: 'æ™‚ç©ºè£æ±ºè€…', lv: 280 }, { id: 'dimension_breaker', name: 'ç¶­åº¦ç²‰ç¢è€…', lv: 290 }, { id: 'entropy_god', name: 'ğŸ‘‘ çµ‚ç„‰Â·ç†±å¯‚ä¹‹ç¥ (GOD)', lv: 300 }] }
        ];

        let currentView = 'cities'; 
        let selectedCity = null;
        let selectedMonster = null;
        let cityData = {}; 
        let activeRooms = []; 
        let bossHubTimer = null;

        socket.on('connect', () => {
            const status = document.getElementById('conn-status');
            status.innerHTML = " å·²é€£ç·š";
            status.style.color = "#2ecc71";
            socket.emit('joinGame', myToken);
        });

        socket.on('disconnect', () => {
            const status = document.getElementById('conn-status');
            status.innerHTML = " æ–·ç·š...";
            status.style.color = "#e74c3c";
        });

        socket.on('tokenExpired', () => {
            alert("âš ï¸ ç™»å…¥æ†‘è­‰å·²å¤±æ•ˆ (å¯èƒ½å¯†ç¢¼å·²æ›´æ”¹)ï¼Œè«‹é‡æ–°ç™»å…¥ï¼");
            localStorage.removeItem('rpg_token'); 
            window.location.href = 'index.html';  
        });
        
        socket.on('playerStatsUpdate', (p) => {
            myLevel = p.level;
            myName = p.name;
            document.getElementById('pid').innerText = p.name || "Unknown";
            document.getElementById('lvl').innerText = p.level;
            document.getElementById('gold').innerText = (p.gold || 0).toLocaleString();
            let hpPct = (p.hp / p.maxHp) * 100;
            document.getElementById('hp').innerText = `${p.hp}/${p.maxHp}`;
            document.getElementById('hp-bar-fill').style.width = Math.max(0, Math.min(100, hpPct)) + '%';
            let mpPct = (p.mp / p.maxMp) * 100;
            document.getElementById('mp').innerText = `${p.mp}/${p.maxMp}`;
            document.getElementById('mp-bar-fill').style.width = Math.max(0, Math.min(100, mpPct)) + '%';
            document.getElementById('atk').innerText = (p.atk || 0).toLocaleString();
            document.getElementById('def').innerText = (p.def || 0).toLocaleString();
            document.getElementById('exp-txt').innerText = `${p.exp}/${p.maxExp}`;
            document.getElementById('exp-fill').style.width = Math.min(100, (p.exp / p.maxExp * 100)) + '%';
            refreshUI();
        });

        socket.on('hubDataUpdate', (data) => {
            cityData = data.cityCounts;
            activeRooms = data.roomsList;
            refreshUI(); 
        });

        socket.on('worldBossUpdate', (data) => {
            const banner = document.getElementById('boss-banner');
            if (data.active) {
                banner.style.display = 'block';
                const pct = (data.hp / data.maxHp) * 100;
                document.getElementById('boss-hp-bar').style.width = pct + "%";
                document.getElementById('boss-hp-text').innerText = `${(data.hp/100000000).toFixed(1)}å„„ / ${(data.maxHp/100000000).toFixed(1)}å„„`;
                if (data.remainingTime !== undefined) {
                    let timeLeft = Math.floor(data.remainingTime / 1000);
                    const timerSpan = document.getElementById('boss-timer');
                    if (bossHubTimer) clearInterval(bossHubTimer);
                    updateHubTimer(timerSpan, timeLeft);
                    bossHubTimer = setInterval(() => {
                        timeLeft--;
                        updateHubTimer(timerSpan, timeLeft);
                        if (timeLeft <= 0) clearInterval(bossHubTimer);
                    }, 1000);
                }
            } else {
                banner.style.display = 'none';
                if (bossHubTimer) clearInterval(bossHubTimer);
            }
        });

        socket.on('updateHubRanking', (ranking) => {
            const box = document.getElementById('boss-ranking-area');
            const list = document.getElementById('ranking-list');
            if (!ranking || ranking.length === 0) { box.style.display = 'none'; return; }
            box.style.display = 'block';
            list.innerHTML = '';
            ranking.forEach((r, index) => {
                const div = document.createElement('div');
                div.className = 'rank-row';
                let medal = `#${index + 1}`;
                let rankClass = '';
                if (index === 0) { medal = 'ğŸ¥‡'; rankClass = 'rank-1'; }
                else if (index === 1) { medal = 'ğŸ¥ˆ'; rankClass = 'rank-2'; }
                else if (index === 2) { medal = 'ğŸ¥‰'; rankClass = 'rank-3'; }
                let dmgText = (r.dmg / 100000000).toFixed(2) + "å„„";
                if (r.dmg < 100000000) dmgText = (r.dmg / 10000).toFixed(0) + "è¬";
                div.innerHTML = `<span class="${rankClass}">${medal} ${r.name}</span><span style="color:#ccc;">è¼¸å‡º: ${dmgText}</span>`;
                list.appendChild(div);
            });
        });

        function updateHubTimer(el, sec) {
            if (sec < 0) sec = 0;
            const m = Math.floor(sec / 60).toString().padStart(2, '0');
            const s = (sec % 60).toString().padStart(2, '0');
            el.innerText = `${m}:${s}`;
        }

        function joinBoss() { socket.emit('joinWorldBoss'); }

        socket.on('marketResult', (res) => { if (res.success) { showToast(res.msg); } });
        socket.on('bagResult', (res) => { if (res.success) { showToast(res.msg); } });

        function showToast(msg) {
            const toast = document.getElementById('toast-notification');
            toast.innerText = msg;
            toast.style.top = "30px"; 
            setTimeout(() => { toast.style.top = "-60px"; }, 3000);
        }

        socket.on('roomJoined', (data) => { 
            const roomId = data.roomId || data; 
            window.location.href = `battle.html?room=${roomId}`; 
        });
        
        socket.on('errorMessage', (msg) => { alert("âŒ " + msg); });
        socket.on('battleLog', (msg) => {
             appendChat('ç³»çµ±', msg);
        });

        socket.on('chatHistory', (history) => {
            const box = document.getElementById('chat-history');
            box.innerHTML = ''; 
            history.forEach(data => appendChat(data.name, data.msg));
        });

        socket.on('chatMessage', (data) => {
            appendChat(data.name, data.msg);
        });

        function appendChat(name, msg) {
            if (name === 'ç³»çµ±') return; 
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            const nameSpan = document.createElement('span');
            nameSpan.style.color = '#f1c40f';
            nameSpan.style.fontWeight = 'bold';
            nameSpan.textContent = `[${name}]: `;
            div.innerHTML = `<span style="color:#f1c40f; font-weight:bold;">[${name}]:</span> ${msg}`;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        document.getElementById('chat-send').onclick = sendChat;
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (msg) { socket.emit('sendChat', msg); input.value = ''; }
        }

        function toggleChat() {
            const chat = document.getElementById('chat-container');
            const header = document.getElementById('chat-header');
            if (window.innerWidth >= 1024) return;
            chat.classList.toggle('chat-open');
            header.innerText = chat.classList.contains('chat-open') ? " é»æ“Šæ”¶èµ·" : " å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)";
        }

        window.logout = function() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('rpg_token');
                window.location.href = 'index.html';
            }
        };

        let isProcessing = false;
        
        window.triggerCreateRoom = function(mobId) {
            if (isProcessing) return; 
            if (!socket.connected) { showToast("éŒ¯èª¤ï¼šæœªé€£ç·šåˆ°ä¼ºæœå™¨ï¼"); return; }
            isProcessing = true; 
            document.getElementById('list-title').innerText = "æ­£åœ¨å»ºç«‹æˆ¿é–“...";
            socket.emit('createRoom', mobId);
            setTimeout(() => {
                isProcessing = false;
                if(selectedMonster) document.getElementById('list-title').innerText = `${selectedMonster.name} - æˆ¿é–“`;
            }, 2000);
        };
        
        window.triggerJoinRoom = function(roomId) { socket.emit('joinRoom', roomId); };
        window.triggerEnterCity = function(cityId) {
            let city = WORLD_MAP.find(c => c.id === cityId);
            if (city) { selectedCity = city; currentView = 'monsters'; socket.emit('enterCity', cityId); refreshUI(); }
        };
        window.triggerSelectMonster = function(mobId) {
            let city = selectedCity;
            let mob = city.monsters.find(m => m.id === mobId);
            if (mob) { selectedMonster = mob; currentView = 'rooms'; refreshUI(); }
        };
        window.goBack = function(view) { currentView = view; refreshUI(); };

        function triggerSelectChaosBoss() {
            selectedMonster = { id: 'chaos_boss', name: 'ğŸ”® æ··æ²Œè£‚ç¸«', lv: '350-500' };
            currentView = 'rooms'; 
            refreshUI();
        }

        function refreshUI() {
            const container = document.getElementById('map-list');
            let html = '';
            
            if (currentView === 'cities') {
                document.getElementById('list-title').innerText = "é¸æ“‡å€åŸŸ";
                WORLD_MAP.forEach(city => {
                    const isLowLevel = myLevel < city.reqLv;
                    const count = cityData[city.id] || 0;
                    const warnText = isLowLevel ? `<span style="color:#e74c3c">(LV${city.reqLv})</span>` : '';
                    const lockClass = isLowLevel ? 'locked' : '';
                    const action = isLowLevel ? '' : `onclick="triggerEnterCity('${city.id}')"`;
                    html += `<div class="btn ${lockClass}" style="border-color:#3498db" ${action}>
                        <div style="display:flex; justify-content:space-between;"><span style="font-size:12px; font-weight:bold;">${city.name} ${warnText}</span><span class="info-tag">${count}äºº</span></div>
                        <div style="font-size:10px; color:#bdc3c7; margin-top:5px;">${city.desc}</div></div>`;
                });
            } else if (currentView === 'monsters') {
                document.getElementById('list-title').innerText = `${selectedCity.name} - æ€ªç‰©`;
                selectedCity.monsters.forEach(mob => {
                    const rooms = activeRooms.filter(r => r.monsterKey === mob.id);
                    const fighting = rooms.filter(r => r.status === 'fighting').length;
                    const waiting = rooms.filter(r => r.status === 'waiting').length;
                    html += `<div class="btn" style="border-color:#c0392b" onclick="triggerSelectMonster('${mob.id}')">
                        <span style="font-size:12px; font-weight:bold;">${mob.name} (LV.${mob.lv})</span>
                        <div style="margin-top:5px; font-size:10px;"><span class="info-tag" style="color:#2ecc71">ç­‰:${waiting}</span><span class="info-tag" style="color:#e74c3c; margin-right:10px;">æˆ°:${fighting}</span></div></div>`;
                });
                html += `<div class="btn" style="background:#7f8c8d; text-align:center;" onclick="goBack('cities')">â—€ è¿”å›åœ°åœ–</div>`;
            } else if (currentView === 'rooms') {
                document.getElementById('list-title').innerText = `${selectedMonster.name} - æˆ¿é–“`;
                html += `<div class="btn" style="background:#27ae60; text-align:center; font-weight:bold; font-size:12px;" onclick="triggerCreateRoom('${selectedMonster.id}')">â• é–‹æ–°æˆ¿é–“</div>`;
                const myRooms = activeRooms.filter(r => r.monsterKey === selectedMonster.id);
                if (myRooms.length === 0) html += `<div style="font-size:10px; color:#aaa; margin:10px;">ç›®å‰æ²’æœ‰æˆ¿é–“...</div>`;
                myRooms.forEach((room, index) => { 
                    const isFighting = room.status === 'fighting';
                    const clickAction = isFighting ? '' : `onclick="triggerJoinRoom('${room.id}')"`;
                    let statusTag = '<span class="room-tag status-waiting">ç­‰å¾…ä¸­</span>';
                    let lockClass = '';
                    if (isFighting) { statusTag = '<span class="room-tag status-fighting">æˆ°é¬¥ä¸­</span>'; lockClass = 'locked'; }
                    else if (room.playerCount >= 6) { statusTag = '<span class="room-tag" style="background:#e67e22; color:white">å·²æ»¿å“¡</span>'; }
                    html += `<div class="btn ${lockClass}" ${clickAction}>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:12px; font-weight:bold; color:#f1c40f;">ğŸš© ${room.hostName} çš„éšŠä¼</span>
                            <span style="font-size:10px; color:#bdc3c7;">#${index + 1}</span>
                        </div>
                        <div style="margin-top:5px; display:flex; justify-content:space-between;">${statusTag}<span class="info-tag">${room.playerCount}/5 äºº</span></div>
                        ${room.monsterKey === 'chaos_boss' ? `<div style="font-size:9px; color:#aaa; margin-top:2px;">ç›®æ¨™: ${room.monsterName}</div>` : ''}
                    </div>`;
                });
                if (selectedMonster.id === 'chaos_boss') {
                    html += `<div class="btn" style="background:#7f8c8d; text-align:center;" onclick="goBack('cities')">â—€ è¿”å›å¤§å»³</div>`;
                } else {
                    html += `<div class="btn" style="background:#7f8c8d; text-align:center;" onclick="goBack('monsters')">â—€ è¿”å›åˆ—è¡¨</div>`;
                }
            }
            container.innerHTML = html;
        }
    </script>
</body>
</html>
