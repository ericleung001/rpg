<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¹¸é‹å½©ç¥¨2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 20px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .header { color: #f1c40f; margin-bottom: 20px; text-shadow: 2px 2px #000; }
        
        .jackpot-box {
            background: #c0392b; padding: 15px; border-radius: 10px; border: 4px solid #e74c3c;
            margin-bottom: 20px; width: 100%; max-width: 500px; box-sizing: border-box;
            box-shadow: 0 0 20px #e74c3c; position: relative;
        }
        .jackpot-title { font-size: 12px; margin-bottom: 10px; }
        .jackpot-amount { font-size: 20px; font-weight: bold; color: #f1c40f; word-break: break-all; }
        
        /* ç³»çµ±é—œé–‰æ™‚çš„é®ç½© */
        .closed-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center;
            font-size: 14px; color: #e74c3c; font-weight: bold;
            z-index: 10; border-radius: 6px;
        }

        .number-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;
            max-width: 500px; margin-bottom: 20px;
        }
        .ball {
            width: 35px; height: 35px; border-radius: 50%;
            background: #ecf0f1; color: #2c3e50;
            display: flex; justify-content: center; align-items: center;
            font-size: 12px; font-weight: bold; cursor: pointer;
            border: 2px solid #bdc3c7; user-select: none;
            transition: transform 0.1s;
        }
        .ball:active { transform: scale(0.9); }
        .ball.selected { background: #e74c3c; color: white; border-color: #fff; box-shadow: 0 0 10px #e74c3c; }

        .selected-info { font-size: 12px; margin-bottom: 15px; color: #aaa; }
        .buy-btn {
            background: #27ae60; color: white; padding: 15px 30px; font-family: inherit; font-size: 14px;
            border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 4px 0 #1e8449;
            transition: background 0.3s;
        }
        .buy-btn:active { transform: translateY(4px); box-shadow: none; }
        
        /* ç¦ç”¨æŒ‰éˆ•æ¨£å¼ */
        .buy-btn:disabled {
            background: #7f8c8d; cursor: not-allowed; box-shadow: none; transform: none;
        }
        
        .back-btn { margin-top: 20px; background: #7f8c8d; padding: 10px 20px; color: white; text-decoration: none; border-radius: 5px; font-size: 12px; display: inline-block;}

        /* ğŸŸ¢ æˆ‘çš„å½©ç¥¨æ¨£å¼ */
        .my-tickets-area {
            width: 100%; max-width: 500px; margin-top: 30px;
            text-align: left;
        }
        .section-title { font-size: 12px; color: #3498db; margin-bottom: 10px; border-bottom: 1px dashed #555; padding-bottom: 5px; }
        
        .ticket-row {
            background: rgba(0,0,0,0.3); padding: 8px; margin-bottom: 5px; border-radius: 5px;
            display: flex; align-items: center; justify-content: space-between;
            border-left: 4px solid #f1c40f;
        }
        .ticket-nums { font-size: 10px; color: #fff; letter-spacing: 1px; }
        .ticket-tag { font-size: 8px; color: #aaa; }

        .last-result {
            margin-top: 30px; border-top: 1px dashed #7f8c8d; padding-top: 10px; font-size: 10px; color: #bdc3c7; width: 100%; max-width: 500px;
        }
        .result-balls { display: flex; gap: 5px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
        .res-ball { width: 30px; height: 30px; border-radius: 50%; background: #3498db; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; margin: 2px; }
    </style>
</head>
<body>

    <h1 class="header">ğŸ± å½©ç¥¨</h1>

    <div class="jackpot-box">
        <div id="closed-msg" class="closed-mask">â›” æš«åœè³¼è²·</div>
        <div class="jackpot-title">æœ¬æœŸç´¯ç©çé‡‘</div>
        <div class="jackpot-amount" id="jackpot-display">Loading...</div>
        <div style="font-size:10px; margin-top:5px;">æ¯æ™š 10:00 é–‹ç</div>
    </div>

    <div class="selected-info">
        å·²é¸è™Ÿç¢¼: <span id="count">0</span> / 6
        <br><br>
        <span id="selected-nums" style="color:#f1c40f; min-height: 20px; display:block;">-</span>
    </div>

    <div class="number-grid" id="grid"></div>

    <button id="btn-buy" class="buy-btn" onclick="buyTicket()">è³¼è²·å½©ç¥¨ (1è¬ G)</button>

    <div class="my-tickets-area">
        <div class="section-title">æˆ‘çš„å½©ç¥¨ (<span id="my-ticket-count">0</span>)</div>
        <div id="my-ticket-list">
            <div style="font-size:10px; color:#aaa; padding:10px;">å°šæœªè³¼è²·</div>
        </div>
    </div>

    <div class="last-result" id="last-result-area" style="display:none;">
        ä¸Šæ¬¡é–‹ççµæœ <span id="last-draw-time" style="font-size:8px; color:#777;"></span> :
        <div class="result-balls" id="res-balls"></div>
    </div>

    <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
            transports: ['websocket', 'polling'],
            secure: true 
        });
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let selected = [];
        let isLotteryOpen = true;

        // åˆå§‹åŒ– 49 å€‹è™Ÿç¢¼çƒ
        const grid = document.getElementById('grid');
        for(let i=1; i<=49; i++) {
            const ball = document.createElement('div');
            ball.className = 'ball';
            ball.innerText = i;
            ball.onclick = () => toggleNumber(i, ball);
            grid.appendChild(ball);
        }

        function toggleNumber(n, el) {
            if (!isLotteryOpen) return; // é—œé–‰æ™‚ä¸èƒ½é¸

            if (selected.includes(n)) {
                selected = selected.filter(x => x !== n);
                el.classList.remove('selected');
            } else {
                if (selected.length >= 6) { alert("æœ€å¤šåªèƒ½é¸ 6 å€‹è™Ÿç¢¼ï¼"); return; }
                selected.push(n);
                el.classList.add('selected');
            }
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('count').innerText = selected.length;
            document.getElementById('selected-nums').innerText = selected.sort((a,b)=>a-b).join(', ');
        }

        function buyTicket() {
            if (!isLotteryOpen) { alert("â›” ç³»çµ±ç›®å‰æš«åœè³¼è²·ï¼"); return; }
            if (selected.length !== 6) { alert("è«‹é¸æ“‡ 6 å€‹è™Ÿç¢¼ï¼"); return; }
            if (!confirm(`ç¢ºå®šè¦èŠ±è²» 10,000 G è³¼è²·è™Ÿç¢¼ [${selected.join(',')}] å—ï¼Ÿ`)) return;
            
            socket.emit('buyLottery', selected);
        }

        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
            socket.emit('getLotteryInfo'); // è«‹æ±‚çæ± è³‡è¨Š
        });

        socket.on('lotteryUpdate', (data) => {
            // 1. æ›´æ–°çæ± èˆ‡ç‹€æ…‹
            document.getElementById('jackpot-display').innerText = `$ ${data.jackpot.toLocaleString()}`;
            
            if (data.isOpen !== undefined) {
                isLotteryOpen = data.isOpen;
                const btn = document.getElementById('btn-buy');
                const mask = document.getElementById('closed-msg');
                
                if (isLotteryOpen) {
                    btn.disabled = false;
                    btn.innerText = "è³¼è²·å½©ç¥¨ (1è¬ G)";
                    mask.style.display = 'none';
                } else {
                    btn.disabled = true;
                    btn.innerText = "â›” æš«åœè³¼è²·";
                    mask.style.display = 'flex';
                }
            }

            // 2. æ›´æ–°æˆ‘çš„å½©ç¥¨åˆ—è¡¨
            if (data.myBets) {
                const list = document.getElementById('my-ticket-list');
                const count = document.getElementById('my-ticket-count');
                
                count.innerText = data.myBets.length;
                list.innerHTML = '';

                if (data.myBets.length === 0) {
                    list.innerHTML = '<div style="font-size:10px; color:#aaa; padding:10px;">å°šæœªè³¼è²·</div>';
                } else {
                    // åè½‰é™£åˆ—ï¼Œè®“æœ€æ–°çš„é¡¯ç¤ºåœ¨æœ€ä¸Šé¢
                    const reversedBets = [...data.myBets].reverse();
                    
                    reversedBets.forEach((bet, idx) => {
                        const div = document.createElement('div');
                        div.className = 'ticket-row';
                        
                        // å°‡è™Ÿç¢¼ç¾åŒ–é¡¯ç¤º
                        const fmtNums = bet.nums.map(n => n.toString().padStart(2, '0')).join(' - ');
                        
                        // è¨ˆç®—é€™æ˜¯ç¬¬å¹¾å¼µ (åŸæœ¬çš„ç´¢å¼•æ˜¯å€’éä¾†çš„)
                        const ticketNum = data.myBets.length - idx;

                        div.innerHTML = `
                            <span class="ticket-tag">#${ticketNum}</span>
                            <span class="ticket-nums">${fmtNums}</span>
                        `;
                        list.appendChild(div);
                    });
                }
            }

            // 3. æ›´æ–°ä¸Šæ¬¡é–‹ççµæœ (ä¿®æ­£ç‰ˆ)
            if (data.lastDraw && data.lastDraw.numbers) {
                document.getElementById('last-result-area').style.display = 'block';
                const container = document.getElementById('res-balls');
                container.innerHTML = '';
                
                // é¡¯ç¤ºè™Ÿç¢¼çƒ
                data.lastDraw.numbers.forEach(n => {
                    const b = document.createElement('div');
                    b.className = 'res-ball';
                    b.innerText = n;
                    container.appendChild(b);
                });

                // é¡¯ç¤ºé–‹çæ™‚é–“
                if (data.lastDraw.time) {
                    const date = new Date(data.lastDraw.time);
                    document.getElementById('last-draw-time').innerText = 
                        `(${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')})`;
                }
            }
        });

        socket.on('lotteryResult', (res) => {
            alert(res.msg);
            if(res.success) {
                // æ¸…ç©ºé¸æ“‡
                selected = [];
                document.querySelectorAll('.ball').forEach(b => b.classList.remove('selected'));
                updateDisplay();
            }
        });

        socket.on('errorMessage', (msg) => { alert(msg); });

    </script>
</body>
</html>
