<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>裝備強化</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 15px; 
            display:flex; flex-direction:column; align-items:center; 
            height: 100dvh; margin:0; box-sizing:border-box; 
            overflow: scroll;
        }
        
        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 20px; margin: 0; color: #e67e22; text-shadow: 2px 2px 0 #000; }

        .container { 
            width: 100%; max-width: 600px; flex: 1; 
            display: flex; flex-direction: column; gap: 15px; 
        }

        .enhance-card { 
            background: #34495e; border: 4px solid #7f8c8d; 
            padding: 15px; border-radius: 10px; 
            width: 100%; box-sizing: border-box; 
        }

        .slot-btn { 
            width: 100%; padding: 15px; margin: 8px 0; 
            border: 2px solid #bdc3c7; background: #2c3e50; color: white; 
            font-family: inherit; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 6px; font-size: 10px;
            transition: all 0.2s;
        }
        .slot-btn:active { transform: scale(0.98); }
        .slot-btn.selected { border-color: #f1c40f; background: #222; box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        
        .enhance-info { 
            background: #222; padding: 20px; border: 2px dashed #e67e22; 
            margin-top: 10px; display: none; border-radius: 8px; 
            width: 100%; box-sizing: border-box; text-align: left;
        }
        
        .info-row { margin-bottom: 8px; font-size: 10px; display: flex; justify-content: space-between; }
        .plus-text { color: #f1c40f; font-weight: bold; }
        
        .risk-safe { color: #2ecc71; }
        .risk-drop { color: #e67e22; }
        .risk-break { color: #e74c3c; font-weight: bold; }

        .btn { 
            padding: 15px; font-family: inherit; font-size: 14px; font-weight: bold;
            cursor: pointer; border: 2px solid #fff; color: white; margin-top: 15px; width: 100%; 
            background: #c0392b; border-radius: 6px;
        }
        .btn:disabled { background: #555; cursor: not-allowed; }
        
        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
            margin-top: 20px;
        }

        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f; color: #fff;
            padding: 15px 30px; border-radius: 30px; z-index: 9999; font-size: 14px;
            font-weight: bold; white-space: nowrap; transition: top 0.5s ease-in-out; 
            pointer-events: none; 
        }

        /* 強化動畫 */
        #hammer-anim { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 999; display: none; 
            flex-direction: column; justify-content: center; align-items: center;
        }
        .hammer { font-size: 80px; animation: hit 0.5s infinite; }
        @keyframes hit { 0% { transform: rotate(0deg); } 50% { transform: rotate(-45deg); } 100% { transform: rotate(0deg); } }
    </style>
</head>
<body>
    <div id="game-toast"></div>
    
    <div id="hammer-anim">
        <div class="hammer"></div>
        <div style="color:white; margin-top:20px; font-size:14px;">強化進行中...</div>
    </div>

    <div class="header">
        <h1> 裝備強化</h1>
        <div class="gold-display"> <span id="my-gold">0</span> G</div>
    </div>

    <div class="container">
        <div style="font-size: 10px; color: #bdc3c7; margin-bottom: 5px;">
            消耗金幣與強化石提升裝備能力<br>
            擁有強化石: <span id="stone-count" style="color:#2ecc71; font-size:12px;">0</span>
        </div>

        <div class="enhance-card">
            <button id="btn-weapon" class="slot-btn" onclick="selectEnhanceSlot('weapon')">
                <span>⚔️ 武器</span>
                <span id="weapon-display">無</span>
            </button>
            <button id="btn-armor" class="slot-btn" onclick="selectEnhanceSlot('armor')">
                <span>️ 防具</span>
                <span id="armor-display">無</span>
            </button>
            <button id="btn-acc" class="slot-btn" onclick="selectEnhanceSlot('acc')">
                <span> 飾品</span>
                <span id="acc-display">無</span>
            </button>
        </div>

        <div id="enhance-info" class="enhance-info">
            <div id="target-name" style="color: #f1c40f; margin-bottom: 15px; font-size: 14px; font-weight: bold; text-align:center; border-bottom:1px solid #555; padding-bottom:10px;"></div>
            
            <div class="info-row"><span>當前等級:</span> <span id="cur-lv" style="color:#fff">0</span></div>
            <div class="info-row"><span>強化目標:</span> <span id="next-lv" style="color:#f1c40f; font-weight:bold;">+1</span></div>
            <div class="info-row"><span>成功機率:</span> <span id="rate-txt">100%</span></div>
            <div class="info-row"><span>消耗金幣:</span> <span id="cost-txt" style="color:#f1c40f">1000</span></div>
            <div class="info-row"><span>消耗材料:</span> <span>強化石 x1</span></div>
            
            <div style="margin-top: 10px; border-top: 1px dashed #555; padding-top: 10px; text-align:center;">
                失敗風險: <span id="risk-txt" class="risk-safe">無</span>
            </div>
            
            <button id="enhance-btn" class="btn" style="animation: pulse 2s infinite;" onclick="doEnhance()"> 開始強化 </button>
        </div>
    </div>

    <a href="hub.html" class="back-btn">◀ 返回大廳</a>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
            transports: ['websocket', 'polling'],
            secure: true 
        });
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myData = null;
        let selectedEnhanceSlot = null;

        //  裝備名稱對照表 (確保顯示中文)
        const ITEM_MAP = {
            'wood_sword': '木劍', 'copper_dagger': '銅匕首', 'iron_sword': '鐵劍', 'silver_blade': '銀刃',
            'spike_club': '狼牙棒', 'poison_dag': '劇毒匕首', 'shark_tooth': '鯊魚牙匕首',
            'flame_staff': '火焰法杖', 'emerald_staff': '翡翠法杖', 'gold_axe': '黃金巨斧',
            'obsidian_blade': '黑曜石之劍', 'frost_bow': '寒冰弓', 'dragon_spear': '龍骨長槍',
            'mithril_saber': '秘銀軍刀', 'void_reaper': '虛空收割者', 'void_reaper_dark': '闇·虛空收割者',
            'god_slayer': '弒神劍', 'chaos_staff': '混沌法杖', 'hero_sword': '勇者之劍',
            'steel_blade': '精鋼劍', 'assassin_dag': '刺客短刀', 'genesis_weapon': '創世·終焉之劍',
            'void_blade': '虛空之刃', 'galaxy_saber': '銀河光劍', 'entropy_sword': '終焉·熱寂之劍',
            'oak_bow': '橡木弓', 'maple_staff': '楓木法杖',
            'cloth_armor': '布衣', 'hunt_vest': '獵人背心', 'leather_armor': '皮甲', 'plate_mail': '板金甲',
            'dragon_mail': '龍鱗甲', 'chain_mail': '鎖子甲', 'iron_armor': '鐵盔甲', 'magma_plate': '熔岩胸甲',
            'ice_robe': '冰霜法袍', 'yeti_cloak': '雪怪斗篷', 'demon_armor': '惡魔戰甲',
            'angel_armor': '熾天使鎧甲', 'genesis_armor': '創世·神之庇護',
            'void_armor': '虛空戰甲', 'nebula_plate': '星雲板甲', 'entropy_god_armor': '終焉·神之庇護',
            'bone_ring': '骨戒', 'ring_str': '力量戒指', 'bracelet_def': '堅毅手環',
            'necklace_hp': '紅水晶項鍊', 'necklace_mp': '藍水晶項鍊', 'snake_boots': '蛇皮長靴',
            'fish_ring': '魚鱗戒指', 'pearl_necklace': '珍珠項鍊', 'amulet_soul': '靈魂護符',
            'ring_lord': '領主指環', 'crown_chaos': '混沌之冠', 'ring_galaxy': '銀河指環',
            'ring_life': '生命護符', 'ring_magic': '魔力耳環', 'dimension_ring': '維度指環'
        };

        const ENHANCE_RATES = {
            1: { rate: 100, cost: 1000, risk: 'safe' },
            2: { rate: 100, cost: 2000, risk: 'safe' },
            3: { rate: 100, cost: 5000, risk: 'safe' },
            4: { rate: 80,  cost: 10000, risk: 'drop' },
            5: { rate: 70,  cost: 20000, risk: 'drop' },
            6: { rate: 60,  cost: 40000, risk: 'drop' },
            7: { rate: 50,  cost: 80000, risk: 'break' },
            8: { rate: 40,  cost: 150000,risk: 'break' },
            9: { rate: 30,  cost: 300000,risk: 'break' },
            10:{ rate: 20,  cost: 1000000,risk: 'break'}
        };

        socket.on('connect', () => { socket.emit('joinGame', myToken); });

        socket.on('playerStatsUpdate', (p) => {
            myData = p;
            document.getElementById('my-gold').innerText = p.gold.toLocaleString();
            updateUI();
        });

        socket.on('enhanceResult', (res) => {
            document.getElementById('hammer-anim').style.display = 'none';
            if(res.success) {
                showMsg(res.msg);
            } else {
                alert(res.msg);
            }
            if(res.broken) {
                document.getElementById('enhance-info').style.display = 'none';
                selectedEnhanceSlot = null;
                document.querySelectorAll('.slot-btn').forEach(el => el.classList.remove('selected'));
            }
        });

        socket.on('errorMessage', (msg) => { 
            document.getElementById('hammer-anim').style.display = 'none';
            alert("❌ " + msg); 
        });

        function updateUI() {
            if(!myData) return;
            const stones = myData.inventory['enhance_stone'] || 0;
            document.getElementById('stone-count').innerText = stones;

            updateSlotDisplay('weapon');
            updateSlotDisplay('armor');
            updateSlotDisplay('acc');

            if (selectedEnhanceSlot) selectEnhanceSlot(selectedEnhanceSlot);
        }

        function updateSlotDisplay(slot) {
            const el = document.getElementById(`${slot}-display`);
            const itemId = myData.equipment[slot];
            
            if (itemId) {
                //  讀取強化等級 (ItemID based)
                const lv = (myData.enhancements && myData.enhancements[itemId]) || 0;
                let name = ITEM_MAP[itemId] || itemId;
                
                if (lv > 0) {
                    name += ` <span class="plus-text">+${lv}</span>`;
                }
                el.innerHTML = name;
                el.style.color = "#fff";
            } else {
                el.innerHTML = `<span style="color:#555">無</span>`;
            }
        }

        function selectEnhanceSlot(slot) {
            document.querySelectorAll('.slot-btn').forEach(el => el.classList.remove('selected'));
            document.getElementById(`btn-${slot}`).classList.add('selected');

            const itemId = myData.equipment[slot];
            if (!itemId) {
                document.getElementById('enhance-info').style.display = 'none';
                selectedEnhanceSlot = null;
                alert("該部位沒有裝備！");
                return;
            }

            selectedEnhanceSlot = slot;
            const currentLv = (myData.enhancements && myData.enhancements[itemId]) || 0;
            const nextLv = currentLv + 1;

            if (nextLv > 10) {
                document.getElementById('enhance-info').style.display = 'block';
                document.getElementById('target-name').innerText = (ITEM_MAP[itemId] || itemId) + " (MAX)";
                document.getElementById('enhance-btn').style.display = 'none';
                // 隱藏其他資訊
                return;
            }

            const config = ENHANCE_RATES[nextLv];
            
            document.getElementById('enhance-info').style.display = 'block';
            document.getElementById('enhance-btn').style.display = 'block';
            document.getElementById('target-name').innerText = ITEM_MAP[itemId] || itemId;
            
            document.getElementById('cur-lv').innerText = `+${currentLv}`;
            document.getElementById('next-lv').innerText = `+${nextLv}`;
            document.getElementById('rate-txt').innerText = `${config.rate}%`;
            document.getElementById('cost-txt').innerText = config.cost.toLocaleString() + " G";
            
            const riskEl = document.getElementById('risk-txt');
            riskEl.className = "";
            if (config.risk === 'safe') {
                riskEl.innerText = "安全 (無懲罰)";
                riskEl.classList.add("risk-safe");
            } else if (config.risk === 'drop') {
                riskEl.innerText = "危險 (失敗降級)";
                riskEl.classList.add("risk-drop");
            } else {
                riskEl.innerText = "極度危險 (失敗裝備消失)";
                riskEl.classList.add("risk-break");
            }
        }

        function doEnhance() {
            if (!selectedEnhanceSlot) return;
            if (confirm(`確定要強化嗎？\n失敗可能會導致降級或消失！`)) {
                document.getElementById('hammer-anim').style.display = 'flex';
                // 模擬延遲 1.5秒
                setTimeout(() => {
                    socket.emit('enhanceItem', selectedEnhanceSlot);
                }, 1500);
            }
        }

        function showMsg(text) {
            const toast = document.getElementById('game-toast');
            toast.innerText = text;
            toast.style.top = "30px"; 
            setTimeout(() => { toast.style.top = "-100px"; }, 3000);
        }
    </script>
</body>
</html>