<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è£å‚™å¼·åŒ–</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; margin: 0; padding: 0;
            display: flex; justify-content: center;
            height: 100dvh; overflow: hidden; 
        }

        #app-layout {
            display: flex;
            flex-direction: column; 
            width: 100%;
            height: 100%;
            max-width: 600px; 
            position: relative;
        }

        /* ä¸»å…§å®¹å€å¡Š (å·¦å´/æ‰‹æ©Ÿå…¨è¢å¹•) */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 40px; /* ç•™ç©ºé–“çµ¦æ‰‹æ©Ÿç‰ˆèŠå¤©å®¤ */
            width: 100%;
            box-sizing: border-box;
        }
        
        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 20px; margin: 0; color: #e67e22; text-shadow: 2px 2px 0 #000; }

        .container { 
            width: 100%; max-width: 600px; flex: 1; 
            display: flex; flex-direction: column; gap: 15px; 
        }

        .enhance-card { 
            background: #34495e; border: 4px solid #7f8c8d; 
            padding: 15px; border-radius: 10px; 
            width: 100%; box-sizing: border-box; 
        }

        .slot-btn { 
            width: 100%; padding: 15px; margin: 8px 0; 
            border: 2px solid #bdc3c7; background: #2c3e50; color: white; 
            font-family: inherit; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 6px; font-size: 10px;
            transition: all 0.2s;
        }
        .slot-btn:active { transform: scale(0.98); }
        .slot-btn.selected { border-color: #f1c40f; background: #222; box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        
        .enhance-info { 
            background: #222; padding: 20px; border: 2px dashed #e67e22; 
            margin-top: 10px; display: none; border-radius: 8px; 
            width: 100%; box-sizing: border-box; text-align: left;
        }
        
        .info-row { margin-bottom: 8px; font-size: 10px; display: flex; justify-content: space-between; }
        .plus-text { color: #f1c40f; font-weight: bold; }
        
        .risk-safe { color: #2ecc71; }
        .risk-drop { color: #e67e22; }
        .risk-break { color: #e74c3c; font-weight: bold; }

        .btn { 
            padding: 15px; font-family: inherit; font-size: 14px; font-weight: bold;
            cursor: pointer; border: 2px solid #fff; color: white; margin-top: 15px; width: 100%; 
            background: #c0392b; border-radius: 6px;
        }
        .btn:disabled { background: #555; cursor: not-allowed; }
        
        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
            margin-top: 20px;
        }

        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f; color: #fff;
            padding: 15px 30px; border-radius: 30px; z-index: 20000; font-size: 14px;
            font-weight: bold; white-space: nowrap; transition: top 0.5s ease-in-out; 
            pointer-events: none; 
        }

        /* å¼·åŒ–å‹•ç•« (å±¤ç´šè¦æœ€é«˜ï¼Œè“‹éèŠå¤©å®¤) */
        #hammer-anim { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 30000; display: none; 
            flex-direction: column; justify-content: center; align-items: center;
        }
        .hammer { font-size: 80px; animation: hit 0.5s infinite; }
        @keyframes hit { 0% { transform: rotate(0deg); } 50% { transform: rotate(-45deg); } 100% { transform: rotate(0deg); } }

        /* --- èŠå¤©å®¤æ¨£å¼ --- */
        #chat-container {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.95); border-top: 4px solid #bdc3c7;
            display: flex; flex-direction: column; font-size: 10px; 
            z-index: 12000; 
            padding-bottom: env(safe-area-inset-bottom);
            transition: height 0.3s ease-in-out;
            height: 30px; 
        }
        #chat-header {
            height: 30px; background: #34495e; color: #fff; line-height: 30px; 
            cursor: pointer; font-weight: bold; border-bottom: 1px solid #555;
            display: flex; justify-content: center; align-items: center;
            touch-action: manipulation; flex-shrink: 0; 
        }
        #chat-header:hover { background: #2c3e50; }
        .chat-open { height: 40vh !important; }
        #chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-open #chat-body { display: flex; } 
        #chat-history { flex: 1; overflow-y: auto; padding: 8px; text-align: left; color: white; }
        #chat-input-area { display: flex; border-top: 1px solid #555; height: 40px; flex-shrink: 0; }
        #chat-input { flex: 1; background: #222; color: white; border: none; padding: 0 10px; font-family: inherit; font-size: 12px; outline: none; }
        #chat-send { background: #2980b9; color: white; border: none; padding: 0 15px; cursor: pointer; font-family: inherit; font-size: 12px; font-weight: bold; touch-action: manipulation; }

        @media (min-width: 1024px) {
            body { background-color: #222; }
            #app-layout {
                flex-direction: row; 
                max-width: 1000px; 
                background-color: #2c3e50;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
            }
            #main-content {
                width: 600px; 
                border-right: 4px solid #bdc3c7;
            }
            #chat-container {
                position: relative; 
                width: 400px;
                height: 100% !important; 
                border-top: none;
                background: #34495e;
            }
            #chat-header { cursor: default; background: #2c3e50; }
            #chat-header:active { pointer-events: none; }
            #chat-body { display: flex !important; height: calc(100% - 30px); }
        }
    </style>
</head>
<body>
    <div id="game-toast"></div>
    
    <div id="hammer-anim">
        <div class="hammer">ğŸ”¨</div>
        <div style="color:white; margin-top:20px; font-size:14px;">å¼·åŒ–é€²è¡Œä¸­...</div>
    </div>

    <div id="app-layout">
        <div id="main-content">
            <div class="header">
                <h1> è£å‚™å¼·åŒ–</h1>
                <div class="gold-display"> <span id="my-gold">0</span> G</div>
            </div>

            <div class="container">
                <div style="font-size: 10px; color: #bdc3c7; margin-bottom: 5px;">
                    æ¶ˆè€—é‡‘å¹£èˆ‡å¼·åŒ–çŸ³æå‡è£å‚™èƒ½åŠ›<br>
                    æ“æœ‰å¼·åŒ–çŸ³: <span id="stone-count" style="color:#2ecc71; font-size:12px;">0</span>
                </div>

                <div class="enhance-card">
                    <button id="btn-weapon" class="slot-btn" onclick="selectEnhanceSlot('weapon')">
                        <span>âš”ï¸ æ­¦å™¨</span>
                        <span id="weapon-display">ç„¡</span>
                    </button>
                    <button id="btn-armor" class="slot-btn" onclick="selectEnhanceSlot('armor')">
                        <span>ï¸ é˜²å…·</span>
                        <span id="armor-display">ç„¡</span>
                    </button>
                    <button id="btn-acc" class="slot-btn" onclick="selectEnhanceSlot('acc')">
                        <span> é£¾å“</span>
                        <span id="acc-display">ç„¡</span>
                    </button>
                </div>

                <div id="enhance-info" class="enhance-info">
                    <div id="target-name" style="color: #f1c40f; margin-bottom: 15px; font-size: 14px; font-weight: bold; text-align:center; border-bottom:1px solid #555; padding-bottom:10px;"></div>
                    
                    <div class="info-row"><span>ç•¶å‰ç­‰ç´š:</span> <span id="cur-lv" style="color:#fff">0</span></div>
                    <div class="info-row"><span>å¼·åŒ–ç›®æ¨™:</span> <span id="next-lv" style="color:#f1c40f; font-weight:bold;">+1</span></div>
                    <div class="info-row"><span>æˆåŠŸæ©Ÿç‡:</span> <span id="rate-txt">100%</span></div>
                    <div class="info-row"><span>æ¶ˆè€—é‡‘å¹£:</span> <span id="cost-txt" style="color:#f1c40f">1000</span></div>
                    <div class="info-row"><span>æ¶ˆè€—ææ–™:</span> <span>å¼·åŒ–çŸ³ x1</span></div>
                    
                    <div style="margin-top: 10px; border-top: 1px dashed #555; padding-top: 10px; text-align:center;">
                        å¤±æ•—é¢¨éšª: <span id="risk-txt" class="risk-safe">ç„¡</span>
                    </div>
                    
                    <button id="enhance-btn" class="btn" style="animation: pulse 2s infinite;" onclick="doEnhance()"> é–‹å§‹å¼·åŒ– </button>
                </div>
            </div>

            <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>
        </div>

        <div id="chat-container">
            <div id="chat-header" onclick="toggleChat()"> å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)</div>
            <div id="chat-body">
                <div id="chat-history"></div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." maxlength="50">
                    <button id="chat-send">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myData = null;
        let selectedEnhanceSlot = null;

        //  è£å‚™åç¨±å°ç…§è¡¨ (ç¢ºä¿é¡¯ç¤ºä¸­æ–‡)
        const ITEM_MAP = {
            'wood_sword': 'æœ¨åŠ', 'copper_dagger': 'éŠ…åŒ•é¦–', 'iron_sword': 'éµåŠ', 'silver_blade': 'éŠ€åˆƒ',
            'spike_club': 'ç‹¼ç‰™æ£’', 'poison_dag': 'åŠ‡æ¯’åŒ•é¦–', 'shark_tooth': 'é¯Šé­šç‰™åŒ•é¦–',
            'flame_staff': 'ç«ç„°æ³•æ–', 'emerald_staff': 'ç¿¡ç¿ æ³•æ–', 'gold_axe': 'é»ƒé‡‘å·¨æ–§',
            'obsidian_blade': 'é»‘æ›œçŸ³ä¹‹åŠ', 'frost_bow': 'å¯’å†°å¼“', 'dragon_spear': 'é¾éª¨é•·æ§',
            'mithril_saber': 'ç§˜éŠ€è»åˆ€', 'void_reaper': 'è™›ç©ºæ”¶å‰²è€…', 'void_reaper_dark': 'é—‡Â·è™›ç©ºæ”¶å‰²è€…',
            'god_slayer': 'å¼’ç¥åŠ', 'chaos_staff': 'æ··æ²Œæ³•æ–', 'hero_sword': 'å‹‡è€…ä¹‹åŠ',
            'steel_blade': 'ç²¾é‹¼åŠ', 'assassin_dag': 'åˆºå®¢çŸ­åˆ€', 'genesis_weapon': 'å‰µä¸–Â·çµ‚ç„‰ä¹‹åŠ',
            'void_blade': 'è™›ç©ºä¹‹åˆƒ', 'galaxy_saber': 'éŠ€æ²³å…‰åŠ', 'entropy_sword': 'çµ‚ç„‰Â·ç†±å¯‚ä¹‹åŠ',
            'oak_bow': 'æ©¡æœ¨å¼“', 'maple_staff': 'æ¥“æœ¨æ³•æ–',
            'cloth_armor': 'å¸ƒè¡£', 'hunt_vest': 'çµäººèƒŒå¿ƒ', 'leather_armor': 'çš®ç”²', 'plate_mail': 'æ¿é‡‘ç”²',
            'dragon_mail': 'é¾é±—ç”²', 'chain_mail': 'é–å­ç”²', 'iron_armor': 'éµç›”ç”²', 'magma_plate': 'ç†”å²©èƒ¸ç”²',
            'ice_robe': 'å†°éœœæ³•è¢', 'yeti_cloak': 'é›ªæ€ªæ–—ç¯·', 'demon_armor': 'æƒ¡é­”æˆ°ç”²',
            'angel_armor': 'ç†¾å¤©ä½¿é§ç”²', 'genesis_armor': 'å‰µä¸–Â·ç¥ä¹‹åº‡è­·',
            'void_armor': 'è™›ç©ºæˆ°ç”²', 'nebula_plate': 'æ˜Ÿé›²æ¿ç”²', 'entropy_god_armor': 'çµ‚ç„‰Â·ç¥ä¹‹åº‡è­·',
            'bone_ring': 'éª¨æˆ’', 'ring_str': 'åŠ›é‡æˆ’æŒ‡', 'bracelet_def': 'å …æ¯…æ‰‹ç’°',
            'necklace_hp': 'ç´…æ°´æ™¶é …éŠ', 'necklace_mp': 'è—æ°´æ™¶é …éŠ', 'snake_boots': 'è›‡çš®é•·é´',
            'fish_ring': 'é­šé±—æˆ’æŒ‡', 'pearl_necklace': 'çç é …éŠ', 'amulet_soul': 'éˆé­‚è­·ç¬¦',
            'ring_lord': 'é ˜ä¸»æŒ‡ç’°', 'crown_chaos': 'æ··æ²Œä¹‹å† ', 'ring_galaxy': 'éŠ€æ²³æŒ‡ç’°',
            'ring_life': 'ç”Ÿå‘½è­·ç¬¦', 'ring_magic': 'é­”åŠ›è€³ç’°', 'dimension_ring': 'ç¶­åº¦æŒ‡ç’°'
        };

        // ğŸŸ¢ [æ›´æ–°] å¼·åŒ–æ©Ÿç‡è¡¨ (æ”¯æ´åˆ° +20)
        const ENHANCE_RATES = {
            1: { rate: 100, cost: 1000,  risk: 'safe' },
            2: { rate: 100, cost: 2000,  risk: 'safe' },
            3: { rate: 100, cost: 5000,  risk: 'safe' },
            4: { rate: 80,  cost: 10000, risk: 'drop' },
            5: { rate: 70,  cost: 20000, risk: 'drop' },
            6: { rate: 60,  cost: 40000, risk: 'drop' },
            7: { rate: 50,  cost: 80000, risk: 'drop' },
            8: { rate: 40,  cost: 150000,risk: 'drop' },
            9: { rate: 30,  cost: 300000,risk: 'drop' },
            10:{ rate: 20,  cost: 1000000,risk: 'drop'},
            
            // --- æ–°å¢ +11 ~ +20 ---
            11:{ rate: 15, cost: 2000000, risk: 'break'},
            12:{ rate: 12, cost: 3000000, risk: 'break'},
            13:{ rate: 10, cost: 5000000, risk: 'break'},
            14:{ rate: 8,  cost: 8000000, risk: 'break'},
            15:{ rate: 5,  cost: 10000000,risk: 'break'},
            16:{ rate: 3,  cost: 20000000,risk: 'break'},
            17:{ rate: 2,  cost: 30000000,risk: 'break'},
            18:{ rate: 1,  cost: 50000000,risk: 'break'},
            19:{ rate: 0.5,cost: 80000000,risk: 'break'},
            20:{ rate: 0.1,cost: 100000000,risk: 'break'}
        };

        socket.on('connect', () => { socket.emit('joinGame', myToken); });

        socket.on('playerStatsUpdate', (p) => {
            myData = p;
            document.getElementById('my-gold').innerText = p.gold.toLocaleString();
            updateUI();
        });

        socket.on('enhanceResult', (res) => {
            document.getElementById('hammer-anim').style.display = 'none';
            if(res.success) {
                showMsg(res.msg);
            } else {
                alert(res.msg);
            }
            if(res.broken) {
                document.getElementById('enhance-info').style.display = 'none';
                selectedEnhanceSlot = null;
                document.querySelectorAll('.slot-btn').forEach(el => el.classList.remove('selected'));
            }
        });

        socket.on('errorMessage', (msg) => { 
            document.getElementById('hammer-anim').style.display = 'none';
            alert("âŒ " + msg); 
        });

        // --- èŠå¤©åŠŸèƒ½ ---
        socket.on('chatHistory', (history) => {
            const box = document.getElementById('chat-history');
            box.innerHTML = ''; 
            history.forEach(data => appendChat(data.name, data.msg));
        });
        socket.on('chatMessage', (data) => { appendChat(data.name, data.msg); });
        
        function appendChat(name, msg) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            const nameSpan = document.createElement('span');
            nameSpan.style.color = '#f1c40f'; nameSpan.style.fontWeight = 'bold';
            nameSpan.textContent = `[${name}]: `;
            div.appendChild(nameSpan); div.appendChild(document.createTextNode(msg));
            history.appendChild(div); history.scrollTop = history.scrollHeight;
        }

        document.getElementById('chat-send').onclick = sendChat;
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (msg) { socket.emit('sendChat', msg); input.value = ''; }
        }
        function toggleChat() {
            const chat = document.getElementById('chat-container');
            const header = document.getElementById('chat-header');
            if (window.innerWidth >= 1024) return;
            chat.classList.toggle('chat-open');
            header.innerText = chat.classList.contains('chat-open') ? " é»æ“Šæ”¶èµ·" : " å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)";
        }

        function updateUI() {
            if(!myData) return;
            const stones = myData.inventory['enhance_stone'] || 0;
            document.getElementById('stone-count').innerText = stones;

            updateSlotDisplay('weapon');
            updateSlotDisplay('armor');
            updateSlotDisplay('acc');

            if (selectedEnhanceSlot) selectEnhanceSlot(selectedEnhanceSlot);
        }

        function updateSlotDisplay(slot) {
            const el = document.getElementById(`${slot}-display`);
            const itemId = myData.equipment[slot];
            
            if (itemId) {
                //  è®€å–å¼·åŒ–ç­‰ç´š (ItemID based)
                const lv = (myData.enhancements && myData.enhancements[itemId]) || 0;
                let name = ITEM_MAP[itemId] || itemId;
                
                if (lv > 0) {
                    name += ` <span class="plus-text">+${lv}</span>`;
                }
                el.innerHTML = name;
                el.style.color = "#fff";
            } else {
                el.innerHTML = `<span style="color:#555">ç„¡</span>`;
            }
        }

        function selectEnhanceSlot(slot) {
            document.querySelectorAll('.slot-btn').forEach(el => el.classList.remove('selected'));
            document.getElementById(`btn-${slot}`).classList.add('selected');

            const itemId = myData.equipment[slot];
            if (!itemId) {
                document.getElementById('enhance-info').style.display = 'none';
                selectedEnhanceSlot = null;
                alert("è©²éƒ¨ä½æ²’æœ‰è£å‚™ï¼");
                return;
            }

            selectedEnhanceSlot = slot;
            const currentLv = (myData.enhancements && myData.enhancements[itemId]) || 0;
            const nextLv = currentLv + 1;

            // ğŸŸ¢ [æ›´æ–°] ä¸Šé™æ”¹ç‚º 20
            if (nextLv > 20) {
                document.getElementById('enhance-info').style.display = 'block';
                document.getElementById('target-name').innerText = (ITEM_MAP[itemId] || itemId) + " (MAX)";
                document.getElementById('enhance-btn').style.display = 'none';
                // éš±è—å…¶ä»–è³‡è¨Š
                return;
            }

            const config = ENHANCE_RATES[nextLv];
            
            document.getElementById('enhance-info').style.display = 'block';
            document.getElementById('enhance-btn').style.display = 'block';
            document.getElementById('target-name').innerText = ITEM_MAP[itemId] || itemId;
            
            document.getElementById('cur-lv').innerText = `+${currentLv}`;
            document.getElementById('next-lv').innerText = `+${nextLv}`;
            document.getElementById('rate-txt').innerText = `${config.rate}%`;
            document.getElementById('cost-txt').innerText = config.cost.toLocaleString() + " G";
            
            const riskEl = document.getElementById('risk-txt');
            riskEl.className = "";
            if (config.risk === 'safe') {
                riskEl.innerText = "å®‰å…¨ (ç„¡æ‡²ç½°)";
                riskEl.classList.add("risk-safe");
            } else if (config.risk === 'drop') {
                riskEl.innerText = "å±éšª (å¤±æ•—é™ç´š)";
                riskEl.classList.add("risk-drop");
            } else {
                riskEl.innerText = "æ¥µåº¦å±éšª (å¤±æ•—è£å‚™æ¶ˆå¤±)";
                riskEl.classList.add("risk-break");
            }
        }

        function doEnhance() {
            if (!selectedEnhanceSlot) return;
            if (confirm(`ç¢ºå®šè¦å¼·åŒ–å—ï¼Ÿ\nå¤±æ•—å¯èƒ½æœƒå°è‡´é™ç´šæˆ–æ¶ˆå¤±ï¼`)) {
                document.getElementById('hammer-anim').style.display = 'flex';
                // æ¨¡æ“¬å»¶é² 1.5ç§’
                setTimeout(() => {
                    socket.emit('enhanceItem', selectedEnhanceSlot);
                }, 1500);
            }
        }

        function showMsg(text) {
            const toast = document.getElementById('game-toast');
            toast.innerText = text;
            toast.style.top = "30px"; 
            setTimeout(() => { toast.style.top = "-100px"; }, 3000);
        }
    </script>
</body>
</html>
