<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–™ç†å»šæˆ¿</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #d35400; color: #fff; /* æ©˜è‰²ç³»èƒŒæ™¯ä»£è¡¨å»šæˆ¿ */
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 10px; margin: 0;
            display: flex; flex-direction: column; height: 100dvh; box-sizing:border-box;
        }
        .header { padding: 10px; border-bottom: 2px solid #fff; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: #34495e; border: 2px solid #fff; color: white; padding: 8px; cursor: pointer; font-family: inherit; font-size: 10px; text-decoration: none;}
        
        .gold-display { font-size: 12px; color: #f1c40f; margin-bottom: 15px; }

        .recipe-container { display: grid; grid-template-columns: 1fr; gap: 10px; padding: 5px; overflow-y: auto; flex: 1; }
        
        .recipe-card { 
            background: #e67e22; border: 4px solid #a04000; 
            padding: 15px; border-radius: 8px; text-align: left;
            position: relative;
        }
        .recipe-name { color: #fff; font-size: 14px; margin-bottom: 5px; font-weight: bold; }
        .recipe-desc { font-size: 10px; color: #fce4ec; margin-bottom: 10px; }
        
        /* ğŸŸ¢ ææ–™åˆ—è¡¨æ¨£å¼ */
        .mat-list { 
            font-size: 10px; color: #fff; margin-bottom: 10px; 
            background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; 
        }
        .mat-item { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .mat-ok { color: #2ecc71; } /* è¶³å¤ é¡¯ç¤ºç¶ è‰² */
        .mat-no { color: #e74c3c; } /* ä¸è¶³é¡¯ç¤ºç´…è‰² */
        
        /* ğŸŸ¢ æŒ‰éˆ•æ¨£å¼ */
        .btn-cook { 
            width: 100%; padding: 12px; 
            font-family: inherit; font-size: 12px; font-weight: bold; border-radius: 6px;
            cursor: pointer; border: 2px solid transparent;
            transition: all 0.2s;
        }
        .btn-ready { 
            background: #2ecc71; color: white; border-color: #27ae60; 
            box-shadow: 0 4px 0 #27ae60;
        }
        .btn-ready:active { transform: translateY(2px); box-shadow: 0 2px 0 #27ae60; }
        
        .btn-disabled { 
            background: #7f8c8d; color: #bdc3c7; border-color: #95a5a6; 
            cursor: not-allowed; opacity: 0.8;
        }

        #game-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 2px solid #f1c40f; padding: 10px 20px; border-radius: 20px; z-index: 999; transition: top 0.5s; font-size: 12px; white-space: nowrap; }
    </style>
</head>
<body>
    <div id="game-toast"></div>
    
    <div class="header">
        <span style="font-size:12px;">ğŸ³ æ–™ç†å»šæˆ¿</span>
        <a href="hub.html" class="back-btn">å›å¤§å»³</a>
    </div>
    
    <div class="gold-display">ğŸ’° æŒæœ‰é‡‘å¹£: <span id="my-gold">0</span> G</div>

    <div id="recipe-list" class="recipe-container">
        <div style="font-size:12px; color:#ddd; margin-top:20px;">è¼‰å…¥é£Ÿè­œä¸­...</div>
    </div>

    <script src="socket.io.js"></script>
    <script>
        const _0x5a1b = "aHR0cHM6Ly9tbW8udHRjdHYtMTA1LmNj"; 
        const BACKEND_URL = atob(_0x5a1b);
        const socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myInventory = {};
        let myGold = 0;
        let allRecipes = [];
        
        // åªé¡¯ç¤ºæ–™ç†é¡çš„é…æ–¹ ID
        const FOOD_IDs = ['grilled_carp', 'salmon_sushi', 'tuna_steak', 'eel_rice', 'void_soup', 'sushi_plate'];

        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
            socket.emit('getRecipes'); // è«‹æ±‚é…æ–¹è³‡æ–™
        });

        // ğŸŸ¢ 1. æ¥æ”¶ç©å®¶èƒŒåŒ…è³‡æ–™
        socket.on('playerStatsUpdate', (p) => { 
            myInventory = p.inventory; 
            myGold = p.gold;
            document.getElementById('my-gold').innerText = myGold;
            renderRecipes(); // è³‡æ–™æ›´æ–°æ™‚é‡ç¹ªä»‹é¢
        });

        // ğŸŸ¢ 2. æ¥æ”¶é…æ–¹è³‡æ–™
        socket.on('recipeList', (recipes) => {
            allRecipes = recipes;
            renderRecipes();
        });

        socket.on('craftResult', (res) => {
            showToast(res.success ? "âœ… " + res.msg : "âŒ " + res.msg);
        });

        function renderRecipes() {
            if (allRecipes.length === 0) return;

            const container = document.getElementById('recipe-list');
            container.innerHTML = '';

            allRecipes.forEach(r => {
                // ç¯©é¸ï¼šåªé¡¯ç¤ºé£Ÿç‰©
                if (!FOOD_IDs.includes(r.itemId)) return;

                const div = document.createElement('div');
                div.className = 'recipe-card';
                
                let canCook = true;
                let matsHtml = '';

                // ğŸŸ¢ æª¢æŸ¥ææ–™æ˜¯å¦è¶³å¤ 
                r.materials.forEach(m => {
                    const have = myInventory[m.id] || 0;
                    const need = m.count;
                    const isEnough = have >= need;
                    
                    if (!isEnough) canCook = false;

                    const colorClass = isEnough ? 'mat-ok' : 'mat-no';
                    matsHtml += `
                        <div class="mat-item">
                            <span>${m.name}</span>
                            <span class="${colorClass}">${have}/${need}</span>
                        </div>
                    `;
                });

                // æª¢æŸ¥é‡‘éŒ¢
                if (myGold < r.goldCost) canCook = false;
                const goldClass = (myGold >= r.goldCost) ? 'mat-ok' : 'mat-no';

                // ğŸŸ¢ è¨­å®šæŒ‰éˆ•ç‹€æ…‹
                let btnHtml = '';
                if (canCook) {
                    btnHtml = `<button class="btn-cook btn-ready" onclick="cook('${r.itemId}')">ğŸ³ å¯ä»¥çƒ¹é£ª</button>`;
                } else {
                    btnHtml = `<button class="btn-cook btn-disabled" disabled>âŒ ææ–™/é‡‘éŒ¢ä¸è¶³</button>`;
                }

                div.innerHTML = `
                    <div class="recipe-name">ğŸ± ${r.itemName}</div>
                    <div class="recipe-desc">${r.itemDesc}</div>
                    <div class="mat-list">
                        ${matsHtml}
                        <div class="mat-item" style="border-top:1px dashed #fff; margin-top:4px; padding-top:4px;">
                            <span>è£½ä½œè²»ç”¨</span>
                            <span class="${goldClass}">${r.goldCost} G</span>
                        </div>
                    </div>
                    ${btnHtml}
                `;
                container.appendChild(div);
            });
        }

        function cook(id) {
            socket.emit('craftItem', id);
        }

        function showToast(msg) {
            const t = document.getElementById('game-toast');
            t.innerText = msg;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 2000);
        }
    </script>
</body>
</html>
