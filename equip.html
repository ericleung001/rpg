<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è£å‚™ç®¡ç†3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 15px; 
            display:flex; flex-direction:column; align-items:center; 
            height: 100dvh; margin:0; box-sizing:border-box; overscroll-behavior: none;
            overflow: scroll;
        }
        .main-box { background: #34495e; border: 4px solid #fff; padding: 15px; width: 100%; max-width: 600px; border-radius: 12px; box-sizing: border-box; flex: 1; display: flex; flex-direction: column;}
        h2 { font-size: 18px; margin: 0 0 15px 0; }
        .stats-display { text-align: left; margin-bottom: 15px; font-size: 12px; line-height: 2; border-bottom: 2px solid #555; padding-bottom: 10px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .slots-area { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; background: #2c3e50; padding: 10px; border: 2px solid #bdc3c7; border-radius: 8px;}
        .slot { border: 2px dashed #95a5a6; padding: 10px 5px; min-height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .slot-title { font-size: 10px; color: #f1c40f; margin-bottom: 5px; }
        .slot-item { font-size: 10px; color: #fff; text-align: center; line-height: 1.2; }
        h3 { font-size: 14px; margin: 10px 0; text-align: left; color: #bdc3c7; }
        .inventory-container { flex: 1; overflow-y: auto; border: 2px solid #3498db; background: #2c3e50; padding: 5px; border-radius: 8px;}
        .inv-item { background: #34495e; border-bottom: 1px solid #555; padding: 12px; display: flex; justify-content: space-between; align-items: center; text-align: left; margin-bottom: 5px;}
        .inv-name { font-size: 12px; color: #fff; margin-bottom: 3px; }
        .inv-desc { font-size: 10px; color: #bdc3c7; }
        .btn { background: #27ae60; color: white; border: 2px solid #2ecc71; padding: 8px 12px; cursor: pointer; font-family: inherit; font-size: 12px; border-radius: 4px;}
        .btn-unequip { background: #c0392b; border-color: #e74c3c; margin-top: 5px; font-size: 10px; padding: 5px 8px; }
        .back-btn { background: #7f8c8d; color: white; padding: 15px; text-decoration: none; font-size: 14px; display: block; width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px; margin-top: 15px; border: 3px solid #fff;}
        /* === é€šç”¨é€šçŸ¥æ¢æ¨£å¼ === */
        #game-toast {
            position: fixed; 
            top: -100px; 
            left: 50%; 
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #f1c40f; 
            color: #fff;
            padding: 15px 30px;
            border-radius: 30px;
            z-index: 9999; 
            font-size: 14px;
            font-weight: bold;
            white-space: nowrap;
            transition: top 0.5s ease-in-out; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            pointer-events: none; 
        }
    </style>
</head>
<body>
<div id="game-toast"></div>
    <div class="main-box">
        <h2>ğŸ›¡ï¸ è£å‚™ç‹€æ…‹</h2>
        <div class="stats-display">
            <div class="stat-grid">
                <div>âš”ï¸ ATK: <span id="atk" style="color:#e74c3c">0</span></div>
                <div>ğŸ›¡ï¸ DEF: <span id="def" style="color:#3498db">0</span></div>
                <div>â¤ï¸ HP : <span id="hp">0</span></div>
                <div>ğŸ’§ MP : <span id="mp">0</span></div>
            </div>
        </div>
        <div class="slots-area">
            <div class="slot"><div class="slot-title">æ­¦å™¨ (Weapon)</div><div id="slot-weapon" class="slot-item">ç„¡</div></div>
            <div class="slot"><div class="slot-title">é˜²å…· (Armor)</div><div id="slot-armor" class="slot-item">ç„¡</div></div>
            <div class="slot"><div class="slot-title">é£¾å“ (Acc)</div><div id="slot-acc" class="slot-item">ç„¡</div></div>
        </div>
        <h3>ğŸ’ èƒŒåŒ… (é»æ“Šè£å‚™)</h3>
        <div id="inventory-list" class="inventory-container"><div style="font-size:12px; color:#aaa; padding:10px;">è®€å–ä¸­...</div></div>
    </div>
    <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
            transports: ['websocket', 'polling'],
            secure: true 
        });
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        // ğŸŸ¢ å®Œæ•´è£å‚™åˆ—è¡¨ (éœ€èˆ‡ Server åŒæ­¥)
        const ITEM_MAP = {
            // === æ­¦å™¨ ===
            'wood_sword':       { name: "æœ¨åŠ", cost: 100, desc: "ATK+10" },
            'copper_dagger':    { name: "éŠ…åŒ•é¦–", cost: 400, desc: "ATK+20" }, 
            'iron_sword':       { name: "éµåŠ", cost: 1500, desc: "ATK+60" }, 
            'silver_blade':     { name: "éŠ€åˆƒ", cost: 4000, desc: "ATK+100" },
            'spike_club':       { name: "ç‹¼ç‰™æ£’", cost: 0, desc: "ATK+140 HP+300" }, 
            'poison_dag':       { name: "åŠ‡æ¯’åŒ•é¦–", cost: 0, desc: "ATK+160" }, 
            'shark_tooth':      { name: "é¯Šé­šç‰™åŒ•é¦–", cost: 800, desc: "ATK+80" },
            'flame_staff':      { name: "ç«ç„°æ³•æ–", cost: 0, desc: "ATK+300 MP+100" }, 
            'emerald_staff':    { name: "ç¿¡ç¿ æ³•æ–", cost: 5000, desc: "ATK+300" },
            'gold_axe':         { name: "é»ƒé‡‘å·¨æ–§", cost: 10000, desc: "ATK+500" },
            'obsidian_blade':   { name: "é»‘æ›œçŸ³ä¹‹åŠ", cost: 8000, desc: "ATK+600" },
            'frost_bow':        { name: "å¯’å†°å¼“", cost: 0, desc: "ATK+1300" }, 
            'dragon_spear':     { name: "é¾éª¨é•·æ§", cost: 15000, desc: "ATK+1200" },
            'mithril_saber':    { name: "ç§˜éŠ€è»åˆ€", cost: 50000, desc: "ATK+2000" },
            'void_reaper':      { name: "è™›ç©ºæ”¶å‰²è€…", cost: 0, desc: "ATK+3500" },
            'void_reaper_dark': { name: "é—‡Â·è™›ç©ºæ”¶å‰²è€…", cost: 0, desc: "ATK+5500" }, 
            'god_slayer':       { name: "å¼’ç¥åŠ", cost: 0, desc: "ATK+20000 HP+4000" }, 
            'chaos_staff':      { name: "æ··æ²Œæ³•æ–", cost: 0, desc: "ATK+25000 MP+300" }, 
            'hero_sword':       { name: "å‹‡è€…ä¹‹åŠ", cost: 0, desc: "ATK+50" },
            'steel_blade':      { name: "ç²¾é‹¼åŠ", cost: 0, desc: "ATK+25" },
            'assassin_dag':     { name: "åˆºå®¢çŸ­åˆ€", cost: 0, desc: "ATK+120" },
            'genesis_weapon':   { name: "å‰µä¸–Â·çµ‚ç„‰ä¹‹åŠ", cost: 0, desc: "ATK+50000 HP+20000" }, 
            
            // Lv.230 - 300 æ–°æ­¦å™¨
            'void_blade':       { name: "è™›ç©ºä¹‹åˆƒ", cost: 0, desc: "ATK+75000 HP+80000" }, 
            'galaxy_saber':     { name: "éŠ€æ²³å…‰åŠ", cost: 0, desc: "ATK+110000 HP+150000" }, 
            'entropy_sword':    { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹åŠ", cost: 0, desc: "ATK+200000 HP+300000" },
            
            // æ¡é›†æ­¦å™¨
            'oak_bow':          { name: "æ©¡æœ¨å¼“", cost: 200, desc: "ATK+25" },
            'maple_staff':      { name: "æ¥“æœ¨æ³•æ–", cost: 500, desc: "ATK+50" },

            // === é˜²å…· ===
            'cloth_armor':      { name: "å¸ƒè¡£", cost: 100, desc: "DEF+5" },
            'hunt_vest':        { name: "çµäººèƒŒå¿ƒ", cost: 0, desc: "DEF+25 HP+200" },
            'leather_armor':    { name: "çš®ç”²", cost: 400, desc: "DEF+15" }, 
            'plate_mail':       { name: "æ¿é‡‘ç”²", cost: 0, desc: "DEF+15" },
            'dragon_mail':      { name: "é¾é±—ç”²", cost: 0, desc: "DEF+30" },
            'chain_mail':       { name: "é–å­ç”²", cost: 1500, desc: "DEF+40" }, 
            'iron_armor':       { name: "éµç›”ç”²", cost: 4000, desc: "DEF+100" }, 
            'magma_plate':      { name: "ç†”å²©èƒ¸ç”²", cost: 0, desc: "DEF+150 HP+1500" }, 
            'ice_robe':         { name: "å†°éœœæ³•è¢", cost: 0, desc: "DEF+200 MP+500" },
            'yeti_cloak':       { name: "é›ªæ€ªæ–—ç¯·", cost: 0, desc: "DEF+350 HP+4000" }, 
            'demon_armor':      { name: "æƒ¡é­”æˆ°ç”²", cost: 0, desc: "DEF+1000 HP+12000" }, 
            'angel_armor':      { name: "ç†¾å¤©ä½¿é§ç”²", cost: 0, desc: "DEF+5000 HP+50000" },
            'genesis_armor':    { name: "å‰µä¸–Â·ç¥ä¹‹åº‡è­·", cost: 0, desc: "DEF+20000 HP+150000" }, 

            // Lv.230 - 300 æ–°é˜²å…·
            'void_armor':       { name: "è™›ç©ºæˆ°ç”²", cost: 0, desc: "DEF+45000 HP+300000" }, 
            'nebula_plate':     { name: "æ˜Ÿé›²æ¿ç”²", cost: 0, desc: "DEF+70000 HP+600000" }, 
            'entropy_god_armor':{ name: "çµ‚ç„‰Â·ç¥ä¹‹åº‡è­·", cost: 0, desc: "DEF+120000 HP+1500000" },

            // === é£¾å“ ===
            'bone_ring':        { name: "éª¨æˆ’", cost: 0, desc: "ATK+15 HP+200" }, 
            'ring_str':         { name: "åŠ›é‡æˆ’æŒ‡", cost: 3000, desc: "ATK+30" },
            'bracelet_def':     { name: "å …æ¯…æ‰‹ç’°", cost: 3000, desc: "DEF+30" }, 
            'necklace_hp':      { name: "ç´…æ°´æ™¶é …éŠ", cost: 5000, desc: "HP+250" }, 
            'necklace_mp':      { name: "è—æ°´æ™¶é …éŠ", cost: 5000, desc: "MP+60" }, 
            'snake_boots':      { name: "è›‡çš®é•·é´", cost: 0, desc: "DEF+30 HP+200" }, 
            'fish_ring':        { name: "é­šé±—æˆ’æŒ‡", cost: 400, desc: "DEF+50 HP+500" }, 
            'pearl_necklace':   { name: "çç é …éŠ", cost: 2000, desc: "DEF+20 MP+150" }, 
            'amulet_soul':      { name: "éˆé­‚è­·ç¬¦", cost: 0, desc: "MP+300 HP+1000" },
            'ring_lord':        { name: "é ˜ä¸»æŒ‡ç’°", cost: 0, desc: "å…¨èƒ½åŠ›+600" }, 
            'crown_chaos':      { name: "æ··æ²Œä¹‹å† ", cost: 0, desc: "å…¨èƒ½åŠ›+2000" },
            'ring_galaxy':      { name: "éŠ€æ²³æŒ‡ç’°", cost: 0, desc: "å…¨èƒ½åŠ›+5000" }, 
            'ring_life':        { name: "ç”Ÿå‘½è­·ç¬¦", cost: 0, desc: "HP+100" },
            'ring_magic':       { name: "é­”åŠ›è€³ç’°", cost: 0, desc: "MP+50" },

            // Lv.280 æ–°é£¾å“
            'dimension_ring':   { name: "ç¶­åº¦æŒ‡ç’°", cost: 0, desc: "å…¨èƒ½åŠ›+15000" }
        };

        socket.on('connect', () => { socket.emit('joinGame', myToken); });
        
        socket.on('playerStatsUpdate', (p) => { 
            renderStats(p); 
            // ğŸ”¥ [ä¿®æ”¹ 1] å‚³å…¥ enhancements
            renderSlots(p.equipment, p.enhancements); 
            renderInventory(p.inventory, p.enhancements); 
        });
        
        socket.on('equipResult', (msg) => { showMsg(msg); });
        socket.on('errorMessage', (msg) => { showMsg("âŒ " + msg); });

        function renderStats(p) {
            document.getElementById('atk').innerText = (p.atk || 0).toLocaleString();
            document.getElementById('def').innerText = (p.def || 0).toLocaleString();
            document.getElementById('hp').innerText = p.maxHp.toLocaleString();
            document.getElementById('mp').innerText = p.maxMp.toLocaleString();
        }

        // è£å‚™ä¸­ç‰©å“é¡¯ç¤º
        function renderSlots(eq, enhancements) {
            const types = ['weapon', 'armor', 'acc'];
            if (!enhancements) enhancements = {};

            types.forEach(type => {
                const div = document.getElementById(`slot-${type}`);
                const itemId = eq[type];
                
                if (itemId && ITEM_MAP[itemId]) {
                    const lv = enhancements[itemId] || 0;
                    let displayName = ITEM_MAP[itemId].name;
                    if (lv > 0) displayName += ` <span style="color:#f1c40f; font-weight:bold;">+${lv}</span>`;

                    div.innerHTML = `
                        <div style="color:#2ecc71; margin-bottom:5px;">${displayName}</div>
                        <button class="btn btn-unequip" onclick="unequip('${type}')">å¸ä¸‹</button>
                    `;
                } else {
                    div.innerHTML = `<span style="color:#7f8c8d">ç„¡</span>`;
                }
            });
        }

        // ğŸŸ¢ [ä¿®æ”¹ 2] èƒŒåŒ…ç‰©å“é¡¯ç¤º (åŠ å…¥å¼·åŒ–ç­‰ç´š)
        function renderInventory(inv, enhancements) {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            let hasEquipable = false;
            
            // ç¢ºä¿ enhancements ä¸æœƒ undefined
            if (!enhancements) enhancements = {};

            Object.keys(inv).forEach(key => {
                const item = ITEM_MAP[key];
                if (item && inv[key] > 0) {
                    hasEquipable = true;
                    
                    // ğŸ”¥ è®€å–å¼·åŒ–ç­‰ç´š
                    const lv = enhancements[key] || 0;
                    let nameDisplay = `${item.name} x${inv[key]}`;
                    
                    // å¦‚æœæœ‰å¼·åŒ–ï¼ŒåŠ ä¸Š +N
                    if (lv > 0) {
                        nameDisplay += ` <span style="color:#f1c40f; font-weight:bold;">+${lv}</span>`;
                    }

                    const div = document.createElement('div');
                    div.className = 'inv-item';
                    div.innerHTML = `
                        <div>
                            <div class="inv-name">${nameDisplay}</div>
                            <div class="inv-desc">${item.desc}</div>
                        </div>
                        <button class="btn" onclick="equip('${key}')">è£å‚™</button>
                    `;
                    list.appendChild(div);
                }
            });
            
            if (!hasEquipable) list.innerHTML = `<div style="color:#7f8c8d; font-size:12px; padding:20px;">èƒŒåŒ…æ²’æœ‰å¯è£å‚™çš„ç‰©å“<br>(å¦‚è—¥æ°´è«‹è‡³èƒŒåŒ…æŸ¥çœ‹)</div>`;
        }

        function equip(id) { socket.emit('equipItem', id); }
        function unequip(slot) { socket.emit('unequipItem', slot); }
        
        function showMsg(text) {
            const toast = document.getElementById('game-toast');
            toast.innerText = text;
            toast.style.top = "30px"; 
            setTimeout(() => {
                toast.style.top = "-100px"; 
            }, 3000);
        }
    </script>
</body>
</html>
