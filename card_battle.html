<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡ç‰‡å°æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            margin: 0; padding: 0; overflow: hidden;
            display: flex; flex-direction: column; height: 100vh;
            user-select: none;
        }

        /* å€åŸŸ */
        .opponent-area { flex: 1; background: #34495e; display: flex; flex-direction: column; border-bottom: 2px solid #000; position: relative; }
        .my-area { flex: 1; background: #2c3e50; display: flex; flex-direction: column-reverse; position: relative; }

        .hand-zone { height: 120px; display: flex; justify-content: center; align-items: center; gap: 5px; padding: 5px; background: rgba(0,0,0,0.3); overflow-x: auto; }
        .card-back { background: linear-gradient(135deg, #e67e22 25%, #d35400 25%, #d35400 50%, #e67e22 50%, #e67e22 75%, #d35400 75%, #d35400 100%); width: 60px; height: 85px; border-radius: 5px; border: 2px solid #fff; }
        .field-zone { flex: 1; display: flex; justify-content: center; align-items: center; gap: 10px; padding: 10px; }
        
        .player-info { position: absolute; padding: 8px 12px; background: rgba(0,0,0,0.85); border-radius: 8px; border: 1px solid #f1c40f; font-size: 12px; z-index: 10; }
        .opp-info { top: 10px; left: 10px; }
        .my-info { bottom: 10px; left: 10px; }

        /* å¡ç‰‡ */
        .battle-card { width: 70px; height: 100px; background: #2c3e50; border: 2px solid #fff; border-radius: 6px; display: flex; flex-direction: column; align-items: center; font-size: 8px; position: relative; cursor: pointer; transition: 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .battle-card:active { transform: scale(0.95); }
        .battle-card img { width: 50px; height: 50px; object-fit: contain; margin-top: 5px; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .battle-card .cost { position: absolute; top: -5px; right: -5px; background: #3498db; color: white; width: 18px; height: 18px; border-radius: 50%; font-size: 8px; line-height: 18px; text-align: center; border: 1px solid #fff; }

        /* ç‹€æ…‹ */
        .field-unit { border-color: #f1c40f; }
        .field-unit.selected { border-color: #e74c3c; box-shadow: 0 0 15px #e74c3c; transform: scale(1.1); z-index: 5; }
        .battle-card.spell-selected { border-color: #3498db; box-shadow: 0 0 15px #3498db; transform: translateY(-10px); }
        .field-unit.source-selected { border-color: #9b59b6; box-shadow: 0 0 15px #9b59b6; transform: scale(1.1); z-index: 5; }
        .field-unit.sleeping { opacity: 0.6; filter: grayscale(80%); cursor: not-allowed; }

        /* ä»‹é¢å…ƒç´  */
        #turn-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 15px 30px; border: 3px solid #e74c3c; color: #fff; font-size: 16px; display: none; z-index: 200; border-radius: 10px; pointer-events: none; }
        
        #end-turn-btn { position: fixed; right: 10px; top: 50%; transform: translateY(-50%); padding: 15px; background: #f39c12; border: none; color: white; border-radius: 50%; width: 70px; height: 70px; font-weight: bold; cursor: pointer; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; text-align: center; font-family: inherit; font-size: 10px; }
        
        /* é›¢é–‹æŒ‰éˆ• */
        #leave-btn { position: fixed; top: 10px; left: 10px; padding: 8px 12px; background: #c0392b; border: 2px solid #fff; color: white; border-radius: 5px; font-weight: bold; cursor: pointer; z-index: 200; font-family: inherit; font-size: 10px; }
    </style>
</head>
<body>

    <button id="leave-btn" onclick="surrender()">ğŸ³ï¸ é›¢é–‹/æŠ•é™</button>
    <div id="turn-indicator">æˆ°é¬¥é–‹å§‹</div>
    <button id="end-turn-btn" onclick="endTurn()">çµæŸ<br>å›åˆ</button>

    <div class="opponent-area">
        <div class="hand-zone" id="opp-hand"></div>
        <div class="field-zone" id="opp-field"></div>
        <div class="player-info opp-info"><span id="opp-name" style="color:#e74c3c">å°æ‰‹</span><br>AP: <span id="opp-ap" style="color:#3498db">10</span></div>
    </div>

    <div class="my-area">
        <div class="hand-zone" id="my-hand"></div>
        <div class="field-zone" id="my-field"></div>
        <div class="player-info my-info"><span id="my-name" style="color:#2ecc71">æˆ‘</span><br>AP: <span id="my-ap" style="color:#3498db">10</span></div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        const IMG_BASE_URL = "https://ericleung001.github.io/rpg/img/monsters/";
        
        // éœ€èˆ‡ Server ä¿æŒä¸€è‡´
        const MONSTER_LIST = {
            'slime': { name: "å²èŠå§†", img: "slime.png" },
            'rat': { name: "å¤§è€é¼ ", img: "rat.png" },
            'wolf_king': { name: "ç‹¼ç‹", img: "wolf_king.png" },
            'demon_king': { name: "é­”ç‹æ’’æ—¦", img: "demon_king.png" },
            'bee': { name: "æ®ºäººèœ‚", img: "bee.png" },
            'boar': { name: "é‡è±¬", img: "boar.png" },
            'thief': { name: "ç›œè³Š", img: "thief.png" },
            'snake': { name: "æ¯’è›‡", img: "snake.png" },
            'zombie': { name: "è…å±", img: "zombie.png" },
            'skeleton': { name: "éª·é«å…µ", img: "skeleton.png" },
            'ghoul': { name: "é£Ÿå±é¬¼", img: "ghoul.png" },
            'witch': { name: "æ²¼æ¾¤å¥³å·«", img: "witch.png" },
            'hydra': { name: "ä¹é ­è›‡", img: "hydra.png" },
            'fire_imp': { name: "ç«ç„°å°é¬¼", img: "fire_imp.png" },
            'lava_golem': { name: "ç†”å²©æˆˆä¾–", img: "lava_golem.png" },
            'salamander': { name: "ç«èœ¥èœ´", img: "salamander.png" },
            'fire_mage': { name: "çƒˆç„°æ³•å¸«", img: "fire_mage.png" },
            'dragon_hatchling': { name: "å¹¼é¾", img: "dragon_hatchling.png" },
            'balrog': { name: "ç‚é­”", img: "balrog.png" },
            'snow_wolf': { name: "é›ªåŸç‹¼", img: "snow_wolf.png" },
            'yeti': { name: "é›ªäºº", img: "yeti.png" },
            'ice_spirit': { name: "å†°ç²¾éˆ", img: "ice_spirit.png" },
            'frost_knight': { name: "å¯’éœœé¨å£«", img: "frost_knight.png" },
            'ice_dragon': { name: "å†°éœœé¾", img: "ice_dragon.png" },
            'lich_king': { name: "å·«å¦–ç‹", img: "lich_king.png" },
            'void_eye': { name: "è™›ç©ºä¹‹çœ¼", img: "void_eye.png" },
            'shadow_assassin': { name: "æš—å½±åˆºå®¢", img: "shadow_assassin.png" },
            'dark_paladin': { name: "å¢®è½è–é¨", img: "dark_paladin.png" },
            'demon_guard': { name: "æƒ¡é­”å®ˆè¡›", img: "demon_guard.png" },
            'succubus': { name: "é­…é­”", img: "succubus.png" },
            'void_lord': { name: "è™›ç©ºé ˜ä¸»", img: "void_lord.png" },
            'chaos_beast': { name: "æ··æ²Œå·¨ç¸", img: "chaos_beast.png" },
            'fallen_angel': { name: "å¢®å¤©ä½¿", img: "fallen_angel.png" },
            'void_walker': { name: "è™›ç©ºè¡Œè€…", img: "void_walker.png" },
            'chaos_knight': { name: "æ··æ²Œé¨å£«", img: "chaos_knight.png" },
            'abyss_dragon': { name: "æ·±æ·µé­”é¾", img: "abyss_dragon.png" },
            'fallen_titan': { name: "å¢®è½æ³°å¦", img: "fallen_titan.png" },
            'genesis_god': { name: "å‰µä¸–ç ´å£ç¥", img: "genesis_god.png" },
            'void_worm': { name: "è™›ç©ºåå™¬èŸ²", img: "void_worm.png" },
            'shadow_phantom': { name: "è™šå½±å¤¢é­˜", img: "shadow_phantom.png" },
            'star_eater': { name: "åæ˜Ÿå·¨ç¸", img: "star_eater.png" },
            'nebula_dragon': { name: "æ˜Ÿé›²å¹»é¾", img: "nebula_dragon.png" },
            'time_keeper': { name: "æ™‚ç©ºè£æ±ºè€…", img: "time_keeper.png" },
            'dimension_breaker': { name: "ç¶­åº¦ç²‰ç¢è€…", img: "dimension_breaker.png" },
            'entropy_god': { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹ç¥", img: "entropy_god.png" }
        };

        const SPELL_LIST = {
            'card_potion': { name: "å›å¾©å¡", icon: "ğŸ’Š" },
            'card_fire': { name: "æ”»æ“Šå¡", icon: "ğŸ”¥" },
            'card_shield': { name: "è­·ç›¾å¡", icon: "ğŸ›¡ï¸" }
        };

        const CARD_DB = {};
        Object.keys(MONSTER_LIST).forEach(k => CARD_DB[`card_${k}`] = { ...MONSTER_LIST[k], type: 'unit', cost: 1 });
        Object.keys(SPELL_LIST).forEach(k => CARD_DB[k] = { ...SPELL_LIST[k], type: 'spell', cost: 1 });

        let selectedAttackerIndex = null;
        let selectedSpellIndex = null;
        let selectedSpellId = null;
        let selectedSourceIndex = null;
        let isMyTurn = false;
        let lastTurnOwner = null;

        socket.on('connect', () => { socket.emit('joinGame', myToken); });
        socket.on('cardGameUpdate', (data) => renderGame(data));
        socket.on('errorMessage', (msg) => alert(msg));
        
        socket.on('cardGameEnd', (res) => { 
            let msg = `éŠæˆ²çµæŸï¼\nç²å‹è€…: ${res.winner}`;
            if (res.reason) msg += `\n(${res.reason})`;
            alert(msg); 
            window.location.href = 'hub.html'; 
        });

        function renderGame(data) {
            const me = data.me;
            const opp = data.opponent;
            isMyTurn = (data.turn === socket.id);

            document.getElementById('my-ap').innerText = me.ap;
            document.getElementById('opp-name').innerText = opp.name;
            document.getElementById('opp-ap').innerText = opp.ap;

            if (data.turn !== lastTurnOwner) {
                lastTurnOwner = data.turn;
                const indicator = document.getElementById('turn-indicator');
                indicator.innerText = isMyTurn ? "ğŸ‘‰ ä½ çš„å›åˆ ğŸ‘ˆ" : "â³ å°æ‰‹å›åˆ";
                indicator.style.borderColor = isMyTurn ? "#2ecc71" : "#e74c3c";
                indicator.style.display = 'block';
                setTimeout(() => indicator.style.display = 'none', 1500);
            }

            document.getElementById('end-turn-btn').style.display = isMyTurn ? 'flex' : 'none';
            if (!isMyTurn) resetSelection();

            renderHand(me.hand);
            renderOppHand(opp.handCount);
            renderMyField(me.field);
            renderOppField(opp.field);
        }

        function renderHand(hand) {
            const container = document.getElementById('my-hand');
            container.innerHTML = '';
            
            hand.forEach((cardId, index) => {
                const el = createCardElement(cardId);
                const cardInfo = CARD_DB[cardId];

                if (index === selectedSpellIndex) el.classList.add('spell-selected');

                el.onclick = () => {
                    if (!isMyTurn) { alert("ç¾åœ¨æ˜¯å°æ‰‹çš„å›åˆï¼"); return; }

                    if (cardInfo.type === 'unit') {
                        socket.emit('cardAction', { type: 'play', index: index });
                        resetSelection();
                    } else if (cardInfo.type === 'spell') {
                        if (selectedSpellIndex === index) {
                            resetSelection();
                        } else {
                            resetSelection();
                            selectedSpellIndex = index;
                            selectedSpellId = cardId;
                            renderHand(hand);
                        }
                    }
                };
                container.appendChild(el);
            });
        }

        function renderOppHand(count) {
            const container = document.getElementById('opp-hand');
            container.innerHTML = '';
            for(let i=0; i<count; i++) container.appendChild(Object.assign(document.createElement('div'), {className:'card-back'}));
        }

        function renderMyField(fieldData) {
            const container = document.getElementById('my-field');
            container.innerHTML = '';
            
            fieldData.forEach((monster, index) => {
                const el = createUnitElement(monster);
                
                if (!monster.canAttack) el.classList.add('sleeping');
                if (index === selectedAttackerIndex) el.classList.add('selected');
                if (index === selectedSourceIndex) el.classList.add('source-selected');

                el.onclick = () => {
                    if (!isMyTurn) return;

                    // æ–½æ³•æ¨¡å¼
                    if (selectedSpellIndex !== null) {
                        if (selectedSpellId.includes('potion') || selectedSpellId.includes('shield')) {
                            socket.emit('cardAction', { type: 'play', index: selectedSpellIndex, targetIdx: index });
                            resetSelection();
                        } 
                        else if (selectedSpellId.includes('fire')) {
                            if (selectedSourceIndex === index) selectedSourceIndex = null;
                            else selectedSourceIndex = index;
                            renderMyField(fieldData);
                        }
                        return;
                    }

                    // æ”»æ“Šæ¨¡å¼
                    if (!monster.canAttack) { alert("é€™éš»æ€ªç‰©å‰›å¬å–šï¼Œé‚„ä¸èƒ½æ”»æ“Šï¼"); return; }
                    
                    if (selectedAttackerIndex === index) selectedAttackerIndex = null;
                    else selectedAttackerIndex = index;
                    renderMyField(fieldData);
                };
                container.appendChild(el);
            });
        }

        function renderOppField(fieldData) {
            const container = document.getElementById('opp-field');
            container.innerHTML = '';

            fieldData.forEach((monster, index) => {
                const el = createUnitElement(monster);
                el.onclick = () => {
                    if (!isMyTurn) return;

                    if (selectedSpellIndex !== null && selectedSpellId.includes('fire')) {
                        if (selectedSourceIndex === null) {
                            alert("è«‹å…ˆé»æ“Šã€Œæˆ‘æ–¹æ€ªç‰©ã€ä½œç‚ºåŠ›é‡ä¾†æº (ç¥­å“)ï¼");
                            return;
                        }
                        socket.emit('cardAction', { 
                            type: 'play', index: selectedSpellIndex, 
                            sourceIdx: selectedSourceIndex, targetIdx: index 
                        });
                        resetSelection();
                        return;
                    }

                    if (selectedAttackerIndex !== null) {
                        socket.emit('cardAction', { 
                            type: 'attack', attackerIdx: selectedAttackerIndex, targetIdx: index 
                        });
                        resetSelection();
                        return;
                    }

                    if (selectedSpellIndex !== null) alert("é€™å¼µé­”æ³•å¡åªèƒ½å°è‡ªå·±ä½¿ç”¨ï¼");
                    else alert("è«‹å…ˆé¸æ“‡æˆ‘æ–¹æ€ªç‰©(æ”»æ“Š) æˆ– é­”æ³•å¡(æ–½æ³•)ï¼");
                };
                container.appendChild(el);
            });
        }

        function createUnitElement(monster) {
            const div = document.createElement('div');
            div.className = 'battle-card field-unit';
            let imgUrl = 'ğŸ‘¾';
            const cardInfo = CARD_DB[monster.id];
            if (cardInfo) imgUrl = `<img src="${IMG_BASE_URL + cardInfo.img}" onerror="this.style.display='none'">`;
            div.innerHTML = `${imgUrl}<div style="font-size:8px; margin-top:2px;">${cardInfo ? cardInfo.name : 'æ€ªç‰©'}</div><div style="color:#e74c3c; font-weight:bold; font-size:9px;">âš”ï¸${monster.atk} â¤ï¸${monster.hp}</div>`;
            return div;
        }

        function createCardElement(cardId) {
            const div = document.createElement('div');
            const cardInfo = CARD_DB[cardId];
            let name = "æœªçŸ¥", visual = "â“", type = "spell";
            if (cardInfo) {
                name = cardInfo.name; type = cardInfo.type;
                if (type === 'unit') {
                    div.className = 'battle-card unit';
                    visual = `<img src="${IMG_BASE_URL + cardInfo.img}" onerror="this.style.display='none';this.parentNode.innerHTML='ğŸ‘¾'">`;
                } else {
                    div.className = 'battle-card spell';
                    visual = `<div style="font-size:24px; margin-top:10px;">${cardInfo.icon}</div>`;
                }
            } else { div.className = 'battle-card'; }
            div.innerHTML = `<div class="cost">1</div>${visual}<div class="name">${name}</div>`;
            return div;
        }

        function resetSelection() {
            selectedAttackerIndex = null;
            selectedSpellIndex = null;
            selectedSpellId = null;
            selectedSourceIndex = null;
            // ç­‰å¾…é‡ç¹ªæˆ–æ‰‹å‹•é‡ç¹ª
            // é€™è£¡ä¸éœ€æ‰‹å‹• remove classï¼Œå› ç‚º render æœƒè™•ç†
        }

        function endTurn() {
            if(confirm("ç¢ºå®šè¦çµæŸå›åˆå—ï¼Ÿ")) {
                socket.emit('cardAction', { type: 'endTurn' });
                resetSelection();
            }
        }

        function surrender() {
            if(confirm("ç¢ºå®šè¦æŠ•é™ä¸¦é›¢é–‹æˆ°é¬¥å—ï¼Ÿ(è¦–ç‚ºæˆ°æ•—)")) {
                socket.emit('cardAction', { type: 'surrender' });
            }
        }
    </script>
</body>
</html>
