<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¡ç‰‡å°æˆ°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            margin: 0; padding: 0; overflow: hidden;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* å€åŸŸåŠƒåˆ† */
        .opponent-area { flex: 1; background: #34495e; display: flex; flex-direction: column; border-bottom: 2px solid #000; position: relative; }
        .my-area { flex: 1; background: #2c3e50; display: flex; flex-direction: column-reverse; position: relative; }

        /* æ‰‹ç‰Œå€ */
        .hand-zone { 
            height: 120px; display: flex; justify-content: center; align-items: center; 
            gap: 5px; padding: 5px; background: rgba(0,0,0,0.3); 
            overflow-x: auto;
        }
        
        /* å¡èƒŒ (å°æ‰‹æ‰‹ç‰Œ) */
        .card-back { 
            background: linear-gradient(135deg, #e67e22 25%, #d35400 25%, #d35400 50%, #e67e22 50%, #e67e22 75%, #d35400 75%, #d35400 100%);
            background-size: 20px 20px;
            width: 60px; height: 85px; border-radius: 5px; border: 2px solid #fff; box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }

        /* æˆ°å ´å€ (æ”¾æ€ªç‰©çš„) */
        .field-zone { 
            flex: 1; display: flex; justify-content: center; align-items: center; gap: 10px; 
            padding: 10px; 
        }
        
        /* ç©å®¶è³‡è¨Š (HP/AP) */
        .player-info { 
            position: absolute; padding: 8px 12px; background: rgba(0,0,0,0.85); 
            border-radius: 8px; border: 1px solid #f1c40f; font-size: 10px;
            z-index: 10; width: 120px;
        }
        .opp-info { top: 10px; left: 10px; text-align: left; }
        .my-info { bottom: 10px; left: 10px; text-align: left; }

        /* å¡ç‰‡æ¨£å¼ (æˆ°é¬¥ç‰ˆ) */
        .battle-card {
            width: 70px; height: 100px; background: #2c3e50; border: 2px solid #fff;
            border-radius: 6px; display: flex; flex-direction: column; align-items: center;
            font-size: 8px; position: relative; cursor: pointer;
            transition: transform 0.1s; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .battle-card:active { transform: scale(0.95); }
        .battle-card img { width: 50px; height: 50px; object-fit: contain; margin-top: 5px; background: rgba(0,0,0,0.2); border-radius: 4px; }
        .battle-card .name { font-size: 8px; margin-top: 2px; white-space: nowrap; overflow: hidden; max-width: 90%; }
        .battle-card .stats { font-size: 7px; margin-top: 2px; color: #f1c40f; }
        .battle-card .cost { 
            position: absolute; top: -5px; right: -5px; 
            background: #3498db; color: white; width: 18px; height: 18px; 
            border-radius: 50%; font-size: 8px; line-height: 18px; text-align: center;
            border: 1px solid #fff;
        }

        /* å¡ç‰‡é¡å‹é¡è‰² */
        .battle-card.unit { border-color: #f1c40f; }
        .battle-card.spell { border-color: #9b59b6; }

        /* ç‹€æ…‹æç¤º */
        #turn-indicator {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); padding: 15px 30px; border: 3px solid #e74c3c;
            color: #fff; font-size: 16px; display: none; z-index: 200; pointer-events: none;
            border-radius: 10px; box-shadow: 0 0 20px #e74c3c;
        }

        /* çµæŸå›åˆæŒ‰éˆ• */
        #end-turn-btn {
            position: fixed; right: 10px; top: 50%; transform: translateY(-50%);
            padding: 15px; background: #f39c12; border: none; color: white;
            border-radius: 50%; width: 70px; height: 70px; font-weight: bold;
            cursor: pointer; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center; text-align: center;
            font-family: inherit; font-size: 10px;
        }
        #end-turn-btn:active { transform: translateY(-50%) scale(0.95); }
    </style>
</head>
<body>

    <div id="turn-indicator">æˆ°é¬¥é–‹å§‹</div>

    <button id="end-turn-btn" onclick="endTurn()">çµæŸ<br>å›åˆ</button>

    <div class="opponent-area">
        <div class="hand-zone" id="opp-hand"></div>
        <div class="field-zone" id="opp-field"></div>
        <div class="player-info opp-info">
            <span id="opp-name" style="color:#e74c3c; font-weight:bold;">å°æ‰‹</span><br>
            <div style="margin-top:5px;">HP: <span id="opp-hp">50</span></div>
            <div>AP: <span id="opp-ap" style="color:#3498db">3</span></div>
        </div>
    </div>

    <div class="my-area">
        <div class="hand-zone" id="my-hand"></div>
        <div class="field-zone" id="my-field"></div>
        <div class="player-info my-info">
            <span id="my-name" style="color:#2ecc71; font-weight:bold;">æˆ‘</span><br>
            <div style="margin-top:5px;">HP: <span id="my-hp">50</span></div>
            <div>AP: <span id="my-ap" style="color:#3498db">3</span></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        // åœ–ç‰‡è·¯å¾‘
        const IMG_BASE_URL = "https://ericleung001.github.io/rpg/img/monsters/";
        
        // æ€ªç‰©åˆ—è¡¨ (éœ€èˆ‡ cards.html ä¸€è‡´)
        const MONSTER_LIST = {
            'slime': { name: "å²èŠå§†", img: "slime.png" },
            'rat': { name: "å¤§è€é¼ ", img: "rat.png" },
            'bee': { name: "æ®ºäººèœ‚", img: "bee.png" },
            'boar': { name: "é‡è±¬", img: "boar.png" },
            'thief': { name: "ç›œè³Š", img: "thief.png" },
            'wolf_king': { name: "ç‹¼ç‹", img: "wolf_king.png" },
            'snake': { name: "æ¯’è›‡", img: "snake.png" },
            'zombie': { name: "è…å±", img: "zombie.png" },
            'skeleton': { name: "éª·é«å…µ", img: "skeleton.png" },
            'ghoul': { name: "é£Ÿå±é¬¼", img: "ghoul.png" },
            'witch': { name: "æ²¼æ¾¤å¥³å·«", img: "witch.png" },
            'hydra': { name: "ä¹é ­è›‡", img: "hydra.png" },
            'fire_imp': { name: "ç«ç„°å°é¬¼", img: "fire_imp.png" },
            'lava_golem': { name: "ç†”å²©æˆˆä¾–", img: "lava_golem.png" },
            'salamander': { name: "ç«èœ¥èœ´", img: "salamander.png" },
            'fire_mage': { name: "çƒˆç„°æ³•å¸«", img: "fire_mage.png" },
            'dragon_hatchling': { name: "å¹¼é¾", img: "dragon_hatchling.png" },
            'balrog': { name: "ç‚é­”", img: "balrog.png" },
            'snow_wolf': { name: "é›ªåŸç‹¼", img: "snow_wolf.png" },
            'yeti': { name: "é›ªäºº", img: "yeti.png" },
            'ice_spirit': { name: "å†°ç²¾éˆ", img: "ice_spirit.png" },
            'frost_knight': { name: "å¯’éœœé¨å£«", img: "frost_knight.png" },
            'ice_dragon': { name: "å†°éœœé¾", img: "ice_dragon.png" },
            'lich_king': { name: "å·«å¦–ç‹", img: "lich_king.png" },
            'void_eye': { name: "è™›ç©ºä¹‹çœ¼", img: "void_eye.png" },
            'shadow_assassin': { name: "æš—å½±åˆºå®¢", img: "shadow_assassin.png" },
            'dark_paladin': { name: "å¢®è½è–é¨", img: "dark_paladin.png" },
            'demon_guard': { name: "æƒ¡é­”å®ˆè¡›", img: "demon_guard.png" },
            'succubus': { name: "é­…é­”", img: "succubus.png" },
            'void_lord': { name: "è™›ç©ºé ˜ä¸»", img: "void_lord.png" },
            'chaos_beast': { name: "æ··æ²Œå·¨ç¸", img: "chaos_beast.png" },
            'fallen_angel': { name: "å¢®å¤©ä½¿", img: "fallen_angel.png" },
            'demon_king': { name: "é­”ç‹æ’’æ—¦", img: "demon_king.png" },
            'void_walker': { name: "è™›ç©ºè¡Œè€…", img: "void_walker.png" },
            'chaos_knight': { name: "æ··æ²Œé¨å£«", img: "chaos_knight.png" },
            'abyss_dragon': { name: "æ·±æ·µé­”é¾", img: "abyss_dragon.png" },
            'fallen_titan': { name: "å¢®è½æ³°å¦", img: "fallen_titan.png" },
            'genesis_god': { name: "å‰µä¸–ç ´å£ç¥", img: "genesis_god.png" },
            'void_worm': { name: "è™›ç©ºåå™¬èŸ²", img: "void_worm.png" },
            'shadow_phantom': { name: "è™šå½±å¤¢é­˜", img: "shadow_phantom.png" },
            'star_eater': { name: "åæ˜Ÿå·¨ç¸", img: "star_eater.png" },
            'nebula_dragon': { name: "æ˜Ÿé›²å¹»é¾", img: "nebula_dragon.png" },
            'time_keeper': { name: "æ™‚ç©ºè£æ±ºè€…", img: "time_keeper.png" },
            'dimension_breaker': { name: "ç¶­åº¦ç²‰ç¢è€…", img: "dimension_breaker.png" },
            'entropy_god': { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹ç¥", img: "entropy_god.png" }
        };

        const SPELL_LIST = {
            'card_potion': { name: "å›å¾©å¡", icon: "ğŸ’Š", desc: "å›å¾© 50 HP" },
            'card_fire': { name: "ç«çƒå¡", icon: "ğŸ”¥", desc: "30 å‚·å®³" },
            'card_shield': { name: "è­·ç›¾å¡", icon: "ğŸ›¡ï¸", desc: "ç²å¾—è­·ç›¾" }
        };

        // å»ºç«‹å¿«é€ŸæŸ¥è©¢è¡¨
        const CARD_DB = {};
        Object.keys(MONSTER_LIST).forEach(k => {
            CARD_DB[`card_${k}`] = { ...MONSTER_LIST[k], type: 'unit', cost: 2 };
        });
        Object.keys(SPELL_LIST).forEach(k => {
            CARD_DB[k] = { ...SPELL_LIST[k], type: 'spell', cost: 1 };
        });

        // ============================================

        socket.on('connect', () => { 
            console.log("Connected to battle server");
            socket.emit('joinGame', myToken); 
        });

        // æ¥æ”¶æˆ°æ³æ›´æ–°
        socket.on('cardGameUpdate', (data) => {
            console.log("æ”¶åˆ°æˆ°æ³:", data);
            renderGame(data);
        });

        // æ¥æ”¶éŒ¯èª¤è¨Šæ¯
        socket.on('errorMessage', (msg) => alert(msg));

        // æ¥æ”¶éŠæˆ²çµæŸ
        socket.on('cardGameEnd', (res) => {
            alert(`éŠæˆ²çµæŸï¼å‹åˆ©è€…: ${res.winner}`);
            window.location.href = 'hub.html';
        });

        function renderGame(data) {
            const me = data.me;
            const opp = data.opponent;

            // 1. æ›´æ–°æ•¸å€¼
            document.getElementById('my-hp').innerText = me.hp;
            document.getElementById('my-ap').innerText = me.ap;
            document.getElementById('opp-name').innerText = opp.name;
            document.getElementById('opp-hp').innerText = opp.hp;
            document.getElementById('opp-ap').innerText = opp.ap;

            // 2. é¡¯ç¤ºå›åˆæç¤º
            const indicator = document.getElementById('turn-indicator');
            if (data.turn === socket.id) {
                indicator.innerText = "ğŸ‘‰ ä½ çš„å›åˆ ğŸ‘ˆ";
                indicator.style.borderColor = "#2ecc71";
                indicator.style.boxShadow = "0 0 20px #2ecc71";
                document.getElementById('end-turn-btn').style.display = 'flex'; // é¡¯ç¤ºçµæŸæŒ‰éˆ•
            } else {
                indicator.innerText = "â³ å°æ‰‹å›åˆ";
                indicator.style.borderColor = "#e74c3c";
                indicator.style.boxShadow = "0 0 20px #e74c3c";
                document.getElementById('end-turn-btn').style.display = 'none'; // éš±è—çµæŸæŒ‰éˆ•
            }
            indicator.style.display = 'block';
            setTimeout(() => indicator.style.display = 'none', 1500);

            // 3. æ¸²æŸ“æˆ‘æ–¹æ‰‹ç‰Œ
            const myHandDiv = document.getElementById('my-hand');
            myHandDiv.innerHTML = '';
            
            if (me.hand && me.hand.length > 0) {
                me.hand.forEach((cardId, index) => {
                    const el = createCardElement(cardId);
                    // é»æ“Šå‡ºç‰Œ
                    el.onclick = () => {
                        if (data.turn !== socket.id) {
                            alert("é‚„æ²’è¼ªåˆ°ä½ ï¼");
                            return;
                        }
                        socket.emit('cardAction', { type: 'play', index: index });
                    };
                    myHandDiv.appendChild(el);
                });
            } else {
                myHandDiv.innerHTML = '<span style="font-size:10px; color:#aaa;">ç„¡æ‰‹ç‰Œ</span>';
            }

            // 4. æ¸²æŸ“å°æ‰‹æ‰‹ç‰Œ (å¡èƒŒ)
            const oppHandDiv = document.getElementById('opp-hand');
            oppHandDiv.innerHTML = '';
            for(let i=0; i < opp.handCount; i++) {
                const back = document.createElement('div');
                back.className = 'card-back';
                oppHandDiv.appendChild(back);
            }

            // 5. æ¸²æŸ“æˆ°å ´
            renderField(me.field, 'my-field', true);
            renderField(opp.field, 'opp-field', false);
        }

        function createCardElement(cardId) {
            const div = document.createElement('div');
            const cardInfo = CARD_DB[cardId];
            
            let name = "æœªçŸ¥";
            let visual = "â“";
            let cost = 1;
            let type = "spell";

            if (cardInfo) {
                name = cardInfo.name;
                cost = cardInfo.cost; 
                type = cardInfo.type;

                if (type === 'unit') {
                    div.className = 'battle-card unit';
                    const imgUrl = IMG_BASE_URL + cardInfo.img;
                    visual = `<img src="${imgUrl}" onerror="this.style.display='none';this.parentNode.innerHTML='ğŸ‘¾'">`;
                } else {
                    div.className = 'battle-card spell';
                    visual = `<div style="font-size:24px; margin-top:10px;">${cardInfo.icon}</div>`;
                }
            } else {
                div.className = 'battle-card'; 
            }

            div.innerHTML = `
                <div class="cost">${cost}</div>
                ${visual}
                <div class="name">${name}</div>
                <div class="stats">${type==='unit'?'':''}</div> 
            `;
            return div;
        }

        // æ¸²æŸ“æˆ°å ´ä¸Šçš„æ€ªç‰©
        function renderField(fieldData, elementId, isMine) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            fieldData.forEach(monster => {
                const div = document.createElement('div');
                div.className = 'battle-card unit';
                
                let imgUrl = 'ğŸ‘¾';
                const cardInfo = CARD_DB[monster.id];
                if (cardInfo) {
                    imgUrl = `<img src="${IMG_BASE_URL + cardInfo.img}" onerror="this.style.display='none'">`;
                }

                div.innerHTML = `
                    ${imgUrl}
                    <div style="font-size:8px; margin-top:2px;">${cardInfo ? cardInfo.name : 'æ€ªç‰©'}</div>
                    <div style="color:#e74c3c; font-weight:bold; font-size:9px;">
                        âš”ï¸${monster.atk} â¤ï¸${monster.hp}
                    </div>
                `;
                
                // å¦‚æœæ˜¯å‰›å¬å–š (ä¸èƒ½æ”»æ“Š)ï¼Œè®ŠåŠé€æ˜
                if (isMine && !monster.canAttack) {
                    div.style.opacity = "0.6";
                }

                container.appendChild(div);
            });
        }

        function endTurn() {
            socket.emit('cardAction', { type: 'endTurn' });
        }

    </script>
</body>
</html>
