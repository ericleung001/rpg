<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>冒險者公會 - 登入</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body { 
            background-color: #2c3e50; color: #ecf0f1; 
            font-family: 'Press Start 2P', monospace; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100dvh; margin: 0; 
            background-image: radial-gradient(#34495e 15%, transparent 16%), radial-gradient(#34495e 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .container {
            background: #fff; color: #333; 
            padding: 30px 20px; 
            border-radius: 10px; 
            border: 4px solid #000;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.5);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        h1 { font-size: 24px; margin-bottom: 30px; color: #e74c3c; text-shadow: 2px 2px 0 #000; }

        input {
            width: 100%; padding: 15px; margin: 10px 0; 
            font-family: inherit; font-size: 14px; 
            border: 2px solid #333; background: #eee;
            box-sizing: border-box;
            outline: none;
        }
        input:focus { background: #fff; border-color: #3498db; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }

        button {
            flex: 1; padding: 15px; 
            font-family: inherit; font-size: 14px; font-weight: bold; 
            cursor: pointer; border: 2px solid #000; 
            transition: all 0.1s;
            min-width: 80px;
        }

        #btn-login { background: #2ecc71; color: white; }
        #btn-reg { background: #f1c40f; color: black; }
        #btn-change { background: #3498db; color: white; width: 100%; margin-top: 5px; }

        button:active { transform: translateY(3px); box-shadow: none; }
        
        #msg { margin-top: 15px; font-size: 12px; min-height: 20px; color: #c0392b; white-space: pre-line; }
        
        .footer { margin-top: 30px; font-size: 10px; color: #bdc3c7; }

        /* 修改密碼專用欄位 (預設隱藏) */
        #new-pass-area { display: none; margin-top: 10px; border-top: 2px dashed #ccc; padding-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>⚔️ 冒險者公會</h1>
        
        <input type="text" id="user" placeholder="帳號 (Username)" maxlength="20">
        <input type="password" id="pass" placeholder="密碼 (Password)" maxlength="20">
        
        <div id="new-pass-area">
            <input type="password" id="new-pass" placeholder="新密碼 (8位+大寫+小寫+數字)" maxlength="30">
            <button onclick="doChangePass()" style="background:#8e44ad; color:white; width:100%;">確認修改</button>
            <button onclick="toggleChangeMode()" style="background:#95a5a6; color:white; width:100%; margin-top:5px;">取消</button>
        </div>

        <div class="btn-group" id="main-btns">
            <button id="btn-login" onclick="doAuth('login')">登入</button>
            <button id="btn-reg" onclick="doAuth('register')">註冊</button>
            <button id="btn-change" onclick="toggleChangeMode()">修改密碼</button>
        </div>

        <div id="msg"></div>
    </div>

    <div class="footer">Server Status: <span id="status" style="color:red">Connecting...</span></div>

    	
    
    <script>
// 指定連接到你的 https 網址
const socket = io('https://mmorpg.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // 因為你用 https，建議加呢個
});

        const statusSpan = document.getElementById('status');
        const msgDiv = document.getElementById('msg');
        const savedToken = localStorage.getItem('rpg_token');

        if (savedToken) {
            msgDiv.innerText = "嘗試自動登入中...";
        }

        socket.on('connect', () => {
            console.log("✅ 連線成功！Socket ID:", socket.id);
            statusSpan.innerText = "Online";
            statusSpan.style.color = "#2ecc71";
            if (savedToken) window.location.href = 'hub.html';
        });

        socket.on('connect_error', (err) => {
            console.error("❌ 連線失敗:", err);
            statusSpan.innerText = "Error";
            msgDiv.innerText = "無法連線伺服器，請稍後再試";
        });

        socket.on('disconnect', () => {
            statusSpan.innerText = "Offline";
            statusSpan.style.color = "red";
        });

        socket.on('authResult', (res) => {
            if (res.success) {
                msgDiv.style.color = "#27ae60";
                msgDiv.innerText = "✅ " + res.msg;
                
                if (res.token) {
                    localStorage.setItem('rpg_token', res.token);
                    setTimeout(() => window.location.href = 'hub.html', 1000);
                } else {
                    // 修改密碼成功後，重置介面
                    if (document.getElementById('new-pass-area').style.display === 'block') {
                        toggleChangeMode();
                        document.getElementById('user').value = '';
                        document.getElementById('pass').value = '';
                        document.getElementById('new-pass').value = '';
                    }
                }
            } else {
                msgDiv.style.color = "#c0392b";
                msgDiv.innerText = "❌ " + res.msg;
            }
        });

        // 強密碼驗證 (8位, 大寫, 小寫, 數字)
        function validatePassword(pw) {
            if (pw.length < 8) return "密碼長度需至少 8 位";
            if (!/[A-Z]/.test(pw)) return "密碼需包含大寫英文 (A-Z)";
            if (!/[a-z]/.test(pw)) return "密碼需包含小寫英文 (a-z)";
            if (!/[0-9]/.test(pw)) return "密碼需包含數字 (0-9)";
            return null; // 通過
        }

        function doAuth(type) {
            const user = document.getElementById('user').value.trim();
            const pass = document.getElementById('pass').value.trim();
            
            if (!socket.connected) return showMsg("⚠️ 無法連線到伺服器");
            if (user.length < 3) return showMsg("⚠️ 帳號太短");

            // 註冊時才需要強密碼驗證，登入不用 (怕舊玩家登不進去)
            if (type === 'register') {
                const err = validatePassword(pass);
                if (err) return showMsg("⚠️ " + err);
            } else {
                if (pass.length < 1) return showMsg("⚠️ 請輸入密碼");
            }

            msgDiv.innerText = "處理中...";
            socket.emit(type, { user, pass });
        }

        // 切換修改密碼模式
        function toggleChangeMode() {
            const area = document.getElementById('new-pass-area');
            const btns = document.getElementById('main-btns');
            
            if (area.style.display === 'none' || area.style.display === '') {
                area.style.display = 'block';
                btns.style.display = 'none';
                msgDiv.innerText = "請輸入帳號、舊密碼 與 新密碼";
                msgDiv.style.color = "#3498db";
            } else {
                area.style.display = 'none';
                btns.style.display = 'flex';
                msgDiv.innerText = "";
            }
        }

        // 執行修改密碼
        function doChangePass() {
            const user = document.getElementById('user').value.trim();
            const oldPass = document.getElementById('pass').value.trim();
            const newPass = document.getElementById('new-pass').value.trim();

            if (!user || !oldPass || !newPass) return showMsg("請填寫所有欄位");
            
            // 驗證新密碼強度
            const err = validatePassword(newPass);
            if (err) return showMsg("⚠️ " + err);

            msgDiv.innerText = "修改中...";
            socket.emit('changePassword', { user, oldPass, newPass });
        }

        function showMsg(txt) {
            msgDiv.style.color = "#c0392b";
            msgDiv.innerText = txt;
        }
    </script>
</body>
</html>
