<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å†’éšªè€…å…¬æœƒ - ç™»å…¥</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body { 
            background-color: #2c3e50; color: #ecf0f1; 
            font-family: 'Press Start 2P', monospace; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100dvh; margin: 0; 
            background-image: radial-gradient(#34495e 15%, transparent 16%), radial-gradient(#34495e 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        .container {
            background: #fff; color: #333; 
            padding: 30px 20px; 
            border-radius: 10px; 
            border: 4px solid #000;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.5);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        h1 { font-size: 24px; margin-bottom: 30px; color: #e74c3c; text-shadow: 2px 2px 0 #000; }

        input {
            width: 100%; padding: 15px; margin: 10px 0; 
            font-family: inherit; font-size: 14px; 
            border: 2px solid #333; background: #eee;
            box-sizing: border-box;
            outline: none;
        }
        input:focus { background: #fff; border-color: #3498db; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }

        button {
            flex: 1; padding: 15px; 
            font-family: inherit; font-size: 14px; font-weight: bold; 
            cursor: pointer; border: 2px solid #000; 
            transition: all 0.1s;
            min-width: 80px;
        }

        #btn-login { background: #2ecc71; color: white; }
        #btn-reg { background: #f1c40f; color: black; }
        #btn-change { background: #3498db; color: white; width: 100%; margin-top: 5px; }

        button:active { transform: translateY(3px); box-shadow: none; }
        
        #msg { margin-top: 15px; font-size: 12px; min-height: 20px; color: #c0392b; white-space: pre-line; }
        
        .footer { margin-top: 30px; font-size: 10px; color: #bdc3c7; }

        /* ä¿®æ”¹å¯†ç¢¼å°ˆç”¨æ¬„ä½ (é è¨­éš±è—) */
        #new-pass-area { display: none; margin-top: 10px; border-top: 2px dashed #ccc; padding-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>âš”ï¸ å†’éšªè€…å…¬æœƒ</h1>
        
        <input type="text" id="user" placeholder="å¸³è™Ÿ (Username)" maxlength="20">
        <input type="password" id="pass" placeholder="å¯†ç¢¼ (Password)" maxlength="20">
        
        <div id="new-pass-area">
            <input type="password" id="new-pass" placeholder="æ–°å¯†ç¢¼ (8ä½+å¤§å¯«+å°å¯«+æ•¸å­—)" maxlength="30">
            <button onclick="doChangePass()" style="background:#8e44ad; color:white; width:100%;">ç¢ºèªä¿®æ”¹</button>
            <button onclick="toggleChangeMode()" style="background:#95a5a6; color:white; width:100%; margin-top:5px;">å–æ¶ˆ</button>
        </div>

        <div class="btn-group" id="main-btns">
            <button id="btn-login" onclick="doAuth('login')">ç™»å…¥</button>
            <button id="btn-reg" onclick="doAuth('register')">è¨»å†Š</button>
            <button id="btn-change" onclick="toggleChangeMode()">ä¿®æ”¹å¯†ç¢¼</button>
        </div>

        <div id="msg"></div>
    </div>

    <div class="footer">Server Status: <span id="status" style="color:red">Connecting...</span></div>

    	
    
    <script>
// æŒ‡å®šé€£æ¥åˆ°ä½ çš„ https ç¶²å€
const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});

        const io = require('socket.io')(http, {
    cors: {
        origin: "*",  // ğŸŸ¢ å…è¨±æ‰€æœ‰ç¶²å€é€£æ¥ (åŒ…æ‹¬ä½ çš„ NAS)
        methods: ["GET", "POST"]
    }
});

        const statusSpan = document.getElementById('status');
        const msgDiv = document.getElementById('msg');
        const savedToken = localStorage.getItem('rpg_token');

        if (savedToken) {
            msgDiv.innerText = "å˜—è©¦è‡ªå‹•ç™»å…¥ä¸­...";
        }

        socket.on('connect', () => {
            console.log("âœ… é€£ç·šæˆåŠŸï¼Socket ID:", socket.id);
            statusSpan.innerText = "Online";
            statusSpan.style.color = "#2ecc71";
            if (savedToken) window.location.href = 'hub.html';
        });

        socket.on('connect_error', (err) => {
            console.error("âŒ é€£ç·šå¤±æ•—:", err);
            statusSpan.innerText = "Error";
            msgDiv.innerText = "ç„¡æ³•é€£ç·šä¼ºæœå™¨ï¼Œè«‹ç¨å¾Œå†è©¦";
        });

        socket.on('disconnect', () => {
            statusSpan.innerText = "Offline";
            statusSpan.style.color = "red";
        });

        socket.on('authResult', (res) => {
            if (res.success) {
                msgDiv.style.color = "#27ae60";
                msgDiv.innerText = "âœ… " + res.msg;
                
                if (res.token) {
                    localStorage.setItem('rpg_token', res.token);
                    setTimeout(() => window.location.href = 'hub.html', 1000);
                } else {
                    // ä¿®æ”¹å¯†ç¢¼æˆåŠŸå¾Œï¼Œé‡ç½®ä»‹é¢
                    if (document.getElementById('new-pass-area').style.display === 'block') {
                        toggleChangeMode();
                        document.getElementById('user').value = '';
                        document.getElementById('pass').value = '';
                        document.getElementById('new-pass').value = '';
                    }
                }
            } else {
                msgDiv.style.color = "#c0392b";
                msgDiv.innerText = "âŒ " + res.msg;
            }
        });

        // å¼·å¯†ç¢¼é©—è­‰ (8ä½, å¤§å¯«, å°å¯«, æ•¸å­—)
        function validatePassword(pw) {
            if (pw.length < 8) return "å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 8 ä½";
            if (!/[A-Z]/.test(pw)) return "å¯†ç¢¼éœ€åŒ…å«å¤§å¯«è‹±æ–‡ (A-Z)";
            if (!/[a-z]/.test(pw)) return "å¯†ç¢¼éœ€åŒ…å«å°å¯«è‹±æ–‡ (a-z)";
            if (!/[0-9]/.test(pw)) return "å¯†ç¢¼éœ€åŒ…å«æ•¸å­— (0-9)";
            return null; // é€šé
        }

        function doAuth(type) {
            const user = document.getElementById('user').value.trim();
            const pass = document.getElementById('pass').value.trim();
            
            if (!socket.connected) return showMsg("âš ï¸ ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨");
            if (user.length < 3) return showMsg("âš ï¸ å¸³è™Ÿå¤ªçŸ­");

            // è¨»å†Šæ™‚æ‰éœ€è¦å¼·å¯†ç¢¼é©—è­‰ï¼Œç™»å…¥ä¸ç”¨ (æ€•èˆŠç©å®¶ç™»ä¸é€²å»)
            if (type === 'register') {
                const err = validatePassword(pass);
                if (err) return showMsg("âš ï¸ " + err);
            } else {
                if (pass.length < 1) return showMsg("âš ï¸ è«‹è¼¸å…¥å¯†ç¢¼");
            }

            msgDiv.innerText = "è™•ç†ä¸­...";
            socket.emit(type, { user, pass });
        }

        // åˆ‡æ›ä¿®æ”¹å¯†ç¢¼æ¨¡å¼
        function toggleChangeMode() {
            const area = document.getElementById('new-pass-area');
            const btns = document.getElementById('main-btns');
            
            if (area.style.display === 'none' || area.style.display === '') {
                area.style.display = 'block';
                btns.style.display = 'none';
                msgDiv.innerText = "è«‹è¼¸å…¥å¸³è™Ÿã€èˆŠå¯†ç¢¼ èˆ‡ æ–°å¯†ç¢¼";
                msgDiv.style.color = "#3498db";
            } else {
                area.style.display = 'none';
                btns.style.display = 'flex';
                msgDiv.innerText = "";
            }
        }

        // åŸ·è¡Œä¿®æ”¹å¯†ç¢¼
        function doChangePass() {
            const user = document.getElementById('user').value.trim();
            const oldPass = document.getElementById('pass').value.trim();
            const newPass = document.getElementById('new-pass').value.trim();

            if (!user || !oldPass || !newPass) return showMsg("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
            
            // é©—è­‰æ–°å¯†ç¢¼å¼·åº¦
            const err = validatePassword(newPass);
            if (err) return showMsg("âš ï¸ " + err);

            msgDiv.innerText = "ä¿®æ”¹ä¸­...";
            socket.emit('changePassword', { user, oldPass, newPass });
        }

        function showMsg(txt) {
            msgDiv.style.color = "#c0392b";
            msgDiv.innerText = txt;
        }
    </script>
</body>
</html>
