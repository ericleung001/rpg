<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë≥áÊ∫êÊé°ÈõÜ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; padding: 10px; margin: 0;
            display: flex; flex-direction: column; height: 100dvh;
        }
        .header { padding: 10px; border-bottom: 2px solid #fff; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: #e74c3c; border: 2px solid #c0392b; color: white; padding: 8px; cursor: pointer; font-family: inherit; font-size: 10px; text-decoration: none;}
        
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #34495e; border: 2px solid #7f8c8d; color: #bdc3c7; padding: 10px; cursor: pointer; font-family: inherit; flex: 1; }
        .tab-btn.active { background: #2ecc71; color: white; border-color: #27ae60; }

        .node-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; overflow-y: auto; flex: 1; }
        
        .node-card { 
            background: #3498db; border: 4px solid #2980b9; 
            padding: 15px; border-radius: 8px; cursor: pointer; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100px;
        }
        .node-card:active { transform: scale(0.95); }
        .node-card.locked { background: #7f8c8d; border-color: #95a5a6; cursor: not-allowed; opacity: 0.7; }
        
        .progress-bar { 
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 80%; height: 20px; background: #333; border: 2px solid #fff; border-radius: 10px; 
            display: none; 
        }
        .progress-fill { height: 100%; background: #f1c40f; width: 0%; transition: width 0.1s linear; }

        .action-img { font-size: 40px; margin-bottom: 10px; }

        /* ÂãïÁï´ */
        @keyframes chop { 0% { transform: rotate(0deg); } 50% { transform: rotate(-20deg); } 100% { transform: rotate(0deg); } }
        .anim-chop { animation: chop 0.5s infinite; }
        
        @keyframes fish { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
        .anim-fish { animation: fish 1s infinite ease-in-out; }

        #game-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 2px solid #f1c40f; padding: 10px 20px; border-radius: 20px; z-index: 999; transition: top 0.5s; font-size: 12px; white-space: nowrap; }
    </style>
</head>
<body>
    <div id="game-toast"></div>
    
    <div class="header">
        <span style="font-size:12px;">üå≤ Ë≥áÊ∫êÊé°ÈõÜ</span>
        <a href="hub.html" class="back-btn">ÂõûÂ§ßÂª≥</a>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('wood')">ü™ì ‰ºêÊú®</button>
        <button class="tab-btn" onclick="switchTab('fish')">üé£ Èá£È≠ö</button>
    </div>

    <div id="node-list" class="node-container">
        </div>

    <div id="progress-bar" class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
    </div>
    
    <div id="status-text" style="margin-bottom: 20px; height: 20px; font-size: 12px; color: #f1c40f;"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const _0x5a1b = "aHR0cHM6Ly9tbW8udHRjdHYtMTA1LmNj"; 
        const BACKEND_URL = atob(_0x5a1b);
        const socket = io(BACKEND_URL, { transports: ['websocket', 'polling'] });
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myLevel = 1;
        let gatherData = {};
        let currentType = 'wood';
        let isGathering = false;

        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
            socket.emit('getGatherNodes');
        });

        socket.on('playerStatsUpdate', (p) => { myLevel = p.level; renderNodes(); });
        
        socket.on('gatherNodeList', (data) => {
            gatherData = data;
            renderNodes();
        });

        socket.on('gatherResult', (res) => {
            isGathering = false;
            document.getElementById('progress-bar').style.display = 'none';
            document.getElementById('status-text').innerText = "";
            showToast(res.success ? "‚úÖ " + res.msg : "‚ùå " + res.msg);
        });

        function switchTab(type) {
            currentType = type;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderNodes();
        }

        function renderNodes() {
            const container = document.getElementById('node-list');
            container.innerHTML = '';
            
            Object.keys(gatherData).forEach(key => {
                const node = gatherData[key];
                if (node.type !== currentType) return;

                const isLocked = myLevel < node.reqLv;
                const div = document.createElement('div');
                div.className = `node-card ${isLocked ? 'locked' : ''}`;
                
                const icon = currentType === 'wood' ? 'üå≤' : 'üíß';
                const lockMsg = isLocked ? `(ÈúÄ Lv.${node.reqLv})` : '';

                div.innerHTML = `
                    <div class="action-img">${icon}</div>
                    <div style="font-size:12px; margin-bottom:5px;">${node.name}</div>
                    <div style="font-size:10px; color:#ddd;">${lockMsg}</div>
                `;

                if (!isLocked) {
                    div.onclick = () => startGather(key, node.time, div);
                }
                
                container.appendChild(div);
            });
        }

        function startGather(nodeId, duration, element) {
            if (isGathering) return;
            isGathering = true;
            
            const iconDiv = element.querySelector('.action-img');
            const animClass = currentType === 'wood' ? 'anim-chop' : 'anim-fish';
            iconDiv.classList.add(animClass);

            document.getElementById('progress-bar').style.display = 'block';
            document.getElementById('status-text').innerText = currentType === 'wood' ? "Á†ç‰ºê‰∏≠..." : "Á≠âÂæÖÈ≠öÂÖí‰∏äÈâ§...";
            
            const fill = document.getElementById('progress-fill');
            fill.style.transition = `width ${duration}ms linear`;
            
            // Âº∑Âà∂ÈáçÁπ™‰ª•Ëß∏ÁôºÂãïÁï´
            fill.style.width = '0%';
            setTimeout(() => { fill.style.width = '100%'; }, 10);

            setTimeout(() => {
                iconDiv.classList.remove(animClass);
                fill.style.transition = 'none';
                fill.style.width = '0%';
                socket.emit('gatherAction', nodeId);
            }, duration);
        }

        function showToast(msg) {
            const t = document.getElementById('game-toast');
            t.innerText = msg;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 2000);
        }
    </script>
</body>
</html>
