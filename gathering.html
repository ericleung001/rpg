<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>è³‡æºæ¡é›†v3</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100dvh;
            overflow: scroll; 
        }

        /* ä¸»å…§å®¹å€å¡Š */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 40px; 
        }

        .header { padding: 10px; border-bottom: 2px solid #fff; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* ğŸŸ¢ è¿”å›æŒ‰éˆ• z-index 10001 (æ¯”é®ç½©é«˜ï¼Œå…è¨±ä¸­é€”é›¢é–‹) */
        .back-btn { 
            background: #e74c3c; border: 2px solid #c0392b; color: white; padding: 8px; 
            cursor: pointer; font-family: inherit; font-size: 10px; text-decoration: none;
            position: relative; z-index: 10001; 
        }
        
        .gather-status-bar { 
            background: #34495e; padding: 10px; border-radius: 8px; margin-bottom: 15px; 
            font-size: 10px; border: 2px solid #7f8c8d; text-align: left;
        }
        .exp-bar { width: 100%; height: 8px; background: #555; margin-top: 5px; border-radius: 4px; overflow:hidden; }
        .exp-fill { height: 100%; background: #f39c12; width: 0%; transition: width 0.3s; }

        .tabs { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; }
        .tab-btn { background: #34495e; border: 2px solid #7f8c8d; color: #bdc3c7; padding: 10px; cursor: pointer; font-family: inherit; flex: 1; font-size: 10px; }
        .tab-btn.active { background: #2ecc71; color: white; border-color: #27ae60; }

        .count-selector {
            display: flex; justify-content: center; gap: 5px; margin-bottom: 15px;
            background: #2c3e50; padding: 5px; border-radius: 8px; flex-wrap: wrap;
        }
        .count-btn {
            background: #34495e; border: 2px solid #7f8c8d; color: #fff;
            padding: 8px 12px; cursor: pointer; font-family: inherit; font-size: 10px;
            border-radius: 4px; margin-bottom: 5px;
        }
        .count-btn.selected { background: #f39c12; border-color: #e67e22; color: #000; font-weight: bold; }
        
        .node-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 5px; }
        
        .node-card { 
            background: #3498db; border: 4px solid #2980b9; 
            padding: 10px; border-radius: 8px; cursor: pointer; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100px;
        }
        .node-card:active { transform: scale(0.95); }
        .node-card.locked { background: #7f8c8d; border-color: #95a5a6; cursor: not-allowed; opacity: 0.7; }
        
        .action-img { font-size: 30px; margin-bottom: 10px; }

        #game-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 2px solid #f1c40f; padding: 10px 20px; border-radius: 20px; z-index: 20000; transition: top 0.5s; font-size: 12px; white-space: nowrap; color: white;}

        /* ğŸ›‘ æ¡é›†é–å®šé®ç½© (z-index: 10000) */
        #lock-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); 
            z-index: 10000; display: none; 
            flex-direction: column; justify-content: center; align-items: center;
            color: white;
        }

        .loading-box {
            width: 80%; max-width: 300px; background: #34495e; padding: 20px;
            border-radius: 10px; border: 2px solid #f1c40f; text-align: center;
        }

        .progress-bar { width: 100%; height: 20px; background: #2c3e50; margin-top: 15px; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #2ecc71; transition: width 0.1s linear; }
        .loading-text { font-size: 14px; margin-bottom: 5px; font-weight: bold; color: #f1c40f; }
        
        .overlay-stop-btn {
            background: #c0392b; border: 2px solid #e74c3c; color: white;
            padding: 10px 20px; cursor: pointer; font-family: inherit; font-size: 12px;
            border-radius: 4px; margin-top: 15px;
        }

        /* ğŸŸ¢ èŠå¤©å®¤æ¨£å¼ (ä¿®æ­£ç‰ˆ) */
        #chat-container {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.95); border-top: 4px solid #bdc3c7;
            display: flex; flex-direction: column; font-size: 10px; 
            
            /* â­ é—œéµä¿®æ”¹ï¼šå°‡å±¤ç´šè¨­ç‚º 12000ï¼Œé«˜æ–¼é®ç½©çš„ 10000 */
            z-index: 12000; 
            
            padding-bottom: env(safe-area-inset-bottom);
            transition: height 0.3s ease-in-out;
            height: 30px; 
        }
        
        #chat-header {
            height: 30px; background: #34495e; color: #fff; line-height: 30px; 
            cursor: pointer; font-weight: bold; border-bottom: 1px solid #555;
            display: flex; justify-content: center; align-items: center;
            touch-action: manipulation;
            flex-shrink: 0; 
        }
        #chat-header:hover { background: #2c3e50; }

        .chat-open { height: 40vh !important; }
        #chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-open #chat-body { display: flex; } 

        #chat-history { flex: 1; overflow-y: auto; padding: 8px; text-align: left; color: white; }
        #chat-input-area { display: flex; border-top: 1px solid #555; height: 40px; flex-shrink: 0; }
        #chat-input { flex: 1; background: #222; color: white; border: none; padding: 0 10px; font-family: inherit; font-size: 12px; outline: none; }
        #chat-send { background: #2980b9; color: white; border: none; padding: 0 15px; cursor: pointer; font-family: inherit; font-size: 12px; font-weight: bold; touch-action: manipulation; }
        
        @media (min-width: 1024px) {
            body { 
                flex-direction: row; 
                justify-content: center;
                background-color: #222;
            }
            #app-layout {
                display: flex;
                width: 1000px;
                background-color: #2c3e50;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                height: 100%;
            }
            #main-content {
                width: 600px;
                border-right: 4px solid #bdc3c7;
                padding-bottom: 10px;
            }
            #chat-container {
                /* â­ é—œéµä¿®æ”¹ï¼šPCç‰ˆæ”¹ç‚º relativeï¼Œç¢ºä¿ z-index ç”Ÿæ•ˆ */
                position: relative; 
                width: 400px;
                height: 100% !important; 
                border-top: none;
                background: #34495e;
                z-index: 12000;
            }
            #chat-header {
                cursor: default;
                background: #2c3e50;
            }
            #chat-header:active { pointer-events: none; }
            #chat-body {
                display: flex !important;
                height: calc(100% - 30px);
            }
        }
    </style>
</head>
<body>
    <div id="game-toast"></div>
    
    <div id="app-layout">
        <div id="main-content">
            <div class="header">
                <span style="font-size:12px;">ğŸŒ² è³‡æºæ¡é›†</span>
                <a href="hub.html" class="back-btn" onclick="stopGathering()">å›å¤§å»³</a>
            </div>

            <div class="gather-status-bar">
                <div style="display:flex; justify-content:space-between;">
                    <span>æ¡é›†ç†Ÿç·´åº¦: Lv.<span id="gather-lv">1</span></span>
                    <span id="gather-exp-txt">0/500</span>
                </div>
                <div class="exp-bar"><div id="gather-exp-fill" class="exp-fill"></div></div>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('wood')">ğŸª“ ä¼æœ¨</button>
                <button class="tab-btn" onclick="switchTab('mine')">â›ï¸ æ¡ç¤¦</button>
                <button class="tab-btn" onclick="switchTab('fish')">ğŸ£ é‡£é­š</button>
            </div>

            <div class="count-selector">
                <button class="count-btn selected" onclick="setCount(1)">x1</button>
                <button class="count-btn" onclick="setCount(30)">x30</button>
                <button class="count-btn" onclick="setCount(50)">x50</button>
                <button class="count-btn" onclick="setCount(70)">x70</button>
                <button class="count-btn" onclick="setCount(100)">x100</button>
                <button class="count-btn" onclick="setCount(200)">x200</button>
            </div>

            <div id="node-list" class="node-container">
                <div style="font-size:10px; color:#aaa; width:200%;">æ­£åœ¨è®€å–è³‡æ–™...</div>
            </div>
        </div>

        <div id="chat-container">
            <div id="chat-header" onclick="toggleChat()"> å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)</div>
            <div id="chat-body">
                <div id="chat-history"></div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." maxlength="50">
                    <button id="chat-send">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="lock-overlay">
        <div class="loading-box">
            <div class="loading-text" id="action-text">æ­£åœ¨æ¡é›†ä¸­...</div>
            <div id="queue-text" style="font-size: 10px; color: #ccc;">å‰©é¤˜æ¬¡æ•¸: 0</div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="timer-text" style="margin-top: 5px; font-size: 10px; color: #aaa;">è«‹å‹¿é—œé–‰è¦–çª—</div>
            <button class="overlay-stop-btn" onclick="stopGathering()">â›” åœæ­¢æ¡é›†</button>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
const socket = io('https://mmo.ttctv-105.cc', { 
    transports: ['websocket', 'polling'],
    secure: true // å› ç‚ºä½ ç”¨ httpsï¼Œå»ºè­°åŠ å‘¢å€‹
});
        
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myGatherLv = 1;
        let gatherData = {};
        let currentType = 'wood';
        
        // ğŸŸ¢ ç‹€æ…‹æ§åˆ¶è®Šæ•¸
        let isGathering = false;        
        let isWaitingServer = false;    
        let targetCount = 1;            
        let remainingCount = 0;         
        let currentGatherNodeId = null; 
        let currentGatherTime = 0; 
        let currentActionName = "";

        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
        });

        socket.on('playerStatsUpdate', (p) => { 
            myGatherLv = p.gatherLevel || 1;
            const gExp = p.gatherExp || 0;
            const maxExp = myGatherLv * 500;

            updateGatherUI(myGatherLv, gExp, maxExp);
            
            if (Object.keys(gatherData).length === 0) {
                socket.emit('getGatherNodes');
            } else {
                renderNodes(); 
            }
        });
        
        socket.on('gatherNodeList', (data) => {
            gatherData = data;
            renderNodes();
        });

        // ğŸŸ¢ [èŠå¤©å®¤é‚è¼¯]
        socket.on('chatHistory', (history) => {
            const box = document.getElementById('chat-history');
            box.innerHTML = ''; 
            history.forEach(data => appendChat(data.name, data.msg));
        });

        socket.on('chatMessage', (data) => {
            appendChat(data.name, data.msg);
        });

        function appendChat(name, msg) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            
            const nameSpan = document.createElement('span');
            nameSpan.style.color = '#f1c40f';
            nameSpan.style.fontWeight = 'bold';
            nameSpan.textContent = `[${name}]: `;

            const msgNode = document.createTextNode(msg);

            div.appendChild(nameSpan);
            div.appendChild(msgNode);
            
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
        }

        document.getElementById('chat-send').onclick = sendChat;
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (msg) { socket.emit('sendChat', msg); input.value = ''; }
        }

        function toggleChat() {
            const chat = document.getElementById('chat-container');
            const header = document.getElementById('chat-header');
            
            if (window.innerWidth >= 1024) return;

            chat.classList.toggle('chat-open');
            if(chat.classList.contains('chat-open')) {
                header.innerText = " é»æ“Šæ”¶èµ·";
            } else {
                header.innerText = " å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)";
            }
        }

        // ğŸŸ¢ [æ ¸å¿ƒ] åˆå§‹åŒ–æ¡é›†ï¼šå‘ Server ç”³è«‹
        function initGatherSequence(nodeId, duration, name) {
            if (isGathering) return;
            
            currentGatherNodeId = nodeId;
            currentGatherTime = duration || 3000;
            currentActionName = name;

            socket.emit('startGather', targetCount);
        }

        // ğŸŸ¢ [æ ¸å¿ƒ] Server æ‰¹å‡†å¾Œæ‰æ­£å¼é–‹å§‹
        socket.on('gatherStarted', (approvedCount) => {
            isGathering = true;
            isWaitingServer = false;
            remainingCount = approvedCount; 
            
            document.querySelectorAll('.count-btn').forEach(b => b.style.opacity = '0.5');
            document.querySelectorAll('.tab-btn').forEach(b => b.style.opacity = '0.5');
            document.getElementById('lock-overlay').style.display = 'flex';
            document.getElementById('action-text').innerText = `æ­£åœ¨æ¡é›†ï¼š${currentActionName}`;
            
            updateQueueDisplay();
            startSingleGather(); 
        });

        socket.on('forceStopGather', () => {
            stopGathering();
            showToast("âš ï¸ ç³»çµ±å¼·åˆ¶åœæ­¢ (é…é¡ç”¨ç›¡)");
        });

        socket.on('gatherResult', (res) => {
            isWaitingServer = false; 

            if (!isGathering) return; 

            remainingCount--; 
            updateQueueDisplay();

            if(res.success) {
                showToast("âœ… " + res.msg);
                
                if (res.gatherLevel) {
                    myGatherLv = res.gatherLevel;
                    updateGatherUI(res.gatherLevel, res.gatherExp, res.gatherMaxExp);
                    renderNodes();
                }
            } else {
                showToast("âŒ " + res.msg);
                if (res.msg.includes("èƒŒåŒ…") || res.msg.includes("ç­‰ç´š") || res.msg.includes("é€²è¡Œä¸­")) {
                    stopGathering();
                    return;
                }
            }

            if (remainingCount > 0) {
                setTimeout(() => {
                    startSingleGather(); 
                }, 50); 
            } else {
                stopGathering(); 
                showToast("ğŸ‰ æ¡é›†ä»»å‹™å®Œæˆï¼");
            }
        });

        function updateGatherUI(lv, exp, max) {
            document.getElementById('gather-lv').innerText = lv;
            document.getElementById('gather-exp-txt').innerText = `${exp}/${max}`;
            document.getElementById('gather-exp-fill').style.width = Math.min(100, (exp / max * 100)) + '%';
        }

        function switchTab(type) {
            stopGathering();
            currentType = type;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderNodes();
        }

        function setCount(n) {
            if (isGathering) return; 
            targetCount = n;
            document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function stopGathering() {
            isGathering = false;
            isWaitingServer = false;
            remainingCount = 0;
            currentGatherNodeId = null;
            
            document.getElementById('lock-overlay').style.display = 'none';
            
            document.querySelectorAll('.count-btn').forEach(b => b.style.opacity = '1');
            document.querySelectorAll('.tab-btn').forEach(b => b.style.opacity = '1');
        }

        function renderNodes() {
            const container = document.getElementById('node-list');
            container.innerHTML = '';
            
            if (Object.keys(gatherData).length === 0) {
                container.innerHTML = '<div style="padding:20px; font-size:10px;">è¼‰å…¥ä¸­...</div>';
                return;
            }

            Object.keys(gatherData).forEach(key => {
                const node = gatherData[key];
                if (node.type !== currentType) return;

                const isLocked = myGatherLv < node.reqLv;
                const div = document.createElement('div');
                div.className = `node-card ${isLocked ? 'locked' : ''}`;
                
                let icon = 'ğŸŒ²';
                if(currentType === 'mine') icon = 'ğŸª¨';
                if(currentType === 'fish') icon = 'ğŸ’§';

                const lockMsg = isLocked ? `(éœ€ Lv.${node.reqLv})` : '';

                div.innerHTML = `
                    <div class="action-img">${icon}</div>
                    <div style="font-size:12px; margin-bottom:5px;">${node.name}</div>
                    <div style="font-size:10px; color:#ddd;">${lockMsg}</div>
                `;

                if (!isLocked) {
                    div.onclick = () => initGatherSequence(key, node.time, node.name);
                } else {
                    div.onclick = () => showToast(`âŒ ç­‰ç´šä¸è¶³ï¼éœ€è¦æ¡é›†ç­‰ç´š ${node.reqLv}`);
                }
                
                container.appendChild(div);
            });
        }

        function updateQueueDisplay() {
            document.getElementById('queue-text').innerText = `å‰©é¤˜æ¬¡æ•¸: ${remainingCount}`;
        }

        function startSingleGather() {
            if (!isGathering || remainingCount <= 0 || isWaitingServer) return;

            const fill = document.getElementById('progress-fill');
            fill.style.transition = 'none';
            fill.style.width = '0%';
            
            void fill.offsetWidth; 

            setTimeout(() => {
                fill.style.transition = `width ${currentGatherTime}ms linear`;
                fill.style.width = '100%';
            }, 50);

            setTimeout(() => {
                if (!isGathering) return; 
                isWaitingServer = true; 
                socket.emit('gatherAction', currentGatherNodeId);
            }, currentGatherTime);
        }

        function showToast(msg) {
            const t = document.getElementById('game-toast');
            t.innerText = msg;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 2000);
        }

        window.onbeforeunload = function() {
            if (isGathering) stopGathering();
        };
    </script>
</body>
</html>
