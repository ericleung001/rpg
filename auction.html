<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸‚é›†</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; 
            padding: 10px; 
            display:flex; flex-direction:column; align-items:center; 
            height: 100dvh; margin:0; box-sizing:border-box;
            overscroll-behavior: none;
            user-select: none; -webkit-user-select: none;
        }

        /* ğŸŸ¢ Loading é®ç½©å±¤ (èˆ‡ hub.html ç›¸åŒé¢¨æ ¼) */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; 
            z-index: 99999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #fff; border-top: 4px solid #f1c40f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 18px; margin: 0; }

        .toolbar {
            width: 100%; max-width: 600px;
            display: flex; gap: 8px; margin-bottom: 10px;
        }
        
        .filter-select {
            background: #ecf0f1; color: #2c3e50; border: 2px solid #bdc3c7;
            padding: 10px; font-family: inherit; font-size: 12px;
            border-radius: 6px; flex: 2; outline: none; font-weight: bold;
        }

        .btn-sell-trigger {
            flex: 1;
            background: #e67e22; color: white; border: 2px solid #d35400;
            border-radius: 6px; cursor: pointer; font-family: inherit;
            font-size: 12px; font-weight: bold; padding: 0 5px;
            display: flex; align-items: center; justify-content: center;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        .btn-sell-trigger:active { transform: translateY(2px); }

        .container { 
            display: flex; flex: 1; 
            width: 100%; max-width: 600px; 
            overflow: hidden; 
            margin-bottom: 15px; 
        }
        
        .market-list { 
            width: 100%; 
            background: #34495e; 
            border: 3px solid #bdc3c7; 
            overflow-y: auto; 
            padding: 8px; 
            border-radius: 8px; 
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            grid-auto-rows: min-content; 
            gap: 10px; 
            align-content: start; 
        }

        .item-card { 
            background: #ecf0f1; color: #2c3e50; 
            padding: 10px; 
            border-radius: 8px; 
            text-align: center; 
            position: relative; 
            box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            aspect-ratio: 1 / 0.85; 
            min-height: 140px; 
        }

        .item-card h3 { 
            font-size: 12px; 
            margin: 0 0 5px 0; 
            color: #2980b9; 
            height: 2.4em; 
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.2;
        }

        .item-info { font-size: 10px; color: #555; width: 100%; margin-bottom: 2px; }
        
        .item-stats { 
            font-size: 10px; 
            color: #e67e22; 
            background: rgba(0,0,0,0.05); padding: 3px; 
            border-radius: 4px; margin: 4px 0; 
            width: 100%; box-sizing: border-box;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .price-tag { color: #c0392b; font-weight: bold; margin-top: auto; font-size: 12px; }
        
        .btn { 
            padding: 8px; font-family: inherit; font-size: 12px; cursor: pointer; 
            border: 2px solid #333; color: white; margin-top: 6px; width: 100%; 
            border-radius: 6px; font-weight: bold;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
        }
        .btn-buy { background: #27ae60; border-color: #2ecc71; }
        .btn-sell { background: #e67e22; border-color: #d35400; }
        .btn-cancel { background: #c0392b; border-color: #e74c3c; } 
        .btn:active { filter: brightness(0.8); transform: translateY(2px); }
        
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; 
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { 
            background: #fff; color: #000; 
            padding: 20px; border: 6px solid #f1c40f; 
            width: 85%; max-width: 320px; border-radius: 12px;
            max-height: 80vh; overflow-y: auto; 
        }
        input { 
            width: 100%; padding: 12px; margin: 10px 0; 
            font-family: inherit; font-size: 16px; 
            box-sizing: border-box; border: 2px solid #ccc;
        }

        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
        }

        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f;
            color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999;
            font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out;
            pointer-events: none;
        }
        
        .sell-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 5px; border-bottom: 1px solid #eee;
        }
        .sell-list-item button { width: auto; margin: 0; padding: 8px 12px; font-size: 12px;}
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-size:12px; margin-top:10px;">è®€å–å¸‚é›†è³‡è¨Š...</div>
        <div style="font-size:10px; color:#95a5a6; margin-top:5px;">(è«‹ç¨å€™)</div>
    </div>

    <div id="game-toast"></div>

    <div class="header">
        <h1>âš–ï¸ å¸‚é›†</h1>
        <div class="gold-display">ğŸ’° <span id="my-gold">0</span> G</div>
    </div>

    <div class="toolbar">
        <select id="category-filter" class="filter-select" onchange="applyFilter()">
            <option value="all">ğŸ” å…¨éƒ¨å•†å“</option>
            <option value="weapon">âš”ï¸ æ­¦å™¨</option>
            <option value="armor">ğŸ›¡ï¸ é˜²å…·</option>
            <option value="acc">ğŸ’ é£¾å“</option>
            <option value="consumable">ğŸ§ª æ¶ˆè€—å“</option>
            <option value="material">ğŸªµ ææ–™</option>
            <option value="mine">ğŸŸ¢ æˆ‘çš„æ‹è³£</option>
        </select>
        <button class="btn-sell-trigger" onclick="openInventoryModal()">+ æˆ‘è¦è³£</button>
    </div>

    <div class="container">
        <div class="market-list" id="market-list">
            <div style="font-size:12px; color:#aaa; margin-top:20px; grid-column: span 2;">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>

    <div id="inventory-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:15px;">é¸æ“‡è¦è³£çš„ç‰©å“</h3>
            <div id="sell-inventory-list" style="text-align:left;"></div>
            <button class="btn" style="background:#7f8c8d; margin-top:15px;" onclick="closeInventoryModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="sell-price-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-item-name" style="font-size:16px; margin-bottom:10px;">ä¸Šæ¶ç‰©å“</h3>
            <input type="number" id="sell-price" placeholder="è¼¸å…¥åƒ¹æ ¼ (G)">
            <button class="btn btn-sell" style="font-size:14px; padding:15px;" onclick="confirmSell()">ç¢ºèªä¸Šæ¶</button>
            <button class="btn" style="background:#555; margin-top:10px; font-size:14px; padding:15px;" onclick="closePriceModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:15px; color:#e74c3c;">âš ï¸ ç¢ºèªæ“ä½œ</h3>
            <div id="confirm-msg" style="font-size:12px; color:#555; margin-bottom:20px; line-height:1.5;">ç¢ºå®šè¦å–å›é€™å€‹ç‰©å“å—ï¼Ÿ</div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="background:#e74c3c; margin-top:0;" onclick="doConfirmAction()">ç¢ºå®š</button>
                <button class="btn" style="background:#7f8c8d; margin-top:0;" onclick="closeConfirmModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
        // ğŸŸ¢ Loading æ§åˆ¶ (3.5ç§’)
        window.addEventListener('load', () => {
            setTimeout(() => {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 500);
            }, 3500);
        });

        const _0x5a1b = "aHR0cHM6Ly9ycGdnYW1lc2VyLmNj"; 
        const BACKEND_URL = atob(_0x5a1b);
        
        const socket = io(BACKEND_URL, {
            transports: ['websocket', 'polling'],
            secure: true 
        });
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        const ITEM_DB = {
            'copper_ore': { name: 'éŠ…ç¤¦çŸ³', type: 'material', desc: 'ä½éšç¤¦çŸ³' },
            'soft_fur': { name: 'æŸ”è»Ÿçš®æ¯›', type: 'material', desc: 'åŸºç¤çš®é©ææ–™' },
            'beast_fang': { name: 'é‡ç¸å°–ç‰™', type: 'material', desc: 'é‹’åˆ©çš„ç‰™é½’' },
            'slime_gel': { name: 'é»æ¶²', type: 'material', desc: 'é»ç³Šç³Šçš„æ¶²é«”' },
            'iron_ore': { name: 'éµç¤¦çŸ³', type: 'material', desc: 'é›é€ é‡‘å±¬' },
            'leather': { name: 'çš®é©', type: 'material', desc: 'è£½ä½œé˜²å…·çš„ææ–™' },
            'tough_hide': { name: 'ç¡¬çš®é©', type: 'material', desc: 'å …éŸŒçš„ç¸çš®' },
            'magic_dust': { name: 'é­”ç²‰', type: 'material', desc: 'å«æœ‰å¾®å¼±é­”åŠ›' },
            'poison_sac': { name: 'æ¯’å›Š', type: 'material', desc: 'å«æœ‰åŠ‡æ¯’' },
            'bone_shard': { name: 'ç¢éª¨ç‰‡', type: 'material', desc: 'å……æ»¿æ­»æ°£' },
            'silver_ore': { name: 'éŠ€ç¤¦çŸ³', type: 'material', desc: 'å°é­”ç‰©æœ‰æ•ˆ' },
            'fire_core': { name: 'ç«ç„°æ ¸å¿ƒ', type: 'material', desc: 'ç‡ƒç‡’ä¸æ»…' },
            'lava_rock': { name: 'ç†”å²©çŸ³', type: 'material', desc: 'æ»¾ç‡™çš„çŸ³é ­' },
            'dragon_scale': { name: 'é¾é±—', type: 'material', desc: 'æ¥µåº¦å …ç¡¬' },
            'gold_ore': { name: 'é‡‘ç¤¦çŸ³', type: 'material', desc: 'è²´é‡‘å±¬' },
            'ice_crystal': { name: 'æ°¸æ†å†°æ™¶', type: 'material', desc: 'æ°¸ä¸èåŒ–' },
            'yeti_fur': { name: 'é›ªæ€ªæ¯›çš®', type: 'material', desc: 'éå¸¸ä¿æš–' },
            'spirit_dust': { name: 'éˆé­‚ç²‰æœ«', type: 'material', desc: 'äº¡éˆèƒ½é‡' },
            'mithril': { name: 'ç§˜éŠ€', type: 'material', desc: 'å‚³èªªé‡‘å±¬' },
            'void_dust': { name: 'è™›ç©ºä¹‹å¡µ', type: 'material', desc: 'ç•°æ¬¡å…ƒç‰©è³ª' },
            'demon_horn': { name: 'æƒ¡é­”ä¹‹è§’', type: 'material', desc: 'é‚ªæƒ¡åŠ›é‡' },
            'dark_essence': { name: 'æš—ä¹‹ç²¾è¯', type: 'material', desc: 'ç´”ç²¹é»‘æš—' },
            'adamantite': { name: 'ç²¾é‡‘', type: 'material', desc: 'æœ€å …ç¡¬ç‰©è³ª' },
            'god_blood': { name: 'ç¥ä¹‹è¡€', type: 'material', desc: 'ç¥è–æ¶²é«”' },
            'chaos_orb': { name: 'æ··æ²Œå¯¶ç ', type: 'material', desc: 'å‰µä¸–ä¹‹åŠ›' },
            'angel_feather': { name: 'å¤©ä½¿ä¹‹ç¾½', type: 'material', desc: 'ç¥è–ç¾½æ¯›' },
            'potion_hp':    { name: "å°ç´…è—¥æ°´", type: 'consumable', desc: "æ¢å¾© 50 HP" },
            'potion_mid':   { name: "ä¸­ç´…è—¥æ°´", type: 'consumable', desc: "æ¢å¾© 500 HP" },
            'potion_high':  { name: "å¤§ç´…è—¥æ°´", type: 'consumable', desc: "æ¢å¾© 2000 HP" },
            'potion_max':   { name: "ç‰¹ç´šç§˜è—¥", type: 'consumable', desc: "æ¢å¾© 10000 HP" },
            'elixir':       { name: "ç¥ä¹‹ç”˜éœ²", type: 'consumable', desc: "æ¢å¾© 50000 HP" },
            'potion_mp':    { name: "å°è—è—¥æ°´", type: 'consumable', desc: "æ¢å¾© 30 MP" },
            'potion_mp_mid':{ name: "ä¸­è—è—¥æ°´", type: 'consumable', desc: "æ¢å¾© 100 MP" },
            'potion_mp_high':{ name: "å¤§è—è—¥æ°´", type: 'consumable', desc: "æ¢å¾© 500 MP" },
            'grilled_carp': { name: "çƒ¤é¯‰é­š", type: 'consumable', desc: "é£Ÿç”¨: HP+100" },
            'salmon_sushi': { name: "é®­é­šå£½å¸", type: 'consumable', desc: "é£Ÿç”¨: MP+50" },
            'tuna_steak':   { name: "ç…é®ªé­šæ’", type: 'consumable', desc: "é£Ÿç”¨: HP+500" },
            'eel_rice':     { name: "é°»é­šé£¯", type: 'consumable', desc: "é£Ÿç”¨: HP+300, MP+100" },
            'void_soup':    { name: "è™›ç©ºæµ·é®®æ¹¯", type: 'consumable', desc: "é£Ÿç”¨: ç‹€æ…‹å…¨æ»¿" },
            'sushi_plate':  { name: "å£½å¸æ‹¼ç›¤", type: 'consumable', desc: "é£Ÿç”¨: HP+500" },
            'wood_sword':   { name: "æœ¨åŠ", type: 'weapon', desc: "ATK +10" },
            'copper_dagger':{ name: "éŠ…åŒ•é¦–", type: 'weapon', desc: "ATK +15" },
            'iron_sword':   { name: "éµåŠ", type: 'weapon', desc: "ATK +30" },
            'spike_club':   { name: "ç‹¼ç‰™æ£’", type: 'weapon', desc: "ATK +55" },
            'poison_dag':   { name: "åŠ‡æ¯’åŒ•é¦–", type: 'weapon', desc: "ATK +60 (å¸¶æ¯’)" },
            'silver_blade': { name: "éŠ€åˆƒ", type: 'weapon', desc: "ATK +150 (å°ä¸æ­»ç³»å¼·)" },
            'flame_staff':  { name: "ç«ç„°æ³•æ–", type: 'weapon', desc: "ATK +200 (ç«å±¬æ€§)" },
            'gold_axe':     { name: "é»ƒé‡‘å·¨æ–§", type: 'weapon', desc: "ATK +500" },
            'frost_bow':    { name: "å¯’å†°å¼“", type: 'weapon', desc: "ATK +650 (å†°å±¬æ€§)" },
            'mithril_saber':{ name: "ç§˜éŠ€è»åˆ€", type: 'weapon', desc: "ATK +2000" },
            'void_reaper':  { name: "è™›ç©ºæ”¶å‰²è€…", type: 'weapon', desc: "ATK +3500" },
            'god_slayer':   { name: "å¼’ç¥åŠ", type: 'weapon', desc: "ATK +20000 (ç¥å™¨)" },
            'chaos_staff':  { name: "æ··æ²Œæ³•æ–", type: 'weapon', desc: "ATK +25000 (å‚³èªª)" },
            'hero_sword':   { name: "å‹‡è€…ä¹‹åŠ", type: 'weapon', desc: "ATK +50" },
            'steel_blade':  { name: "ç²¾é‹¼åŠ", type: 'weapon', desc: "ATK +25" },
            'assassin_dag': { name: "åˆºå®¢çŸ­åˆ€", type: 'weapon', desc: "ATK +120" },
            'oak_bow':      { name: "æ©¡æœ¨å¼“", type: 'weapon', desc: "ATK +25" },
            'maple_staff':  { name: "æ¥“æœ¨æ³•æ–", type: 'weapon', desc: "ATK +50" },
            'shark_tooth':  { name: "é¯Šé­šç‰™åŒ•é¦–", type: 'weapon', desc: "ATK +80" },
            'emerald_staff':{ name: "ç¿¡ç¿ æ³•æ–", type: 'weapon', desc: "ATK +300" },
            'obsidian_blade':{ name: "é»‘æ›œçŸ³ä¹‹åŠ", type: 'weapon', desc: "ATK +600" },
            'dragon_spear': { name: "é¾éª¨é•·æ§", type: 'weapon', desc: "ATK +1200" },
            'cloth_armor':  { name: "å¸ƒè¡£", type: 'armor', desc: "DEF +5" },
            'hunt_vest':    { name: "çµäººèƒŒå¿ƒ", type: 'armor', desc: "DEF +8" },
            'leather_armor':{ name: "çš®ç”²", type: 'armor', desc: "DEF +15" },
            'chain_mail':   { name: "é–å­ç”²", type: 'armor', desc: "DEF +40" },
            'magma_plate':  { name: "ç†”å²©èƒ¸ç”²", type: 'armor', desc: "DEF +100" },
            'ice_robe':     { name: "å†°éœœæ³•è¢", type: 'armor', desc: "DEF +200" },
            'yeti_cloak':   { name: "é›ªæ€ªæ–—ç¯·", type: 'armor', desc: "DEF +250" },
            'demon_armor':  { name: "æƒ¡é­”æˆ°ç”²", type: 'armor', desc: "DEF +1000" },
            'angel_armor':  { name: "ç†¾å¤©ä½¿é§ç”²", type: 'armor', desc: "DEF +5000" },
            'plate_mail':   { name: "æ¿é‡‘ç”²", type: 'armor', desc: "DEF +15" },
            'dragon_mail':  { name: "é¾é±—ç”²", type: 'armor', desc: "DEF +30" },
            'bone_ring':    { name: "éª¨æˆ’", type: 'acc', desc: "ATK +2" },
            'ring_str':     { name: "åŠ›é‡æˆ’æŒ‡", type: 'acc', desc: "ATK +10" },
            'snake_boots':  { name: "è›‡çš®é•·é´", type: 'acc', desc: "DEF +10" },
            'amulet_soul':  { name: "éˆé­‚è­·ç¬¦", type: 'acc', desc: "MP +300" },
            'ring_lord':    { name: "é ˜ä¸»æŒ‡ç’°", type: 'acc', desc: "å…¨èƒ½åŠ› +500" },
            'crown_chaos':  { name: "æ··æ²Œä¹‹å† ", type: 'acc', desc: "å…¨èƒ½åŠ› +2000" },
            'ring_life':    { name: "ç”Ÿå‘½è­·ç¬¦", type: 'acc', desc: "HP +100" },
            'ring_magic':   { name: "é­”åŠ›è€³ç’°", type: 'acc', desc: "MP +50" },
            'fish_ring':    { name: "é­šé±—æˆ’æŒ‡", type: 'acc', desc: "DEF +8" },
            'pearl_necklace':{ name: "çç é …éŠ", type: 'acc', desc: "MP +100, DEF +20" },
            'oak_log':      { name: "æ©¡æœ¨åŸæœ¨", type: 'material', desc: "æ™®é€šå»ºæ" },
            'maple_log':    { name: "æ¥“æœ¨åŸæœ¨", type: 'material', desc: "é«˜ç´šå»ºæ" },
            'yew_log':      { name: "ç´«æ‰åŸæœ¨", type: 'material', desc: "é­”æ³•æœ¨æ" },
            'ancient_log':  { name: "é å¤ç¥æœ¨", type: 'material', desc: "ç¥è©±ææ–™" },
            'spirit_wood':  { name: "éˆæœ¨", type: 'material', desc: "ç¨€æœ‰æœ¨æ" },
            'dragon_wood':  { name: "é¾éª¨æœ¨", type: 'material', desc: "æ¥µç¡¬æœ¨æ" },
            'void_wood':    { name: "è™›ç©ºæœ¨", type: 'material', desc: "ä¾†è‡ªè™›ç©º" },
            'chaos_wood':   { name: "æ··æ²Œç¥æœ¨", type: 'material', desc: "å‚³èªªææ–™" },
            'carp':         { name: "é¯‰é­š", type: 'material', desc: "æ™®é€šé£Ÿæ" },
            'salmon':       { name: "é®­é­š", type: 'material', desc: "ç¾å‘³é£Ÿæ" },
            'koi':          { name: "éŒ¦é¯‰", type: 'material', desc: "å¹¸é‹é­š" },
            'magic_fish':   { name: "é­”åŠ›é­š", type: 'material', desc: "ç™¼å…‰é­š" },
            'tuna':         { name: "é»‘é®ªé­š", type: 'material', desc: "é ‚ç´šé£Ÿæ" },
            'shark':        { name: "å¤§ç™½é¯Š", type: 'material', desc: "å…‡çŒ›é­šé¡" },
            'lava_eel':     { name: "ç†”å²©é°»", type: 'material', desc: "ç‡™æ‰‹é£Ÿæ" },
            'void_squid':   { name: "è™›ç©ºçƒè³Š", type: 'material', desc: "ç¥ç§˜é£Ÿæ" },
            'god_carp':     { name: "ç¥ä¹‹é¯‰", type: 'material', desc: "ç¥é­š" },
            'pearl':        { name: "çç ", type: 'material', desc: "çè²´å¯¶çŸ³" },
            'coal':         { name: "ç…¤ç‚­", type: 'material', desc: "ç‡ƒæ–™" },
            'ruby':         { name: "ç´…å¯¶çŸ³", type: 'material', desc: "å¯¶çŸ³" },
            'diamond':      { name: "é‘½çŸ³", type: 'material', desc: "å …ç¡¬å¯¶çŸ³" },
            'star_fragment':{ name: "æ˜Ÿä¹‹ç¢ç‰‡", type: 'material', desc: "éš•çŸ³" },
            'default':      { name: "æœªçŸ¥ç‰©å“", type: 'material', desc: "ææ–™" }
        };

        let currentSellId = null;
        let pendingAction = null; 
        let pendingId = null;      
        let allListings = []; 
        let myInventory = {};

        socket.on('connect', () => {
            // ğŸŸ¢ éš¨æ©Ÿå»¶é² (Random Jitter)
            // å»¶é² 100ms ~ 1500ms å¾Œå†ç™¼é€è«‹æ±‚
            const delay = Math.floor(Math.random() * 1400) + 100;
            console.log(`[ç³»çµ±] å¸‚é›†é€£ç·šå»¶é²: ${delay}ms`);
            
            setTimeout(() => {
                socket.emit('joinGame', myToken);
                socket.emit('getMarket');
            }, delay);
        });

        socket.on('playerStatsUpdate', (p) => {
            document.getElementById('my-gold').innerText = p.gold;
            myInventory = p.inventory;
        });

        socket.on('marketUpdate', (listings) => {
            allListings = listings; 
            applyFilter(); 
        });

        function applyFilter() {
            const filterType = document.getElementById('category-filter').value;
            const list = document.getElementById('market-list');
            list.innerHTML = '';

            const filtered = allListings.filter(item => {
                const dbInfo = ITEM_DB[item.itemKey];
                const displayName = dbInfo ? dbInfo.name : (item.itemName || item.itemKey);

                if (!isNaN(displayName)) return false;

                if (filterType === 'all') return true;
                if (filterType === 'mine') return item.isMine;
                
                const dbItem = ITEM_DB[item.itemKey];
                if (!dbItem) return filterType === 'material';
                return dbItem.type === filterType;
            });

            if(filtered.length === 0) {
                list.innerHTML = '<div style="font-size:12px; color:#aaa; margin-top:20px; grid-column: span 2;">æ²’æœ‰å•†å“</div>';
                return;
            }

            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                
                const itemData = ITEM_DB[item.itemKey] || { name: item.itemName || item.itemKey, desc: "ææ–™" };

                const btnHtml = item.isMine 
                    ? `<button class="btn btn-cancel" onclick="triggerConfirm('cancel', '${item.id}', 'å–å›ï¼Ÿ')">å–å›</button>`
                    : `<button class="btn btn-buy" onclick="triggerConfirm('buy', '${item.id}', 'èŠ± ${item.price}G è³¼è²·ï¼Ÿ')">è³¼è²·</button>`;
                
                div.innerHTML = `
                    <h3>${itemData.name}</h3>
                    <div class="item-stats">${itemData.desc}</div>
                    <div class="item-info">è³£å®¶: ${item.seller.substr(0,4)}</div>
                    <div class="price-tag">${item.price} G</div>
                    ${btnHtml}
                `;
                list.appendChild(div);
            });
        }

        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        socket.on('marketResult', (res) => { 
            if(res.success) showMsg(res.msg); 
            else showMsg("âŒ " + res.msg);
            closePriceModal();
            closeInventoryModal();
        });
        
        socket.on('marketRefresh', () => { socket.emit('getMarket'); });

        function openInventoryModal() {
            const list = document.getElementById('sell-inventory-list');
            list.innerHTML = '';
            
            const keys = Object.keys(myInventory).filter(k => myInventory[k] > 0);
            
            if (keys.length === 0) {
                list.innerHTML = '<div style="padding:20px; color:#aaa; text-align:center;">èƒŒåŒ…æ˜¯ç©ºçš„ï¼Œç„¡ç‰©å¯è³£</div>';
            } else {
                keys.forEach(key => {
                    const itemData = ITEM_DB[key] || { name: key };
                    if (!isNaN(itemData.name)) return;

                    const div = document.createElement('div');
                    div.className = 'sell-list-item';
                    div.innerHTML = `
                        <div style="font-size:12px;">${itemData.name} x${myInventory[key]}</div>
                        <button class="btn btn-sell" style="font-size:10px;" onclick="openPriceModal('${key}', '${itemData.name}')">è³£å‡º</button>
                    `;
                    list.appendChild(div);
                });
            }
            
            document.getElementById('inventory-modal').style.display = 'flex';
        }
        function closeInventoryModal() { document.getElementById('inventory-modal').style.display = 'none'; }

        function openPriceModal(key, name) {
            currentSellId = key;
            document.getElementById('modal-item-name').innerText = `è³£å‡º: ${name}`;
            document.getElementById('sell-price').value = '';
            document.getElementById('sell-price-modal').style.display = 'flex';
            document.getElementById('inventory-modal').style.display = 'none'; 
        }
        function closePriceModal() { document.getElementById('sell-price-modal').style.display = 'none'; }
        
        function confirmSell() {
            const price = document.getElementById('sell-price').value;
            if(!price || price <= 0) { showMsg("è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼"); return; }
            socket.emit('marketSell', { itemId: currentSellId, price: price });
        }

        function triggerConfirm(action, id, message) {
            pendingAction = action;
            pendingId = id;
            document.getElementById('confirm-msg').innerText = message;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function doConfirmAction() {
            if (pendingAction === 'cancel') {
                socket.emit('marketCancel', pendingId);
            } else if (pendingAction === 'buy') {
                socket.emit('marketBuy', pendingId);
            }
            closeConfirmModal();
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingAction = null;
            pendingId = null;
        }

    </script>
</body>
</html>
