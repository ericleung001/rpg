<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>市集</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; 
            padding: 15px; 
            display:flex; flex-direction:column; align-items:center; 
            height: 100dvh; margin:0; box-sizing:border-box;
            overscroll-behavior: none;
        }
        
        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 20px; margin: 0; }

        .container { 
            display: flex; flex: 1; 
            width: 100%; max-width: 600px; 
            gap: 15px; overflow: hidden; 
            margin-bottom: 15px; 
        }
        
        .market-list { flex: 1.5; background: #34495e; border: 3px solid #bdc3c7; overflow-y: auto; padding: 10px; border-radius: 8px; }
        .my-bag { flex: 1; background: #2c3e50; border: 3px solid #7f8c8d; overflow-y: auto; padding: 10px; border-radius: 8px; }

        .item-card { 
            background: #ecf0f1; color: #2c3e50; 
            padding: 12px; margin-bottom: 10px; 
            border-radius: 6px; text-align: left; 
            position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .item-card h3 { font-size: 12px; margin: 0 0 5px 0; color: #2980b9; }
        .item-info { font-size: 10px; color: #555; }
        .price-tag { color: #c0392b; font-weight: bold; margin-top: 5px; font-size: 12px; }
        
        .btn { 
            padding: 10px; font-family: inherit; font-size: 12px; cursor: pointer; 
            border: 2px solid #333; color: white; margin-top: 8px; width: 100%; 
            border-radius: 4px; font-weight: bold;
        }
        .btn-buy { background: #27ae60; border-color: #2ecc71; }
        .btn-sell { background: #e67e22; border-color: #d35400; }
        .btn-cancel { background: #c0392b; border-color: #e74c3c; } 
        .btn:active { filter: brightness(0.8); transform: translateY(2px); }
        
        /* === 彈窗通用樣式 === */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; 
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { 
            background: #fff; color: #000; 
            padding: 25px; border: 6px solid #f1c40f; 
            width: 80%; max-width: 300px; border-radius: 12px;
        }
        input { 
            width: 100%; padding: 15px; margin: 15px 0; 
            font-family: inherit; font-size: 16px; 
            box-sizing: border-box; border: 2px solid #ccc;
        }

        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
        }

        /* === Toast 通知樣式 === */
        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f;
            color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999;
            font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-toast"></div>

    <div class="header">
        <h1>⚖️ 市集</h1>
        <div class="gold-display"> <span id="my-gold">0</span> G</div>
    </div>

    <div class="container">
        <div class="market-list" id="market-list">
            <div style="font-size:12px; color:#aaa; margin-top:20px;">載入中...</div>
        </div>

        <div class="my-bag">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;">-- 背包 --</div>
            <div id="inventory-list"></div>
        </div>
    </div>

    <a href="hub.html" class="back-btn">◀ 返回大廳</a>

    <div id="sell-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-item-name" style="font-size:16px; margin-bottom:10px;">上架物品</h3>
            <input type="number" id="sell-price" placeholder="輸入價格 (G)">
            <button class="btn btn-sell" style="font-size:14px; padding:15px;" onclick="confirmSell()">確認上架</button>
            <button class="btn" style="background:#555; margin-top:10px; font-size:14px; padding:15px;" onclick="closeSellModal()">取消</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:15px; color:#e74c3c;">⚠️ 確認操作</h3>
            <div id="confirm-msg" style="font-size:12px; color:#555; margin-bottom:20px; line-height:1.5;">確定要取回這個物品嗎？</div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="background:#e74c3c; margin-top:0;" onclick="doConfirmAction()">確定</button>
                <button class="btn" style="background:#7f8c8d; margin-top:0;" onclick="closeConfirmModal()">取消</button>
            </div>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
        // 這是加密後的網址 (一般人看不懂這是什麼)
        const _0x5a1b = "aHR0cHM6Ly9tbW8udHRjdHYtMTA1LmNj"; 

        // atob() 函數會把亂碼解開成原本的網址
        const BACKEND_URL = atob(_0x5a1b); 
        
        const socket = io(BACKEND_URL, {
            transports: ['websocket', 'polling']
        });
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        //  完整物品名稱翻譯表 (包含材料、裝備、藥水)
        const ITEM_NAMES = {
            // === 1. 材料 (Materials) ===
            'copper_ore': '銅礦石', 'soft_fur': '柔軟皮毛', 'beast_fang': '野獸尖牙', 'slime_gel': '黏液',
            'iron_ore': '鐵礦石', 'leather': '皮革', 'tough_hide': '硬皮革', 'magic_dust': '魔粉',
            'poison_sac': '毒囊', 'bone_shard': '碎骨片',
            'silver_ore': '銀礦石', 'fire_core': '火焰核心', 'lava_rock': '熔岩石', 'dragon_scale': '龍鱗',
            'gold_ore': '金礦石', 'ice_crystal': '永恆冰晶', 'yeti_fur': '雪怪毛皮', 'spirit_dust': '靈魂粉末',
            'mithril': '秘銀', 'void_dust': '虛空之塵', 'demon_horn': '惡魔之角', 'dark_essence': '暗之精華',
            'adamantite': '精金', 'god_blood': '神之血', 'chaos_orb': '混沌寶珠', 'angel_feather': '天使之羽',

            // === 2. 消耗品 (Potions) ===
            'potion_hp': '小紅藥水', 'potion_mid': '中紅藥水', 'potion_high': '大紅藥水',
            'potion_max': '特級秘藥', 'elixir': '神之甘露',

            // === 3. 武器 (Weapons) ===
            'wood_sword': '木劍', 'copper_dagger': '銅匕首',
            'iron_sword': '鐵劍', 'spike_club': '狼牙棒', 'poison_dag': '劇毒匕首',
            'silver_blade': '銀刃', 'flame_staff': '火焰法杖',
            'gold_axe': '黃金巨斧', 'frost_bow': '寒冰弓',
            'mithril_saber': '秘銀軍刀', 'void_reaper': '虛空收割者',
            'god_slayer': '弒神劍', 'chaos_staff': '混沌法杖',
            'hero_sword': '勇者之劍', 'steel_blade': '精鋼劍', 'assassin_dag': '刺客短刀',

            // === 4. 防具 (Armor) ===
            'cloth_armor': '布衣', 'hunt_vest': '獵人背心',
            'leather_armor': '皮甲', 'snake_boots': '蛇皮長靴',
            'chain_mail': '鎖子甲', 'magma_plate': '熔岩胸甲',
            'ice_robe': '冰霜法袍', 'yeti_cloak': '雪怪斗篷',
            'demon_armor': '惡魔戰甲',
            'angel_armor': '熾天使鎧甲', 'plate_mail': '板金甲', 'dragon_mail': '龍鱗甲',

            // === 5. 飾品 (Accessories) ===
            'bone_ring': '骨戒', 
            'ring_str': '力量戒指', 
            'amulet_soul': '靈魂護符', 
            'ring_lord': '領主指環', 
            'crown_chaos': '混沌之冠',
            'ring_life': '生命護符', 'ring_magic': '魔力耳環'
        };

        let currentSellId = null;
        let pendingAction = null; // 儲存待確認的動作
        let pendingId = null;     // 儲存待操作的 ID

        // 1. 初始化
        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
            socket.emit('getMarket');
        });

        // 2. 更新資料
        socket.on('playerStatsUpdate', (p) => {
            document.getElementById('my-gold').innerText = p.gold;
            renderInventory(p.inventory);
        });

        socket.on('marketUpdate', (listings) => {
            const list = document.getElementById('market-list');
            list.innerHTML = '';
            if(listings.length === 0) {
                list.innerHTML = '<div style="font-size:12px; color:#aaa; margin-top:20px;">暫無商品</div>';
                return;
            }

            listings.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                
                // 區分按鈕 (取回 vs 購買) - 都改用自訂彈窗
                const btnHtml = item.isMine 
                    ? `<button class="btn btn-cancel" onclick="triggerConfirm('cancel', '${item.id}', '確定要從市集取回嗎？')">取回物品</button>`
                    : `<button class="btn btn-buy" onclick="triggerConfirm('buy', '${item.id}', '確定要花 ${item.price} G 購買嗎？')">購買</button>`;
                
                div.innerHTML = `
                    <h3>${item.itemName}</h3>
                    <div class="item-info">賣家: ${item.seller}</div>
                    <div class="price-tag">${item.price} G</div>
                    ${btnHtml}
                `;
                list.appendChild(div);
            });
        });

        // 3. 通用訊息顯示 (取代 alert)
        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        socket.on('marketResult', (res) => { 
            if(res.success) showMsg(res.msg); 
            else showMsg("❌ " + res.msg);
            closeSellModal();
        });
        
        socket.on('marketRefresh', () => { socket.emit('getMarket'); });

        // 4. 背包渲染
        function renderInventory(inv) {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            Object.keys(inv).forEach(key => {
                if(inv[key] > 0) {
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.style.background = '#34495e';
                    div.style.color = '#fff';
                    div.style.border = '2px solid #555';
                    div.innerHTML = `
                        <div style="font-size:12px; font-weight:bold;">${ITEM_NAMES[key] || key} x${inv[key]}</div>
                        <button class="btn btn-sell" onclick="openSellModal('${key}', '${ITEM_NAMES[key]||key}')">上架</button>
                    `;
                    list.appendChild(div);
                }
            });
        }

        // === 上架視窗邏輯 ===
        function openSellModal(key, name) {
            currentSellId = key;
            document.getElementById('modal-item-name').innerText = `賣出: ${name}`;
            document.getElementById('sell-price').value = '';
            document.getElementById('sell-modal').style.display = 'flex';
        }
        function closeSellModal() { document.getElementById('sell-modal').style.display = 'none'; }
        
        function confirmSell() {
            const price = document.getElementById('sell-price').value;
            if(!price || price <= 0) { showMsg("請輸入有效價格"); return; }
            socket.emit('marketSell', { itemId: currentSellId, price: price });
        }

        // ===  統一確認彈窗邏輯 ===
        function triggerConfirm(action, id, message) {
            pendingAction = action;
            pendingId = id;
            document.getElementById('confirm-msg').innerText = message;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function doConfirmAction() {
            if (pendingAction === 'cancel') {
                socket.emit('marketCancel', pendingId);
            } else if (pendingAction === 'buy') {
                socket.emit('marketBuy', pendingId);
            }
            closeConfirmModal();
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingAction = null;
            pendingId = null;
        }

    </script>
</body>
</html>