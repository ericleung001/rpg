<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸‚é›†</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; 
            padding: 15px; 
            display:flex; flex-direction:column; align-items:center; 
            height: 100dvh; margin:0; box-sizing:border-box;
            overscroll-behavior: none;
        }
        
        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 20px; margin: 0; }

        .container { 
            display: flex; flex: 1; 
            width: 100%; max-width: 600px; 
            gap: 15px; overflow: hidden; 
            margin-bottom: 15px; 
        }
        
        .market-list { flex: 1.5; background: #34495e; border: 3px solid #bdc3c7; overflow-y: auto; padding: 10px; border-radius: 8px; }
        .my-bag { flex: 1; background: #2c3e50; border: 3px solid #7f8c8d; overflow-y: auto; padding: 10px; border-radius: 8px; }

        .item-card { 
            background: #ecf0f1; color: #2c3e50; 
            padding: 12px; margin-bottom: 10px; 
            border-radius: 6px; text-align: left; 
            position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .item-card h3 { font-size: 12px; margin: 0 0 5px 0; color: #2980b9; }
        .item-info { font-size: 10px; color: #555; }
        .price-tag { color: #c0392b; font-weight: bold; margin-top: 5px; font-size: 12px; }
        
        .btn { 
            padding: 10px; font-family: inherit; font-size: 12px; cursor: pointer; 
            border: 2px solid #333; color: white; margin-top: 8px; width: 100%; 
            border-radius: 4px; font-weight: bold;
        }
        .btn-buy { background: #27ae60; border-color: #2ecc71; }
        .btn-sell { background: #e67e22; border-color: #d35400; }
        .btn-cancel { background: #c0392b; border-color: #e74c3c; } 
        .btn:active { filter: brightness(0.8); transform: translateY(2px); }
        
        /* === å½ˆçª—é€šç”¨æ¨£å¼ === */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; 
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { 
            background: #fff; color: #000; 
            padding: 25px; border: 6px solid #f1c40f; 
            width: 80%; max-width: 300px; border-radius: 12px;
        }
        input { 
            width: 100%; padding: 15px; margin: 15px 0; 
            font-family: inherit; font-size: 16px; 
            box-sizing: border-box; border: 2px solid #ccc;
        }

        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
        }

        /* === Toast é€šçŸ¥æ¨£å¼ === */
        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f;
            color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999;
            font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-toast"></div>

    <div class="header">
        <h1>âš–ï¸ å¸‚é›†</h1>
        <div class="gold-display"> <span id="my-gold">0</span> G</div>
    </div>

    <div class="container">
        <div class="market-list" id="market-list">
            <div style="font-size:12px; color:#aaa; margin-top:20px;">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="my-bag">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;">-- èƒŒåŒ… --</div>
            <div id="inventory-list"></div>
        </div>
    </div>

    <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>

    <div id="sell-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-item-name" style="font-size:16px; margin-bottom:10px;">ä¸Šæ¶ç‰©å“</h3>
            <input type="number" id="sell-price" placeholder="è¼¸å…¥åƒ¹æ ¼ (G)">
            <button class="btn btn-sell" style="font-size:14px; padding:15px;" onclick="confirmSell()">ç¢ºèªä¸Šæ¶</button>
            <button class="btn" style="background:#555; margin-top:10px; font-size:14px; padding:15px;" onclick="closeSellModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:15px; color:#e74c3c;">âš ï¸ ç¢ºèªæ“ä½œ</h3>
            <div id="confirm-msg" style="font-size:12px; color:#555; margin-bottom:20px; line-height:1.5;">ç¢ºå®šè¦å–å›é€™å€‹ç‰©å“å—ï¼Ÿ</div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="background:#e74c3c; margin-top:0;" onclick="doConfirmAction()">ç¢ºå®š</button>
                <button class="btn" style="background:#7f8c8d; margin-top:0;" onclick="closeConfirmModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
        // é€™æ˜¯åŠ å¯†å¾Œçš„ç¶²å€ (ä¸€èˆ¬äººçœ‹ä¸æ‡‚é€™æ˜¯ä»€éº¼)
        const _0x5a1b = "aHR0cHM6Ly9tbW8udHRjdHYtMTA1LmNj"; 

        // atob() å‡½æ•¸æœƒæŠŠäº‚ç¢¼è§£é–‹æˆåŸæœ¬çš„ç¶²å€
        const BACKEND_URL = atob(_0x5a1b); 
        
        const socket = io(BACKEND_URL, {
            transports: ['websocket', 'polling']
        });
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        //  å®Œæ•´ç‰©å“åç¨±ç¿»è­¯è¡¨ (åŒ…å«ææ–™ã€è£å‚™ã€è—¥æ°´)
        const ITEM_NAMES = {
            // === 1. ææ–™ (Materials) ===
            'copper_ore': 'éŠ…ç¤¦çŸ³', 'soft_fur': 'æŸ”è»Ÿçš®æ¯›', 'beast_fang': 'é‡ç¸å°–ç‰™', 'slime_gel': 'é»æ¶²',
            'iron_ore': 'éµç¤¦çŸ³', 'leather': 'çš®é©', 'tough_hide': 'ç¡¬çš®é©', 'magic_dust': 'é­”ç²‰',
            'poison_sac': 'æ¯’å›Š', 'bone_shard': 'ç¢éª¨ç‰‡',
            'silver_ore': 'éŠ€ç¤¦çŸ³', 'fire_core': 'ç«ç„°æ ¸å¿ƒ', 'lava_rock': 'ç†”å²©çŸ³', 'dragon_scale': 'é¾é±—',
            'gold_ore': 'é‡‘ç¤¦çŸ³', 'ice_crystal': 'æ°¸æ†å†°æ™¶', 'yeti_fur': 'é›ªæ€ªæ¯›çš®', 'spirit_dust': 'éˆé­‚ç²‰æœ«',
            'mithril': 'ç§˜éŠ€', 'void_dust': 'è™›ç©ºä¹‹å¡µ', 'demon_horn': 'æƒ¡é­”ä¹‹è§’', 'dark_essence': 'æš—ä¹‹ç²¾è¯',
            'adamantite': 'ç²¾é‡‘', 'god_blood': 'ç¥ä¹‹è¡€', 'chaos_orb': 'æ··æ²Œå¯¶ç ', 'angel_feather': 'å¤©ä½¿ä¹‹ç¾½',

            // === 2. æ¶ˆè€—å“ (ğŸŸ¢ é€™è£¡åŠ å…¥äº†è—è—¥æ°´) ===
            'potion_hp': 'å°ç´…è—¥æ°´', 'potion_mid': 'ä¸­ç´…è—¥æ°´', 'potion_high': 'å¤§ç´…è—¥æ°´',
            'potion_max': 'ç‰¹ç´šç§˜è—¥', 'elixir': 'ç¥ä¹‹ç”˜éœ²',
            'potion_mp': 'å°è—è—¥æ°´', 'potion_mp_mid': 'ä¸­è—è—¥æ°´', 'potion_mp_high': 'å¤§è—è—¥æ°´',

            // === 3. æ­¦å™¨ (Weapons) ===
            'wood_sword': 'æœ¨åŠ', 'copper_dagger': 'éŠ…åŒ•é¦–',
            'iron_sword': 'éµåŠ', 'spike_club': 'ç‹¼ç‰™æ£’', 'poison_dag': 'åŠ‡æ¯’åŒ•é¦–',
            'silver_blade': 'éŠ€åˆƒ', 'flame_staff': 'ç«ç„°æ³•æ–',
            'gold_axe': 'é»ƒé‡‘å·¨æ–§', 'frost_bow': 'å¯’å†°å¼“',
            'mithril_saber': 'ç§˜éŠ€è»åˆ€', 'void_reaper': 'è™›ç©ºæ”¶å‰²è€…',
            'god_slayer': 'å¼’ç¥åŠ', 'chaos_staff': 'æ··æ²Œæ³•æ–',
            'hero_sword': 'å‹‡è€…ä¹‹åŠ', 'steel_blade': 'ç²¾é‹¼åŠ', 'assassin_dag': 'åˆºå®¢çŸ­åˆ€',

            // === 4. é˜²å…· (Armor) ===
            'cloth_armor': 'å¸ƒè¡£', 'hunt_vest': 'çµäººèƒŒå¿ƒ',
            'leather_armor': 'çš®ç”²', 'snake_boots': 'è›‡çš®é•·é´',
            'chain_mail': 'é–å­ç”²', 'magma_plate': 'ç†”å²©èƒ¸ç”²',
            'ice_robe': 'å†°éœœæ³•è¢', 'yeti_cloak': 'é›ªæ€ªæ–—ç¯·',
            'demon_armor': 'æƒ¡é­”æˆ°ç”²',
            'angel_armor': 'ç†¾å¤©ä½¿é§ç”²', 'plate_mail': 'æ¿é‡‘ç”²', 'dragon_mail': 'é¾é±—ç”²',

            // === 5. é£¾å“ (Accessories) ===
            'bone_ring': 'éª¨æˆ’', 
            'ring_str': 'åŠ›é‡æˆ’æŒ‡', 
            'amulet_soul': 'éˆé­‚è­·ç¬¦', 
            'ring_lord': 'é ˜ä¸»æŒ‡ç’°', 
            'crown_chaos': 'æ··æ²Œä¹‹å† ',
            'ring_life': 'ç”Ÿå‘½è­·ç¬¦', 'ring_magic': 'é­”åŠ›è€³ç’°'
        };

        let currentSellId = null;
        let pendingAction = null; // å„²å­˜å¾…ç¢ºèªçš„å‹•ä½œ
        let pendingId = null;     // å„²å­˜å¾…æ“ä½œçš„ ID

        // 1. åˆå§‹åŒ–
        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
            socket.emit('getMarket');
        });

        // 2. æ›´æ–°è³‡æ–™
        socket.on('playerStatsUpdate', (p) => {
            document.getElementById('my-gold').innerText = p.gold;
            renderInventory(p.inventory);
        });

        socket.on('marketUpdate', (listings) => {
            const list = document.getElementById('market-list');
            list.innerHTML = '';
            if(listings.length === 0) {
                list.innerHTML = '<div style="font-size:12px; color:#aaa; margin-top:20px;">æš«ç„¡å•†å“</div>';
                return;
            }

            listings.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                
                // å€åˆ†æŒ‰éˆ• (å–å› vs è³¼è²·) - éƒ½æ”¹ç”¨è‡ªè¨‚å½ˆçª—
                const btnHtml = item.isMine 
                    ? `<button class="btn btn-cancel" onclick="triggerConfirm('cancel', '${item.id}', 'ç¢ºå®šè¦å¾å¸‚é›†å–å›å—ï¼Ÿ')">å–å›ç‰©å“</button>`
                    : `<button class="btn btn-buy" onclick="triggerConfirm('buy', '${item.id}', 'ç¢ºå®šè¦èŠ± ${item.price} G è³¼è²·å—ï¼Ÿ')">è³¼è²·</button>`;
                
                div.innerHTML = `
                    <h3>${item.itemName}</h3>
                    <div class="item-info">è³£å®¶: ${item.seller}</div>
                    <div class="price-tag">${item.price} G</div>
                    ${btnHtml}
                `;
                list.appendChild(div);
            });
        });

        // 3. é€šç”¨è¨Šæ¯é¡¯ç¤º (å–ä»£ alert)
        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        socket.on('marketResult', (res) => { 
            if(res.success) showMsg(res.msg); 
            else showMsg("âŒ " + res.msg);
            closeSellModal();
        });
        
        socket.on('marketRefresh', () => { socket.emit('getMarket'); });

        // 4. èƒŒåŒ…æ¸²æŸ“
        function renderInventory(inv) {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            Object.keys(inv).forEach(key => {
                if(inv[key] > 0) {
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.style.background = '#34495e';
                    div.style.color = '#fff';
                    div.style.border = '2px solid #555';
                    div.innerHTML = `
                        <div style="font-size:12px; font-weight:bold;">${ITEM_NAMES[key] || key} x${inv[key]}</div>
                        <button class="btn btn-sell" onclick="openSellModal('${key}', '${ITEM_NAMES[key]||key}')">ä¸Šæ¶</button>
                    `;
                    list.appendChild(div);
                }
            });
        }

        // === ä¸Šæ¶è¦–çª—é‚è¼¯ ===
        function openSellModal(key, name) {
            currentSellId = key;
            document.getElementById('modal-item-name').innerText = `è³£å‡º: ${name}`;
            document.getElementById('sell-price').value = '';
            document.getElementById('sell-modal').style.display = 'flex';
        }
        function closeSellModal() { document.getElementById('sell-modal').style.display = 'none'; }
        
        function confirmSell() {
            const price = document.getElementById('sell-price').value;
            if(!price || price <= 0) { showMsg("è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼"); return; }
            socket.emit('marketSell', { itemId: currentSellId, price: price });
        }

        // ===  çµ±ä¸€ç¢ºèªå½ˆçª—é‚è¼¯ ===
        function triggerConfirm(action, id, message) {
            pendingAction = action;
            pendingId = id;
            document.getElementById('confirm-msg').innerText = message;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function doConfirmAction() {
            if (pendingAction === 'cancel') {
                socket.emit('marketCancel', pendingId);
            } else if (pendingAction === 'buy') {
                socket.emit('marketBuy', pendingId);
            }
            closeConfirmModal();
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingAction = null;
            pendingId = null;
        }

    </script>
</body>
</html>
