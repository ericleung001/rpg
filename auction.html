<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¸‚é›†</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; 
            padding: 15px; 
            display:flex; flex-direction:column; align-items:center; 
            height: 100dvh; margin:0; box-sizing:border-box;
            overscroll-behavior: none;
        }
        
        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 20px; margin: 0; }

        .container { 
            display: flex; flex: 1; 
            width: 100%; max-width: 600px; 
            gap: 15px; overflow: hidden; 
            margin-bottom: 15px; 
        }
        
        .market-list { flex: 1.5; background: #34495e; border: 3px solid #bdc3c7; overflow-y: auto; padding: 10px; border-radius: 8px; }
        .my-bag { flex: 1; background: #2c3e50; border: 3px solid #7f8c8d; overflow-y: auto; padding: 10px; border-radius: 8px; }

        .item-card { 
            background: #ecf0f1; color: #2c3e50; 
            padding: 12px; margin-bottom: 10px; 
            border-radius: 6px; text-align: left; 
            position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .item-card h3 { font-size: 12px; margin: 0 0 5px 0; color: #2980b9; }
        .item-info { font-size: 10px; color: #555; }
        
        /* ğŸŸ¢ å±¬æ€§é¡¯ç¤ºæ¨£å¼ */
        .item-stats { 
            font-size: 9px; color: #e67e22; 
            background: rgba(0,0,0,0.05); padding: 4px; 
            border-radius: 4px; margin-top: 5px; 
            line-height: 1.4;
        }

        .price-tag { color: #c0392b; font-weight: bold; margin-top: 5px; font-size: 12px; }
        
        .btn { 
            padding: 10px; font-family: inherit; font-size: 12px; cursor: pointer; 
            border: 2px solid #333; color: white; margin-top: 8px; width: 100%; 
            border-radius: 4px; font-weight: bold;
        }
        .btn-buy { background: #27ae60; border-color: #2ecc71; }
        .btn-sell { background: #e67e22; border-color: #d35400; }
        .btn-cancel { background: #c0392b; border-color: #e74c3c; } 
        .btn:active { filter: brightness(0.8); transform: translateY(2px); }
        
        /* === å½ˆçª—é€šç”¨æ¨£å¼ === */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; 
            flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .modal-box { 
            background: #fff; color: #000; 
            padding: 25px; border: 6px solid #f1c40f; 
            width: 80%; max-width: 300px; border-radius: 12px;
        }
        input { 
            width: 100%; padding: 15px; margin: 15px 0; 
            font-family: inherit; font-size: 16px; 
            box-sizing: border-box; border: 2px solid #ccc;
        }

        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
        }

        /* === Toast é€šçŸ¥æ¨£å¼ === */
        #game-toast {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f;
            color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999;
            font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-toast"></div>

    <div class="header">
        <h1>âš–ï¸ å¸‚é›†</h1>
        <div class="gold-display">ğŸ’° <span id="my-gold">0</span> G</div>
    </div>

    <div class="container">
        <div class="market-list" id="market-list">
            <div style="font-size:12px; color:#aaa; margin-top:20px;">è¼‰å…¥ä¸­...</div>
        </div>

        <div class="my-bag">
            <div style="font-size:12px; color:#aaa; margin-bottom:10px;">-- èƒŒåŒ… --</div>
            <div id="inventory-list"></div>
        </div>
    </div>

    <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>

    <div id="sell-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-item-name" style="font-size:16px; margin-bottom:10px;">ä¸Šæ¶ç‰©å“</h3>
            <input type="number" id="sell-price" placeholder="è¼¸å…¥åƒ¹æ ¼ (G)">
            <button class="btn btn-sell" style="font-size:14px; padding:15px;" onclick="confirmSell()">ç¢ºèªä¸Šæ¶</button>
            <button class="btn" style="background:#555; margin-top:10px; font-size:14px; padding:15px;" onclick="closeSellModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:15px; color:#e74c3c;">âš ï¸ ç¢ºèªæ“ä½œ</h3>
            <div id="confirm-msg" style="font-size:12px; color:#555; margin-bottom:20px; line-height:1.5;">ç¢ºå®šè¦å–å›é€™å€‹ç‰©å“å—ï¼Ÿ</div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn" style="background:#e74c3c; margin-top:0;" onclick="doConfirmAction()">ç¢ºå®š</button>
                <button class="btn" style="background:#7f8c8d; margin-top:0;" onclick="closeConfirmModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="socket.io.js"></script>
    <script>
        const _0x5a1b = "aHR0cHM6Ly9tbW8udHRjdHYtMTA1LmNj"; 
        const BACKEND_URL = atob(_0x5a1b);
        
        const socket = io(BACKEND_URL, {
            transports: ['websocket', 'polling']
        });
        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        // ğŸŸ¢ ç‰©å“è©³ç´°è³‡æ–™åº« (åŒ…å«åç¨±èˆ‡å±¬æ€§æè¿°)
        const ITEM_DB = {
            // === æ¶ˆè€—å“ & æ–™ç† ===
            'potion_hp':    { name: "å°ç´…è—¥æ°´", desc: "æ¢å¾© 50 HP" },
            'potion_mid':   { name: "ä¸­ç´…è—¥æ°´", desc: "æ¢å¾© 500 HP" },
            'potion_high':  { name: "å¤§ç´…è—¥æ°´", desc: "æ¢å¾© 2000 HP" },
            'potion_max':   { name: "ç‰¹ç´šç§˜è—¥", desc: "æ¢å¾© 10000 HP" },
            'elixir':       { name: "ç¥ä¹‹ç”˜éœ²", desc: "æ¢å¾© 50000 HP" },
            'potion_mp':    { name: "å°è—è—¥æ°´", desc: "æ¢å¾© 30 MP" },
            'potion_mp_mid':{ name: "ä¸­è—è—¥æ°´", desc: "æ¢å¾© 100 MP" },
            'potion_mp_high':{ name: "å¤§è—è—¥æ°´", desc: "æ¢å¾© 500 MP" },
            'grilled_carp': { name: "çƒ¤é¯‰é­š", desc: "é£Ÿç”¨: HP+100" },
            'salmon_sushi': { name: "é®­é­šå£½å¸", desc: "é£Ÿç”¨: MP+50" },
            'tuna_steak':   { name: "ç…é®ªé­šæ’", desc: "é£Ÿç”¨: HP+500" },
            'eel_rice':     { name: "é°»é­šé£¯", desc: "é£Ÿç”¨: HP+300, MP+100" },
            'void_soup':    { name: "è™›ç©ºæµ·é®®æ¹¯", desc: "é£Ÿç”¨: ç‹€æ…‹å…¨æ»¿" },
            'sushi_plate':  { name: "å£½å¸æ‹¼ç›¤", desc: "é£Ÿç”¨: HP+500" },

            // === æ­¦å™¨ ===
            'wood_sword':   { name: "æœ¨åŠ", desc: "ATK +10" },
            'copper_dagger':{ name: "éŠ…åŒ•é¦–", desc: "ATK +15" },
            'iron_sword':   { name: "éµåŠ", desc: "ATK +30" },
            'spike_club':   { name: "ç‹¼ç‰™æ£’", desc: "ATK +55" },
            'poison_dag':   { name: "åŠ‡æ¯’åŒ•é¦–", desc: "ATK +60 (å¸¶æ¯’)" },
            'silver_blade': { name: "éŠ€åˆƒ", desc: "ATK +150 (å°ä¸æ­»ç³»å¼·)" },
            'flame_staff':  { name: "ç«ç„°æ³•æ–", desc: "ATK +200 (ç«å±¬æ€§)" },
            'gold_axe':     { name: "é»ƒé‡‘å·¨æ–§", desc: "ATK +500" },
            'frost_bow':    { name: "å¯’å†°å¼“", desc: "ATK +650 (å†°å±¬æ€§)" },
            'mithril_saber':{ name: "ç§˜éŠ€è»åˆ€", desc: "ATK +2000" },
            'void_reaper':  { name: "è™›ç©ºæ”¶å‰²è€…", desc: "ATK +3500" },
            'god_slayer':   { name: "å¼’ç¥åŠ", desc: "ATK +20000 (ç¥å™¨)" },
            'chaos_staff':  { name: "æ··æ²Œæ³•æ–", desc: "ATK +25000 (å‚³èªª)" },
            'hero_sword':   { name: "å‹‡è€…ä¹‹åŠ", desc: "ATK +50" },
            'steel_blade':  { name: "ç²¾é‹¼åŠ", desc: "ATK +25" },
            'assassin_dag': { name: "åˆºå®¢çŸ­åˆ€", desc: "ATK +120" },
            'oak_bow':      { name: "æ©¡æœ¨å¼“", desc: "ATK +25" },
            'maple_staff':  { name: "æ¥“æœ¨æ³•æ–", desc: "ATK +50" },
            'shark_tooth':  { name: "é¯Šé­šç‰™åŒ•é¦–", desc: "ATK +80" },
            'emerald_staff':{ name: "ç¿¡ç¿ æ³•æ–", desc: "ATK +300" },
            'obsidian_blade':{ name: "é»‘æ›œçŸ³ä¹‹åŠ", desc: "ATK +600" },
            'dragon_spear': { name: "é¾éª¨é•·æ§", desc: "ATK +1200" },

            // === é˜²å…· ===
            'cloth_armor':  { name: "å¸ƒè¡£", desc: "DEF +5" },
            'hunt_vest':    { name: "çµäººèƒŒå¿ƒ", desc: "DEF +8" },
            'leather_armor':{ name: "çš®ç”²", desc: "DEF +15" },
            'chain_mail':   { name: "é–å­ç”²", desc: "DEF +40" },
            'magma_plate':  { name: "ç†”å²©èƒ¸ç”²", desc: "DEF +100" },
            'ice_robe':     { name: "å†°éœœæ³•è¢", desc: "DEF +200" },
            'yeti_cloak':   { name: "é›ªæ€ªæ–—ç¯·", desc: "DEF +250" },
            'demon_armor':  { name: "æƒ¡é­”æˆ°ç”²", desc: "DEF +1000" },
            'angel_armor':  { name: "ç†¾å¤©ä½¿é§ç”²", desc: "DEF +5000" },
            'plate_mail':   { name: "æ¿é‡‘ç”²", desc: "DEF +15" },
            'dragon_mail':  { name: "é¾é±—ç”²", desc: "DEF +30" },

            // === é£¾å“ ===
            'bone_ring':    { name: "éª¨æˆ’", desc: "ATK +2" },
            'ring_str':     { name: "åŠ›é‡æˆ’æŒ‡", desc: "ATK +10" },
            'snake_boots':  { name: "è›‡çš®é•·é´", desc: "DEF +10" },
            'amulet_soul':  { name: "éˆé­‚è­·ç¬¦", desc: "MP +300" },
            'ring_lord':    { name: "é ˜ä¸»æŒ‡ç’°", desc: "å…¨èƒ½åŠ› +500" },
            'crown_chaos':  { name: "æ··æ²Œä¹‹å† ", desc: "å…¨èƒ½åŠ› +2000" },
            'ring_life':    { name: "ç”Ÿå‘½è­·ç¬¦", desc: "HP +100" },
            'ring_magic':   { name: "é­”åŠ›è€³ç’°", desc: "MP +50" },
            'fish_ring':    { name: "é­šé±—æˆ’æŒ‡", desc: "DEF +8" },
            'pearl_necklace':{ name: "çç é …éŠ", desc: "MP +100, DEF +20" },

            // === ææ–™ (é¡¯ç¤ºç‚ºææ–™å³å¯) ===
            'default':      { name: "æœªçŸ¥ç‰©å“", desc: "è£½ä½œ/åˆæˆææ–™" }
        };

        let currentSellId = null;
        let pendingAction = null; 
        let pendingId = null;     

        // 1. åˆå§‹åŒ–
        socket.on('connect', () => {
            socket.emit('joinGame', myToken);
            socket.emit('getMarket');
        });

        // 2. æ›´æ–°è³‡æ–™
        socket.on('playerStatsUpdate', (p) => {
            document.getElementById('my-gold').innerText = p.gold;
            renderInventory(p.inventory);
        });

        socket.on('marketUpdate', (listings) => {
            const list = document.getElementById('market-list');
            list.innerHTML = '';
            if(listings.length === 0) {
                list.innerHTML = '<div style="font-size:12px; color:#aaa; margin-top:20px;">æš«ç„¡å•†å“</div>';
                return;
            }

            listings.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                
                // å–å¾—ç‰©å“è³‡æ–™ï¼Œè‹¥ç„¡å‰‡ä½¿ç”¨é è¨­
                const itemData = ITEM_DB[item.itemKey] || { name: item.itemName || item.itemKey, desc: "ææ–™" };

                // å€åˆ†æŒ‰éˆ• (å–å› vs è³¼è²·)
                const btnHtml = item.isMine 
                    ? `<button class="btn btn-cancel" onclick="triggerConfirm('cancel', '${item.id}', 'ç¢ºå®šè¦å¾å¸‚é›†å–å›å—ï¼Ÿ')">å–å›ç‰©å“</button>`
                    : `<button class="btn btn-buy" onclick="triggerConfirm('buy', '${item.id}', 'ç¢ºå®šè¦èŠ± ${item.price} G è³¼è²·å—ï¼Ÿ')">è³¼è²·</button>`;
                
                // ğŸŸ¢ åœ¨åç¨±ä¸‹æ–¹åŠ å…¥å±¬æ€§æè¿°
                div.innerHTML = `
                    <h3>${itemData.name}</h3>
                    <div class="item-stats">${itemData.desc}</div>
                    <div class="item-info">è³£å®¶: ${item.seller}</div>
                    <div class="price-tag">${item.price} G</div>
                    ${btnHtml}
                `;
                list.appendChild(div);
            });
        });

        // 3. é€šç”¨è¨Šæ¯é¡¯ç¤º (å–ä»£ alert)
        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        socket.on('marketResult', (res) => { 
            if(res.success) showMsg(res.msg); 
            else showMsg("âŒ " + res.msg);
            closeSellModal();
        });
        
        socket.on('marketRefresh', () => { socket.emit('getMarket'); });

        // 4. èƒŒåŒ…æ¸²æŸ“
        function renderInventory(inv) {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            Object.keys(inv).forEach(key => {
                if(inv[key] > 0) {
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.style.background = '#34495e';
                    div.style.color = '#fff';
                    div.style.border = '2px solid #555';
                    
                    const itemData = ITEM_DB[key] || { name: key, desc: "ææ–™" };

                    div.innerHTML = `
                        <div style="font-size:12px; font-weight:bold;">${itemData.name} x${inv[key]}</div>
                        <div style="font-size:9px; color:#aaa; margin-bottom:5px;">${itemData.desc}</div>
                        <button class="btn btn-sell" onclick="openSellModal('${key}', '${itemData.name}')">ä¸Šæ¶</button>
                    `;
                    list.appendChild(div);
                }
            });
        }

        // === ä¸Šæ¶è¦–çª—é‚è¼¯ ===
        function openSellModal(key, name) {
            currentSellId = key;
            document.getElementById('modal-item-name').innerText = `è³£å‡º: ${name}`;
            document.getElementById('sell-price').value = '';
            document.getElementById('sell-modal').style.display = 'flex';
        }
        function closeSellModal() { document.getElementById('sell-modal').style.display = 'none'; }
        
        function confirmSell() {
            const price = document.getElementById('sell-price').value;
            if(!price || price <= 0) { showMsg("è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼"); return; }
            socket.emit('marketSell', { itemId: currentSellId, price: price });
        }

        // ===  çµ±ä¸€ç¢ºèªå½ˆçª—é‚è¼¯ ===
        function triggerConfirm(action, id, message) {
            pendingAction = action;
            pendingId = id;
            document.getElementById('confirm-msg').innerText = message;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function doConfirmAction() {
            if (pendingAction === 'cancel') {
                socket.emit('marketCancel', pendingId);
            } else if (pendingAction === 'buy') {
                socket.emit('marketBuy', pendingId);
            }
            closeConfirmModal();
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingAction = null;
            pendingId = null;
        }

    </script>
</body>
</html>
