<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¤æ˜“æ‰€</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body { 
            background-color: #2c3e50; color: #fff; 
            font-family: 'Press Start 2P', monospace; 
            text-align: center; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100dvh;
            overflow: scroll;
        }

        /* ä¸»å…§å®¹å€å¡Š */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 10px;
            padding-bottom: 40px; 
            align-items: center;
        }

        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; 
            z-index: 99999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #fff; border-top: 4px solid #f1c40f;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header { width: 100%; max-width: 600px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .gold-display { color: #f1c40f; font-size: 14px; font-weight: bold; }
        h1 { font-size: 18px; margin: 0; }

        /* åˆ†é¡é¸æ“‡åˆ— */
        .category-bar {
            width: 100%; max-width: 600px;
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; 
            margin-bottom: 15px;
        }
        .cat-btn {
            background: #34495e; color: #bdc3c7; border: 2px solid #7f8c8d;
            padding: 8px 2px; font-family: inherit; font-size: 9px; 
            border-radius: 6px; cursor: pointer; outline: none; white-space: nowrap;
        }
        .cat-btn.active { background: #f1c40f; color: #2c3e50; border-color: #fff; font-weight: bold; }
        .cat-btn:disabled { opacity: 0.5; cursor: default; }

        /* ç‰©å“é¸æ“‡å€ */
        #item-select-area { 
            display: none; width: 100%; max-width: 600px;
            background: #34495e; border: 2px solid #bdc3c7; border-radius: 8px;
            padding: 10px; box-sizing: border-box; margin-bottom: 15px;
            max-height: 200px; overflow-y: auto;
            grid-template-columns: repeat(2, 1fr); gap: 8px;
        }
        .item-btn { 
            background: #2c3e50; border: 1px solid #7f8c8d; color: #ecf0f1; 
            padding: 10px; font-size: 10px; cursor: pointer; text-align: left; 
            border-radius: 4px; 
        }
        .item-btn:hover { background: #95a5a6; color: #2c3e50; }

        /* æ›å–®åˆ—è¡¨å€ */
        #listings-area { 
            display: none; flex: 1; width: 100%; max-width: 600px;
            background: #fff; color: #000; border: 4px solid #f1c40f; 
            border-radius: 8px; padding: 5px; overflow-y: auto; 
            min-height: 200px; flex-direction: column;
        }
        .listing-header { 
            display: flex; font-size: 10px; font-weight: bold; 
            background: #eee; padding: 8px 5px; border-bottom: 2px solid #000; 
        }
        .listing-row { 
            display: flex; align-items: center; padding: 10px 5px; 
            border-bottom: 1px solid #ccc; font-size: 10px; 
        }
        .listing-row:nth-child(even) { background: #f9f9f9; }
        
        .col-name { flex: 2; text-align: left; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .col-price { flex: 1; text-align: right; color: #c0392b; font-weight: bold; }
        .col-seller { flex: 1; text-align: center; color: #7f8c8d; font-size: 8px; }
        .col-action { flex: 1; text-align: right; }

        .btn-buy { background: #27ae60; color: white; border: none; padding: 6px 10px; cursor: pointer; font-size: 10px; border-radius: 4px; }
        .btn-cancel { background: #c0392b; color: white; border: none; padding: 6px 10px; cursor: pointer; font-size: 10px; border-radius: 4px; }

        .back-btn { 
            background: #7f8c8d; color: white; padding: 15px; 
            text-decoration: none; font-size: 14px; 
            border: 3px solid #fff; display: block; 
            width: 100%; max-width: 600px; box-sizing: border-box; border-radius: 8px;
            margin-top: 10px;
        }

        #status-msg { font-size: 12px; color: #aaa; margin: 10px 0; }

        /* å½ˆå‡ºè¦–çª—æ¨£å¼ */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); display: none; 
            flex-direction: column; justify-content: center; align-items: center; z-index: 200;
        }
        .modal-box { 
            background: #fff; color: #000; 
            padding: 20px; border: 6px solid #f1c40f; 
            width: 85%; max-width: 320px; border-radius: 12px; 
            max-height: 80vh; overflow-y: auto; 
        }
        input { 
            width: 100%; padding: 12px; margin: 10px 0; 
            font-family: inherit; font-size: 16px; 
            box-sizing: border-box; border: 2px solid #ccc;
        }
        .btn { padding: 10px; border-radius: 6px; border:none; color:white; font-family:inherit; cursor:pointer; font-size:12px; width:100%; }
        .sell-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid #eee; }
        .sell-list-item button { width: auto; margin: 0; padding: 8px 12px; font-size: 10px; background: #e67e22;}

        #game-toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.95); border: 2px solid #f1c40f; color: #fff; padding: 15px 30px; border-radius: 30px; z-index: 9999; font-size: 14px; font-weight: bold; transition: top 0.5s ease-in-out; pointer-events: none; }
        
        .btn-sell-trigger {
            width: 100%; max-width: 600px; margin-bottom: 10px;
            background: #e67e22; color: white; border: 2px solid #d35400;
            border-radius: 6px; cursor: pointer; font-family: inherit;
            font-size: 12px; font-weight: bold; padding: 10px;
        }

        /* èŠå¤©å®¤æ¨£å¼ */
        #chat-container {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(0, 0, 0, 0.95); border-top: 4px solid #bdc3c7;
            display: flex; flex-direction: column; font-size: 10px; z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
            transition: height 0.3s ease-in-out;
            height: 30px; 
        }
        #chat-header {
            height: 30px; background: #34495e; color: #fff; line-height: 30px; 
            cursor: pointer; font-weight: bold; border-bottom: 1px solid #555;
            display: flex; justify-content: center; align-items: center;
            touch-action: manipulation;
            flex-shrink: 0; 
        }
        #chat-header:hover { background: #2c3e50; }
        .chat-open { height: 40vh !important; }
        #chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .chat-open #chat-body { display: flex; } 
        #chat-history { flex: 1; overflow-y: auto; padding: 8px; text-align: left; color: white; }
        #chat-input-area { display: flex; border-top: 1px solid #555; height: 40px; flex-shrink: 0; }
        #chat-input { flex: 1; background: #222; color: white; border: none; padding: 0 10px; font-family: inherit; font-size: 12px; outline: none; }
        #chat-send { background: #2980b9; color: white; border: none; padding: 0 15px; cursor: pointer; font-family: inherit; font-size: 12px; font-weight: bold; touch-action: manipulation; }

        @media (min-width: 1024px) {
            body { flex-direction: row; justify-content: center; background-color: #222; }
            #app-layout { display: flex; width: 1000px; background-color: #2c3e50; box-shadow: 0 0 20px rgba(0,0,0,0.5); height: 100%; }
            #main-content { width: 600px; border-right: 4px solid #bdc3c7; padding-bottom: 10px; }
            #chat-container { position: static; width: 400px; height: 100% !important; border-top: none; background: #34495e; }
            #chat-header { cursor: default; background: #2c3e50; }
            #chat-header:active { pointer-events: none; }
            #chat-body { display: flex !important; height: calc(100% - 30px); }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-size:12px; margin-top:10px;">é€£æ¥äº¤æ˜“æ‰€...</div>
    </div>

    <div id="game-toast"></div>

    <div id="app-layout">
        <div id="main-content">
            <div class="header">
                <h1>âš–ï¸ è‡ªç”±å¸‚å ´</h1>
                <div class="gold-display">ğŸ’° <span id="my-gold">0</span> G</div>
            </div>

            <button class="btn-sell-trigger" onclick="openInventoryModal()">+ ä¸Šæ¶ç‰©å“</button>

            <div class="category-bar">
                <button class="cat-btn" onclick="selectCategory('weapon')">âš”ï¸æ­¦å™¨</button>
                <button class="cat-btn" onclick="selectCategory('armor')">ğŸ›¡ï¸é˜²å…·/é£¾å“</button>
                <button class="cat-btn" onclick="selectCategory('consumable')">ğŸ§ªæ¶ˆè€—</button>
                <button class="cat-btn" onclick="selectCategory('material')">ğŸªµææ–™</button>
                <button class="cat-btn" onclick="selectCategory('card')">ğŸƒå¡ç‰‡</button>
                <button class="cat-btn" onclick="selectCategory('mine')">ğŸ“¦æˆ‘çš„</button>
            </div>

            <div id="status-msg">è«‹é¸æ“‡ä¸Šæ–¹åˆ†é¡</div>
            <div id="item-select-area"></div>

            <div id="listings-area">
                <div class="listing-header">
                    <div class="col-name">ç‰©å“</div>
                    <div class="col-price">åƒ¹æ ¼</div>
                    <div class="col-seller">è³£å®¶</div>
                    <div class="col-action">æ“ä½œ</div>
                </div>
                <div id="listings-list"></div>
            </div>

            <a href="hub.html" class="back-btn">â—€ è¿”å›å¤§å»³</a>
        </div>

        <div id="chat-container">
            <div id="chat-header" onclick="toggleChat()"> å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)</div>
            <div id="chat-body">
                <div id="chat-history"></div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯..." maxlength="50">
                    <button id="chat-send">ç™¼é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="inventory-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:15px;">é¸æ“‡è¦è³£çš„ç‰©å“</h3>
            <div id="sell-inventory-list" style="text-align:left;"></div>
            <button class="btn" style="background:#7f8c8d; margin-top:15px;" onclick="closeInventoryModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="sell-price-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-item-name" style="font-size:16px; margin-bottom:10px;">ä¸Šæ¶ç‰©å“</h3>
            <input type="number" id="sell-price" placeholder="è¼¸å…¥åƒ¹æ ¼ (G)" max="999999999">
            <button class="btn" style="background:#e67e22; margin-top:10px;" onclick="confirmSell()">ç¢ºèªä¸Šæ¶</button>
            <button class="btn" style="background:#555; margin-top:10px;" onclick="closePriceModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="captcha-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="font-size:16px; margin-bottom:10px; color:#e74c3c;">å®‰å…¨é©—è­‰</h3>
            <div style="font-size:12px; color:#555; margin-bottom:10px;">è«‹å›ç­”ä»¥ä¸‹å•é¡Œä»¥ç¹¼çºŒè³¼è²·ï¼š</div>
            <div id="captcha-question" style="font-size:24px; font-weight:bold; color:#2c3e50; margin:15px 0;">? + ? = ?</div>
            <input type="number" id="captcha-input" placeholder="è¼¸å…¥ç­”æ¡ˆ">
            <button class="btn" style="background:#27ae60; margin-top:10px;" onclick="submitCaptcha()">é€å‡º</button>
            <button class="btn" style="background:#7f8c8d; margin-top:10px;" onclick="closeCaptchaModal()">å–æ¶ˆ</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 500);
            }, 1000);
        });

        const socket = io('https://mmo.ttctv-105.cc', { 
            transports: ['websocket', 'polling'],
            secure: true 
        });

        let myToken = localStorage.getItem('rpg_token');
        if (!myToken) window.location.href = 'index.html';

        let myInventory = {};
        let currentSellId = null;
        let currentItemKey = ''; 
        let currentPage = 1;
        let pendingBuyId = null; 
        let currentCategory = ''; // ğŸŸ¢ [æ–°å¢] è¿½è¹¤ç•¶å‰åˆ†é¡

        const PROHIBITED_ITEMS = [
            'lucky_bag',
            'genesis_weapon', 'genesis_armor', 'void_reaper_dark', 'ring_galaxy', 
            'void_blade', 'void_armor', 
            'galaxy_saber', 'nebula_plate', 
            'dimension_ring',
            'entropy_sword', 'entropy_god_armor'
        ];

        // å¡ç‰‡åç¨±å°ç…§è¡¨
        const CARD_NAME_MAP = {
            'slime': 'å²èŠå§†', 'rat': 'å¤§è€é¼ ', 'bee': 'æ®ºäººèœ‚', 'boar': 'é‡è±¬',
            'thief': 'ç›œè³Š', 'wolf_king': 'ç‹¼ç‹', 'snake': 'æ¯’è›‡',
            'zombie': 'è…å±', 'skeleton': 'éª·é«å…µ', 'ghoul': 'é£Ÿå±é¬¼', 'witch': 'æ²¼æ¾¤å¥³å·«',
            'hydra': 'ä¹é ­è›‡', 'fire_imp': 'ç«ç„°å°é¬¼', 'lava_golem': 'ç†”å²©æˆˆä¾–', 'salamander': 'ç«èœ¥èœ´',
            'fire_mage': 'çƒˆç„°æ³•å¸«', 'dragon_hatchling': 'å¹¼é¾', 'balrog': 'ç‚é­”',
            'snow_wolf': 'é›ªåŸç‹¼', 'yeti': 'é›ªäºº', 'ice_spirit': 'å†°ç²¾éˆ', 'frost_knight': 'å¯’éœœé¨å£«',
            'ice_dragon': 'å†°éœœé¾', 'lich_king': 'å·«å¦–ç‹',
            'void_eye': 'è™›ç©ºä¹‹çœ¼', 'shadow_assassin': 'æš—å½±åˆºå®¢', 'dark_paladin': 'å¢®è½è–é¨', 'demon_guard': 'æƒ¡é­”å®ˆè¡›',
            'succubus': 'é­…é­”', 'void_lord': 'è™›ç©ºé ˜ä¸»', 'chaos_beast': 'æ··æ²Œå·¨ç¸', 'fallen_angel': 'å¢®å¤©ä½¿',
            'demon_king': 'é­”ç‹æ’’æ—¦', 'void_walker': 'è™›ç©ºè¡Œè€…', 'chaos_knight': 'æ··æ²Œé¨å£«',
            'abyss_dragon': 'æ·±æ·µé­”é¾', 'fallen_titan': 'å¢®è½æ³°å¦', 'genesis_god': 'å‰µä¸–ç ´å£ç¥',
            'void_worm': 'è™›ç©ºåå™¬èŸ²', 'shadow_phantom': 'è™šå½±å¤¢é­˜', 'star_eater': 'åæ˜Ÿå·¨ç¸',
            'nebula_dragon': 'æ˜Ÿé›²å¹»é¾', 'time_keeper': 'æ™‚ç©ºè£æ±ºè€…', 'dimension_breaker': 'ç¶­åº¦ç²‰ç¢è€…',
            'entropy_god': 'çµ‚ç„‰Â·ç†±å¯‚ä¹‹ç¥',
            'potion': 'å›å¾©å¡', 'fire': 'æ”»æ“Šå¡', 'shield': 'è­·ç›¾å¡'
        };

        const ITEM_DB = {
            'copper_ore': { name: 'éŠ…ç¤¦çŸ³' }, 'soft_fur': { name: 'æŸ”è»Ÿçš®æ¯›' }, 'beast_fang': { name: 'é‡ç¸å°–ç‰™' }, 'slime_gel': { name: 'é»æ¶²' },
            'iron_ore': { name: 'éµç¤¦çŸ³' }, 'leather': { name: 'çš®é©' }, 'tough_hide': { name: 'ç¡¬çš®é©' }, 'magic_dust': { name: 'é­”ç²‰' },
            'poison_sac': { name: 'æ¯’å›Š' }, 'bone_shard': { name: 'ç¢éª¨ç‰‡' }, 'silver_ore': { name: 'éŠ€ç¤¦çŸ³' }, 'fire_core': { name: 'ç«ç„°æ ¸å¿ƒ' },
            'lava_rock': { name: 'ç†”å²©çŸ³' }, 'dragon_scale': { name: 'é¾é±—' }, 'gold_ore': { name: 'é‡‘ç¤¦çŸ³' }, 'ice_crystal': { name: 'æ°¸æ†å†°æ™¶' },
            'yeti_fur': { name: 'é›ªæ€ªæ¯›çš®' }, 'spirit_dust': { name: 'éˆé­‚ç²‰æœ«' }, 'mithril': { name: 'ç§˜éŠ€' }, 'void_dust': { name: 'è™›ç©ºä¹‹å¡µ' },
            'demon_horn': { name: 'æƒ¡é­”ä¹‹è§’' }, 'dark_essence': { name: 'æš—ä¹‹ç²¾è¯' }, 'adamantite': { name: 'ç²¾é‡‘' }, 'god_blood': { name: 'ç¥ä¹‹è¡€' },
            'chaos_orb': { name: 'æ··æ²Œå¯¶ç ' }, 'angel_feather': { name: 'å¤©ä½¿ä¹‹ç¾½' }, 'titan_steel': { name: 'æ³°å¦ç¥é‹¼' }, 'star_fragment': { name: 'æ˜Ÿä¹‹ç¢ç‰‡' },
            'void_shard': { name: 'è™›ç©ºç¢ç‰‡' }, 'dark_matter': { name: 'æš—ç‰©è³ª' }, 'star_core': { name: 'æ†æ˜Ÿæ ¸å¿ƒ' },
            'cosmic_steel': { name: 'å®‡å®™é‹¼' }, 'time_sand': { name: 'æ™‚å…‰ä¹‹æ²™' }, 'dimension_gem': { name: 'ç¶­åº¦å¯¶çŸ³' },
            'entropy_origin': { name: 'ç†±å¯‚åŸé»' },
            'oak_log': { name: "æ©¡æœ¨åŸæœ¨" }, 'maple_log': { name: "æ¥“æœ¨åŸæœ¨" }, 'yew_log': { name: "ç´«æ‰åŸæœ¨" }, 'ancient_log': { name: "é å¤ç¥æœ¨" },
            'spirit_wood': { name: "éˆæœ¨" }, 'dragon_wood': { name: "é¾éª¨æœ¨" }, 'void_wood': { name: "è™›ç©ºæœ¨" }, 'chaos_wood': { name: "æ··æ²Œç¥æœ¨" },
            'carp': { name: "é¯‰é­š" }, 'salmon': { name: "é®­é­š" }, 'koi': { name: "éŒ¦é¯‰" }, 'magic_fish': { name: "é­”åŠ›é­š" },
            'tuna': { name: "é»‘é®ªé­š" }, 'shark': { name: "å¤§ç™½é¯Š" }, 'lava_eel': { name: "ç†”å²©é°»" }, 'void_squid': { name: "è™›ç©ºçƒè³Š" },
            'god_carp': { name: "ç¥ä¹‹é¯‰" }, 'pearl': { name: "çç " }, 'coal': { name: "ç…¤ç‚­" }, 'ruby': { name: "ç´…å¯¶çŸ³" },
            'diamond': { name: "é‘½çŸ³" },
            'potion_hp': { name: "å°ç´…è—¥æ°´" }, 'potion_mid': { name: "ä¸­ç´…è—¥æ°´" }, 'potion_high': { name: "å¤§ç´…è—¥æ°´" }, 'potion_max': { name: "ç‰¹ç´šç§˜è—¥" },
            'elixir': { name: "ç¥ä¹‹ç”˜éœ²" }, 
            'potion_mp': { name: "å°è—è—¥æ°´" }, 'potion_mp_mid': { name: "ä¸­è—è—¥æ°´" }, 'potion_mp_high': { name: "å¤§è—è—¥æ°´" },
            'grilled_carp': { name: "çƒ¤é¯‰é­š" }, 'salmon_sushi': { name: "é®­é­šå£½å¸" }, 'tuna_steak': { name: "ç…é®ªé­šæ’" }, 'eel_rice': { name: "é°»é­šé£¯" },
            'void_soup': { name: "è™›ç©ºæµ·é®®æ¹¯" }, 'sushi_plate': { name: "å£½å¸æ‹¼ç›¤" },
            'wood_sword': { name: "æœ¨åŠ" }, 'copper_dagger': { name: "éŠ…åŒ•é¦–" }, 'iron_sword': { name: "éµåŠ" }, 'spike_club': { name: "ç‹¼ç‰™æ£’" },
            'poison_dag': { name: "åŠ‡æ¯’åŒ•é¦–" }, 'silver_blade': { name: "éŠ€åˆƒ" }, 'flame_staff': { name: "ç«ç„°æ³•æ–" }, 'gold_axe': { name: "é»ƒé‡‘å·¨æ–§" },
            'frost_bow': { name: "å¯’å†°å¼“" }, 'mithril_saber': { name: "ç§˜éŠ€è»åˆ€" }, 'void_reaper': { name: "è™›ç©ºæ”¶å‰²è€…" }, 'god_slayer': { name: "å¼’ç¥åŠ" },
            'chaos_staff': { name: "æ··æ²Œæ³•æ–" }, 'oak_bow': { name: "æ©¡æœ¨å¼“" }, 'maple_staff': { name: "æ¥“æœ¨æ³•æ–" }, 'shark_tooth': { name: "é¯Šé­šç‰™åŒ•é¦–" },
            'emerald_staff': { name: "ç¿¡ç¿ æ³•æ–" }, 'obsidian_blade': { name: "é»‘æ›œçŸ³ä¹‹åŠ" }, 'dragon_spear': { name: "é¾éª¨é•·æ§" },
            'hero_sword': { name: "å‹‡è€…ä¹‹åŠ" }, 'steel_blade': { name: "ç²¾é‹¼åŠ" }, 'assassin_dag': { name: "åˆºå®¢çŸ­åˆ€" },
            'void_reaper_dark': { name: "é—‡Â·è™›ç©ºæ”¶å‰²è€…" }, 'genesis_weapon': { name: "å‰µä¸–Â·çµ‚ç„‰ä¹‹åŠ" },
            'void_blade': { name: "è™›ç©ºä¹‹åˆƒ" }, 'galaxy_saber': { name: "éŠ€æ²³å…‰åŠ" }, 'entropy_sword': { name: "çµ‚ç„‰Â·ç†±å¯‚ä¹‹åŠ" },
            'cloth_armor': { name: "å¸ƒè¡£" }, 'hunt_vest': { name: "çµäººèƒŒå¿ƒ" }, 'leather_armor': { name: "çš®ç”²" }, 'chain_mail': { name: "é–å­ç”²" },
            'magma_plate': { name: "ç†”å²©èƒ¸ç”²" }, 'ice_robe': { name: "å†°éœœæ³•è¢" }, 'yeti_cloak': { name: "é›ªæ€ªæ–—ç¯·" }, 'demon_armor': { name: "æƒ¡é­”æˆ°ç”²" },
            'angel_armor': { name: "ç†¾å¤©ä½¿é§ç”²" }, 'plate_mail': { name: "æ¿é‡‘ç”²" }, 'dragon_mail': { name: "é¾é±—ç”²" }, 'iron_armor': { name: "éµç›”ç”²" },
            'genesis_armor': { name: "å‰µä¸–Â·ç¥ä¹‹åº‡è­·" },
            'void_armor': { name: "è™›ç©ºæˆ°ç”²" }, 'nebula_plate': { name: "æ˜Ÿé›²æ¿ç”²" }, 'entropy_god_armor': { name: "çµ‚ç„‰Â·ç¥ä¹‹åº‡è­·" },
            'bone_ring': { name: "éª¨æˆ’" }, 'ring_str': { name: "åŠ›é‡æˆ’æŒ‡" }, 'snake_boots': { name: "è›‡çš®é•·é´" }, 'amulet_soul': { name: "éˆé­‚è­·ç¬¦" },
            'ring_lord': { name: "é ˜ä¸»æŒ‡ç’°" }, 'crown_chaos': { name: "æ··æ²Œä¹‹å† " }, 'fish_ring': { name: "é­šé±—æˆ’æŒ‡" }, 'pearl_necklace': { name: "çç é …éŠ" },
            'ring_life': { name: "ç”Ÿå‘½è­·ç¬¦" }, 'ring_magic': { name: "é­”åŠ›è€³ç’°" },
            'bracelet_def': { name: "å …æ¯…æ‰‹ç’°" }, 'necklace_hp': { name: "ç´…æ°´æ™¶é …éŠ" }, 'necklace_mp': { name: "è—æ°´æ™¶é …éŠ" },
            'ring_galaxy': { name: "éŠ€æ²³æŒ‡ç’°" }, 'dimension_ring': { name: "ç¶­åº¦æŒ‡ç’°" },
            'lucky_bag': { name: "ğŸ§§ å¥‡è¹Ÿç¦è¢‹" } 
        };

        socket.on('connect', () => { socket.emit('joinGame', myToken); });
        socket.on('playerStatsUpdate', (p) => {
            document.getElementById('my-gold').innerText = p.gold;
            myInventory = p.inventory;
        });

        // èŠå¤©å®¤ (ç•¥)
        socket.on('chatHistory', (history) => {
            const box = document.getElementById('chat-history');
            box.innerHTML = ''; 
            history.forEach(data => appendChat(data.name, data.msg));
        });
        socket.on('chatMessage', (data) => { appendChat(data.name, data.msg); });
        function appendChat(name, msg) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            const nameSpan = document.createElement('span');
            nameSpan.style.color = '#f1c40f'; nameSpan.style.fontWeight = 'bold';
            nameSpan.textContent = `[${name}]: `;
            const msgNode = document.createTextNode(msg);
            div.appendChild(nameSpan); div.appendChild(msgNode);
            history.appendChild(div); history.scrollTop = history.scrollHeight;
        }
        document.getElementById('chat-send').onclick = sendChat;
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (msg) { socket.emit('sendChat', msg); input.value = ''; }
        }
        function toggleChat() {
            const chat = document.getElementById('chat-container');
            const header = document.getElementById('chat-header');
            if (window.innerWidth >= 1024) return;
            chat.classList.toggle('chat-open');
            header.innerText = chat.classList.contains('chat-open') ? " é»æ“Šæ”¶èµ·" : " å…¬é »èŠå¤©å®¤ (é»æ“Šå±•é–‹)";
        }

        function selectCategory(cat) {
            currentItemKey = ''; currentPage = 1;
            currentCategory = cat; // ğŸŸ¢ è¨˜éŒ„ç•¶å‰åˆ†é¡
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('item-select-area').style.display = 'none';
            document.getElementById('listings-area').style.display = 'none';

            if (cat === 'mine') {
                document.getElementById('status-msg').innerText = "æŸ¥è©¢æˆ‘çš„æ›å–®...";
                document.getElementById('listings-list').innerHTML = '<div style="padding:10px;">è¼‰å…¥ä¸­...</div>';
                document.getElementById('listings-area').style.display = 'flex';
                socket.emit('getMyListings');
            } else if (cat === 'card') {
                // ğŸŸ¢ [ä¿®æ”¹] é»é¸ "å¡ç‰‡" æ™‚ï¼Œè«‹æ±‚ "material" åˆ†é¡ (å‡è¨­å¡ç‰‡åœ¨ææ–™é¡)
                // æ”¶åˆ°åˆ—è¡¨å¾Œï¼Œæˆ‘å€‘æœƒç”¨ client-side filter åªé¡¯ç¤ºå¡ç‰‡
                document.getElementById('status-msg').innerText = "è®€å–å¡ç‰‡æ¸…å–®...";
                socket.emit('getMarketItems', 'material'); 
            } else {
                document.getElementById('status-msg').innerText = "è®€å–ç‰©å“æ¸…å–®...";
                socket.emit('getMarketItems', cat);
            }
        }

        socket.on('marketItemsList', (items) => {
            const area = document.getElementById('item-select-area');
            area.innerHTML = '';
            
            // ğŸŸ¢ [éæ¿¾æ ¸å¿ƒ]
            // å¦‚æœç•¶å‰é¸çš„æ˜¯ "card"ï¼Œåªé¡¯ç¤º card_ é–‹é ­çš„ç‰©å“
            // å¦‚æœç•¶å‰é¸çš„æ˜¯ "material"ï¼Œåªé¡¯ç¤º é card_ é–‹é ­çš„ç‰©å“
            // å…¶ä»–åˆ†é¡ç…§å¸¸é¡¯ç¤º
            let filteredItems = items.filter(item => !PROHIBITED_ITEMS.includes(item.id));

            if (currentCategory === 'card') {
                filteredItems = filteredItems.filter(item => item.id.startsWith('card_'));
            } else if (currentCategory === 'material') {
                filteredItems = filteredItems.filter(item => !item.id.startsWith('card_'));
            }

            if (filteredItems.length === 0) { 
                document.getElementById('status-msg').innerText = "æ­¤åˆ†é¡æš«ç„¡å¯äº¤æ˜“ç‰©å“"; 
                return; 
            }
            
            document.getElementById('status-msg').innerText = "è«‹é¸æ“‡ç‰©å“æŸ¥è©¢åƒ¹æ ¼";
            area.style.display = 'grid';
            
            filteredItems.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'item-btn';
                
                // é¡¯ç¤ºåç¨±å„ªåŒ–
                if (item.id.startsWith('card_')) {
                    const cardKey = item.id.replace('card_', '');
                    const cardName = CARD_NAME_MAP[cardKey] || cardKey;
                    btn.innerText = `å¡ç‰‡: ${cardName}`;
                } else {
                    btn.innerText = item.name;
                }
                
                btn.onclick = () => loadListings(item.id, btn.innerText);
                area.appendChild(btn);
            });
        });

        function loadListings(itemKey, itemName) {
            currentItemKey = itemKey; currentPage = 1;
            document.getElementById('status-msg').innerText = `æ­£åœ¨æŸ¥è©¢: ${itemName}`;
            document.getElementById('listings-list').innerHTML = '<div style="padding:10px; color:#aaa;">è¼‰å…¥ä¸­...</div>';
            document.getElementById('listings-area').style.display = 'flex';
            socket.emit('getMarketListings', { key: itemKey, page: 1 });
        }

        function changePage(delta) {
            const newPage = currentPage + delta;
            if (newPage < 1) return;
            currentPage = newPage;
            document.getElementById('listings-list').innerHTML = '<div style="padding:10px; color:#aaa;">è®€å–ä¸­...</div>';
            if (currentItemKey) { socket.emit('getMarketListings', { key: currentItemKey, page: currentPage }); }
        }

        socket.on('marketListingsUpdate', (data) => {
            let listings = [];
            let totalPages = 1;
            let page = 1;
            if (Array.isArray(data)) { listings = data; } 
            else { listings = data.listings; totalPages = data.totalPages; page = data.currentPage; }

            const listDiv = document.getElementById('listings-list');
            listDiv.innerHTML = ''; 

            if (listings.length === 0) { listDiv.innerHTML = '<div style="padding:20px; color:#555;">æ­¤é ç„¡ç‰©å“</div>'; } 
            else {
                listings.forEach(row => {
                    const div = document.createElement('div');
                    div.className = 'listing-row';
                    let actionBtn = '';
                    if (row.isMine) {
                        actionBtn = `<button class="btn-cancel" onclick="cancelItem(${row.id})">å–å›</button>`;
                    } else {
                        actionBtn = `<button class="btn-buy" onclick="buyItem(${row.id}, ${row.price})">è³¼è²·</button>`;
                    }
                    
                    // åˆ—è¡¨ä¹Ÿé¡¯ç¤ºå¡ç‰‡åç¨±
                    let displayItemName = row.itemName;
                    if (displayItemName.startsWith('card_')) {
                         const k = displayItemName.replace('card_', '');
                         displayItemName = `å¡ç‰‡: ${CARD_NAME_MAP[k] || k}`;
                    }

                    div.innerHTML = `
                        <div class="col-name">${displayItemName}</div>
                        <div class="col-price">$${row.price}</div>
                        <div class="col-seller">${row.seller}</div>
                        <div class="col-action">${actionBtn}</div>
                    `;
                    listDiv.appendChild(div);
                });
            }

            if (currentItemKey && totalPages > 0) { 
                const paginationDiv = document.createElement('div');
                paginationDiv.style.cssText = "display:flex; justify-content:center; gap:10px; padding:10px; align-items:center; border-top:2px solid #ccc; margin-top:auto;";
                const prevDisabled = page <= 1 ? 'disabled style="opacity:0.5; cursor:default;"' : '';
                const nextDisabled = page >= totalPages ? 'disabled style="opacity:0.5; cursor:default;"' : '';
                paginationDiv.innerHTML = `
                    <button class="cat-btn" ${prevDisabled} onclick="changePage(-1)">â—€ ä¸Šä¸€é </button>
                    <span style="font-size:10px; color:#333;">ç¬¬ ${page} / ${totalPages} é </span>
                    <button class="cat-btn" ${nextDisabled} onclick="changePage(1)">ä¸‹ä¸€é  â–¶</button>
                `;
                listDiv.appendChild(paginationDiv);
            }
        });

        // è³¼è²·æµç¨‹
        function buyItem(id, price) {
            if(confirm(`ç¢ºå®šè¦èŠ±è²» ${price} G è³¼è²·å—ï¼Ÿ`)) {
                pendingBuyId = id; 
                socket.emit('requestCaptcha'); 
            }
        }

        socket.on('captchaGenerated', (data) => {
            document.getElementById('captcha-question').innerText = data.question;
            document.getElementById('captcha-input').value = '';
            document.getElementById('captcha-modal').style.display = 'flex';
        });

        function submitCaptcha() {
            const ans = document.getElementById('captcha-input').value;
            if(!ans) return;
            socket.emit('marketBuy', { listingId: pendingBuyId, answer: ans });
            closeCaptchaModal();
        }

        function closeCaptchaModal() {
            document.getElementById('captcha-modal').style.display = 'none';
            pendingBuyId = null;
        }

        function cancelItem(id) {
            if(confirm("ç¢ºå®šä¸‹æ¶ä¸¦å–å›ç‰©å“å—ï¼Ÿ")) { socket.emit('marketCancel', id); }
        }

        function openInventoryModal() {
            const list = document.getElementById('sell-inventory-list');
            list.innerHTML = '';
            
            const keys = Object.keys(myInventory).filter(k => myInventory[k] > 0 && !PROHIBITED_ITEMS.includes(k));
            
            if (keys.length === 0) { list.innerHTML = '<div style="padding:20px; color:#aaa; text-align:center;">æ²’æœ‰å¯ä¸Šæ¶çš„ç‰©å“</div>'; } 
            else {
                keys.forEach(key => {
                    let itemData = ITEM_DB[key];
                    if (!itemData) {
                        if (key.startsWith('card_')) {
                            const k = key.replace('card_', '');
                            const cName = CARD_NAME_MAP[k] || k;
                            itemData = { name: `å¡ç‰‡: ${cName}` };
                        } else {
                            itemData = { name: key };
                        }
                    }
                    const div = document.createElement('div');
                    div.className = 'sell-list-item';
                    div.innerHTML = `
                        <div style="font-size:12px;">${itemData.name} (x${myInventory[key]})</div>
                        <button onclick="openPriceModal('${key}', '${itemData.name}')">è³£å‡º</button>
                    `;
                    list.appendChild(div);
                });
            }
            document.getElementById('inventory-modal').style.display = 'flex';
        }
        function closeInventoryModal() { document.getElementById('inventory-modal').style.display = 'none'; }

        function openPriceModal(key, name) {
            currentSellId = key;
            document.getElementById('modal-item-name').innerText = `è³£å‡º: ${name}`;
            document.getElementById('sell-price').value = '';
            document.getElementById('sell-price-modal').style.display = 'flex';
            document.getElementById('inventory-modal').style.display = 'none'; 
        }
        function closePriceModal() { document.getElementById('sell-price-modal').style.display = 'none'; }
        
        function confirmSell() {
            const priceInput = document.getElementById('sell-price');
            const price = parseInt(priceInput.value);
            if(!price || price <= 0) { showMsg("è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼"); return; }
            if (price > 999999999) { showMsg("åƒ¹æ ¼ä¸èƒ½è¶…é 999999999 G"); return; }
            socket.emit('marketSell', { itemId: currentSellId, price: price });
        }

        function showMsg(text) {
            const t = document.getElementById('game-toast');
            t.innerText = text;
            t.style.top = "30px";
            setTimeout(() => { t.style.top = "-100px"; }, 3000);
        }

        socket.on('marketResult', (res) => { 
            showMsg(res.success ? "âœ… " + res.msg : "âŒ " + res.msg);
            closePriceModal();
            closeInventoryModal();
            if (res.success && currentItemKey) { socket.emit('getMarketListings', { key: currentItemKey, page: currentPage }); }
            if (res.success && !currentItemKey) { socket.emit('getMyListings'); }
        });
        
        socket.on('marketRefresh', () => {
            if (currentItemKey) { socket.emit('getMarketListings', { key: currentItemKey, page: currentPage }); }
        });
    </script>
</body>
</html>
